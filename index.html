<!DOCTYPE html>
<html lang="he" dir="rtl" data-theme="light" style=""><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¡×¤×¨×™×™×ª Code Snippets ×”××§×™×¤×”</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&amp;family=Fira+Code:wght@300;400;500&amp;display=swap" rel="stylesheet">

    <!-- Prism.js for syntax highlighting -->
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">

    <style>
      :root {
        --primary-color: #2d3748;
        --secondary-color: #4a5568;
        --accent-color: #3182ce;
        --background-color: #ffffff;
        --card-background: #f7fafc;
        --text-color: #1a202c;
        --border-color: #e2e8f0;
        --code-background: #282a36;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          'Heebo',
          -apple-system,
          BlinkMacSystemFont,
          sans-serif;
        background-color: var(--background-color);
        color: var(--text-color);
        line-height: 1.6;
        direction: rtl;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px 150px 20px;
      }

      /* Header */
      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 3rem 0;
        text-align: center;
        margin-bottom: 2rem;
      }

      .header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 1rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .header p {
        font-size: 1.2rem;
        opacity: 0.9;
        max-width: 600px;
        margin: 0 auto;
      }

      /* Search */
      .search-container {
        position: sticky;
        top: 0;
        background: var(--background-color);
        padding: 1rem 0;
        border-bottom: 2px solid var(--border-color);
        margin-bottom: 2rem;
        z-index: 100;
      }

      .search-box {
        position: relative;
        max-width: 500px;
        margin: 0 auto;
      }

      .search-input {
        width: 100%;
        padding: 0.75rem 3rem 0.75rem 1rem;
        border: 2px solid var(--border-color);
        border-radius: 0.5rem;
        font-size: 1rem;
        font-family: 'Heebo', sans-serif;
        direction: rtl;
        outline: none;
        transition: border-color 0.3s ease;
      }

      .search-input:focus {
        border-color: var(--accent-color);
      }

      .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--secondary-color);
        pointer-events: none;
      }

      /* Table of Contents */
      .toc {
        background: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
      }

      .toc h2 {
        color: var(--primary-color);
        margin-bottom: 1rem;
        font-size: 1.5rem;
      }

      .toc-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1rem;
      }

      .toc-category {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        padding: 1rem;
      }

      .toc-category h3 {
        color: var(--accent-color);
        font-size: 1rem;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .toc-links {
        list-style: none;
        font-size: 0.9rem;
      }

      .toc-links li {
        margin-bottom: 0.25rem;
      }

      .toc-links a {
        color: var(--secondary-color);
        text-decoration: none;
        display: block;
        padding: 0.25rem 0;
        border-radius: 0.25rem;
        transition: all 0.2s ease;
      }

      .toc-links a:hover {
        color: var(--accent-color);
        background: var(--card-background);
        padding-right: 0.5rem;
      }

      /* Categories */
      .category {
        margin-bottom: 3rem;
      }

      .category-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid var(--accent-color);
      }

      .category-header i {
        font-size: 1.5rem;
        color: var(--accent-color);
      }

      .category-header h2 {
        color: var(--primary-color);
        font-size: 1.75rem;
        font-weight: 600;
      }

      /* Snippets */
      .snippet {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
        overflow: hidden;
        box-shadow: var(--shadow);
        transition:
          transform 0.2s ease,
          box-shadow 0.2s ease;
      }

      .snippet:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 15px -3px rgba(0, 0, 0, 0.1);
      }

      .snippet-header {
        background: var(--card-background);
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
      }

      .snippet-title {
        color: var(--primary-color);
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }

      .snippet-description {
        color: var(--secondary-color);
        font-size: 0.95rem;
        line-height: 1.5;
      }

      .snippet-content {
        position: relative;
      }

      .copy-button {
        position: absolute;
        top: 0.75rem;
        left: 0.75rem;
        background: var(--accent-color);
        color: white;
        border: none;
        border-radius: 0.25rem;
        padding: 0.5rem;
        cursor: pointer;
        font-size: 0.875rem;
        opacity: 0;
        transition: opacity 0.2s ease;
        z-index: 10;
        direction: ltr;
      }

      .snippet:hover .copy-button {
        opacity: 1;
      }

      .copy-button:hover {
        background: #2c5aa0;
      }

      .copy-success {
        background: #10b981 !important;
      }

      /* Code blocks */
      pre[class*='language-'] {
        direction: ltr;
        text-align: left;
        margin: 0;
        border-radius: 0;
        background: var(--code-background) !important;
        font-family: 'Fira Code', 'Courier New', monospace !important;
      }

      code[class*='language-'] {
        font-family: 'Fira Code', 'Courier New', monospace !important;
        font-size: 0.9rem;
        line-height: 1.5;
      }

      /* Filter animations */
      .snippet.filtered-out {
        display: none;
      }

      .category.no-matches {
        display: none;
      }

      /* Responsive design */
      @media (max-width: 768px) {
        .container {
          padding: 0 15px;
        }

        .header h1 {
          font-size: 2rem;
        }

        .header p {
          font-size: 1rem;
        }

        .toc-grid {
          grid-template-columns: 1fr;
        }

        .snippet-header {
          padding: 0.75rem 1rem;
        }

        .snippet-title {
          font-size: 1.1rem;
        }
      }

      /* Scroll behavior */
      html {
        scroll-behavior: smooth;
      }

      /* Anchor offset */
      .category {
        scroll-margin-top: 100px;
        scroll-margin-bottom: 120px;
      }

      /* No results message */
      .no-results {
        text-align: center;
        padding: 3rem;
        color: var(--secondary-color);
        display: none;
      }

      .no-results.show {
        display: block;
      }

      /* Back to top button */
      .back-to-top {
        position: fixed;
        bottom: 2rem;
        left: 2rem;
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transform: translateY(20px);
        display: flex;
        pointer-events: none;
      }

      .back-to-top.show {
        opacity: 1 !important;
        visibility: visible !important;
        transform: translateY(0) !important;
        pointer-events: auto;
      }

      .back-to-top:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
      }

      .back-to-top:active {
        transform: translateY(-2px);
      }

      @media (max-width: 768px) {
        .back-to-top {
          bottom: 1rem;
          left: 1rem;
          width: 45px;
          height: 45px;
          font-size: 1.2rem;
        }
      }
    </style>
  </head>
  <body style="">
    <!-- Header -->
    <div class="header">
      <div class="container">
        <h1><i class="fas fa-code"></i> ×¡×¤×¨×™×™×ª Code Snippets ×”××§×™×¤×”</h1>
        <p>
          ××•×¡×£ ××§×™×£ ×©×œ ×ª×‘× ×™×•×ª ×§×•×“ ×œ×¤×™×ª×•×— ×‘×•×˜×™× ×‘×˜×œ×’×¨×, WebApps, ×¢×‘×•×“×” ×¢× ××¡×“×™ × ×ª×•× ×™× ×•×¢×•×“. ×›×œ ×”×¡× ×™×¤×˜×™× × ×‘×“×§×• ×•××•×›× ×™×
          ×œ×©×™××•×© ××™×™×“×™.
        </p>
      </div>
    </div>

    <div class="container">
      <!-- Search -->
      <div class="search-container">
        <div class="search-box">
          <input type="text" id="searchInput" class="search-input" placeholder="×—×¤×© ×¡× ×™×¤×˜×™×...">
          <i class="fas fa-search search-icon"></i>
        </div>
      </div>

      <!-- Table of Contents -->
      <div class="toc">
        <h2><i class="fas fa-list"></i> ×ª×•×›×Ÿ ×¢× ×™×™× ×™×</h2>
        <div class="toc-grid">
          <div class="toc-category">
            <h3><i class="fas fa-robot"></i> ×ª×¤×¨×™×˜×™× ×‘×‘×•×˜</h3>
            <ul class="toc-links">
              <li><a href="#snippet-1-1">×ª×¤×¨×™×˜ ×¤×¢×•×œ×•×ª ×¢×œ ×§×•×‘×¥</a></li>
              <li><a href="#snippet-1-2">×ª×™×‘×ª ××™×©×•×¨ ×¢× ×›×¤×ª×•×¨×™×</a></li>
              <li><a href="#snippet-1-3">Callback Query Handler</a></li>
              <li><a href="#snippet-1-4">Pagination Helper</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-database"></i> ×¢×‘×•×“×” ×¢× ××¡×“ × ×ª×•× ×™×</h3>
            <ul class="toc-links">
              <li><a href="#snippet-2-1">×©××™×¨×ª ××¡××š ×¢× Versioning</a></li>
              <li><a href="#snippet-2-2">×©×œ×™×¤×ª ××¡××š ×¢× ××˜××•×Ÿ</a></li>
              <li><a href="#snippet-2-3">Update ×¢× Upsert</a></li>
              <li><a href="#snippet-2-4">Aggregation Pipeline</a></li>
              <li><a href="#snippet-2-5">Soft Delete ×¢× TTL</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-file-code"></i> × ×™×”×•×œ ×§×‘×¦×™× ×•×’×¨×¡××•×ª</h3>
            <ul class="toc-links">
              <li><a href="#snippet-3-1">×©××™×¨×ª ×§×•×‘×¥ ×¢× ×–×™×”×•×™ ×©×¤×”</a></li>
              <li><a href="#snippet-3-2">×©×œ×™×¤×ª ×’×¨×¡××•×ª</a></li>
              <li><a href="#snippet-3-3">×–×™×”×•×™ ×©×™× ×•×™×™× ×¢× Hash</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-globe"></i> ××™× ×˜×’×¨×¦×™×” ×¢× WebApp</h3>
            <ul class="toc-links">
              <li><a href="#snippet-4-1">×›×¤×ª×•×¨ WebApp</a></li>
              <li><a href="#snippet-4-2">×˜×•×§×Ÿ ×”×ª×—×‘×¨×•×ª</a></li>
              <li><a href="#snippet-4-3">××™××•×ª ×˜×•×§×Ÿ</a></li>
              <li><a href="#snippet-4-4">××ª×—×•×œ WebApp</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-paint-brush"></i> ×¨×›×™×‘×™ UI ×‘-WebApp</h3>
            <ul class="toc-links">
              <li><a href="#snippet-5-1">Modal Dialog</a></li>
              <li><a href="#snippet-5-2">Toast Notification</a></li>
              <li><a href="#snippet-5-3">Loading Overlay</a></li>
              <li><a href="#snippet-5-4">Expandable Card</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-clipboard-list"></i> Structured Logging</h3>
            <ul class="toc-links">
              <li><a href="#snippet-6-1">Emit Event ×¢× Request ID</a></li>
              <li><a href="#snippet-6-2">Binding Request ID</a></li>
              <li><a href="#snippet-6-3">Binding User Context</a></li>
              <li><a href="#snippet-6-4">×”×’×“×¨×ª Structlog</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-exclamation-triangle"></i> ×”×•×“×¢×•×ª ×©×’×™××”</h3>
            <ul class="toc-links">
              <li><a href="#snippet-7-1">Rate Limit Error Handler</a></li>
              <li><a href="#snippet-7-2">Database Error</a></li>
              <li><a href="#snippet-7-3">Validation Messages</a></li>
              <li><a href="#snippet-7-4">Batch Processing</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-vial"></i> ×‘×“×™×§×•×ª Pytest</h3>
            <ul class="toc-links">
              <li><a href="#snippet-8-1">Fixture ×¢× Setup/Teardown</a></li>
              <li><a href="#snippet-8-2">Test Parametrization</a></li>
              <li><a href="#snippet-8-3">Async Test</a></li>
              <li><a href="#snippet-8-4">Mocking ×¢× MagicMock</a></li>
              <li><a href="#snippet-8-5">Mocking ×¢× @patch</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-tools"></i> ×¤×•× ×§×¦×™×•×ª ×¢×–×¨</h3>
            <ul class="toc-links">
              <li><a href="#snippet-9-1">×–××Ÿ ×™×—×¡×™ ×‘×¢×‘×¨×™×ª</a></li>
              <li><a href="#snippet-9-2">××¡×§×™×™×¤ ×œ-Markdown</a></li>
              <li><a href="#snippet-9-3">× ×™×§×•×™ ×©××•×ª ×§×‘×¦×™×</a></li>
              <li><a href="#snippet-9-4">××¢× ×” ×‘×˜×•×— ×œ-CallbackQuery</a></li>
              <li><a href="#snippet-9-5">×¤×™×¦×•×œ ×”×•×“×¢×•×ª ××¨×•×›×•×ª</a></li>
              <li><a href="#snippet-9-6">×¢×¨×™×›×ª ×”×•×“×¢×” ×‘×˜×•×—×”</a></li>
              <li><a href="#snippet-9-7">×× ×™×¢×ª ×œ×—×™×¦×” ×›×¤×•×œ×”</a></li>
              <li><a href="#snippet-9-8">×¢×™×‘×•×“ ×¤×¨×™×˜×™× ×‘×§×‘×•×¦×•×ª</a></li>
              <li><a href="#snippet-9-9">××“×™×“×ª ×–××Ÿ</a></li>
              <li><a href="#snippet-9-10">×‘×“×™×§×ª ×§×•×“ ××¡×•×›×Ÿ</a></li>
              <li><a href="#snippet-9-11">×™×¦×™×¨×ª ×§×•×‘×¥ ×–×× ×™</a></li>
              <li><a href="#snippet-9-12">×˜×¢×™× ×ª ×§×•×‘×¥ JSON</a></li>
              <li><a href="#snippet-9-13">×§××© ×–×™×›×¨×•×Ÿ ×¢× TTL</a></li>
              <li><a href="#snippet-9-14">××¡× ×Ÿ ×œ×•×’×™× ×œ×¨×’×™×©×•×™×•×ª</a></li>
              <li><a href="#snippet-9-15">× ×™×¨××•×œ ××¨×’×•×× ×˜×™×</a></li>
              <li><a href="#snippet-9-16">×§×™×¦×•×¨ ×˜×§×¡×˜ ×‘×××¦×¢</a></li>
              <li><a href="#snippet-9-17">××¢×§×‘ ×‘×™×¦×•×¢×™× ×¢× Prometheus</a></li>
              <li><a href="#snippet-9-18">×”×¦×¢×ª ×”×©×œ××•×ª ×œ×—×™×¤×•×©</a></li>
              <li><a href="#snippet-9-19">×”×“×’×©×ª ×˜×•×•×—×™× ×‘×—×™×¤×•×©</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-tasks"></i> Background Jobs</h3>
            <ul class="toc-links">
              <li><a href="#snippet-10-1">RQ Job ×¢× Retry</a></li>
              <li><a href="#snippet-10-2">Enqueue or Run Inline</a></li>
              <li><a href="#snippet-10-3">RQ Scheduler â€“ Recurring Jobs</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-robot"></i> ×ª×‘× ×™×•×ª ×‘×•×˜ ×˜×œ×’×¨×</h3>
            <ul class="toc-links">
              <li><a href="#snippet-11-1">Maintenance Mode</a></li>
              <li><a href="#snippet-11-2">Callback Query Router</a></li>
              <li><a href="#snippet-11-3">Safe Send ×¢× Fallback</a></li>
              <li><a href="#snippet-11-4">Message Chunking</a></li>
              <li><a href="#snippet-11-5">User Mode Management</a></li>
              <li><a href="#snippet-11-6">Progress Bar Generation</a></li>
              <li><a href="#snippet-11-7">Multi-Step Form Flow</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-database"></i> Database Async</h3>
            <ul class="toc-links">
              <li><a href="#snippet-12-1">Async Session Manager</a></li>
              <li><a href="#snippet-12-2">Eager Loading</a></li>
              <li><a href="#snippet-12-3">Complex Filter</a></li>
              <li><a href="#snippet-12-4">Transaction Pattern</a></li>
              <li><a href="#snippet-12-5">Upsert Pattern</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-shield-alt"></i> Authentication</h3>
            <ul class="toc-links">
              <li><a href="#snippet-13-1">JWT Token Creation</a></li>
              <li><a href="#snippet-13-2">JWT Validation</a></li>
              <li><a href="#snippet-13-3">Role-Based Access</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-memory"></i> Redis & Caching</h3>
            <ul class="toc-links">
              <li><a href="#snippet-14-1">Distributed Lock</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-heartbeat"></i> Health Checks</h3>
            <ul class="toc-links">
              <li><a href="#snippet-15-1">Comprehensive Health Check</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-file-upload"></i> File Storage</h3>
            <ul class="toc-links">
              <li><a href="#snippet-16-1">File Validation</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-shield-alt"></i> Webhook Handling & Security</h3>
            <ul class="toc-links">
              <li><a href="#snippet-17-1">Webhook Signature Verification</a></li>
              <li><a href="#snippet-17-2">Webhook Retry Mechanism</a></li>
              <li><a href="#snippet-17-3">Webhook Health Monitoring</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-tachometer-alt"></i> Rate Limiting ××ª×§×“×</h3>
            <ul class="toc-links">
              <li><a href="#snippet-18-1">Token Bucket Algorithm</a></li>
              <li><a href="#snippet-18-2">Rate Limiting Per User/Chat</a></li>
              <li><a href="#snippet-18-3">Distributed Rate Limiting with Redis</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-redo"></i> Retry & Circuit Breaker Patterns</h3>
            <ul class="toc-links">
              <li><a href="#snippet-19-1">Exponential Backoff Retry</a></li>
              <li><a href="#snippet-19-2">Circuit Breaker Pattern</a></li>
              <li><a href="#snippet-19-3">Retry Decorator with Jitter</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-search"></i> Telegram Inline Queries</h3>
            <ul class="toc-links">
              <li><a href="#snippet-20-1">Inline Query Handler with Caching</a></li>
              <li><a href="#snippet-20-2">Inline Result Pagination</a></li>
              <li><a href="#snippet-20-3">Inline Query Rate Limiting</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-clock"></i> Message Scheduling & Delayed Tasks</h3>
            <ul class="toc-links">
              <li><a href="#snippet-21-1">Schedule Messages for Future</a></li>
              <li><a href="#snippet-21-2">Delayed Job Execution</a></li>
              <li><a href="#snippet-21-3">Recurring Tasks</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-database"></i> Database Migrations</h3>
            <ul class="toc-links">
              <li><a href="#snippet-22-1">Alembic Migration Patterns</a></li>
              <li><a href="#snippet-22-2">Data Migration Helpers</a></li>
              <li><a href="#snippet-22-3">Rollback Strategies</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-plug"></i> API Client Patterns</h3>
            <ul class="toc-links">
              <li><a href="#snippet-23-1">Async HTTP Client with Retry</a></li>
              <li><a href="#snippet-23-2">Request/Response Logging</a></li>
              <li><a href="#snippet-23-3">API Rate Limiting Compliance</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-magic"></i> Decorators ×©×™××•×©×™×™×</h3>
            <ul class="toc-links">
              <li><a href="#snippet-24-1">@retry, @timeout, @cache</a></li>
              <li><a href="#snippet-24-2">@require_auth, @admin_only</a></li>
              <li><a href="#snippet-24-3">@log_execution_time</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-credit-card"></i> Telegram Payments & Invoices</h3>
            <ul class="toc-links">
              <li><a href="#snippet-25-1">Payment Processing</a></li>
              <li><a href="#snippet-25-2">Invoice Generation</a></li>
              <li><a href="#snippet-25-3">Payment Verification</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-chart-line"></i> Monitoring & Metrics</h3>
            <ul class="toc-links">
              <li><a href="#snippet-26-1">Prometheus Metrics Collection</a></li>
              <li><a href="#snippet-26-2">Custom Metrics Helpers</a></li>
              <li><a href="#snippet-26-3">Performance Tracking Decorators</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-key"></i> Environment & Secrets Management</h3>
            <ul class="toc-links">
              <li><a href="#snippet-27-1">.env Loading with Validation</a></li>
              <li><a href="#snippet-27-2">Secrets Rotation</a></li>
              <li><a href="#snippet-27-3">Multi-Environment Config</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-check-circle"></i> Data Serialization & Validation</h3>
            <ul class="toc-links">
              <li><a href="#snippet-28-1">Pydantic Models for Data</a></li>
              <li><a href="#snippet-28-2">Custom Validators</a></li>
              <li><a href="#snippet-28-3">Serialization Helpers</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-comments"></i> Conversation Handlers & State Machines</h3>
            <ul class="toc-links">
              <li><a href="#snippet-29-1">Multi-Step Registration Flow</a></li>
              <li><a href="#snippet-29-2">State Persistence with Redis</a></li>
              <li><a href="#snippet-29-3">Nested Conversation with Sub-States</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-photo-video"></i> Telegram Media Handling</h3>
            <ul class="toc-links">
              <li><a href="#snippet-30-1">Image Processing & Resize Before Send</a></li>
              <li><a href="#snippet-30-2">Video Thumbnail Generation</a></li>
              <li><a href="#snippet-30-3">Smart Document Type Detection</a></li>
              <li><a href="#snippet-30-4">Media Compression Before Upload</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-globe"></i> Internationalization (i18n)</h3>
            <ul class="toc-links">
              <li><a href="#snippet-31-1">Multi-Language Support System</a></li>
              <li><a href="#snippet-31-2">Language Switcher with Inline Keyboard</a></li>
              <li><a href="#snippet-31-3">RTL/LTR Text Handling</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-lock"></i> Command Permissions & Access Control</h3>
            <ul class="toc-links">
              <li><a href="#snippet-32-1">Role-Based Access Control Decorator</a></li>
              <li><a href="#snippet-32-2">User Whitelist/Blacklist System</a></li>
              <li><a href="#snippet-32-3">Permission Caching for Performance</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-power-off"></i> Graceful Shutdown & Cleanup</h3>
            <ul class="toc-links">
              <li><a href="#snippet-33-1">Complete Shutdown Handler</a></li>
              <li><a href="#snippet-33-2">In-Flight Request Tracking</a></li>
              <li><a href="#snippet-33-3">Shutdown Hooks System</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-layer-group"></i> Batch Processing & Bulk Operations</h3>
            <ul class="toc-links">
              <li><a href="#snippet-34-1">Batch Database Inserts</a></li>
              <li><a href="#snippet-34-2">Bulk Message Sending with Rate Limiting</a></li>
              <li><a href="#snippet-34-3">Chunked Processing with Progress</a></li>
              <li><a href="#snippet-34-4">Batch Export to CSV</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-users"></i> Telegram Channel/Group Management</h3>
            <ul class="toc-links">
              <li><a href="#snippet-35-1">Auto-Moderation System</a></li>
              <li><a href="#snippet-35-2">Member Management Utilities</a></li>
              <li><a href="#snippet-35-3">Channel Posting Helpers</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-file-export"></i> Data Export/Import</h3>
            <ul class="toc-links">
              <li><a href="#snippet-36-1">CSV Export with Streaming</a></li>
              <li><a href="#snippet-36-2">JSON Import with Validation</a></li>
              <li><a href="#snippet-36-3">Backup/Restore Complete Database</a></li>
              <li><a href="#snippet-36-4">Data Transformation Pipeline</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-chart-bar"></i> Performance Monitoring</h3>
            <ul class="toc-links">
              <li><a href="#snippet-37-1">Query Performance Tracker</a></li>
              <li><a href="#snippet-37-2">Memory Usage Monitor</a></li>
              <li><a href="#snippet-37-3">Slow Request Detection</a></li>
              <li><a href="#snippet-37-4">Performance Profiling Decorator</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-exchange-alt"></i> Webhook vs Polling Patterns</h3>
            <ul class="toc-links">
              <li><a href="#snippet-38-1">Webhook Setup with Security</a></li>
              <li><a href="#snippet-38-2">Smart Polling with Offset Management</a></li>
              <li><a href="#snippet-38-3">Hybrid Approach (Webhook with Polling Fallback)</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-bars"></i> Telegram Bot Commands Menu</h3>
            <ul class="toc-links">
              <li><a href="#snippet-39-1">Dynamic Command Registration</a></li>
              <li><a href="#snippet-39-2">Command Aliases System</a></li>
              <li><a href="#snippet-39-3">Grouped Commands Menu</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-life-ring"></i> Advanced Error Recovery</h3>
            <ul class="toc-links">
              <li><a href="#snippet-40-1">Dead Letter Queue for Failed Messages</a></li>
              <li><a href="#snippet-40-2">Error Notification System</a></li>
              <li><a href="#snippet-40-3">Automatic Recovery Strategies</a></li>
              <li><a href="#snippet-40-4">Error Aggregation & Reporting</a></li>
            </ul>
          </div>

          <div class="toc-category">
            <h3><i class="fas fa-microphone"></i> Voice & Audio Processing</h3>
            <ul class="toc-links">
              <li><a href="#snippet-41-1">Transcribe Voice Messages with Whisper API</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-chart-area"></i> Real-time Analytics Dashboard</h3>
            <ul class="toc-links">
              <li><a href="#snippet-42-1">Stream Bot Metrics via WebSocket</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-user-shield"></i> ML-Based Anti-Spam</h3>
            <ul class="toc-links">
              <li><a href="#snippet-43-1">Detect Spam with Machine Learning</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-clipboard-check"></i> Advanced Survey Builder</h3>
            <ul class="toc-links">
              <li><a href="#snippet-44-1">Create Dynamic Surveys with Branching Logic</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-gamepad"></i> Telegram Games Integration</h3>
            <ul class="toc-links">
              <li><a href="#snippet-45-1">Integrate HTML5 Games</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-map-marker-alt"></i> Location Services</h3>
            <ul class="toc-links">
              <li><a href="#snippet-46-1">Find Nearby Users or Services</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-project-diagram"></i> Bot-to-Bot Communication</h3>
            <ul class="toc-links">
              <li><a href="#snippet-47-1">Inter-Bot Messaging System</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-rocket"></i> Auto-Deployment Scripts</h3>
            <ul class="toc-links">
              <li><a href="#snippet-48-1">GitHub Actions Deployment</a></li>
              <li><a href="#snippet-48-2">Docker Deployment Script</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-sync"></i> Smart Caching with Dynamic TTL</h3>
            <ul class="toc-links">
              <li><a href="#snippet-49-1">Adaptive Cache Management</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-video"></i> Video Chat Integration</h3>
            <ul class="toc-links">
              <li><a href="#snippet-50-1">Create Video Rooms for Users</a></li>
            </ul>
          </div>

        </div>
      </div>

      <!-- No results message -->
      <div class="no-results" id="noResults">
        <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5"></i>
        <h3>×œ× × ××¦××• ×ª×•×¦××•×ª</h3>
        <p>× ×¡×” ×œ×—×¤×© ×‘××™×œ×•×ª ××¤×ª×— ××—×¨×•×ª ××• ×‘×“×•×§ ××ª ×”××™×•×ª</p>
      </div>

      <!-- Category 1: ×ª×¤×¨×™×˜×™× ×‘×‘×•×˜ -->
      <div class="category" id="category-1">
        <div class="category-header">
          <i class="fas fa-robot"></i>
          <h2>×ª×¤×¨×™×˜×™× ×‘×‘×•×˜</h2>
        </div>

        <div class="snippet" id="snippet-1-1">
          <div class="snippet-header">
            <h3 class="snippet-title">1.1 ×ª×¤×¨×™×˜ ×¤×¢×•×œ×•×ª ×¢×œ ×§×•×‘×¥ (Multi-Row Grid)</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×™×¦×™×¨×ª ×ª×¤×¨×™×˜ ×¢× ××¡×¤×¨ ×©×•×¨×•×ª ×©×œ ×›×¤×ª×•×¨×™×, ×××•×¨×’× ×™× ×œ×¤×™ ×¤×•× ×§×¦×™×•× ×œ×™×•×ª.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">from</span> telegram <span class="token keyword">import</span> InlineKeyboardButton<span class="token punctuation">,</span> InlineKeyboardMarkup

<span class="token comment"># ×™×¦×™×¨×ª ×ª×¤×¨×™×˜ ×¢× ×›×¤×ª×•×¨×™× ××¨×•×‘×™×</span>
buttons <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span>
        InlineKeyboardButton<span class="token punctuation">(</span><span class="token string">"ğŸ—‘ï¸ ××—×™×§×”"</span><span class="token punctuation">,</span> callback_data<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"delete_</span><span class="token interpolation"><span class="token punctuation">{</span>file_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        InlineKeyboardButton<span class="token punctuation">(</span><span class="token string">"âœï¸ ×¢×¨×™×›×”"</span><span class="token punctuation">,</span> callback_data<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"edit_</span><span class="token interpolation"><span class="token punctuation">{</span>file_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
        InlineKeyboardButton<span class="token punctuation">(</span><span class="token string">"ğŸ“ ×¢×¨×•×š ×”×¢×¨×”"</span><span class="token punctuation">,</span> callback_data<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"edit_note_</span><span class="token interpolation"><span class="token punctuation">{</span>file_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        InlineKeyboardButton<span class="token punctuation">(</span><span class="token string">"ğŸ’¾ ×”×•×¨×“×”"</span><span class="token punctuation">,</span> callback_data<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"download_</span><span class="token interpolation"><span class="token punctuation">{</span>file_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
        InlineKeyboardButton<span class="token punctuation">(</span><span class="token string">"ğŸŒ ×©×™×ª×•×£"</span><span class="token punctuation">,</span> callback_data<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"share_</span><span class="token interpolation"><span class="token punctuation">{</span>file_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
        InlineKeyboardButton<span class="token punctuation">(</span>fav_text<span class="token punctuation">,</span> callback_data<span class="token operator">=</span>fav_cb<span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">]</span>
reply_markup <span class="token operator">=</span> InlineKeyboardMarkup<span class="token punctuation">(</span>buttons<span class="token punctuation">)</span>
<span class="token keyword">await</span> update<span class="token punctuation">.</span>message<span class="token punctuation">.</span>reply_text<span class="token punctuation">(</span>
    response_text<span class="token punctuation">,</span>
    parse_mode<span class="token operator">=</span><span class="token string">'HTML'</span><span class="token punctuation">,</span>
    reply_markup<span class="token operator">=</span>reply_markup
<span class="token punctuation">)</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-1-2">
          <div class="snippet-header">
            <h3 class="snippet-title">1.2 ×ª×™×‘×ª ××™×©×•×¨ ×¢× ×›×¤×ª×•×¨×™× (Yes/No Dialog)</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×“×™××œ×•×’ ××™×©×•×¨ ×¤×©×•×˜ ×œ×¤× ×™ ×‘×™×¦×•×¢ ×¤×¢×•×œ×” ×§×¨×™×˜×™×ª.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">from</span> telegram <span class="token keyword">import</span> InlineKeyboardButton<span class="token punctuation">,</span> InlineKeyboardMarkup
<span class="token keyword">from</span> telegram<span class="token punctuation">.</span>constants <span class="token keyword">import</span> ParseMode

keyboard <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span>
        InlineKeyboardButton<span class="token punctuation">(</span><span class="token string">"âœ… ×›×Ÿ, ××—×§"</span><span class="token punctuation">,</span> callback_data<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"confirm_delete_</span><span class="token interpolation"><span class="token punctuation">{</span>file_name<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        InlineKeyboardButton<span class="token punctuation">(</span><span class="token string">"âŒ ×‘×™×˜×•×œ"</span><span class="token punctuation">,</span> callback_data<span class="token operator">=</span><span class="token string">"cancel_delete"</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">]</span>
reply_markup <span class="token operator">=</span> InlineKeyboardMarkup<span class="token punctuation">(</span>keyboard<span class="token punctuation">)</span>

<span class="token keyword">await</span> update<span class="token punctuation">.</span>message<span class="token punctuation">.</span>reply_text<span class="token punctuation">(</span>
    <span class="token string-interpolation"><span class="token string">f"ğŸ—‘ï¸ **××™×©×•×¨ ××—×™×§×”**\n\n"</span></span>
    <span class="token string-interpolation"><span class="token string">f"×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª `</span><span class="token interpolation"><span class="token punctuation">{</span>file_name<span class="token punctuation">}</span></span><span class="token string">`?"</span></span><span class="token punctuation">,</span>
    parse_mode<span class="token operator">=</span>ParseMode<span class="token punctuation">.</span>MARKDOWN<span class="token punctuation">,</span>
    reply_markup<span class="token operator">=</span>reply_markup
<span class="token punctuation">)</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-1-3">
          <div class="snippet-header">
            <h3 class="snippet-title">1.3 Callback Query Handler - × ×™×ª×•×‘ ×œ×¤×™ ×“×¤×•×¡</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×˜×™×¤×•×œ ××¨×•×›×– ×‘×›×œ ×œ×—×™×¦×•×ª ×”×›×¤×ª×•×¨×™×, ×¢× × ×™×ª×•×‘ ×œ×¤×™ prefix.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">handle_callback_query</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> update<span class="token punctuation">:</span> Update<span class="token punctuation">,</span> context<span class="token punctuation">:</span> ContextTypes<span class="token punctuation">.</span>DEFAULT_TYPE<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""×˜×™×¤×•×œ ×‘×œ×—×™×¦×•×ª ×¢×œ ×›×¤×ª×•×¨×™×"""</span>
    query <span class="token operator">=</span> update<span class="token punctuation">.</span>callback_query
    <span class="token keyword">await</span> query<span class="token punctuation">.</span>answer<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># ×—×©×•×‘! ×××©×¨ ×§×‘×œ×ª ×”×œ×—×™×¦×”</span>

    data <span class="token operator">=</span> query<span class="token punctuation">.</span>data
    user_id <span class="token operator">=</span> query<span class="token punctuation">.</span>from_user<span class="token punctuation">.</span><span class="token builtin">id</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> data<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"confirm_delete_"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            file_name <span class="token operator">=</span> data<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"confirm_delete_"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> db<span class="token punctuation">.</span>delete_file<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> file_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">await</span> query<span class="token punctuation">.</span>edit_message_text<span class="token punctuation">(</span>
                    <span class="token string-interpolation"><span class="token string">f"âœ… ×”×§×•×‘×¥ `</span><span class="token interpolation"><span class="token punctuation">{</span>file_name<span class="token punctuation">}</span></span><span class="token string">` × ××—×§ ×‘×”×¦×œ×—×”!"</span></span><span class="token punctuation">,</span>
                    parse_mode<span class="token operator">=</span>ParseMode<span class="token punctuation">.</span>MARKDOWN
                <span class="token punctuation">)</span>

        <span class="token keyword">elif</span> data <span class="token operator">==</span> <span class="token string">"cancel_delete"</span><span class="token punctuation">:</span>
            <span class="token keyword">await</span> query<span class="token punctuation">.</span>edit_message_text<span class="token punctuation">(</span><span class="token string">"âŒ ××—×™×§×” ×‘×•×˜×œ×”."</span><span class="token punctuation">)</span>

        <span class="token keyword">elif</span> data<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"share_gist_"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            file_name <span class="token operator">=</span> data<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"share_gist_"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
            <span class="token keyword">await</span> self<span class="token punctuation">.</span>_share_to_gist<span class="token punctuation">(</span>query<span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> file_name<span class="token punctuation">)</span>

        <span class="token comment"># ... more handlers</span>

    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error handling callback: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> query<span class="token punctuation">.</span>edit_message_text<span class="token punctuation">(</span><span class="token string">"âš ï¸ ××™×¨×¢×” ×©×’×™××”"</span><span class="token punctuation">)</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-1-4">
          <div class="snippet-header">
            <h3 class="snippet-title">1.4 Pagination Helper - ×›×¤×ª×•×¨×™ ×”×§×•×“×/×”×‘×</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×¤×•× ×§×¦×™×” ×©×™××•×©×™×ª ×œ×‘× ×™×™×ª ×›×¤×ª×•×¨×™ × ×™×•×•×˜ ×‘×¢××•×“×™×.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">from</span> telegram <span class="token keyword">import</span> InlineKeyboardButton
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Optional<span class="token punctuation">,</span> List

<span class="token keyword">def</span> <span class="token function">build_pagination_row</span><span class="token punctuation">(</span>
    page<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    total_items<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    page_size<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    callback_prefix<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">[</span>List<span class="token punctuation">[</span>InlineKeyboardButton<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""×‘×•× ×” ×©×•×¨×ª ×›×¤×ª×•×¨×™ pagination ××• None ×× ××™×Ÿ ×¦×•×¨×š."""</span>
    <span class="token keyword">if</span> page_size <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>

    total_pages <span class="token operator">=</span> <span class="token punctuation">(</span>total_items <span class="token operator">+</span> page_size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">//</span> page_size <span class="token keyword">if</span> total_items <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">1</span>
    <span class="token keyword">if</span> total_pages <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>

    row<span class="token punctuation">:</span> List<span class="token punctuation">[</span>InlineKeyboardButton<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">if</span> page <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span>
        row<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
            InlineKeyboardButton<span class="token punctuation">(</span><span class="token string">"â¬…ï¸ ×”×§×•×“×"</span><span class="token punctuation">,</span> callback_data<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>callback_prefix<span class="token punctuation">}</span></span><span class="token interpolation"><span class="token punctuation">{</span>page<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">if</span> page <span class="token operator">&lt;</span> total_pages<span class="token punctuation">:</span>
        row<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
            InlineKeyboardButton<span class="token punctuation">(</span><span class="token string">"â¡ï¸ ×”×‘×"</span><span class="token punctuation">,</span> callback_data<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>callback_prefix<span class="token punctuation">}</span></span><span class="token interpolation"><span class="token punctuation">{</span>page<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">return</span> row <span class="token keyword">or</span> <span class="token boolean">None</span></code></pre>
          </div>
        </div>
      </div>

      <!-- Category 2: ×¢×‘×•×“×” ×¢× ××¡×“ × ×ª×•× ×™× -->
      <div class="category" id="category-2">
        <div class="category-header">
          <i class="fas fa-database"></i>
          <h2>×¢×‘×•×“×” ×¢× ××¡×“ × ×ª×•× ×™×</h2>
        </div>

        <div class="snippet" id="snippet-2-1">
          <div class="snippet-header">
            <h3 class="snippet-title">2.1 ×©××™×¨×ª ××¡××š ×¢× Versioning</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×©××™×¨×” ×¢× × ×™×”×•×œ ×’×¨×¡××•×ª ××•×˜×•××˜×™ + ×‘×™×˜×•×œ cache.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timezone
<span class="token keyword">from</span> dataclasses <span class="token keyword">import</span> asdict

<span class="token keyword">def</span> <span class="token function">save_code_snippet</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> snippet<span class="token punctuation">:</span> CodeSnippet<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># × ×¨××•×œ ×§×•×“ ×œ×¤× ×™ ×©××™×¨×”</span>
        <span class="token keyword">if</span> config<span class="token punctuation">.</span>NORMALIZE_CODE_ON_SAVE<span class="token punctuation">:</span>
            snippet<span class="token punctuation">.</span>code <span class="token operator">=</span> normalize_code<span class="token punctuation">(</span>snippet<span class="token punctuation">.</span>code<span class="token punctuation">)</span>

        <span class="token comment"># ×‘×“×™×§×ª ×’×¨×¡×” ×§×™×™××ª</span>
        existing <span class="token operator">=</span> self<span class="token punctuation">.</span>get_latest_version<span class="token punctuation">(</span>snippet<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span> snippet<span class="token punctuation">.</span>file_name<span class="token punctuation">)</span>
        <span class="token keyword">if</span> existing<span class="token punctuation">:</span>
            snippet<span class="token punctuation">.</span>version <span class="token operator">=</span> existing<span class="token punctuation">[</span><span class="token string">'version'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span>

        snippet<span class="token punctuation">.</span>updated_at <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span>timezone<span class="token punctuation">.</span>utc<span class="token punctuation">)</span>

        <span class="token comment"># ×©××™×¨×” ×‘××¡×“ ×”× ×ª×•× ×™×</span>
        result <span class="token operator">=</span> self<span class="token punctuation">.</span>manager<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>insert_one<span class="token punctuation">(</span>asdict<span class="token punctuation">(</span>snippet<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> result<span class="token punctuation">.</span>inserted_id<span class="token punctuation">:</span>
            <span class="token comment"># ×‘×™×˜×•×œ cache ×œ××©×ª××©</span>
            cache<span class="token punctuation">.</span>invalidate_user_cache<span class="token punctuation">(</span>snippet<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>

        <span class="token keyword">return</span> <span class="token boolean">False</span>

    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error saving snippet: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-2-2">
          <div class="snippet-header">
            <h3 class="snippet-title">2.2 ×©×œ×™×¤×ª ××¡××š ××—×“ ×¢× ××˜××•×Ÿ (Cached Query)</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×©×œ×™×¤×” ××”×™×¨×” ×¢× caching ××•×˜×•××˜×™ ×œ××©×š 3 ×“×§×•×ª.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Optional<span class="token punctuation">,</span> Dict

<span class="token decorator annotation punctuation">@cached</span><span class="token punctuation">(</span>expire_seconds<span class="token operator">=</span><span class="token number">180</span><span class="token punctuation">,</span> key_prefix<span class="token operator">=</span><span class="token string">"latest_version"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">get_latest_version</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> file_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># Fast-path ×œ×¡×‘×™×‘×•×ª ×‘×“×™×§×”</span>
        docs_list <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>manager<span class="token punctuation">.</span>collection<span class="token punctuation">,</span> <span class="token string">'docs'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>docs_list<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            candidates <span class="token operator">=</span> <span class="token punctuation">[</span>
                d <span class="token keyword">for</span> d <span class="token keyword">in</span> docs_list
                <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span>
                <span class="token keyword">and</span> d<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'user_id'</span><span class="token punctuation">)</span> <span class="token operator">==</span> user_id
                <span class="token keyword">and</span> d<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'file_name'</span><span class="token punctuation">)</span> <span class="token operator">==</span> file_name
            <span class="token punctuation">]</span>
            <span class="token keyword">if</span> candidates<span class="token punctuation">:</span>
                latest <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>candidates<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> d<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'version'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>latest<span class="token punctuation">)</span>

        <span class="token comment"># ×©×œ×™×¤×” ××”-DB ×¢× ×¡×™× ×•×Ÿ ×•×¡×™×“×•×¨</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>manager<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>find_one<span class="token punctuation">(</span>
            <span class="token punctuation">{</span>
                <span class="token string">"user_id"</span><span class="token punctuation">:</span> user_id<span class="token punctuation">,</span>
                <span class="token string">"file_name"</span><span class="token punctuation">:</span> file_name<span class="token punctuation">,</span>
                <span class="token string">"$or"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                    <span class="token punctuation">{</span><span class="token string">"is_active"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token punctuation">{</span><span class="token string">"is_active"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"$exists"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
                <span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            sort<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">"version"</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error fetching latest version: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-2-3">
          <div class="snippet-header">
            <h3 class="snippet-title">2.3 Update ×¢× Upsert ×•×˜×™×¤×•×œ ×‘×©×“×•×ª ××•×ª× ×™×</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×¢×“×›×•×Ÿ ××• ×™×¦×™×¨×” (upsert) ×¢× ×”×’×“×¨×ª ×©×“×•×ª ×©×•× ×™× ×œ×™×¦×™×¨×” ××•×œ ×¢×“×›×•×Ÿ.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timezone

<span class="token keyword">def</span> <span class="token function">save_github_token</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> token<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># ×”×¦×¤× ×ª ×”×˜×•×§×Ÿ</span>
        <span class="token keyword">from</span> secret_manager <span class="token keyword">import</span> encrypt_secret
        enc <span class="token operator">=</span> encrypt_secret<span class="token punctuation">(</span>token<span class="token punctuation">)</span>
        stored <span class="token operator">=</span> enc <span class="token keyword">if</span> enc <span class="token keyword">else</span> token

        users_collection <span class="token operator">=</span> self<span class="token punctuation">.</span>manager<span class="token punctuation">.</span>db<span class="token punctuation">.</span>users

        result <span class="token operator">=</span> users_collection<span class="token punctuation">.</span>update_one<span class="token punctuation">(</span>
            <span class="token punctuation">{</span><span class="token string">"user_id"</span><span class="token punctuation">:</span> user_id<span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token string">"$set"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    <span class="token string">"github_token"</span><span class="token punctuation">:</span> stored<span class="token punctuation">,</span>
                    <span class="token string">"updated_at"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span>timezone<span class="token punctuation">.</span>utc<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string">"$setOnInsert"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    <span class="token string">"created_at"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span>timezone<span class="token punctuation">.</span>utc<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            upsert<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>  <span class="token comment"># ×™×¦×™×¨×” ×× ×œ× ×§×™×™×</span>
        <span class="token punctuation">)</span>

        <span class="token keyword">return</span> <span class="token builtin">bool</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>acknowledged<span class="token punctuation">)</span>

    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error saving token: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-2-4">
          <div class="snippet-header">
            <h3 class="snippet-title">2.4 Aggregation Pipeline - ×©××™×œ×ª× ××•×¨×›×‘×ª</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×©××™×œ×ª×•×ª ××ª×§×“××•×ª ×¢× grouping, sorting ×•-projection.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_latest_files_aggregated</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> limit<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""××—×–×™×¨ ××ª ×”×’×¨×¡×” ×”××—×¨×•× ×” ×©×œ ×›×œ ×§×•×‘×¥"""</span>

    <span class="token keyword">match</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"user_id"</span><span class="token punctuation">:</span> user_id<span class="token punctuation">,</span> <span class="token string">"is_active"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>
    sort_key <span class="token operator">=</span> <span class="token string">"updated_at"</span>
    sort_dir <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>  <span class="token comment"># DESC</span>

    pipeline <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token string">"$match"</span><span class="token punctuation">:</span> <span class="token keyword">match</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment"># ×¡×™× ×•×Ÿ</span>
        <span class="token punctuation">{</span><span class="token string">"$sort"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"file_name"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"version"</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment"># ××™×•×Ÿ</span>
        <span class="token punctuation">{</span><span class="token string">"$group"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>  <span class="token comment"># ×§×™×‘×•×¥ ×œ×¤×™ ×©× ×§×•×‘×¥</span>
            <span class="token string">"_id"</span><span class="token punctuation">:</span> <span class="token string">"$file_name"</span><span class="token punctuation">,</span>
            <span class="token string">"latest"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"$first"</span><span class="token punctuation">:</span> <span class="token string">"$$ROOT"</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"$replaceRoot"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"newRoot"</span><span class="token punctuation">:</span> <span class="token string">"$latest"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment"># ×”×—×œ×¤×ª root</span>
        <span class="token punctuation">{</span><span class="token string">"$sort"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>sort_key<span class="token punctuation">:</span> sort_dir<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment"># ××™×•×Ÿ ×¡×•×¤×™</span>
        <span class="token punctuation">{</span><span class="token string">"$limit"</span><span class="token punctuation">:</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>limit <span class="token keyword">or</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment"># ×”×’×‘×œ×ª ×ª×•×¦××•×ª</span>
        <span class="token punctuation">{</span><span class="token string">"$project"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>  <span class="token comment"># ×‘×—×™×¨×ª ×©×“×•×ª</span>
            <span class="token string">"_id"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token string">"file_name"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token string">"programming_language"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token string">"updated_at"</span><span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>

    rows <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>manager<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>aggregate<span class="token punctuation">(</span>pipeline<span class="token punctuation">,</span> allowDiskUse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> rows</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-2-5">
          <div class="snippet-header">
            <h3 class="snippet-title">2.5 Soft Delete ×¢× TTL (Recycle Bin)</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××—×™×§×” ×¨×›×” ×¢× ××¤×©×¨×•×ª ×©×—×–×•×¨, ×•××—×™×§×” ×¡×•×¤×™×ª ××•×˜×•××˜×™×ª ×œ××—×¨ 7 ×™××™×.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timezone<span class="token punctuation">,</span> timedelta

<span class="token keyword">def</span> <span class="token function">delete_file</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> file_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""××—×™×§×” ×¨×›×” - ××¡××Ÿ ×›×œ× ×¤×¢×™×œ ×‘××§×•× ×œ××—×•×§"""</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        now <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span>timezone<span class="token punctuation">.</span>utc<span class="token punctuation">)</span>
        ttl_days <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">getattr</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token string">'RECYCLE_TTL_DAYS'</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token number">7</span><span class="token punctuation">)</span>
        expires <span class="token operator">=</span> now <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> ttl_days<span class="token punctuation">)</span><span class="token punctuation">)</span>

        result <span class="token operator">=</span> self<span class="token punctuation">.</span>manager<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>update_many<span class="token punctuation">(</span>
            <span class="token punctuation">{</span>
                <span class="token string">"user_id"</span><span class="token punctuation">:</span> user_id<span class="token punctuation">,</span>
                <span class="token string">"file_name"</span><span class="token punctuation">:</span> file_name<span class="token punctuation">,</span>
                <span class="token string">"$or"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                    <span class="token punctuation">{</span><span class="token string">"is_active"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token punctuation">{</span><span class="token string">"is_active"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"$exists"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
                <span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token string">"$set"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    <span class="token string">"is_active"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
                    <span class="token string">"updated_at"</span><span class="token punctuation">:</span> now<span class="token punctuation">,</span>
                    <span class="token string">"deleted_at"</span><span class="token punctuation">:</span> now<span class="token punctuation">,</span>
                    <span class="token string">"deleted_expires_at"</span><span class="token punctuation">:</span> expires<span class="token punctuation">,</span>  <span class="token comment"># TTL field</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

        <span class="token keyword">if</span> result<span class="token punctuation">.</span>modified_count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            cache<span class="token punctuation">.</span>invalidate_user_cache<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>

        <span class="token keyword">return</span> <span class="token boolean">False</span>

    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error deleting file: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span></code></pre>
          </div>
        </div>
      </div>

      <!-- Category 3: × ×™×”×•×œ ×§×‘×¦×™× ×•×’×¨×¡××•×ª -->
      <div class="category" id="category-3">
        <div class="category-header">
          <i class="fas fa-file-code"></i>
          <h2>× ×™×”×•×œ ×§×‘×¦×™× ×•×’×¨×¡××•×ª</h2>
        </div>

        <div class="snippet" id="snippet-3-1">
          <div class="snippet-header">
            <h3 class="snippet-title">3.1 ×©××™×¨×ª ×§×•×‘×¥ ×¢× ×–×™×”×•×™ ×©×¤×” ××•×˜×•××˜×™</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×–×¨×™××” ××œ××” ×©×œ ×©××™×¨×ª ×§×•×‘×¥ - × ×¨××•×œ, ×–×™×”×•×™ ×©×¤×”, ×©××™×¨×” + ×”×—×–×¨×ª ID.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">from</span> database <span class="token keyword">import</span> db<span class="token punctuation">,</span> CodeSnippet
<span class="token keyword">from</span> services<span class="token punctuation">.</span>code_service <span class="token keyword">import</span> detect_language<span class="token punctuation">,</span> normalize_code

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">save_file_final</span><span class="token punctuation">(</span>update<span class="token punctuation">,</span> context<span class="token punctuation">,</span> filename<span class="token punctuation">,</span> user_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""×©×•××¨ ×§×•×‘×¥ ×¢× metadata ××œ×"""</span>

    code <span class="token operator">=</span> context<span class="token punctuation">.</span>user_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'code_to_save'</span><span class="token punctuation">)</span>

    <span class="token comment"># × ×¨××•×œ ×§×•×“</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        code <span class="token operator">=</span> normalize_code<span class="token punctuation">(</span>code<span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
        <span class="token keyword">pass</span>

    <span class="token comment"># ×–×™×”×•×™ ×©×¤×ª ×ª×›× ×•×ª</span>
    detected_language <span class="token operator">=</span> detect_language<span class="token punctuation">(</span>code<span class="token punctuation">,</span> filename<span class="token punctuation">)</span>

    <span class="token comment"># ×”×¢×¨×” ××•×¤×¦×™×•× ×œ×™×ª</span>
    note <span class="token operator">=</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>user_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'note_to_save'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># ×™×¦×™×¨×ª snippet</span>
    snippet <span class="token operator">=</span> CodeSnippet<span class="token punctuation">(</span>
        user_id<span class="token operator">=</span>user_id<span class="token punctuation">,</span>
        file_name<span class="token operator">=</span>filename<span class="token punctuation">,</span>
        code<span class="token operator">=</span>code<span class="token punctuation">,</span>
        programming_language<span class="token operator">=</span>detected_language<span class="token punctuation">,</span>
        description<span class="token operator">=</span>note<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token comment"># ×©××™×¨×”</span>
    success <span class="token operator">=</span> db<span class="token punctuation">.</span>save_code_snippet<span class="token punctuation">(</span>snippet<span class="token punctuation">)</span>

    <span class="token keyword">if</span> success<span class="token punctuation">:</span>
        <span class="token comment"># ×©×œ×™×¤×ª ×”××¡××š ×”×©××•×¨ ×œ×§×‘×œ×ª ID</span>
        saved_doc <span class="token operator">=</span> db<span class="token punctuation">.</span>get_latest_version<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> filename<span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        file_id <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>saved_doc<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'_id'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">''</span><span class="token punctuation">)</span>

        <span class="token comment"># ×©××™×¨×” ×‘×”×§×©×¨ ×œ×©×™××•×© ×¢×ª×™×“×™</span>
        context<span class="token punctuation">.</span>user_data<span class="token punctuation">[</span><span class="token string">"last_save_success"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">"file_name"</span><span class="token punctuation">:</span> filename<span class="token punctuation">,</span>
            <span class="token string">"language"</span><span class="token punctuation">:</span> detected_language<span class="token punctuation">,</span>
            <span class="token string">"file_id"</span><span class="token punctuation">:</span> file_id<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">await</span> update<span class="token punctuation">.</span>message<span class="token punctuation">.</span>reply_text<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"âœ… ×”×§×•×‘×¥ `</span><span class="token interpolation"><span class="token punctuation">{</span>filename<span class="token punctuation">}</span></span><span class="token string">` × ×©××¨ ×‘×”×¦×œ×—×”!"</span></span><span class="token punctuation">)</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-3-2">
          <div class="snippet-header">
            <h3 class="snippet-title">3.2 ×©×œ×™×¤×ª ×’×¨×¡××•×ª - Latest / All / Specific</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×××©×§ ×¤×©×•×˜ ×œ× ×™×”×•×œ ×’×¨×¡××•×ª ×©×œ ×§×‘×¦×™×.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_latest_version</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> file_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""××—×–×™×¨ ××ª ×”×’×¨×¡×” ×”××—×¨×•× ×” ×©×œ ×§×•×‘×¥"""</span>
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>_get_repo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_latest_version<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> file_name<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">get_all_versions</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> file_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""××—×–×™×¨ ××ª ×›×œ ×”×’×¨×¡××•×ª ×©×œ ×§×•×‘×¥"""</span>
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>_get_repo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_all_versions<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> file_name<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">get_version</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> file_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> version<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""××—×–×™×¨ ×’×¨×¡×” ×¡×¤×¦×™×¤×™×ª"""</span>
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>_get_repo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_version<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> file_name<span class="token punctuation">,</span> version<span class="token punctuation">)</span>

<span class="token comment"># ×©×™××•×©:</span>
<span class="token comment"># latest = db.get_latest_version(123, "main.py")</span>
<span class="token comment"># all_versions = db.get_all_versions(123, "main.py")</span>
<span class="token comment"># v2 = db.get_version(123, "main.py", 2)</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-3-3">
          <div class="snippet-header">
            <h3 class="snippet-title">3.3 ×–×™×”×•×™ ×©×™× ×•×™×™× ×‘×§×•×‘×¥ ×¢× Hash</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×–×™×”×•×™ ×× ×§×•×‘×¥ ×”×©×ª× ×” ×œ×œ× ×¦×•×¨×š ×‘×”×©×•×•××ª ×ª×•×›×Ÿ ××œ×.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">import</span> hashlib
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timezone

<span class="token keyword">def</span> <span class="token function">check_file_sync</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> file_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> new_content<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""×‘×•×“×§ ×× ×”×§×•×‘×¥ ×”×©×ª× ×” ×××– ×”×©××™×¨×” ×”××—×¨×•× ×”"""</span>

    <span class="token comment"># ×—×™×©×•×‘ hash ×—×“×©</span>
    new_hash <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha256<span class="token punctuation">(</span>new_content<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># ×©×œ×™×¤×ª hash ×™×©×Ÿ</span>
    file_doc <span class="token operator">=</span> self<span class="token punctuation">.</span>files_collection<span class="token punctuation">.</span>find_one<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"_id"</span><span class="token punctuation">:</span> ObjectId<span class="token punctuation">(</span>file_id<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    old_hash <span class="token operator">=</span> file_doc<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"content_hash"</span><span class="token punctuation">)</span> <span class="token keyword">if</span> file_doc <span class="token keyword">else</span> <span class="token boolean">None</span>

    <span class="token comment"># ×”×©×•×•××”</span>
    <span class="token keyword">if</span> old_hash <span class="token operator">==</span> new_hash<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"changed"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">"affected"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span>

    <span class="token comment"># × ×™×ª×•×— ×”×©×¤×¢×” ×¢×œ ×¨×©×•××•×ª ×ª×œ×•×™×•×ª (×œ××©×œ ×¡×™×× ×™×•×ª)</span>
    old_lines <span class="token operator">=</span> file_doc<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>splitlines<span class="token punctuation">(</span><span class="token punctuation">)</span>
    new_lines <span class="token operator">=</span> new_content<span class="token punctuation">.</span>splitlines<span class="token punctuation">(</span><span class="token punctuation">)</span>
    affected <span class="token operator">=</span> self<span class="token punctuation">.</span>_analyze_bookmark_changes<span class="token punctuation">(</span>file_id<span class="token punctuation">,</span> old_lines<span class="token punctuation">,</span> new_lines<span class="token punctuation">)</span>

    <span class="token comment"># ×¢×“×›×•×Ÿ hash</span>
    self<span class="token punctuation">.</span>files_collection<span class="token punctuation">.</span>update_one<span class="token punctuation">(</span>
        <span class="token punctuation">{</span><span class="token string">"_id"</span><span class="token punctuation">:</span> ObjectId<span class="token punctuation">(</span>file_id<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"$set"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"content_hash"</span><span class="token punctuation">:</span> new_hash<span class="token punctuation">,</span>
            <span class="token string">"code"</span><span class="token punctuation">:</span> new_content<span class="token punctuation">,</span>
            <span class="token string">"last_sync"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span>timezone<span class="token punctuation">.</span>utc<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token string">"changed"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
        <span class="token string">"old_hash"</span><span class="token punctuation">:</span> old_hash<span class="token punctuation">,</span>
        <span class="token string">"new_hash"</span><span class="token punctuation">:</span> new_hash<span class="token punctuation">,</span>
        <span class="token string">"affected"</span><span class="token punctuation">:</span> affected
    <span class="token punctuation">}</span></code></pre>
          </div>
        </div>
      </div>

      <!-- Category 4: ××™× ×˜×’×¨×¦×™×” ×¢× WebApp -->
      <div class="category" id="category-4">
        <div class="category-header">
          <i class="fas fa-globe"></i>
          <h2>××™× ×˜×’×¨×¦×™×” ×¢× WebApp</h2>
        </div>

        <div class="snippet" id="snippet-4-1">
          <div class="snippet-header">
            <h3 class="snippet-title">4.1 ×™×¦×™×¨×ª ×›×¤×ª×•×¨ WebApp ×¢× ×§×™×©×•×¨ ×œ×§×•×‘×¥</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×¤×ª×™×—×ª WebApp ×™×©×™×¨×•×ª ×œ×§×•×‘×¥ ×¡×¤×¦×™×¤×™ ××• ×ª×•×¦××•×ª ×—×™×¤×•×©.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">from</span> telegram <span class="token keyword">import</span> InlineKeyboardButton
<span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> quote_plus
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Optional<span class="token punctuation">,</span> List

<span class="token keyword">def</span> <span class="token function">_get_webapp_button_row</span><span class="token punctuation">(</span>
    file_id<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    file_name<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">[</span>List<span class="token punctuation">[</span>InlineKeyboardButton<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""×‘×•× ×” ×›×¤×ª×•×¨ WebApp ×¢× ×§×™×©×•×¨ ×œ×§×•×‘×¥"""</span>

    base_url <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">'WEBAPP_URL'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> config<span class="token punctuation">.</span>WEBAPP_URL
    <span class="token keyword">if</span> <span class="token keyword">not</span> base_url<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>

    <span class="token comment"># ×§×™×©×•×¨ ×™×©×™×¨ ×œ×§×•×‘×¥ ×œ×¤×™ ID</span>
    <span class="token keyword">if</span> file_id<span class="token punctuation">:</span>
        target_url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>base_url<span class="token punctuation">}</span></span><span class="token string">/file/</span><span class="token interpolation"><span class="token punctuation">{</span>file_id<span class="token punctuation">}</span></span><span class="token string">"</span></span>

    <span class="token comment"># ××• ×§×™×©×•×¨ ×œ×—×™×¤×•×© ×œ×¤×™ ×©×</span>
    <span class="token keyword">elif</span> file_name<span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            query <span class="token operator">=</span> quote_plus<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
            query <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>
        target_url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>base_url<span class="token punctuation">}</span></span><span class="token string">/files?q=</span><span class="token interpolation"><span class="token punctuation">{</span>query<span class="token punctuation">}</span></span><span class="token string">#results"</span></span>

    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>

    <span class="token keyword">return</span> <span class="token punctuation">[</span>InlineKeyboardButton<span class="token punctuation">(</span><span class="token string">"ğŸŒ ×¦×¤×™×™×” ×‘WebApp"</span><span class="token punctuation">,</span> url<span class="token operator">=</span>target_url<span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token comment"># ×©×™××•×©:</span>
<span class="token comment"># webapp_row = _get_webapp_button_row(file_id_str, file_name)</span>
<span class="token comment"># if webapp_row:</span>
<span class="token comment">#     buttons.append(webapp_row)</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-4-2">
          <div class="snippet-header">
            <h3 class="snippet-title">4.2 ×™×¦×™×¨×ª ×˜×•×§×Ÿ ×”×ª×—×‘×¨×•×ª ×œ-WebApp</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×™×¦×™×¨×ª ×˜×•×§×Ÿ ×××•×‘×˜×— ×œ×›× ×™×¡×” ×œ-WebApp ××”×‘×•×˜.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">import</span> hashlib
<span class="token keyword">import</span> time
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timezone<span class="token punctuation">,</span> timedelta
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Optional<span class="token punctuation">,</span> Dict

<span class="token keyword">def</span> <span class="token function">_build_webapp_login_payload</span><span class="token punctuation">(</span>
    db_manager<span class="token punctuation">,</span>
    user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    username<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""×™×•×¦×¨ ×˜×•×§×Ÿ ×”×ª×—×‘×¨×•×ª ×××•×‘×˜×— ×œ-WebApp"""</span>

    base_url <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"WEBAPP_URL"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> config<span class="token punctuation">.</span>WEBAPP_URL
    secret <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"WEBAPP_LOGIN_SECRET"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> config<span class="token punctuation">.</span>SECRET_KEY <span class="token keyword">or</span> <span class="token string">"dev-secret-key"</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># ×™×¦×™×¨×ª ×˜×•×§×Ÿ ×××•×‘×˜×—</span>
        token_data <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>user_id<span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">int</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{</span>secret<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        auth_token <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha256<span class="token punctuation">(</span>token_data<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">32</span><span class="token punctuation">]</span>
    <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>exception<span class="token punctuation">(</span><span class="token string">"×™×¦×™×¨×ª ×˜×•×§×Ÿ webapp × ×›×©×œ×”"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>

    <span class="token comment"># ×©××™×¨×ª ×”×˜×•×§×Ÿ ×‘-DB</span>
    now_utc <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span>timezone<span class="token punctuation">.</span>utc<span class="token punctuation">)</span>
    token_doc <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">"token"</span><span class="token punctuation">:</span> auth_token<span class="token punctuation">,</span>
        <span class="token string">"user_id"</span><span class="token punctuation">:</span> user_id<span class="token punctuation">,</span>
        <span class="token string">"username"</span><span class="token punctuation">:</span> username<span class="token punctuation">,</span>
        <span class="token string">"created_at"</span><span class="token punctuation">:</span> now_utc<span class="token punctuation">,</span>
        <span class="token string">"expires_at"</span><span class="token punctuation">:</span> now_utc <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>minutes<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># ×ª×•×§×£ 5 ×“×§×•×ª</span>
    <span class="token punctuation">}</span>
    db_manager<span class="token punctuation">.</span>db<span class="token punctuation">.</span>webapp_tokens<span class="token punctuation">.</span>insert_one<span class="token punctuation">(</span>token_doc<span class="token punctuation">)</span>

    <span class="token comment"># ×™×¦×™×¨×ª URL ×”×ª×—×‘×¨×•×ª</span>
    login_url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>base_url<span class="token punctuation">}</span></span><span class="token string">/auth/token?token=</span><span class="token interpolation"><span class="token punctuation">{</span>auth_token<span class="token punctuation">}</span></span><span class="token string">&amp;user_id=</span><span class="token interpolation"><span class="token punctuation">{</span>user_id<span class="token punctuation">}</span></span><span class="token string">"</span></span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token string">"auth_token"</span><span class="token punctuation">:</span> auth_token<span class="token punctuation">,</span>
        <span class="token string">"login_url"</span><span class="token punctuation">:</span> login_url<span class="token punctuation">,</span>
        <span class="token string">"webapp_url"</span><span class="token punctuation">:</span> base_url<span class="token punctuation">,</span>
    <span class="token punctuation">}</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-4-3">
          <div class="snippet-header">
            <h3 class="snippet-title">4.3 ××™××•×ª ×˜×•×§×Ÿ ×•×™×¦×™×¨×ª Session (Server-Side)</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××™××•×ª ×”×˜×•×§×Ÿ ××”×‘×•×˜ ×•×™×¦×™×¨×ª session ×‘××¢×¨×›×ª ×”-WebApp.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> request<span class="token punctuation">,</span> session<span class="token punctuation">,</span> render_template
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timezone

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/auth/token'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">token_auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""×˜×™×¤×•×œ ×‘××™××•×ª ×¢× ×˜×•×§×Ÿ ××”×‘×•×˜"""</span>

    token <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">)</span>
    user_id <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'user_id'</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> token <span class="token keyword">or</span> <span class="token keyword">not</span> user_id<span class="token punctuation">:</span>
        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'404.html'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">404</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        db <span class="token operator">=</span> get_db<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># ×—×™×¤×•×© ×”×˜×•×§×Ÿ ×‘××¡×“ × ×ª×•× ×™×</span>
        token_doc <span class="token operator">=</span> db<span class="token punctuation">.</span>webapp_tokens<span class="token punctuation">.</span>find_one<span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token string">'token'</span><span class="token punctuation">:</span> token<span class="token punctuation">,</span>
            <span class="token string">'user_id'</span><span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token keyword">not</span> token_doc<span class="token punctuation">:</span>
            <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'login.html'</span><span class="token punctuation">,</span>
                                 error<span class="token operator">=</span><span class="token string">"×§×™×©×•×¨ ×”×”×ª×—×‘×¨×•×ª ×œ× ×ª×§×£ ××• ×¤×’ ×ª×•×§×¤×•"</span><span class="token punctuation">)</span>

        <span class="token comment"># ×‘×“×™×§×ª ×ª×•×§×£</span>
        <span class="token keyword">if</span> token_doc<span class="token punctuation">[</span><span class="token string">'expires_at'</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span>timezone<span class="token punctuation">.</span>utc<span class="token punctuation">)</span><span class="token punctuation">:</span>
            db<span class="token punctuation">.</span>webapp_tokens<span class="token punctuation">.</span>delete_one<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'_id'</span><span class="token punctuation">:</span> token_doc<span class="token punctuation">[</span><span class="token string">'_id'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'login.html'</span><span class="token punctuation">,</span>
                                 error<span class="token operator">=</span><span class="token string">"×§×™×©×•×¨ ×”×”×ª×—×‘×¨×•×ª ×¤×’ ×ª×•×§×£. ×× × ×‘×§×© ×§×™×©×•×¨ ×—×“×© ××”×‘×•×˜."</span><span class="token punctuation">)</span>

        <span class="token comment"># ××—×™×§×ª ×”×˜×•×§×Ÿ ×œ××—×¨ ×©×™××•×© (×—×“ ×¤×¢××™)</span>
        db<span class="token punctuation">.</span>webapp_tokens<span class="token punctuation">.</span>delete_one<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'_id'</span><span class="token punctuation">:</span> token_doc<span class="token punctuation">[</span><span class="token string">'_id'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment"># ×©××™×¨×ª × ×ª×•× ×™ ×”××©×ª××© ×‘×¡×©×Ÿ</span>
        user_id_int <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>
        session<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> user_id_int
        session<span class="token punctuation">[</span><span class="token string">'user_data'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">'id'</span><span class="token punctuation">:</span> user_id_int<span class="token punctuation">,</span>
            <span class="token string">'first_name'</span><span class="token punctuation">:</span> token_doc<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'first_name'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'username'</span><span class="token punctuation">:</span> token_doc<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>

        <span class="token comment"># ×”×¤×•×š ××ª ×”×¡×©×Ÿ ×œ×§×‘×•×¢ (30 ×™×•×)</span>
        session<span class="token punctuation">.</span>permanent <span class="token operator">=</span> <span class="token boolean">True</span>

        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'/files'</span><span class="token punctuation">)</span>

    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error in token auth: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'login.html'</span><span class="token punctuation">,</span> error<span class="token operator">=</span><span class="token string">"×©×’×™××” ×‘××™××•×ª"</span><span class="token punctuation">)</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-4-4">
          <div class="snippet-header">
            <h3 class="snippet-title">4.4 ××ª×—×•×œ WebApp ×‘×¦×“ ×”×œ×§×•×— (Frontend)</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×–×™×”×•×™ ×©×”-WebApp × ×˜×¢×Ÿ ×‘×ª×•×š ×˜×œ×’×¨× ×•×”×ª×××ª ×”×ª×¦×•×’×”.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// ×–×™×”×•×™ Telegram WebApp SDK</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>Telegram <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span>Telegram<span class="token punctuation">.</span>WebApp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'telegram-mini-app'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// ×”×¨×—×‘×ª viewport ×œ×©×™××•×© ××œ× ×‘××¡×š</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                window<span class="token punctuation">.</span>Telegram<span class="token punctuation">.</span>WebApp<span class="token punctuation">.</span><span class="token function">expand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

            <span class="token comment">// ××™×ª×•×ª ×©×”-WebApp ××•×›×Ÿ</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                window<span class="token punctuation">.</span>Telegram<span class="token punctuation">.</span>WebApp<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

            <span class="token comment">// ×§×‘×œ×ª × ×ª×•× ×™ ××©×ª××© ××˜×œ×’×¨×</span>
            <span class="token keyword">const</span> initData <span class="token operator">=</span> window<span class="token punctuation">.</span>Telegram<span class="token punctuation">.</span>WebApp<span class="token punctuation">.</span>initData<span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Telegram WebApp initialized:'</span><span class="token punctuation">,</span> initData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Error initializing Telegram WebApp:'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
          </div>
        </div>
      </div>

      <!-- Category 5: ×¨×›×™×‘×™ UI ×‘-WebApp -->
      <div class="category" id="category-5">
        <div class="category-header">
          <i class="fas fa-paint-brush"></i>
          <h2>×¨×›×™×‘×™ UI ×‘-WebApp</h2>
        </div>

        <div class="snippet" id="snippet-5-1">
          <div class="snippet-header">
            <h3 class="snippet-title">5.1 Modal Dialog ×¢× Promise</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×“×™××œ×•×’ ××•×“×œ×™ ×©××—×–×™×¨ ×ª×•×¦××” ×“×¨×š Promise (async/await).
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">async</span> <span class="token function">showTagDialog</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> dialog <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dialog<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">'modal-overlay'</span><span class="token punctuation">;</span>

        dialog<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
            
                
                     ×”×•×¡×£ ×ª×’×™×•×ª
                    
                        
                    
                

                
                    ×”×–×Ÿ ×ª×’×™×•×ª ××•×¤×¨×“×•×ª ×‘×¤×¡×™×§×™×:
                    
                    
                        ×”×¦×¢×•×ª:
                        important
                        python
                    
                

                
                    
                         ××™×©×•×¨
                    
                    
                         ×‘×™×˜×•×œ
                    
                
            
        </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>dialog<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ×˜×™×¤×•×œ ×‘××™×¨×•×¢×™×</span>
        dialog<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> action <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">closest</span><span class="token punctuation">(</span><span class="token string">'[data-action]'</span><span class="token punctuation">)</span><span class="token operator">?.</span>dataset<span class="token punctuation">.</span>action<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">===</span> <span class="token string">'confirm'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> input <span class="token operator">=</span> dialog<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#tagInput'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> tags <span class="token operator">=</span> input<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">t</span> <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">)</span><span class="token punctuation">;</span>
                document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>dialog<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>tags<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">===</span> <span class="token string">'cancel'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>dialog<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ×¤×•×§×•×¡ ×¢×œ ×”-input</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> dialog<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#tagInput'</span><span class="token punctuation">)</span><span class="token operator">?.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// ×©×™××•×©:</span>
<span class="token comment">// const tags = await showTagDialog();</span>
<span class="token comment">// if (tags) {</span>
<span class="token comment">//     console.log('Selected tags:', tags);</span>
<span class="token comment">// }</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-5-2">
          <div class="snippet-header">
            <h3 class="snippet-title">5.2 Toast Notification ×¢× Auto-Dismiss</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×”×¦×’×ª ×”×•×“×¢×•×ª ×–×× ×™×•×ª ×©× ×¢×œ××•×ª ××•×˜×•××˜×™×ª.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">NotificationManager</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>notificationContainer <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>notificationContainer<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">'notification-container'</span><span class="token punctuation">;</span>
        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>notificationContainer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">showNotification</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">'info'</span><span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> notification <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        notification<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">notification </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> icon <span class="token operator">=</span> <span class="token string">'info-circle'</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'success'</span><span class="token punctuation">)</span> icon <span class="token operator">=</span> options<span class="token punctuation">.</span>icon <span class="token operator">||</span> <span class="token string">'check-circle'</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'error'</span><span class="token punctuation">)</span> icon <span class="token operator">=</span> <span class="token string">'exclamation-circle'</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'warning'</span><span class="token punctuation">)</span> icon <span class="token operator">=</span> <span class="token string">'exclamation-triangle'</span><span class="token punctuation">;</span>

        notification<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
            
                
                </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
            
            
                
            
        </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

        <span class="token comment">// ×˜×™×¤×•×œ ×‘×¡×’×™×¨×” ×™×“× ×™×ª</span>
        notification<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.notification-close'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            notification<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'fade-out'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> notification<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>notificationContainer<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>notification<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ×× ×™××¦×™×™×ª ×›× ×™×¡×”</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> notification<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'show'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ×¡×’×™×¨×” ××•×˜×•××˜×™×ª</span>
        <span class="token keyword">const</span> duration <span class="token operator">=</span> options<span class="token punctuation">.</span>duration <span class="token operator">||</span> <span class="token number">3000</span><span class="token punctuation">;</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>notification<span class="token punctuation">.</span>parentNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                notification<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'fade-out'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> notification<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// ×©×™××•×©:</span>
<span class="token comment">// const notifier = new NotificationManager();</span>
<span class="token comment">// notifier.showNotification('×”×§×•×‘×¥ × ×©××¨ ×‘×”×¦×œ×—×”!', 'success');</span>
<span class="token comment">// notifier.showNotification('×©×’×™××” ×‘×©××™×¨×”', 'error', { duration: 5000 });</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-5-3">
          <div class="snippet-header">
            <h3 class="snippet-title">5.3 Loading Overlay ×¢× Progress Bar</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××¡×š ×˜×¢×™× ×” ×¢× ××¤×©×¨×•×ª ×œ×¢×“×›×•×Ÿ ×”×ª×§×“××•×ª ×‘××—×•×–×™×.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">ProcessingOverlay</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> overlay <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        overlay<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">'processing-overlay hidden'</span><span class="token punctuation">;</span>
        overlay<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
            
                
                ××¢×‘×“...
                
                    
                        
                    
                    0%
                
            
        </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>overlay<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>overlay <span class="token operator">=</span> overlay<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">show</span><span class="token punctuation">(</span>text <span class="token operator">=</span> <span class="token string">'××¢×‘×“...'</span><span class="token punctuation">,</span> showProgress <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>overlay<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.processing-text'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textContent <span class="token operator">=</span> text<span class="token punctuation">;</span>
        <span class="token keyword">const</span> progressEl <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>overlay<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.processing-progress'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>showProgress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            progressEl<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">'hidden'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            progressEl<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'hidden'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>overlay<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">'hidden'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">updateProgress</span><span class="token punctuation">(</span><span class="token parameter">percent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> progressFill <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>overlay<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.progress-fill'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> progressText <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>overlay<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.progress-text'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>progressFill <span class="token operator">&amp;&amp;</span> progressText<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            progressFill<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>percent<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">%</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
            progressText<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>percent<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">%</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">hide</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>overlay<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'hidden'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// ×©×™××•×©:</span>
<span class="token comment">// const overlay = new ProcessingOverlay();</span>
<span class="token comment">// overlay.show('××¢×‘×“ ×§×‘×¦×™×...', true);</span>
<span class="token comment">// for (let i = 0; i &lt;= 100; i += 10) {</span>
<span class="token comment">//     overlay.updateProgress(i);</span>
<span class="token comment">//     await processChunk();</span>
<span class="token comment">// }</span>
<span class="token comment">// overlay.hide();</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-5-4">
          <div class="snippet-header">
            <h3 class="snippet-title">5.4 Card ×¢× ×”×¨×—×‘×” (Expandable Card)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×›×¨×˜×™×¡ ×©× ×™×ª×Ÿ ×œ×”×¨×—×™×‘ ×œ×ª×¦×•×’×” ××§×“×™××” ××œ××”.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">async</span> <span class="token function">expandCard</span><span class="token punctuation">(</span><span class="token parameter">fileId<span class="token punctuation">,</span> cardElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cardElement<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'card-preview-expanding'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> wrapper <span class="token operator">=</span> cardElement<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.preview-wrapper'</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createWrapper</span><span class="token punctuation">(</span>cardElement<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ×”×¦×’×ª spinner</span>
    wrapper<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
        
            
            ×˜×•×¢×Ÿ ×ª×¦×•×’×” ××§×“×™××”...
        
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// ×©×œ×™×¤×ª ×ª×•×›×Ÿ</span>
        <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/api/file/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>fileId<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/preview</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'Accept'</span><span class="token operator">:</span> <span class="token string">'application/json'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">credentials</span><span class="token operator">:</span> <span class="token string">'same-origin'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">.</span>ok <span class="token operator">||</span> <span class="token operator">!</span>data <span class="token operator">||</span> data<span class="token punctuation">.</span>ok <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token punctuation">(</span>data <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token operator">?</span> data<span class="token punctuation">.</span>error <span class="token operator">:</span> <span class="token string">'×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×¦×•×’×” ××§×“×™××”'</span><span class="token punctuation">;</span>
            wrapper<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
                
                     </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>msg<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
                
            </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// ×”×¦×’×ª ×ª×•×›×Ÿ</span>
        wrapper<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildPreviewHTML</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> fileId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cardElement<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'card-preview-expanded'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        wrapper<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
            
                 ×©×’×™××ª ×¨×©×ª
            
        </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        cardElement<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">'card-preview-expanding'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
          </div>
        </div>
      </div>

      <!-- Additional categories would continue here... -->
      <!-- Due to length constraints, I'll show the structure with a few more key categories -->

      <!-- Category 6: Structured Logging -->
      <div class="category" id="category-6">
        <div class="category-header">
          <i class="fas fa-clipboard-list"></i>
          <h2>Structured Logging</h2>
        </div>

        <div class="snippet" id="snippet-6-1">
          <div class="snippet-header">
            <h3 class="snippet-title">6.1 Emit Event ×¢× Request ID</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×œ×•×’×™× ××•×‘× ×™× ×¢× ××¢×§×‘ ××—×¨ request ×™×™×—×•×“×™ ×œ××•×¨×š ×›×œ ×”×ª×”×œ×™×š.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import structlog
from typing import Any

def emit_event(event: str, severity: str = "info", **fields: Any) -> None:
    """×©×•×œ×— ××™×¨×•×¢ ×œ×•×’ ××•×‘× ×”"""

    logger = structlog.get_logger()
    fields.setdefault("event", event)

    # ×”×•×¡×¤×ª request_id ××”×§×•× ×˜×§×¡×˜
    if severity in {"error", "critical"}:
        ctx = get_observability_context()
        request_id = str(fields.get("request_id") or ctx.get("request_id") or "").strip()
        if request_id and "request_id" not in fields:
            fields["request_id"] = request_id

        # ×”×¢×©×¨×ª context ×¢× command, user_id, chat_id
        command_tag = _sanitize_command_identifier(fields.get("command")) or str(ctx.get("command") or "")
        user_tag = _hash_identifier(fields.get("user_id")) or str(ctx.get("user_id") or "")
        chat_tag = _hash_identifier(fields.get("chat_id")) or str(ctx.get("chat_id") or "")

        if command_tag:
            fields["command"] = command_tag
        if user_tag:
            fields["user_id"] = user_tag
        if chat_tag:
            fields["chat_id"] = chat_tag

    # ×©×œ×™×—×ª ×œ×•×’
    log_method = getattr(logger, severity, logger.info)
    log_method(event, **fields)

# ×©×™××•×©:
# emit_event("file_saved", severity="info", user_id=123, file_name="main.py")
# emit_event("db_error", severity="error", error=str(e), request_id=req_id)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-6-2">
          <div class="snippet-header">
            <h3 class="snippet-title">6.2 Binding Request ID ×œ×§×•× ×˜×§×¡×˜</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×§×•×©×¨ request_id ×œ×›×œ ×”×œ×•×’×™× ×‘×–×¨×™××” ×”× ×•×›×—×™×ª (×’× async).</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import structlog

def bind_request_id(request_id: str) -> None:
    """×§×•×©×¨ request_id ×œ×›×œ ×”×œ×•×’×™× ×‘×”×§×©×¨ ×”× ×•×›×—×™"""
    try:
        structlog.contextvars.bind_contextvars(request_id=request_id)
    except Exception:
        pass

    # ×©×œ×™×—×” ×’× ×œ-Sentry
    _set_sentry_tag("request_id", request_id)

# ×©×™××•×© ×‘×ª×—×™×œ×ª request:
# request_id = generate_request_id()  # uuid4().hex
# bind_request_id(request_id)
#
# # ×›×œ ×”×œ×•×’×™× ××¢×›×©×™×• ×™×›×œ×œ×• ××ª ×”-request_id ××•×˜×•××˜×™×ª:
# emit_event("processing_started", severity="info")
# emit_event("processing_completed", severity="info")</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-6-3">
          <div class="snippet-header">
            <h3 class="snippet-title">6.3 Binding User Context</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×§×™×©×•×¨ user_id ×•-chat_id ×œ×›×œ ×”×œ×•×’×™× ×‘×¦×•×¨×” ××•×˜×•××˜×™×ª.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import structlog
from typing import Any, Optional, Dict

def bind_user_context(
    *,
    user_id: Any | None = None,
    chat_id: Any | None = None
) -> None:
    """×§×•×©×¨ ×”×§×©×¨ ××©×ª××© ×œ×›×œ ×”×œ×•×’×™×"""

    to_bind: Dict[str, str] = {}

    # Hash ×©×œ user_id (××‘×˜×—×ª ×¤×¨×˜×™×•×ª)
    user_hash = _hash_identifier(user_id)
    if user_hash:
        to_bind["user_id"] = user_hash
        _set_sentry_tag("user_id", user_hash)

    # Hash ×©×œ chat_id
    chat_hash = _hash_identifier(chat_id)
    if chat_hash:
        to_bind["chat_id"] = chat_hash
        _set_sentry_tag("chat_id", chat_hash)

    # ×§×™×©×•×¨ ×œ×§×•× ×˜×§×¡×˜
    if to_bind:
        try:
            structlog.contextvars.bind_contextvars(**to_bind)
        except Exception:
            pass

# ×©×™××•×©:
# bind_user_context(user_id=update.effective_user.id, chat_id=update.effective_chat.id)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-6-4">
          <div class="snippet-header">
            <h3 class="snippet-title">6.4 ×”×’×“×¨×ª Structlog ×¢× Merge Context</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×§×•× ×¤×™×’×•×¨×¦×™×” ××œ××” ×©×œ structlog ×¢× ××™×–×•×’ ×§×•× ×˜×§×¡×˜ ××•×˜×•××˜×™.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import structlog

def setup_structlog_logging(min_level: str | int = "INFO") -> None:
    """××’×“×™×¨ structlog ×¢× processors ××œ××™×"""

    level = _parse_log_level(min_level)

    structlog.configure(
        processors=[
            structlog.contextvars.merge_contextvars,  # ××™×–×•×’ context ××•×˜×•××˜×™
            _add_otel_ids,                             # ×”×•×¡×¤×ª trace_id/span_id
            _redact_sensitive,                         # ×”×¡×¨×ª × ×ª×•× ×™× ×¨×’×™×©×™×
            _add_schema_version,                       # ×’×¨×¡×ª schema
            structlog.processors.add_log_level,        # ×¨××ª ×œ×•×’
            _mirror_to_log_aggregator,                 # ×©×œ×™×—×” ×œ-aggregator
            _maybe_sample_info,                        # ×“×’×™××ª info logs
            structlog.processors.TimeStamper(fmt="iso"),
            _choose_renderer(),  # JSON ××• console
        ],
        wrapper_class=structlog.make_filtering_bound_logger(level),
        context_class=dict,
        logger_factory=structlog.PrintLoggerFactory(),
        cache_logger_on_first_use=False,
    )

# ×©×™××•×©:
# setup_structlog_logging("INFO")</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 7: ×”×•×“×¢×•×ª ×©×’×™××” ×™×“×™×“×•×ª×™×•×ª -->
      <div class="category" id="category-7">
        <div class="category-header">
          <i class="fas fa-exclamation-triangle"></i>
          <h2>×”×•×“×¢×•×ª ×©×’×™××” ×™×“×™×“×•×ª×™×•×ª</h2>
        </div>

        <div class="snippet" id="snippet-7-1">
          <div class="snippet-header">
            <h3 class="snippet-title">7.1 Rate Limit Error Handler</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×˜×™×¤×•×œ ×‘×’×‘×œ×ª ×§×¦×‘ ×¢× ×”×•×“×¢×” ×™×“×™×“×•×ª×™×ª ×œ××©×ª××© + metrics.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from flask import jsonify, request

@app.errorhandler(429)
def _ratelimit_handler(e):
    """×˜×™×¤×•×œ ×‘×”×’×‘×œ×ª ×§×¦×‘"""
    try:
        # ×œ×•×’×™× ×•××˜×¨×™×§×•×ª (best-effort)
        try:
            emit_event(
                "rate_limit_blocked",
                severity="warning",
                path=str(getattr(request, 'path', '')),
                remote=str(getattr(request, 'remote_addr', '')),
            )
        except Exception:
            pass

        try:
            from metrics import rate_limit_blocked
            if rate_limit_blocked is not None:
                scope = str(getattr(request, 'path', '') or 'route')
                rate_limit_blocked.labels(
                    source="webapp",
                    scope=scope,
                    limit="route"
                ).inc()
        except Exception:
            pass

        # ×ª×’×•×‘×” ×œ××©×ª××©
        payload = {
            "error": "rate_limit_exceeded",
            "message": "×™×•×ª×¨ ××“×™ ×‘×§×©×•×ª. ×× × × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.",
            "retry_after": getattr(e, 'description', None),
        }
        return jsonify(payload), 429

    except Exception:
        # fallback ×× ×”×›×œ × ×›×©×œ
        return jsonify({"error": "rate_limit_exceeded"}), 429</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-7-2">
          <div class="snippet-header">
            <h3 class="snippet-title">7.2 Database Error ×¢× ×”×•×“×¢×•×ª ×¡×¤×¦×™×¤×™×•×ª</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×˜×™×¤×•×œ ×‘×©×’×™××•×ª DB ×¡×¤×¦×™×¤×™×•×ª ×¢× ×”×•×“×¢×•×ª ××ª××™××•×ª.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from pymongo.errors import DuplicateKeyError

def toggle_bookmark(
    self,
    user_id: int,
    file_id: str,
    file_name: str,
    line_number: int,
    **kwargs
) -> Dict[str, Any]:
    """××•×¡×™×£ ××• ××¡×™×¨ ×¡×™×× ×™×™×”"""

    try:
        # Validation
        if line_number <= 0:
            return {
                "ok": False,
                "action": "error",
                "error": "××¡×¤×¨ ×©×•×¨×” ×œ× ×ª×§×™×Ÿ"
            }

        note = kwargs.get('note', '')
        if len(note) > MAX_NOTE_LENGTH:
            note = note[:MAX_NOTE_LENGTH]

        # ... bookmark logic ...

        return {
            "ok": True,
            "action": "added",
            "bookmark": self._bookmark_to_response(bookmark)
        }

    except DuplicateKeyError:
        # ×©×’×™××” ×¡×¤×¦×™×¤×™×ª - ××¤×ª×— ×›×¤×•×œ
        return {
            "ok": False,
            "action": "error",
            "error": "×”×¡×™×× ×™×™×” ×›×‘×¨ ×§×™×™××ª"
        }

    except Exception as e:
        # ×©×’×™××” ×›×œ×œ×™×ª
        logger.error(f"Error toggling bookmark: {e}", exc_info=True)
        return {
            "ok": False,
            "action": "error",
            "error": "×©×’×™××” ×‘×©××™×¨×ª ×”×¡×™×× ×™×™×”"
        }</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-7-3">
          <div class="snippet-header">
            <h3 class="snippet-title">7.3 Validation ×¢× Error Messages</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×•×œ×™×“×¦×™×” ×¢× ×”×—×–×¨×ª tuple ×©×œ (success, data, error_message).</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from typing import Tuple

def validate_code_input(
    code: str,
    file_name: str,
    user_id: int
) -> Tuple[bool, str, str]:
    """
    ×‘×•×“×§ ×•×× ×§×” ×§×œ×˜ ×§×•×“.

    Returns:
        Tuple[bool, str, str]: (is_valid, cleaned_code, error_message)
    """

    # ×‘×“×™×§×•×ª ×‘×¡×™×¡×™×•×ª
    if not code or not code.strip():
        return False, "", "×”×§×•×“ ×¨×™×§"

    if len(code) > MAX_CODE_LENGTH:
        return False, "", f"×”×§×•×“ ××¨×•×š ××“×™ (××§×¡×™××•× {MAX_CODE_LENGTH} ×ª×•×•×™×)"

    # × ×™×§×•×™ ×§×•×“
    try:
        cleaned = normalize_code(code)
    except Exception as e:
        return False, "", f"×©×’×™××” ×‘× ×™×§×•×™ ×”×§×•×“: {str(e)}"

    # ×•×œ×™×“×¦×™×” × ×•×¡×¤×ª ×× ×™×©
    if code_processor:
        ok, cleaned, msg = code_processor.validate_code_input(code, file_name, user_id)
        if not ok:
            return False, cleaned, msg

    return True, cleaned, ""

# ×©×™××•×©:
# is_valid, cleaned_code, error_msg = validate_code_input(code, filename, user_id)
# if not is_valid:
#     await update.message.reply_text(f"âŒ {error_msg}")
#     return
# # ×”××©×š ×¢× cleaned_code</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-7-4">
          <div class="snippet-header">
            <h3 class="snippet-title">7.4 Batch Processing ×¢× Per-Item Errors</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×¢×™×‘×•×“ batch ×©×œ× × ×¢×¦×¨ ×¢×œ ×©×’×™××” ×‘×•×“×“×ª, ××œ× ×¢×•×§×‘ ××—×¨ ×”×¦×œ×—×•×ª/×›×™×©×œ×•× ×•×ª.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from concurrent.futures import ThreadPoolExecutor, as_completed
import time

async def process_files_batch(
    self,
    job_id: str,
    operation_func: Callable,
    **kwargs
) -> BatchJob:
    """×¢×™×‘×•×“ batch ×©×œ ×§×‘×¦×™× ×¢× ××¢×§×‘ ××—×¨ ×©×’×™××•×ª"""

    if job_id not in self.active_jobs:
        raise ValueError(f"×¢×‘×•×“×ª batch {job_id} ×œ× × ××¦××”")

    job = self.active_jobs[job_id]
    job.status = "running"
    job.start_time = time.time()

    try:
        with ThreadPoolExecutor(max_workers=self.max_workers) as executor:
            # ×™×¦×™×¨×ª futures ×œ×›×œ ×”×§×‘×¦×™×
            future_to_file = {
                executor.submit(operation_func, job.user_id, file_name, **kwargs): file_name
                for file_name in job.files
            }

            # ×¢×™×‘×•×“ ×ª×•×¦××•×ª ×¢× ××¢×§×‘ ××—×¨ ×©×’×™××•×ª
            for future in as_completed(future_to_file):
                file_name = future_to_file[future]

                try:
                    result = future.result()
                    success_flag = True

                    # ×‘×“×™×§×ª ×”×¦×œ×—×”
                    if isinstance(result, dict):
                        if 'is_valid' in result:
                            success_flag = bool(result.get('is_valid'))
                        elif 'error' in result:
                            success_flag = False

                    job.results[file_name] = {
                        'success': success_flag,
                        'result': result
                    }

                except Exception as e:
                    # ×©×’×™××” ×‘×§×•×‘×¥ ×‘×•×“×“ - ×œ× ×¢×•×¦×¨×™×
                    job.results[file_name] = {
                        'success': False,
                        'error': str(e)
                    }
                    logger.error(f"×©×’×™××” ×‘×¢×™×‘×•×“ {file_name}: {e}")

                job.progress += 1

        # ×¡×™×›×•×
        job.status = "completed"
        successful = sum(1 for r in job.results.values() if r['success'])
        failed = job.total - successful

        logger.info(f"×¢×‘×•×“×ª batch {job_id} ×”×•×©×œ××”: {successful} ×”×¦×œ×™×—×•, {failed} × ×›×©×œ×•")

    except Exception as e:
        job.status = "failed"
        job.error_message = str(e)
        logger.error(f"×¢×‘×•×“×ª batch {job_id} × ×›×©×œ×”: {e}")

    return job</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 8: ×‘×“×™×§×•×ª Pytest -->
      <div class="category" id="category-8">
        <div class="category-header">
          <i class="fas fa-vial"></i>
          <h2>×‘×“×™×§×•×ª Pytest</h2>
        </div>

        <div class="snippet" id="snippet-8-1">
          <div class="snippet-header">
            <h3 class="snippet-title">8.1 Fixture ×¢× Setup/Teardown</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> × ×™×§×•×™ ×¡×‘×™×‘×” ×œ×¤× ×™ ×•××—×¨×™ ×›×œ ×‘×“×™×§×”.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import pytest

@pytest.fixture(autouse=True)
def _clear_env(monkeypatch):
    """× ×™×§×•×™ ××©×ª× ×™ ×¡×‘×™×‘×” ×œ×¤× ×™ ×•××—×¨×™ ×›×œ ×‘×“×™×§×”"""
    # Setup
    monkeypatch.delenv('WEBAPP_URL', raising=False)

    yield  # ×”×‘×“×™×§×” ×¨×¦×” ×›××Ÿ

    # Teardown
    monkeypatch.delenv('WEBAPP_URL', raising=False)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-8-2">
          <div class="snippet-header">
            <h3 class="snippet-title">8.2 Test Parametrization</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×”×¨×¦×ª ××•×ª×” ×‘×“×™×§×” ×¢× ×›××” ×¡×˜×™× ×©×œ × ×ª×•× ×™×.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import pytest
import types

@pytest.mark.parametrize(
    "config_values, env_value, expected",
    [
        (
            {"WEBAPP_URL": "https://cfg.example", "PUBLIC_BASE_URL": None},
            None,
            "https://cfg.example/file/abc"
        ),
        (
            {"WEBAPP_URL": None, "PUBLIC_BASE_URL": "https://public.example"},
            None,
            "https://public.example/file/abc"
        ),
        (
            {"WEBAPP_URL": None, "PUBLIC_BASE_URL": None},
            "https://env.example",
            "https://env.example/file/abc"
        ),
    ],
)
def test_file_view_webapp_button_prefers_available_source(
    monkeypatch,
    config_values,
    env_value,
    expected
):
    """×‘×•×“×§ ×©×”×›×¤×ª×•×¨ ×‘×•×—×¨ ××ª ×”××§×•×¨ ×”× ×›×•×Ÿ"""
    import handlers.file_view as fv

    # ×”×’×“×¨×ª config mock
    stub_cfg = types.SimpleNamespace(**config_values)
    monkeypatch.setattr(fv, 'config', stub_cfg, raising=False)

    # ×”×’×“×¨×ª env ×× × ×“×¨×©
    if env_value:
        monkeypatch.setenv('WEBAPP_URL', env_value)

    # ×”×¨×¦×ª ×”×¤×•× ×§×¦×™×”
    row = fv._get_webapp_button_row('abc', None)

    # ×‘×“×™×§×”
    assert row[0].url == expected</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-8-3">
          <div class="snippet-header">
            <h3 class="snippet-title">8.3 Async Test</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×‘×“×™×§×ª ×¤×•× ×§×¦×™×•×ª async ×¢× aiohttp ××• asyncio.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import pytest
from aiohttp import web
import aiohttp

@pytest.mark.asyncio
async def test_health_endpoint_ok(monkeypatch):
    """×‘×•×“×§ ×©×”-health endpoint ×¢×•×‘×“"""
    from services.webserver import create_app

    app = create_app()

    # ×”×¨×¦×ª server ×–×× ×™
    runner = web.AppRunner(app)
    await runner.setup()
    site = web.TCPSite(runner, host="127.0.0.1", port=0)
    await site.start()

    try:
        # ×§×‘×œ×ª ×¤×•×¨×˜ ×“×™× ××™
        port = list(site._server.sockets)[0].getsockname()[1]

        # ×©×œ×™×—×ª request
        async with aiohttp.ClientSession() as session:
            async with session.get(f"http://127.0.0.1:{port}/health") as resp:
                assert resp.status == 200
                data = await resp.json()
                assert data.get("status") == "ok"

    finally:
        # × ×™×§×•×™
        await runner.cleanup()</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-8-4">
          <div class="snippet-header">
            <h3 class="snippet-title">8.4 Mocking ×¢× MagicMock</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×”×—×œ×¤×ª dependencies ×¢× mocks ×œ×‘×“×™×§×” ××‘×•×“×“×ª.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from unittest.mock import MagicMock, Mock
import unittest

class TestBookmarks(unittest.TestCase):
    def test_toggle_bookmark_add(self):
        """×‘×•×“×§ ×”×•×¡×¤×ª ×¡×™×× ×™×™×” ×—×“×©×”"""

        # ×”×’×“×¨×ª mocks
        mock_collection = MagicMock()
        mock_collection.find_one.return_value = None  # ×¡×™×× ×™×™×” ×œ× ×§×™×™××ª
        mock_collection.count_documents.return_value = 0
        mock_collection.insert_one.return_value = Mock(inserted_id="new_id")

        mock_db = MagicMock()
        mock_db.file_bookmarks = mock_collection

        manager = BookmarksManager(mock_db)

        # ×”×¨×¦×ª ×”×¤×•× ×§×¦×™×”
        result = manager.toggle_bookmark(
            user_id=123,
            file_id="file123",
            file_name="test.py",
            file_path="/test.py",
            line_number=42,
            line_text="def test():",
            note="Test bookmark"
        )

        # ×‘×“×™×§×•×ª
        self.assertTrue(result["ok"])
        self.assertEqual(result["action"], "added")
        self.assertIsNotNone(result["bookmark"])

        # ×•×™×“×•× ×©×”×¤×•× ×§×¦×™×” × ×§×¨××”
        mock_collection.insert_one.assert_called_once()</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-8-5">
          <div class="snippet-header">
            <h3 class="snippet-title">8.5 Mocking ×¢× @patch Decorator</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×”×—×œ×¤×ª ××•×“×•×œ×™× ×©×œ××™× ××• ×¤×•× ×§×¦×™×•×ª ×‘×¦×•×¨×” × ×§×™×™×”.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from unittest.mock import patch, MagicMock
import unittest

class TestBookmarks(unittest.TestCase):

    @patch('database.bookmarks_manager.logger')
    def test_error_handling(self, mock_logger):
        """×‘×•×“×§ ×©×”×œ×•×’×™× ×¢×•×‘×“×™× ×‘×©×’×™××•×ª"""

        # ×”×’×“×¨×ª mocks
        mock_db = MagicMock()
        mock_collection = MagicMock()
        mock_db.file_bookmarks = mock_collection

        # ×’×•×¨× ×œ×©×’×™××”
        mock_collection.find_one.return_value = None
        mock_collection.count_documents.return_value = 0
        mock_collection.insert_one.side_effect = Exception("DB Error")

        manager = BookmarksManager(mock_db)

        # ×”×¨×¦×ª ×”×¤×•× ×§×¦×™×”
        result = manager.toggle_bookmark(
            user_id=123,
            file_id="file123",
            file_name="test.py",
            file_path="/test.py",
            line_number=42
        )

        # ×‘×“×™×§×•×ª
        self.assertFalse(result["ok"])
        self.assertEqual(result["action"], "error")

        # ×•×™×“×•× ×©×”×©×’×™××” × ×¨×©××”
        mock_logger.error.assert_called()</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 9: ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ (Utility Functions) -->
      <div class="category" id="category-9">
        <div class="category-header">
          <i class="fas fa-tools"></i>
          <h2>×¤×•× ×§×¦×™×•×ª ×¢×–×¨</h2>
        </div>

        <div class="snippet" id="snippet-9-1">
          <div class="snippet-header">
            <h3 class="snippet-title">9.1 ×–××Ÿ ×™×—×¡×™ ×‘×¢×‘×¨×™×ª (TimeUtils.format_relative_time)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×¢×•×–×¨ ×œ×”×¦×™×’ ×œ××©×ª××©×™× ×›××” ×–××Ÿ ×¢×‘×¨ ×‘×©×¤×” ×˜×‘×¢×™×ª ×‘×¢×‘×¨×™×ª, ×¢× ×˜×™×¤×•×œ ×—×›× ×‘×™×—×™×“×•×ª ×–××Ÿ ×©×•× ×•×ª.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class TimeUtils:
    """×›×œ×™× ×œ×¢×‘×•×“×” ×¢× ×–××Ÿ ×•×ª××¨×™×›×™×"""
    
    @staticmethod
    def format_relative_time(dt: datetime) -> str:
        """×¤×•×¨××˜ ×–××Ÿ ×™×—×¡×™ (×œ×¤× ×™ 5 ×“×§×•×ª, ××ª××•×œ ×•×›×•')"""
        
        now = datetime.now(timezone.utc) if dt.tzinfo else datetime.now()
        diff = now - dt
        
        if diff.days > 365:
            years = diff.days // 365
            return f"×œ×¤× ×™ {years} ×©× {'×”' if years == 1 else '×™×'}"
        
        elif diff.days > 30:
            months = diff.days // 30
            return f"×œ×¤× ×™ {months} ×—×•×“{'×©' if months == 1 else '×©×™×'}"
        
        elif diff.days > 7:
            weeks = diff.days // 7
            return f"×œ×¤× ×™ {weeks} ×©×‘×•×¢{'×•×ª' if weeks > 1 else ''}"
        
        elif diff.days > 0:
            if diff.days == 1:
                return "××ª××•×œ"
            return f"×œ×¤× ×™ {diff.days} ×™××™×"
        
        elif diff.seconds > 3600:
            hours = diff.seconds // 3600
            return f"×œ×¤× ×™ {hours} ×©×¢{'×”' if hours == 1 else '×•×ª'}"
        
        elif diff.seconds > 60:
            minutes = diff.seconds // 60
            return f"×œ×¤× ×™ {minutes} ×“×§{'×”' if minutes == 1 else '×•×ª'}"
        
        else:
            return "×¢×›×©×™×•"</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-2">
          <div class="snippet-header">
            <h3 class="snippet-title">9.2 ××¡×§×™×™×¤ ×œ-Markdown ×‘×˜×œ×’×¨× (TextUtils.escape_markdown)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××ª××™× ×›×©×¦×¨×™×š ×œ×”×¦×™×’ ×˜×§×¡×˜ ×’×•×œ××™ ×‘×˜×œ×’×¨× ×‘×œ×™ ×œ×©×‘×•×¨ ×¢×™×¦×•×‘ Markdown V1/V2.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class TextUtils:
    """×›×œ×™× ×œ×¢×‘×•×“×” ×¢× ×˜×§×¡×˜"""
    
    @staticmethod
    def escape_markdown(text: str, version: int = 2) -> str:
        """×”×’× ×” ×¢×œ ×ª×•×•×™× ××™×•×—×“×™× ×‘-Markdown"""
        
        if version == 2:
            # Markdown V2: ×›×œ ×”×ª×•×•×™× ×©×™×© ×œ××¡×§×™×™×¤ ×œ×¤×™ Telegram MarkdownV2
            special_chars = set("_*[]()~`>#+-=|{}.!\\")
            return "".join(("\\" + ch) if ch in special_chars else ch for ch in text)
        else:
            # Markdown V1: × ×©×ª××© ×‘×§×‘×•×¦×” ××¦×•××¦××ª ××š ×’× × ×¡××Ÿ ×¡×•×’×¨×™×™× ×›×“×™ ×œ×”×™×× ×¢ ××ª×§×œ×•×ª ×›×œ×œ×™×•×ª
            special_chars = set("_*`[()\\")
            return "".join(("\\" + ch) if ch in special_chars else ch for ch in text)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-3">
          <div class="snippet-header">
            <h3 class="snippet-title">9.3 × ×™×§×•×™ ×©××•×ª ×§×‘×¦×™× (TextUtils.clean_filename)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××¡×™×¨ ×ª×•×•×™× ××¡×•×¨×™× ×•××§×¦×¨ ×©××•×ª ×œ×¤× ×™ ×©××™×¨×” ×‘×“×™×¡×§ ××• ×”×¢×œ××” ×œ×¢× ×Ÿ.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class TextUtils:
    """×›×œ×™× ×œ×¢×‘×•×“×” ×¢× ×˜×§×¡×˜"""
    
    @staticmethod
    def clean_filename(filename: str) -> str:
        """× ×™×§×•×™ ×©× ×§×•×‘×¥ ××ª×•×•×™× ×œ× ×—×•×§×™×™×"""
        
        # ×”×¡×¨×ª ×ª×•×•×™× ×œ× ×—×•×§×™×™×
        cleaned = re.sub(r'[<>:"/\\|?*]', '_', filename)
        
        # ×”×¡×¨×ª ×¨×•×•×—×™× ××™×•×ª×¨×™×
        cleaned = re.sub(r'\s+', '_', cleaned)
        
        # ×”×¡×¨×ª × ×§×•×“×•×ª ××™×•×ª×¨×•×ª
        cleaned = re.sub(r'\.+', '.', cleaned)
        
        # ×”×’×‘×œ×ª ××•×¨×š
        if len(cleaned) > 100:
            name, ext = os.path.splitext(cleaned)
            cleaned = name[:100-len(ext)] + ext
        
        return cleaned.strip('._')</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-4">
          <div class="snippet-header">
            <h3 class="snippet-title">9.4 ××¢× ×” ×‘×˜×•×— ×œ-CallbackQuery (TelegramUtils.safe_answer)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××‘×¦×¢ `query.answer` ×¢× ×”×—×¨×’×” ×©×œ ×©×’×™××•×ª ×™×“×•×¢×•×ª ×›×“×™ ×œ× ×œ×”×¤×™×œ ××ª ×”×–×¨×™××”.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class TelegramUtils:
    """×›×œ×™× ×œ×¢×‘×•×“×” ×¢× Telegram"""
    
    @staticmethod
    async def safe_answer(query, text: Optional[str] = None, show_alert: bool = False, cache_time: Optional[int] = None) -> None:
        """××¢× ×” ×‘×˜×•×— ×œ-CallbackQuery: ××ª×¢×œ× ××©×’×™××•×ª 'Query is too old'/'query_id_invalid'."""
        try:
            kwargs: Dict[str, Any] = {}
            if text is not None:
                kwargs["text"] = text
            if show_alert:
                kwargs["show_alert"] = True
            if cache_time is not None:
                kwargs["cache_time"] = int(cache_time)
            await query.answer(**kwargs)
        except Exception as e:
            msg = str(e).lower()
            if "query is too old" in msg or "query_id_invalid" in msg or "message to edit not found" in msg:
                return
            raise</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-5">
          <div class="snippet-header">
            <h3 class="snippet-title">9.5 ×¤×™×¦×•×œ ×”×•×“×¢×•×ª ××¨×•×›×•×ª (TelegramUtils.split_long_message)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×¢×•×–×¨ ×œ×¤×¦×œ ×ª×©×•×‘×” ×’×“×•×œ×” ×œ××§×˜×¢×™× ×‘×’×‘×•×œ 4096 ×ª×•×•×™× ×©×œ ×˜×œ×’×¨×.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class TelegramUtils:
    """×›×œ×™× ×œ×¢×‘×•×“×” ×¢× Telegram"""
    
    @staticmethod
    def split_long_message(text: str, max_length: int = 4096) -> List[str]:
        """×—×œ×•×§×ª ×”×•×“×¢×” ××¨×•×›×” ×œ×—×œ×§×™×"""
        
        if len(text) <= max_length:
            return [text]
        
        parts = []
        current_part = ""
        
        for line in text.split('\n'):
            if len(current_part) + len(line) + 1 <= max_length:
                current_part += line + '\n'
            else:
                if current_part:
                    parts.append(current_part.rstrip())
                current_part = line + '\n'
        
        if current_part:
            parts.append(current_part.rstrip())
        
        return parts</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-6">
          <div class="snippet-header">
            <h3 class="snippet-title">9.6 ×¢×¨×™×›×ª ×”×•×“×¢×” ×‘×˜×•×—×” (TelegramUtils.safe_edit_message_text)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××˜×¤×œ ×’× ×‘××™××•×©×™× ×¡×™× ×›×¨×•× ×™×™× ×•×’× ××¡×™× ×›×¨×•× ×™×™× ×•××“×›× ××ª ×©×’×™××ª "message is not modified".</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class TelegramUtils:
    """×›×œ×™× ×œ×¢×‘×•×“×” ×¢× Telegram"""
    
    @staticmethod
    async def safe_edit_message_text(query, text: str, reply_markup=None, parse_mode: Optional[str] = None) -> None:
        """×¢×¨×™×›×ª ×˜×§×¡×˜ ×”×•×“×¢×” ×‘×‘×˜×™×—×•×ª: ××ª×¢×œ× ××©×’×™××ª 'Message is not modified'.

        ×ª×•××š ×’× ×‘××™××•×©×™ ×‘×“×™×§×•×ª ×©×‘×”× `edit_message_text` ×”×™× ×¤×•× ×§×¦×™×” ×¡×™× ×›×¨×•× ×™×ª
        ×©××—×–×™×¨×” `None` (×œ× awaitable), ×•×’× ×‘××™××•×©×™× ××¡×™× ×›×¨×•× ×™×™× ×¨×’×™×œ×™×.
        """
        try:
            edit_func = getattr(query, "edit_message_text", None)
            if not callable(edit_func):
                return

            kwargs = {"text": text, "reply_markup": reply_markup}
            if parse_mode is not None:
                kwargs["parse_mode"] = parse_mode

            result = edit_func(**kwargs)

            # ×× ×—×–×¨ coroutine â€“ ×¦×¨×™×š ×œ×”××ª×™×Ÿ; ××—×¨×ª ×–×• ×¤×•× ×§×¦×™×” ×¡×™× ×›×¨×•× ×™×ª ×•××™×Ÿ ××” ×œ×”××ª×™×Ÿ
            if asyncio.iscoroutine(result):
                await result
        except Exception as e:
            msg = str(e).lower()
            # ×”×ª×¢×œ××•×ª ×¨×§ ×‘××§×¨×” "not modified" (×¢××™×“ ×œ×©×™× ×•×™×™× ×§×œ×™× ×‘×˜×§×¡×˜)
            if "not modified" in msg or "message is not modified" in msg:
                return
            raise</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-7">
          <div class="snippet-header">
            <h3 class="snippet-title">9.7 ×× ×™×¢×ª ×œ×—×™×¦×” ×›×¤×•×œ×” (CallbackQueryGuard.should_block_async)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××•× ×¢ ×”×¤×¢×œ×” ×›×¤×•×œ×” ×©×œ ××•×ª×• ×›×¤×ª×•×¨ ×‘×××¦×¢×•×ª × ×¢×™×œ×•×ª ×¤×¨-××©×ª××© ×•×—×œ×•×Ÿ ×–××Ÿ ×§×¦×¨.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class CallbackQueryGuard:
    """Guard ×’×•×¨×£ ×œ×œ×—×™×¦×•×ª ×›×¤×•×œ×•×ª ×¢×œ ×›×¤×ª×•×¨×™ CallbackQuery.
    
    ××‘×•×¡×¡ ×¢×œ ×˜×‘×™×¢×ª ××¦×‘×¢ ×©×œ ×”××©×ª××©/×”×•×“×¢×”/×”× ×ª×•×Ÿ (callback_data) ×›×“×™ ×œ×—×¡×•×
    ××ª ××•×ª×” ×¤×¢×•×œ×” ×‘×—×œ×•×Ÿ ×–××Ÿ ×§×¦×¨, ×‘×œ×™ ×œ×—×¡×•× ×¤×¢×•×œ×•×ª ×©×•× ×•×ª.
    """

    DEFAULT_WINDOW_SECONDS: float = 1.2
    _user_locks: Dict[int, asyncio.Lock] = {}

    @staticmethod
    async def should_block_async(update: Update, context: ContextTypes.DEFAULT_TYPE, window_seconds: Optional[float] = None) -> bool:
        """×‘×•×“×§ ×‘×¦×•×¨×” ××˜×•××™×ª (×¢× × ×¢×™×œ×”) ×× ×œ×—×¡×•× ×œ×—×™×¦×” ×›×¤×•×œ×” ×©×œ ××•×ª×• ××©×ª××©.

        ×—×¡×™××” ××‘×•×¡×¡×ª ×—×œ×•×Ÿ ×–××Ÿ ×¤×¨-××©×ª××©, ×œ×œ× ×ª×œ×•×ª ×‘-message_id/data, ×›×“×™ ×œ×× ×•×¢ ××¨×•×¥.
        """
        try:
            try:
                win = float(window_seconds if window_seconds is not None else CallbackQueryGuard.DEFAULT_WINDOW_SECONDS)
            except Exception:
                win = CallbackQueryGuard.DEFAULT_WINDOW_SECONDS

            user_id = int(getattr(getattr(update, 'effective_user', None), 'id', 0) or 0)

            # ×× ××™×Ÿ ×–×™×”×•×™ ××©×ª××©, fallback ×œ×”×ª× ×”×’×•×ª ×”×™×©× ×” ×œ×œ× ×—×¡×™××”
            if user_id <= 0:
                return CallbackQueryGuard.should_block(update, context, window_seconds=win)

            # ×§×‘×œ/×¦×•×¨ × ×¢×™×œ×” ×œ××©×ª××©
            lock = CallbackQueryGuard._user_locks.get(user_id)
            if lock is None:
                lock = asyncio.Lock()
                CallbackQueryGuard._user_locks[user_id] = lock

            async with lock:
                now_ts = time.time()
                # ×”×©×ª××© ×‘××•×ª×• ×©×“×” ×–××Ÿ ×’×œ×•×‘×œ×™ ×©×”×™×” ×‘×©×™××•×©, ××š ×œ×œ× ×˜×‘×™×¢×ª ××¦×‘×¢
                busy_until = float(context.user_data.get("_cb_guard_until", 0.0) or 0.0) if hasattr(context, "user_data") else 0.0
                if now_ts < busy_until:
                    return True
                # ×¡×× ×• ×—×œ×•×Ÿ ×–××Ÿ ×—×¡×™××” ×—×“×©
                if hasattr(context, "user_data"):
                    context.user_data["_cb_guard_until"] = now_ts + win
                return False
        except Exception:
            # ××œ ×ª×—×¡×•× ×× guard × ×›×©×œ
            return False</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-8">
          <div class="snippet-header">
            <h3 class="snippet-title">9.8 ×¢×™×‘×•×“ ×¤×¨×™×˜×™× ×‘×§×‘×•×¦×•×ª (AsyncUtils.batch_process)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×××¤×©×¨ ×œ×”×¨×™×¥ ×¤×¢×•×œ×•×ª ××¡×™× ×›×¨×•× ×™×•×ª ×‘×§×‘×•×¦×•×ª ×§×˜× ×•×ª ×¢× ×”×©×”×™×” ×‘×™×Ÿ ×’×•×©×™×.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class AsyncUtils:
    """×›×œ×™× ×œ×¢×‘×•×“×” ××¡×™× ×›×¨×•× ×™×ª"""
    
    @staticmethod
    async def batch_process(items: List[Any], process_func: Callable, 
                           batch_size: int = 10, delay: float = 0.1) -> List[Any]:
        """×¢×™×‘×•×“ ×¤×¨×™×˜×™× ×‘×§×‘×•×¦×•×ª"""
        
        results = []
        
        for i in range(0, len(items), batch_size):
            batch = items[i:i + batch_size]
            
            # ×¢×™×‘×•×“ ×”×§×‘×•×¦×”
            batch_tasks = [process_func(item) for item in batch]
            batch_results = await asyncio.gather(*batch_tasks, return_exceptions=True)
            
            results.extend(batch_results)
            
            # ×”××ª× ×” ×‘×™×Ÿ ×§×‘×•×¦×•×ª
            if delay > 0 and i + batch_size < len(items):
                await asyncio.sleep(delay)
        
        return results</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-9">
          <div class="snippet-header">
            <h3 class="snippet-title">9.9 ××“×™×“×ª ×–××Ÿ ×¢× context manager (PerformanceUtils.measure_time)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> × ×•×ª×Ÿ ×“×¨×š ×§×œ×” ×œ××“×•×“ ××©×š ×¤×¢×•×œ×” ×•×œ×¨×©×•× ××•×ª×• ×œ×œ×•×’.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class PerformanceUtils:
    """×›×œ×™× ×œ××“×™×“×ª ×‘×™×¦×•×¢×™×"""
    
    @staticmethod
    @contextmanager
    def measure_time(operation_name: str):
        """××“×™×“×ª ×–××Ÿ ×¢× context manager"""
        
        start_time = time.time()
        try:
            yield
        finally:
            execution_time = time.time() - start_time
            logger.info(f"{operation_name}: {execution_time:.3f}s")</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-10">
          <div class="snippet-header">
            <h3 class="snippet-title">9.10 ×‘×“×™×§×ª ×§×•×“ ××¡×•×›×Ÿ (ValidationUtils.is_safe_code)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××¡×¤×§ ×‘×“×™×§×ª ×‘×˜×™×—×•×ª ×‘×¡×™×¡×™×ª ×œ×§×•×“ ×œ×¤×™ ×©×¤×” ×•××—×–×™×¨ ×”×ª×¨××•×ª ××¤×©×¨×™×•×ª.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class ValidationUtils:
    """×›×œ×™× ×œ×•×•×œ×™×“×¦×™×”"""
    
    @staticmethod
    def is_safe_code(code: str, programming_language: str) -> Tuple[bool, List[str]]:
        """×‘×“×™×§×” ×‘×¡×™×¡×™×ª ×©×œ ×‘×˜×™×—×•×ª ×§×•×“"""
        
        warnings = []
        
        # ×“×¤×•×¡×™× ××¡×•×›× ×™×
        dangerous_patterns = {
            'python': [
                r'exec\s*\(',
                r'eval\s*\(',
                r'__import__\s*\(',
                r'open\s*\([^)]*["\']w',  # ×›×ª×™×‘×” ×œ×§×•×‘×¥
                r'subprocess\.',
                r'os\.system\s*\(',
                r'os\.popen\s*\(',
            ],
            'javascript': [
                r'eval\s*\(',
                r'Function\s*\(',
                r'document\.write\s*\(',
                r'innerHTML\s*=',
                r'outerHTML\s*=',
            ],
            'bash': [
                r'rm\s+-rf',
                r'rm\s+/',
                r'dd\s+if=',
                r'mkfs\.',
                r'fdisk\s+',
            ]
        }
        
        if programming_language in dangerous_patterns:
            for pattern in dangerous_patterns[programming_language]:
                if re.search(pattern, code, re.IGNORECASE):
                    warnings.append(f"×“×¤×•×¡ ××¡×•×›×Ÿ ××¤×©×¨×™: {pattern}")
        
        # ×‘×“×™×§×•×ª ×›×œ×œ×™×•×ª
        if 'password' in code.lower() or 'secret' in code.lower():
            warnings.append("×”×§×•×“ ××›×™×œ ××™×œ×•×ª ×¡×™×¡××” ××• ×¡×•×“")
        
        if re.search(r'https?://\S+', code):
            warnings.append("×”×§×•×“ ××›×™×œ URL×™×")
        
        is_safe = len(warnings) == 0
        return is_safe, warnings</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-11">
          <div class="snippet-header">
            <h3 class="snippet-title">9.11 ×™×¦×™×¨×ª ×§×•×‘×¥ ×–×× ×™ (FileUtils.create_temp_file)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×™×•×¦×¨ ×§×•×‘×¥ ×–×× ×™ ×¢× ×ª×•×›×Ÿ ××—×¨×•×–×ª/×‘×™×™×˜×™× ×•××—×–×™×¨ ××ª ×”× ×ª×™×‘ ×œ×©×™××•×© ××™×™×“×™.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class FileUtils:
    """×›×œ×™× ×œ×¢×‘×•×“×” ×¢× ×§×‘×¦×™×"""
    
    @staticmethod
    async def create_temp_file(content: Union[str, bytes], 
                              suffix: str = "") -> str:
        """×™×¦×™×¨×ª ×§×•×‘×¥ ×–×× ×™"""
        
        with tempfile.NamedTemporaryFile(mode='wb', suffix=suffix, delete=False) as temp_file:
            if isinstance(content, str):
                content = content.encode('utf-8')
            
            temp_file.write(content)
            return temp_file.name</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-12">
          <div class="snippet-header">
            <h3 class="snippet-title">9.12 ×˜×¢×™× ×ª ×§×•×‘×¥ JSON ×¢× ×‘×¨×™×¨×ª ××—×“×œ (ConfigUtils.load_json_config)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> × ×•×— ×œ×§×¨×™××ª ×§×‘×¦×™ ×”×’×“×¨×•×ª ×¢× ×˜×™×¤×•×œ ×‘×©×’×™××•×ª ×•×œ×•×’ ××–×”×¨×” ×× ×”×§×•×‘×¥ ×—×¡×¨.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class ConfigUtils:
    """×›×œ×™× ×œ×§×•× ×¤×™×’×•×¨×¦×™×”"""
    
    @staticmethod
    def load_json_config(file_path: str, default: Optional[Dict[str, Any]] = None) -> Dict[str, Any]:
        """×˜×¢×™× ×ª ×§×•× ×¤×™×’×•×¨×¦×™×” ××§×•×‘×¥ JSON"""
        
        if default is None:
            default = {}
        
        try:
            if os.path.exists(file_path):
                with open(file_path, 'r', encoding='utf-8') as f:
                    return json.load(f)
            else:
                logger.warning(f"×§×•×‘×¥ ×§×•× ×¤×™×’×•×¨×¦×™×” ×œ× × ××¦×: {file_path}")
                return default
        
        except Exception as e:
            logger.error(f"×©×’×™××” ×‘×˜×¢×™× ×ª ×§×•× ×¤×™×’×•×¨×¦×™×”: {e}")
            return default</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-13">
          <div class="snippet-header">
            <h3 class="snippet-title">9.13 ×§××© ×–×™×›×¨×•×Ÿ ×¢× TTL (CacheUtils.set/get)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×××¤×©×¨ ×œ×©××•×¨ ×¢×¨×›×™× ×‘×–×™×›×¨×•×Ÿ ×œ×–××Ÿ ×§×¦×•×‘ ×•×œ×”×¡×™×¨× ××•×˜×•××˜×™×ª ×›×©×”×ª×•×§×£ ×¤×’.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class CacheUtils:
    """×›×œ×™× ×œ×§××© ×–×× ×™"""
    
    _cache: Dict[str, Any] = {}
    _cache_times: Dict[str, float] = {}
    
    @classmethod
    def set(cls, key: str, value: Any, ttl: int = 300):
        """×©××™×¨×” ×‘×§××© ×¢× TTL (×©× ×™×•×ª)"""
        cls._cache[key] = value
        cls._cache_times[key] = time.time() + ttl
    
    @classmethod
    def get(cls, key: str, default: Any = None) -> Any:
        """×§×‘×œ×” ××”×§××©"""
        
        if key not in cls._cache:
            return default
        
        # ×‘×“×™×§×ª ×ª×¤×•×’×”
        if time.time() > cls._cache_times.get(key, 0):
            cls.delete(key)
            return default
        
        return cls._cache[key]

    @classmethod
    def delete(cls, key: str):
        """××—×™×§×” ××”×§××©"""
        cls._cache.pop(key, None)
        cls._cache_times.pop(key, None)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-14">
          <div class="snippet-header">
            <h3 class="snippet-title">9.14 ××¡× ×Ÿ ×œ×•×’×™× ×œ×¨×’×™×©×•×™×•×ª (SensitiveDataFilter)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××˜×©×˜×© ×˜×•×§× ×™× ×—×©×•×¤×™× ×‘×œ×•×’×™× ×œ×¤× ×™ ×©×”× × ×›×ª×‘×™× ×”×—×•×¦×”.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class SensitiveDataFilter(logging.Filter):
    """××¡× ×Ÿ ×©××˜×©×˜×© ×˜×•×§× ×™× ×•× ×ª×•× ×™× ×¨×’×™×©×™× ×‘×œ×•×’×™×."""
    def filter(self, record: logging.LogRecord) -> bool:
        try:
            msg = str(record.getMessage())
            # ×–×™×”×•×™ ×‘×¡×™×¡×™ ×©×œ ×˜×•×§× ×™×: ghp_..., github_pat_..., Bearer ...
            patterns = [
                (r"ghp_[A-Za-z0-9]{20,}", "ghp_***REDACTED***"),
                (r"github_pat_[A-Za-z0-9_]{20,}", "github_pat_***REDACTED***"),
                (r"Bearer\s+[A-Za-z0-9\-_.=:/+]{10,}", "Bearer ***REDACTED***"),
            ]
            redacted = msg
            import re as _re
            for pat, repl in patterns:
                redacted = _re.sub(pat, repl, redacted)
            # ×¢×“×›×Ÿ ×¨×§ ××ª message ×”×¤×•×¨××˜×™
            record.msg = redacted
            # ×—×©×•×‘: × ×§×” ××¨×’×•×× ×˜×™× ×›×“×™ ×œ×× ×•×¢ × ×™×¡×™×•×Ÿ ×¤×•×¨××˜ ×—×•×–×¨ (%s) ×©×™×•×‘×™×œ ×œ-TypeError
            record.args = ()
        except Exception:
            pass
        return True</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-15">
          <div class="snippet-header">
            <h3 class="snippet-title">9.15 × ×™×¨××•×œ ××¨×’×•×× ×˜×™× ×œ×¤×§×•×“×•×ª (_coerce_command_args)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××ª××™× ×›×©×¦×¨×™×š ×œ×§×‘×œ ××¨×’×•×× ×˜×™× ××¤×§×•×“×ª ×˜×œ×’×¨× ×•×œ×ª××•×š ×‘××¡×¤×¨ ×˜×™×¤×•×¡×™× ×©×•× ×™×.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">def _coerce_command_args(raw_args) -> List[str]:
    """×”××¨×ª args ××¡×•×’×™× ×©×•× ×™× ×œ×¨×©×™××ª ××—×¨×•×–×•×ª × ×§×™×™×”."""
    normalized: List[str] = []
    if raw_args is None:
        return normalized
    try:
        if isinstance(raw_args, (list, tuple, set)):
            iterable = list(raw_args)
        elif isinstance(raw_args, str):
            iterable = [raw_args]
        else:
            try:
                iterable = list(raw_args)
            except TypeError:
                iterable = [raw_args]
    except Exception:
        iterable = []
    for arg in iterable:
        if arg is None:
            continue
        if isinstance(arg, bytes):
            try:
                normalized.append(arg.decode("utf-8"))
                continue
            except Exception:
                normalized.append(arg.decode("utf-8", "ignore"))
                continue
        normalized.append(str(arg))
    return normalized</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-16">
          <div class="snippet-header">
            <h3 class="snippet-title">9.16 ×§×™×¦×•×¨ ×˜×§×¡×˜ ×‘×××¦×¢ (_truncate_middle)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> × ×•×— ×œ×”×¦×’×ª ×©××•×ª ×§×‘×¦×™× ××• ××–×”×™× ××¨×•×›×™× ×ª×•×š ×©××™×¨×” ×¢×œ ×”×”×ª×—×œ×” ×•×”×¡×•×£.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">def _truncate_middle(text: str, max_len: int) -> str:
    """××§×¦×¨ ××—×¨×•×–×ª ×‘×××¦×¢ ×¢× ××œ×™×¤×¡×™×¡ ×× ×—×•×¨×’×ª ×××•×¨×š × ×ª×•×Ÿ."""
    if max_len <= 0:
        return ''
    if len(text) <= max_len:
        return text
    if max_len <= 1:
        return text[:max_len]
    keep = max_len - 1
    front = keep // 2
    back = keep - front
    return text[:front] + 'â€¦' + text[-back:]</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-17">
          <div class="snippet-header">
            <h3 class="snippet-title">9.17 ××¢×§×‘ ×‘×™×¦×•×¢×™× ×¢× Prometheus (track_performance)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> context manager ×©××–×™×Ÿ Histogram ×©×œ Prometheus ×‘×œ×™ ×œ×”×¤×™×œ ××ª ×”×©×™×¨×•×ª ×‘××§×¨×” ×©×œ ×©×’×™××ª ×œ×™×™×‘×œ×™×.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">@contextmanager
def track_performance(operation: str, labels: Optional[Dict[str, str]] = None):
    start = time.time()
    try:
        yield
    finally:
        if operation_latency_seconds is not None:
            try:
                # ×‘×—×¨ ×¨×§ ×œ×™×™×‘×œ×™× ×©××•×’×“×¨×™× ×‘××˜×¨×™×§×” ×•××œ ×ª××¤×©×¨ ×“×¨×™×¡×” ×©×œ 'operation'
                allowed = set(getattr(operation_latency_seconds, "_labelnames", []) or [])
                target = {"operation": operation}
                if labels:
                    for k, v in labels.items():
                        if k in allowed and k != "operation":
                            target[k] = v
                # ×¡×¤×§ ×¢×¨×›×™ ×‘×¨×™×¨×ª ××—×“×œ ×œ×›×œ ×œ×™×™×‘×œ ×—×¡×¨ (×œ××©×œ repo="") ×›×“×™ ×œ×©××•×¨ ×ª××™××•×ª ×œ××—×•×¨
                for name in allowed:
                    if name not in target:
                        if name == "operation":
                            # ×›×‘×¨ ×¡×•×¤×§ ×œ×¢×™×œ
                            continue
                        # ×‘×¨×™×¨×ª ××—×“×œ: ××™×ª×¨ ×¡×× ×˜×™×§×”, ××•× ×¢ ValueError ×¢×œ ×—×•×¡×¨ ×‘×œ×™×™×‘×œ
                        target[name] = ""
                operation_latency_seconds.labels(**target).observe(time.time() - start)
            except Exception:
                # avoid breaking app on label mistakes
                pass</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-18">
          <div class="snippet-header">
            <h3 class="snippet-title">9.18 ×”×¦×¢×ª ×”×©×œ××•×ª ×œ×—×™×¤×•×© ×’×œ×•×‘×œ×™ (fetchSuggestions)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×©×•×œ×— ×‘×§×©×” ××¡×™× ×›×¨×•× ×™×ª ×‘×¦×“ ×”×œ×§×•×— ×•×× ×ª×‘ ×”×ª×—×‘×¨×•×ª ×××•×œ×¦×ª ×‘××§×¨×” ×©×œ 401.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript"><code class="language-javascript">async function fetchSuggestions(q){
  try{
    const res = await fetch('/api/search/suggestions?q=' + encodeURIComponent(q), {
      headers: { 'Accept': 'application/json' },
      credentials: 'same-origin'
    });

    if (res.status === 401 || res.redirected) {
      window.location.href = '/login?next=' + encodeURIComponent(location.pathname + location.search + location.hash);
      return;
    }

    const contentType = res.headers.get('content-type') || '';
    if (!contentType.includes('application/json')) { hideSuggestions(); return; }

    const data = await res.json();
    if (data && data.suggestions && data.suggestions.length){
      showSuggestions(data.suggestions);
    } else hideSuggestions();
  } catch (e){ hideSuggestions(); }
}</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-19">
          <div class="snippet-header">
            <h3 class="snippet-title">9.19 ×”×“×’×©×ª ×˜×•×•×—×™× ×‘×ª×•×¦××•×ª ×—×™×¤×•×© (highlightSnippet)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××§×‘×œ ×˜×§×¡×˜ ×’×•×œ××™ ×•××“×’×™×© ×˜×•×•×—×™× ×¨×œ×•×•× ×˜×™×™× ×¢× `&lt;mark&gt;` ××‘×œ×™ ×œ×©×‘×•×¨ HTML.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript"><code class="language-javascript">function highlightSnippet(text, ranges){
  text = String(text || '');
  if (!ranges || !ranges.length) return escapeHtml(text);
  const items = ranges.slice().sort((a,b)=> (a[0]-b[0]));
  let out = '', last = 0;
  for (const [s,e] of items){
    if (s < last) continue;
    out += escapeHtml(text.slice(last, s));
    out += '<mark class="bg-warning">' + escapeHtml(text.slice(s, e)) + '</mark>';
    last = e;
  }
  out += escapeHtml(text.slice(last));
  return out;
}</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 10: Background Jobs ×•-RQ -->
      <div class="category" id="category-10">
        <div class="category-header">
          <i class="fas fa-tasks"></i>
          <h2>Background Jobs ×•-RQ</h2>
        </div>

        <div class="snippet" id="snippet-10-1">
          <div class="snippet-header">
            <h3 class="snippet-title">10.1 RQ Job Definition ×¢× Retry ×•-Timeout</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×™×¦×™×¨×ª background job ×¢× RQ ×›×•×œ×œ retry ××•×˜×•××˜×™ ×•×˜×™×™××××•×˜</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from rq import Retry
from rq.decorators import job
from app.core.cache import redis_queue_sync

@job("default", timeout="10m", retry=Retry(max=3, interval=60), connection=redis_queue_sync)
def process_new_report(report_id: str):
    """
    Process a newly submitted report.
    
    Args:
        report_id: UUID string of the report to process
    """
    logger.info("Processing report", report_id=report_id)
    
    try:
        # Run async code from sync job
        return asyncio.run(_process_new_report_async(report_id))
    except Exception as e:
        logger.error("Failed to process report", report_id=report_id, error=str(e))
        raise  # Re-raise for RQ retry mechanism</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-10-2">
          <div class="snippet-header">
            <h3 class="snippet-title">10.2 Enqueue or Run Inline Pattern</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×ª××™×›×” ×‘-workers ×•×’× ×‘××¦×‘ ×œ×œ× workers (development)</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">def enqueue_or_run(func, *args, **kwargs):
    """
    Enqueue an RQ job when workers enabled, otherwise run inline.
    
    Example:
        enqueue_or_run(process_new_report, report_id=str(report.id))
    """
    if settings.ENABLE_WORKERS:
        # Production: Queue to RQ worker
        return func.delay(*args, **kwargs)
    else:
        # Development: Run inline
        if asyncio.iscoroutinefunction(func):
            return asyncio.create_task(func(*args, **kwargs))
        else:
            return func(*args, **kwargs)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-10-3">
          <div class="snippet-header">
            <h3 class="snippet-title">10.3 RQ Scheduler â€“ Recurring Jobs</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×ª×–××•×Ÿ ××©×™××•×ª ×—×•×–×¨×•×ª (cleanup, stats, sync)</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from rq_scheduler import Scheduler
from app.core.cache import redis_queue_sync

def schedule_recurring_jobs():
    """Schedule recurring background jobs."""
    scheduler = Scheduler(connection=redis_queue_sync)
    
    # Daily cleanup at 2 AM
    scheduler.cron(
        cron_string="0 2 * * *",  # Every day at 2 AM
        func=cleanup_old_data,
        timeout="30m",
        use_local_timezone=False
    )
    
    # Update stats every 6 hours
    scheduler.cron(
        cron_string="0 */6 * * *",
        func=update_organization_stats,
        timeout="10m",
        use_local_timezone=False
    )
    
    logger.info("Recurring jobs scheduled")</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 11: Telegram Bot Patterns -->
      <div class="category" id="category-11">
        <div class="category-header">
          <i class="fas fa-robot"></i>
          <h2>×ª×‘× ×™×•×ª ×‘×•×˜ ×˜×œ×’×¨×</h2>
        </div>

        <div class="snippet" id="snippet-11-1">
          <div class="snippet-header">
            <h3 class="snippet-title">11.1 Maintenance Mode Middleware</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×××¤×©×¨ ×œ×”×›× ×™×¡ ××ª ×”×‘×•×˜ ×œ××¦×‘ ×ª×—×–×•×§×” ×ª×•×š ×©××™×¨×” ×¢×œ ×’×™×©×” ×œ××“××™× ×™×.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript"><code class="language-javascript">const isMaintenanceMode = () => {
  return process.env.MAINTENANCE_MODE === 'true';
};

const isAdmin = (userId) => {
  const admins = (process.env.ADMIN_USER_IDS || '')
    .split(',')
    .map(s => s.trim())
    .filter(Boolean);
  return admins.includes(String(userId));
};

const maintenanceMiddleware = async (msg, next) => {
  if (!isMaintenanceMode() || isAdmin(msg.from.id)) {
    return next();
  }

  await bot.sendMessage(msg.chat.id,
    'ğŸ”§ *×”×‘×•×˜ ×‘××¦×‘ ×ª×—×–×•×§×”*\n\n' +
    '×× ×—× ×• ×¢×•×©×™× ×©×“×¨×•×’ ××”×™×¨ ×œ×‘×•×˜ ğŸš€\n\n' +
    '×”×›×œ ×™×—×–×•×¨ ×œ×¢×‘×•×“ ×ª×•×š ×›××” ×“×§×•×ª.\n\n' +
    '×ª×•×“×” ×¢×œ ×”×¡×‘×œ× ×•×ª! ğŸ˜Š',
    { parse_mode: 'Markdown' }
  );
  return false; // Block further processing
};</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-11-2">
          <div class="snippet-header">
            <h3 class="snippet-title">11.2 Callback Query Router</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> × ×™×ª×•×‘ ××•×˜×•××˜×™ ×©×œ callback queries ×œ×¤×™ prefix, ×—×•×¡×š if-else ××¨×•×›×™× ×•×××¨×’×Ÿ ××ª ×”×§×•×“.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript"><code class="language-javascript">async handleCallbackQuery(query) {
  const chatId = query.message.chat.id;
  const userId = query.from.id;
  const data = query.data;
  const messageId = query.message.message_id;

  // Answer callback to remove loading state
  await this.bot.answerCallbackQuery(query.id);

  // Route based on callback data prefix
  if (data.startsWith('pace_')) {
    await this.handlePaceSelection(chatId, userId, data, messageId);
  } else if (data.startsWith('answer_')) {
    await this.handleQuizAnswer(chatId, userId, data, messageId);
  } else if (data.startsWith('theme_')) {
    await this.handleThemeSelection(chatId, userId, data, messageId);
  } else if (data.startsWith('cheat_')) {
    await this.handleCheatsheetTopic(chatId, userId, data, messageId);
  } else if (data.startsWith('template_')) {
    await this.handleTemplateSelection(chatId, userId, data);
  }
  // ... more routes
}</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-11-3">
          <div class="snippet-header">
            <h3 class="snippet-title">11.3 Safe Send with Fallback</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×©×œ×™×—×ª ×”×•×“×¢×•×ª Markdown ×¢× fallback ××•×˜×•××˜×™ ×œ×˜×§×¡×˜ ×¨×’×™×œ ×× ×™×© ×©×’×™××ª parsing.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript"><code class="language-javascript">async safeSendMarkdown(chatId, text, options = {}) {
  try {
    return await this.bot.sendMessage(chatId, text, { 
      parse_mode: 'Markdown', 
      ...options 
    });
  } catch (err) {
    const desc = String(err?.response?.body?.description || err?.message || '').toLowerCase();
    if (desc.includes("can't parse entities") || desc.includes('parse') || desc.includes('entity')) {
      // Retry without parse mode
      return await this.bot.sendMessage(chatId, text, { ...options });
    }
    throw err;
  }
}</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-11-4">
          <div class="snippet-header">
            <h3 class="snippet-title">11.4 Message Chunking (Split Long Messages)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×˜×œ×’×¨× ××’×‘×™×œ ×”×•×“×¢×•×ª ×œ-4096 ×ª×•×•×™×. ×ª×‘× ×™×ª ×–×• ××—×œ×§×ª ×”×•×“×¢×•×ª ××¨×•×›×•×ª ×œ×—×ª×™×›×•×ª ×ª×•×š ×©××™×¨×” ×¢×œ ×§×¨×™××•×ª.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript"><code class="language-javascript">async sendLongMessage(chatId, text, options = {}) {
  const maxLength = 4000; // Leave room for formatting
  const chunks = [];
  let currentChunk = '';
  const lines = text.split('\n');

  for (const line of lines) {
    if ((currentChunk + line + '\n').length > maxLength) {
      chunks.push(currentChunk);
      currentChunk = line + '\n';
    } else {
      currentChunk += line + '\n';
    }
  }
  if (currentChunk) chunks.push(currentChunk);

  // Send each chunk
  for (let i = 0; i < chunks.length; i++) {
    await this.bot.sendMessage(chatId,
      chunks.length > 1 ? `*×—×œ×§ ${i + 1}/${chunks.length}*\n\n${chunks[i]}` : chunks[i],
      { parse_mode: 'Markdown', ...options }
    );
    await this.sleep(500); // Small delay between messages
  }
}</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-11-5">
          <div class="snippet-header">
            <h3 class="snippet-title">11.5 User Mode Management (State Machine)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> × ×™×”×•×œ ××¦×‘×™ ××©×ª××© (sandbox, training, submitting_template) ×¢× × ×ª×•× ×™× JSON. ×××¤×©×¨ ×–×¨×™××•×ª ××•×¨×›×‘×•×ª.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript"><code class="language-javascript">// Database schema:
// CREATE TABLE user_modes (
//   user_id INTEGER PRIMARY KEY,
//   current_mode TEXT DEFAULT 'normal',
//   mode_data TEXT,  -- JSON string
//   updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
// )

getUserMode(userId) {
  const stmt = this.db.prepare('SELECT * FROM user_modes WHERE user_id = ?');
  let mode = stmt.get(userId);
  
  if (!mode) {
    const insertStmt = this.db.prepare(`
      INSERT INTO user_modes (user_id, current_mode)
      VALUES (?, 'normal')
    `);
    insertStmt.run(userId);
    mode = { user_id: userId, current_mode: 'normal', mode_data: null };
  }
  
  return mode;
}

setUserMode(userId, mode, modeData = null) {
  const stmt = this.db.prepare(`
    INSERT OR REPLACE INTO user_modes (user_id, current_mode, mode_data, updated_at)
    VALUES (?, ?, ?, CURRENT_TIMESTAMP)
  `);
  stmt.run(userId, mode, modeData ? JSON.stringify(modeData) : null);
}

clearUserMode(userId) {
  this.setUserMode(userId, 'normal', null);
}

// ×©×™××•×©:
const mode = this.db.getUserMode(userId);
if (mode.current_mode === 'sandbox') {
  await this.handleSandboxInput(chatId, userId, text);
} else if (mode.current_mode === 'training') {
  const modeData = JSON.parse(mode.mode_data);
  await this.handleTrainingAnswer(chatId, userId, text, modeData);
}</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-11-6">
          <div class="snippet-header">
            <h3 class="snippet-title">11.6 Progress Bar Generation</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×™×¦×™×¨×ª progress bar ×˜×§×¡×˜×•××œ×™ ×™×¤×” ×œ×”×•×“×¢×•×ª ×˜×œ×’×¨×, ×©×™××•×©×™ ×œ×”×¦×’×ª ×”×ª×§×“××•×ª.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript"><code class="language-javascript">createProgressBar(current, total, barLength = 10) {
  const filledBars = Math.floor((current / total) * barLength);
  const emptyBars = barLength - filledBars;
  return 'â–ˆ'.repeat(filledBars) + 'â–‘'.repeat(emptyBars);
}

// ×©×™××•×©:
const progress = this.db.getUserProgress(userId);
const totalLessons = 14;
const progressBar = this.createProgressBar(
  progress.lessons_completed,
  totalLessons,
  10
);
const message = `ğŸ“ˆ *×”×ª×§×“××•×ª ×‘×©×™×¢×•×¨×™×:*\n${progressBar} ${progressPercentage}%\n${progress.lessons_completed}/${totalLessons} ×©×™×¢×•×¨×™× ×”×•×©×œ××•`;</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-11-7">
          <div class="snippet-header">
            <h3 class="snippet-title">11.7 Multi-Step Form Flow</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×–×¨×™××ª ×”×’×©×ª ×ª×‘× ×™×•×ª/×˜×¤×¡×™× ×¨×‘-×©×œ×‘×™×ª. ×©×™××•×©×™ ×œ×©××œ×•× ×™×, ×”×¨×©××•×ª, ×•×”×’×©×•×ª.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript"><code class="language-javascript">// ×©×œ×‘ 1: ×”×ª×—×œ×”
async handleSubmitTemplate(msg) {
  const userId = msg.from.id;
  this.db.setUserMode(userId, 'submitting_template', JSON.stringify({ step: 'title' }));
  
  await this.bot.sendMessage(chatId,
    'ğŸ“ *×©×œ×‘ 1 ××ª×•×š 4: ×›×•×ª×¨×ª*\n' +
    '××” ×©× ×”×ª×‘× ×™×ª?',
    { parse_mode: 'Markdown' }
  );
}

// ×©×œ×‘ 2: ×˜×™×¤×•×œ ×‘×§×œ×˜
async handleTemplateSubmissionInput(chatId, userId, text, mode) {
  const modeData = JSON.parse(mode.mode_data || '{}');
  const step = modeData.step;

  if (step === 'title') {
    // Validate
    if (text.length < 3 || text.length > 100) {
      await this.bot.sendMessage(chatId, 'âŒ ×”×›×•×ª×¨×ª ×¦×¨×™×›×” ×œ×”×™×•×ª ×‘×™×Ÿ 3 ×œ-100 ×ª×•×•×™×.');
      return;
    }

    // Save and advance
    modeData.title = text;
    modeData.step = 'category';
    this.db.setUserMode(userId, 'submitting_template', JSON.stringify(modeData));

    await this.bot.sendMessage(chatId,
      `âœ… ×›×•×ª×¨×ª × ×©××¨×”: "${text}"\n\n` +
      `ğŸ“ *×©×œ×‘ 2 ××ª×•×š 4: ×§×˜×’×•×¨×™×”*`,
      { parse_mode: 'Markdown' }
    );
  } else if (step === 'category') {
    // ... continue flow
  } else if (step === 'content') {
    // Final step - save and complete
    this.db.createTemplateSubmission(userId, templateId, modeData.title, ...);
    this.db.clearUserMode(userId);
    await this.bot.sendMessage(chatId, 'ğŸ‰ ×ª×‘× ×™×ª × ×©×œ×—×” ×‘×”×¦×œ×—×”!');
  }
}</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 12: Database Async Patterns -->
      <div class="category" id="category-12">
        <div class="category-header">
          <i class="fas fa-database"></i>
          <h2>Database Async Patterns (SQLAlchemy)</h2>
        </div>

        <div class="snippet" id="snippet-12-1">
          <div class="snippet-header">
            <h3 class="snippet-title">12.1 Async Database Session Context Manager</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> × ×™×”×•×œ session ××•×˜×•××˜×™ ×¢× ×¡×’×™×¨×” ×‘×˜×•×—×”</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from sqlalchemy.ext.asyncio import AsyncSession, async_sessionmaker, create_async_engine

# Create async engine
engine = create_async_engine(
    settings.DATABASE_URL,
    pool_size=settings.DATABASE_POOL_SIZE,
    max_overflow=settings.DATABASE_MAX_OVERFLOW,
    pool_timeout=settings.DATABASE_POOL_TIMEOUT,
    echo=settings.DATABASE_ECHO,
    pool_pre_ping=True,  # Validate connections before use
    pool_recycle=3600,   # Recycle connections every hour
)

# Create session factory
async_session_maker = async_sessionmaker(
    engine,
    class_=AsyncSession,
    expire_on_commit=False,
    autoflush=False,
)

# Usage in code
async def some_database_operation():
    async with async_session_maker() as session:
        result = await session.execute(select(User).where(User.id == user_id))
        user = result.scalar_one_or_none()
        
        # Modify user
        user.last_login_at = datetime.now(timezone.utc)
        
        await session.commit()
        await session.refresh(user)
        
        return user</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-12-2">
          <div class="snippet-header">
            <h3 class="snippet-title">12.2 Eager Loading ×¢× selectinload</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×˜×¢×™× ×ª relationships ×‘×©××™×œ×ª×” ××—×ª ×œ×× ×™×¢×ª N+1</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from sqlalchemy.orm import selectinload

async def get_report_with_relations(report_id: uuid.UUID, session: AsyncSession):
    """Get report with all related data loaded."""
    
    query = select(Report).where(Report.id == report_id).options(
        selectinload(Report.reporter),              # Load reporter user
        selectinload(Report.files),                 # Load files
        selectinload(Report.alerts).selectinload(Alert.organization),  # Nested load
        selectinload(Report.assigned_organization)
    )
    
    result = await session.execute(query)
    report = result.scalar_one_or_none()
    
    return report</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-12-3">
          <div class="snippet-header">
            <h3 class="snippet-title">12.3 Complex Filter ×¢× and_ / or_</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×‘× ×™×™×ª ×©××™×œ×ª×•×ª ××•×¨×›×‘×•×ª ×¢× ×ª× ××™× ××¨×•×‘×™×</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from sqlalchemy import select, and_, or_, desc

async def search_reports(
    session: AsyncSession,
    animal_type: Optional[AnimalType] = None,
    urgency_level: Optional[UrgencyLevel] = None,
    city: Optional[str] = None,
    date_from: Optional[datetime] = None,
    status_list: Optional[List[ReportStatus]] = None
):
    """Search reports with multiple filters."""
    
    # Build conditions list
    conditions = []
    
    if animal_type:
        conditions.append(Report.animal_type == animal_type)
    
    if urgency_level:
        conditions.append(Report.urgency_level == urgency_level)
    
    if city:
        conditions.append(Report.city.ilike(f"%{city}%"))
    
    if date_from:
        conditions.append(Report.created_at >= date_from)
    
    if status_list:
        conditions.append(Report.status.in_(status_list))
    
    # Combine all conditions with AND
    query = select(Report)
    if conditions:
        query = query.where(and_(*conditions))
    
    # Order by created_at descending
    query = query.order_by(desc(Report.created_at))
    
    result = await session.execute(query)
    reports = result.scalars().all()
    
    return reports</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-12-4">
          <div class="snippet-header">
            <h3 class="snippet-title">12.4 Database Transaction Pattern</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×‘×™×¦×•×¢ ××¡×¤×¨ ×¤×¢×•×œ×•×ª DB ×›×˜×¨× ×–×§×¦×™×” ××˜×•××™×ª. ××‘×˜×™×— ×¢×§×‘×™×•×ª × ×ª×•× ×™×.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript"><code class="language-javascript">resetUserProgress(userId) {
  const trx = this.db.transaction((uid) => {
    // Reset core progress fields
    const resetStmt = this.db.prepare(`
      UPDATE user_progress
      SET current_lesson = 0,
          total_score = 0,
          level = 'Beginner',
          lessons_completed = 0,
          correct_answers = 0,
          wrong_answers = 0,
          last_lesson_date = NULL
      WHERE user_id = ?
    `);
    resetStmt.run(uid);

    // Clear lesson history and topic performance
    const delHistory = this.db.prepare('DELETE FROM lesson_history WHERE user_id = ?');
    delHistory.run(uid);
    const delTopics = this.db.prepare('DELETE FROM topic_performance WHERE user_id = ?');
    delTopics.run(uid);

    // Reset user mode to normal
    const resetMode = this.db.prepare(`
      INSERT OR REPLACE INTO user_modes (user_id, current_mode, mode_data, updated_at)
      VALUES (?, 'normal', NULL, CURRENT_TIMESTAMP)
    `);
    resetMode.run(uid);
  });

  trx(userId);
}</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-12-5">
          <div class="snippet-header">
            <h3 class="snippet-title">12.5 Upsert with ON CONFLICT</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×¢×“×›×•×Ÿ ××• ×”×•×¡×¤×ª ×¨×©×•××” ×‘×§×¨×™××” ××—×ª. ×©×™××•×©×™ ×œ××¢×§×‘ ×‘×™×¦×•×¢×™×, ×”×¢×“×¤×•×ª ××©×ª××©.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript"><code class="language-javascript">updateTopicPerformance(userId, topic, isCorrect) {
  const field = isCorrect ? 'correct_count' : 'wrong_count';
  
  const stmt = this.db.prepare(`
    INSERT INTO topic_performance (user_id, topic, ${field}, last_practiced)
    VALUES (?, ?, 1, CURRENT_TIMESTAMP)
    ON CONFLICT(user_id, topic) DO UPDATE SET
      ${field} = ${field} + 1,
      last_practiced = CURRENT_TIMESTAMP
  `);
  
  stmt.run(userId, topic);
}</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 13: Authentication & Security -->
      <div class="category" id="category-13">
        <div class="category-header">
          <i class="fas fa-shield-alt"></i>
          <h2>Authentication & Security</h2>
        </div>

        <div class="snippet" id="snippet-13-1">
          <div class="snippet-header">
            <h3 class="snippet-title">13.1 JWT Token Creation</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×™×¦×™×¨×ª JWT tokens ×××•×‘×˜×—×™×</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import jwt
from datetime import datetime, timezone, timedelta

def create_access_token(
    subject: Union[str, int],
    expires_delta: Optional[timedelta] = None,
    additional_claims: Optional[Dict[str, Any]] = None
) -> str:
    """
    Create JWT access token.
    
    Example:
        token = create_access_token(
            subject=str(user.id),
            expires_delta=timedelta(days=7),
            additional_claims={"role": user.role.value}
        )
    """
    if expires_delta:
        expire = datetime.now(timezone.utc) + expires_delta
    else:
        expire = datetime.now(timezone.utc) + timedelta(days=7)
    
    to_encode = {
        "exp": expire,
        "sub": str(subject),
        "iat": datetime.now(timezone.utc),
        "type": "access",
    }
    
    if additional_claims:
        to_encode.update(additional_claims)
    
    encoded_jwt = jwt.encode(
        to_encode,
        settings.SECRET_KEY,
        algorithm="HS256"
    )
    
    return encoded_jwt</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-13-2">
          <div class="snippet-header">
            <h3 class="snippet-title">13.2 JWT Token Validation Dependency</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××™××•×ª ××•×˜×•××˜×™ ×©×œ ××©×ª××© ×-JWT</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from fastapi import Depends, HTTPException, status
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials

security = HTTPBearer()

async def get_current_user(
    session: AsyncSession = Depends(get_db_session),
    credentials: Optional[HTTPAuthorizationCredentials] = Depends(security)
) -> Optional[User]:
    """
    Get current authenticated user from JWT token.
    
    Usage:
        @app.get("/protected")
        async def protected_route(user: User = Depends(get_current_user)):
            return {"user_id": str(user.id)}
    """
    if not credentials:
        return None
    
    try:
        # Decode token
        payload = jwt.decode(
            credentials.credentials,
            settings.SECRET_KEY,
            algorithms=["HS256"]
        )
        
        user_id = payload.get("sub")
        if not user_id:
            return None
        
        # Get user from database
        result = await session.execute(
            select(User).where(User.id == uuid.UUID(user_id))
        )
        user = result.scalar_one_or_none()
        
        if not user or not user.is_active:
            return None
        
        # Update last activity
        user.last_login_at = datetime.now(timezone.utc)
        await session.commit()
        
        return user
    
    except Exception as e:
        logger.debug("Authentication failed", error=str(e))
        return None</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-13-3">
          <div class="snippet-header">
            <h3 class="snippet-title">13.3 Role-Based Access Control</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×”×’×‘×œ×ª ×’×™×©×” ×œ×¤×™ ×ª×¤×§×™×“×™×</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">def require_roles(allowed_roles: List[UserRole]):
    """
    Create dependency that requires specific roles.
    
    Usage:
        @app.post("/admin/action")
        async def admin_action(
            user: User = Depends(require_roles([UserRole.SYSTEM_ADMIN]))
        ):
            return {"status": "ok"}
    """
    async def role_checker(current_user: User = Depends(get_current_user)) -> User:
        if not current_user:
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail="Authentication required"
            )
        
        if current_user.role not in allowed_roles:
            logger.warning(
                "Access denied",
                user_id=str(current_user.id),
                user_role=current_user.role.value,
                required_roles=[r.value for r in allowed_roles]
            )
            raise HTTPException(
                status_code=status.HTTP_403_FORBIDDEN,
                detail="Insufficient permissions"
            )
        
        return current_user
    
    return role_checker</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 14: Redis & Caching -->
      <div class="category" id="category-14">
        <div class="category-header">
          <i class="fas fa-memory"></i>
          <h2>Redis & Caching</h2>
        </div>

        <div class="snippet" id="snippet-14-1">
          <div class="snippet-header">
            <h3 class="snippet-title">14.1 Distributed Lock ×¢× Redis</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> × ×¢×™×œ×” ××‘×•×–×¨×ª ×œ×× ×™×¢×ª race conditions</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from contextlib import asynccontextmanager

class DistributedLock:
    """Redis-based distributed lock."""
    
    def __init__(self, key: str, timeout: int = 30):
        self.key = f"lock:{key}"
        self.timeout = timeout
        self.identifier = f"{id(self)}:{time.time()}"
        self._acquired = False
    
    async def acquire(self) -> bool:
        """Acquire the lock."""
        result = await redis_client.set(
            self.key,
            self.identifier,
            nx=True,  # Only set if doesn't exist
            ex=self.timeout  # Expiration
        )
        self._acquired = bool(result)
        return self._acquired
    
    async def release(self) -> bool:
        """Release the lock (only if we own it)."""
        lua_script = """
        if redis.call('GET', KEYS[1]) == ARGV[1] then
            return redis.call('DEL', KEYS[1])
        else
            return 0
        end
        """
        result = await redis_client.eval(lua_script, 1, self.key, self.identifier)
        return bool(result)
    
    async def __aenter__(self):
        if await self.acquire():
            return self
        raise Exception(f"Could not acquire lock: {self.key}")
    
    async def __aexit__(self, exc_type, exc_val, exc_tb):
        await self.release()

# Usage
async with DistributedLock("process_report", timeout=60):
    # Critical section - only one process can execute this at a time
    await process_report_logic()</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 15: Health Checks & Monitoring -->
      <div class="category" id="category-15">
        <div class="category-header">
          <i class="fas fa-heartbeat"></i>
          <h2>Health Checks & Monitoring</h2>
        </div>

        <div class="snippet" id="snippet-15-1">
          <div class="snippet-header">
            <h3 class="snippet-title">15.1 Comprehensive Health Check</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×‘×“×™×§×ª ×‘×¨×™××•×ª ×›×œ ×”×©×™×¨×•×ª×™×</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">@app.get("/health")
async def health_check():
    """Application health check with all services."""
    
    health_data = {
        "status": "healthy",
        "timestamp": datetime.now(timezone.utc).isoformat(),
        "version": settings.APP_VERSION,
        "environment": settings.ENVIRONMENT,
        "services": {}
    }
    
    # Check database
    try:
        db_health = await check_database_health()
        health_data["services"]["database"] = db_health
    except Exception as e:
        health_data["services"]["database"] = {"status": "unhealthy", "error": str(e)}
        health_data["status"] = "degraded"
    
    # Check Redis
    try:
        await redis_client.ping()
        health_data["services"]["redis"] = {"status": "healthy"}
    except Exception as e:
        health_data["services"]["redis"] = {"status": "unhealthy", "error": str(e)}
        health_data["status"] = "degraded"
    
    # Check external APIs
    try:
        google_service = GoogleService()
        if await google_service.test_connection():
            health_data["services"]["google_apis"] = {"status": "healthy"}
        else:
            health_data["services"]["google_apis"] = {"status": "unavailable"}
    except Exception as e:
        health_data["services"]["google_apis"] = {"status": "unhealthy", "error": str(e)}
    
    # Determine overall health
    unhealthy = [name for name, svc in health_data["services"].items() 
                 if svc.get("status") == "unhealthy"]
    
    if unhealthy:
        health_data["status"] = "unhealthy"
        health_data["unhealthy_services"] = unhealthy
    
    status_code = 200 if health_data["status"] in {"healthy", "degraded"} else 503
    
    return JSONResponse(content=health_data, status_code=status_code)</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 16: File Storage & Validation -->
      <div class="category" id="category-16">
        <div class="category-header">
          <i class="fas fa-file-upload"></i>
          <h2>File Storage & Validation</h2>
        </div>

        <div class="snippet" id="snippet-16-1">
          <div class="snippet-header">
            <h3 class="snippet-title">16.1 File Validation with Security Checks</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×‘×“×™×§×•×ª ××‘×˜×—×” ×œ×§×‘×¦×™× ×©×¢×•×œ×™× ×œ××¢×¨×›×ª</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from PIL import Image
from io import BytesIO
import mimetypes

def validate_file(file_data: bytes, filename: str, content_type: str) -> None:
    """
    Validate uploaded file for security and constraints.
    
    Raises:
        ValidationError: If file is invalid
    """
    # Check file size
    max_size = settings.MAX_FILE_SIZE_MB * 1024 * 1024
    if len(file_data) > max_size:
        raise ValidationError(f"File size exceeds {settings.MAX_FILE_SIZE_MB}MB limit")
    
    # Check file type
    if content_type not in settings.ALLOWED_FILE_TYPES:
        raise ValidationError(f"File type {content_type} is not allowed")
    
    # Verify MIME type matches content
    detected_type, _ = mimetypes.guess_type(filename)
    if detected_type and detected_type != content_type:
        logger.warning(
            "MIME type mismatch",
            declared=content_type,
            detected=detected_type
        )
    
    # Security checks for images
    if content_type.startswith('image/'):
        try:
            # Verify it's a valid image
            image = Image.open(BytesIO(file_data))
            image.verify()
            
            # Check dimensions
            if hasattr(image, 'size'):
                width, height = image.size
                if width > 10000 or height > 10000:
                    raise ValidationError("Image dimensions too large")
        
        except Exception as e:
            raise ValidationError(f"Invalid image file: {str(e)}")
    
    # Check for malicious content
    if b'&lt;script' in file_data.lower() or b'javascript:' in file_data.lower():
        raise ValidationError("File contains potentially malicious content")</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 17: Webhook Handling & Security -->
      <div class="category" id="category-17">
        <div class="category-header">
          <i class="fas fa-shield-alt"></i>
          <h2>Webhook Handling & Security</h2>
        </div>

        <div class="snippet" id="snippet-17-1">
          <div class="snippet-header">
            <h3 class="snippet-title">17.1 Webhook Signature Verification</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> ×œ×•×•×“× ×©×”×‘×§×©×•×ª ×‘×××ª ××’×™×¢×•×ª ××˜×œ×’×¨× ×•×œ× ××ª×•×§×£</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import hmac
import hashlib
from fastapi import Header, HTTPException

async def verify_telegram_webhook(
    request_body: bytes,
    x_telegram_bot_api_secret_token: str = Header(None)
) -&gt; bool:
    """Verify that webhook request comes from Telegram"""
    expected_token = os.getenv("WEBHOOK_SECRET_TOKEN")
    
    if not x_telegram_bot_api_secret_token:
        raise HTTPException(401, "Missing secret token")
    
    if not hmac.compare_digest(
        x_telegram_bot_api_secret_token, 
        expected_token
    ):
        raise HTTPException(403, "Invalid secret token")
    
    return True</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-17-2">
          <div class="snippet-header">
            <h3 class="snippet-title">17.2 Webhook Retry Mechanism</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> ×œ×˜×¤×œ ×‘×›×©×œ×™× ×–×× ×™×™× ×•×œ×•×•×“× ×©××£ ×¢×“×›×•×Ÿ ×œ× ××•×‘×“</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from tenacity import retry, stop_after_attempt, wait_exponential

@retry(
    stop=stop_after_attempt(3),
    wait=wait_exponential(multiplier=1, min=2, max=10),
    reraise=True
)
async def process_webhook_update(update: dict):
    """Process update with automatic retry on failure"""
    try:
        await handle_update(update)
    except Exception as e:
        logger.error(f"Failed processing update {update.get('update_id')}: {e}")
        raise  # Will trigger retry</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-17-3">
          <div class="snippet-header">
            <h3 class="snippet-title">17.3 Webhook Health Monitoring</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> ×œ×¢×§×•×‘ ××—×¨×™ ×‘×¨×™××•×ª ×”-webhook ×•×œ×–×”×•×ª ×‘×¢×™×•×ª ××•×§×“×</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from datetime import datetime, timedelta
from collections import deque

class WebhookHealthMonitor:
    def __init__(self, window_minutes=5):
        self.requests = deque(maxlen=1000)
        self.errors = deque(maxlen=1000)
        self.window = timedelta(minutes=window_minutes)
    
    def record_request(self, success: bool = True):
        now = datetime.now()
        self.requests.append(now)
        if not success:
            self.errors.append(now)
    
    def get_health_status(self) -&gt; dict:
        now = datetime.now()
        cutoff = now - self.window
        
        recent_requests = sum(1 for t in self.requests if t &gt; cutoff)
        recent_errors = sum(1 for t in self.errors if t &gt; cutoff)
        
        error_rate = recent_errors / recent_requests if recent_requests else 0
        
        return {
            "status": "healthy" if error_rate &lt; 0.05 else "degraded",
            "requests_per_minute": recent_requests / self.window.seconds * 60,
            "error_rate": error_rate,
            "last_request": max(self.requests) if self.requests else None
        }</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 18: Rate Limiting ××ª×§×“× -->
      <div class="category" id="category-18">
        <div class="category-header">
          <i class="fas fa-tachometer-alt"></i>
          <h2>Rate Limiting ××ª×§×“×</h2>
        </div>

        <div class="snippet" id="snippet-18-1">
          <div class="snippet-header">
            <h3 class="snippet-title">18.1 Token Bucket Algorithm</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> ×œ×× ×•×¢ spam ×•×”×¦×¤×” ×ª×•×š ×©××™×¨×” ×¢×œ ×—×•×•×™×ª ××©×ª××© ×˜×•×‘×”</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import time
from collections import defaultdict

class TokenBucket:
    def __init__(self, capacity: int, refill_rate: float):
        self.capacity = capacity
        self.refill_rate = refill_rate  # tokens per second
        self.buckets = defaultdict(lambda: {
            'tokens': capacity,
            'last_refill': time.time()
        })
    
    def consume(self, key: str, tokens: int = 1) -&gt; bool:
        bucket = self.buckets[key]
        now = time.time()
        
        # Refill tokens
        time_passed = now - bucket['last_refill']
        bucket['tokens'] = min(
            self.capacity,
            bucket['tokens'] + time_passed * self.refill_rate
        )
        bucket['last_refill'] = now
        
        # Try to consume
        if bucket['tokens'] &gt;= tokens:
            bucket['tokens'] -= tokens
            return True
        return False</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-18-2">
          <div class="snippet-header">
            <h3 class="snippet-title">18.2 Rate Limiting Per User/Chat</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> ×œ×”×’×‘×™×œ ×›×œ ××©×ª××©/×¦'××˜ ×‘× ×¤×¨×“ ×•×œ× ××ª ×›×œ ×”×‘×•×˜</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from functools import wraps
from telegram import Update

class UserRateLimiter:
    def __init__(self, max_requests: int, window_seconds: int):
        self.bucket = TokenBucket(
            capacity=max_requests,
            refill_rate=max_requests / window_seconds
        )
    
    def __call__(self, func):
        @wraps(func)
        async def wrapper(update: Update, context):
            user_id = update.effective_user.id
            
            if not self.bucket.consume(f"user:{user_id}"):
                await update.message.reply_text(
                    "â³ Too many requests. Please wait a moment."
                )
                return
            
            return await func(update, context)
        return wrapper

# Usage
@UserRateLimiter(max_requests=10, window_seconds=60)
async def handle_command(update: Update, context):
    await update.message.reply_text("Processing...")</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-18-3">
          <div class="snippet-header">
            <h3 class="snippet-title">18.3 Distributed Rate Limiting with Redis</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> ×œ×©×ª×£ ××’×‘×œ×•×ª ×‘×™×Ÿ ××¡×¤×¨ ×©×¨×ª×™×/workers</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import redis.asyncio as redis
from datetime import timedelta

class RedisRateLimiter:
    def __init__(self, redis_client: redis.Redis):
        self.redis = redis_client
    
    async def is_allowed(
        self, 
        key: str, 
        max_requests: int, 
        window: timedelta
    ) -&gt; bool:
        pipe = self.redis.pipeline()
        now = int(time.time())
        window_start = now - int(window.total_seconds())
        
        # Remove old entries
        pipe.zremrangebyscore(key, 0, window_start)
        # Count current requests
        pipe.zcard(key)
        # Add current request
        pipe.zadd(key, {str(now): now})
        # Set expiry
        pipe.expire(key, window)
        
        results = await pipe.execute()
        request_count = results[1]
        
        return request_count &lt; max_requests

# Usage
limiter = RedisRateLimiter(redis_client)
if await limiter.is_allowed(f"user:{user_id}", 20, timedelta(minutes=1)):
    # Process request
    pass</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 19: Retry & Circuit Breaker Patterns -->
      <div class="category" id="category-19">
        <div class="category-header">
          <i class="fas fa-redo"></i>
          <h2>Retry & Circuit Breaker Patterns</h2>
        </div>

        <div class="snippet" id="snippet-19-1">
          <div class="snippet-header">
            <h3 class="snippet-title">19.1 Exponential Backoff Retry</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> ×œ× ×¡×•×ª ×©×•×‘ ×‘×¦×•×¨×” ×—×›××” ×›×©×™×© ×›×©×œ×•×Ÿ ×–×× ×™</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import asyncio
import random
from typing import TypeVar, Callable

T = TypeVar('T')

async def retry_with_backoff(
    func: Callable[..., T],
    max_retries: int = 3,
    base_delay: float = 1.0,
    max_delay: float = 60.0,
    *args, **kwargs
) -&gt; T:
    """Retry with exponential backoff and jitter"""
    for attempt in range(max_retries):
        try:
            return await func(*args, **kwargs)
        except Exception as e:
            if attempt == max_retries - 1:
                raise
            
            # Calculate delay with jitter
            delay = min(base_delay * (2 ** attempt), max_delay)
            jitter = random.uniform(0, delay * 0.1)
            wait_time = delay + jitter
            
            logger.warning(
                f"Attempt {attempt + 1} failed: {e}. "
                f"Retrying in {wait_time:.2f}s..."
            )
            await asyncio.sleep(wait_time)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-19-2">
          <div class="snippet-header">
            <h3 class="snippet-title">19.2 Circuit Breaker Pattern</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> ×œ×”×¤×¡×™×§ ×œ× ×¡×•×ª ×›×©×”×©×™×¨×•×ª × ×•×¤×œ, ×œ×—×¡×•×š ××©××‘×™×</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from enum import Enum
from datetime import datetime, timedelta

class CircuitState(Enum):
    CLOSED = "closed"  # Normal operation
    OPEN = "open"      # Blocking requests
    HALF_OPEN = "half_open"  # Testing recovery

class CircuitBreaker:
    def __init__(
        self, 
        failure_threshold: int = 5,
        timeout: timedelta = timedelta(seconds=60),
        success_threshold: int = 2
    ):
        self.failure_threshold = failure_threshold
        self.timeout = timeout
        self.success_threshold = success_threshold
        
        self.failure_count = 0
        self.success_count = 0
        self.state = CircuitState.CLOSED
        self.opened_at = None
    
    async def call(self, func, *args, **kwargs):
        if self.state == CircuitState.OPEN:
            if datetime.now() - self.opened_at &gt; self.timeout:
                self.state = CircuitState.HALF_OPEN
                self.success_count = 0
            else:
                raise Exception("Circuit breaker is OPEN")
        
        try:
            result = await func(*args, **kwargs)
            self._on_success()
            return result
        except Exception as e:
            self._on_failure()
            raise
    
    def _on_success(self):
        self.failure_count = 0
        if self.state == CircuitState.HALF_OPEN:
            self.success_count += 1
            if self.success_count &gt;= self.success_threshold:
                self.state = CircuitState.CLOSED
    
    def _on_failure(self):
        self.failure_count += 1
        if self.failure_count &gt;= self.failure_threshold:
            self.state = CircuitState.OPEN
            self.opened_at = datetime.now()</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-19-3">
          <div class="snippet-header">
            <h3 class="snippet-title">19.3 Retry Decorator with Jitter</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> ×“×§×•×¨×˜×•×¨ × ×•×— ×œ×©×™××•×© ×—×•×–×¨ ×‘×›×œ ×”×¤×¨×•×™×§×˜</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from functools import wraps
import asyncio
import random

def async_retry(
    max_attempts: int = 3,
    base_delay: float = 1.0,
    exceptions: tuple = (Exception,)
):
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            for attempt in range(max_attempts):
                try:
                    return await func(*args, **kwargs)
                except exceptions as e:
                    if attempt == max_attempts - 1:
                        raise
                    
                    delay = base_delay * (2 ** attempt)
                    jitter = random.uniform(0, delay * 0.3)
                    await asyncio.sleep(delay + jitter)
                    
                    logger.info(f"Retry {attempt + 1}/{max_attempts} for {func.__name__}")
        return wrapper
    return decorator

# Usage
@async_retry(max_attempts=3, base_delay=2.0)
async def send_telegram_message(chat_id, text):
    await bot.send_message(chat_id, text)</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 20: Telegram Inline Queries -->
      <div class="category" id="category-20">
        <div class="category-header">
          <i class="fas fa-search"></i>
          <h2>Telegram Inline Queries</h2>
        </div>

        <div class="snippet" id="snippet-20-1">
          <div class="snippet-header">
            <h3 class="snippet-title">20.1 Inline Query Handler with Caching</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> ×œ×©×¤×¨ ×‘×™×¦×•×¢×™× ×•×œ×”×¤×—×™×ª ×¢×•××¡ ×¢×œ ×”×©×¨×ª/API</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from telegram import InlineQueryResultArticle, InputTextMessageContent
from telegram.ext import InlineQueryHandler
from functools import lru_cache
from hashlib import md5

class CachedInlineQueryHandler:
    def __init__(self, cache_ttl: int = 300):
        self.cache = {}
        self.cache_ttl = cache_ttl
    
    @staticmethod
    def _cache_key(query: str) -&gt; str:
        return md5(query.encode()).hexdigest()
    
    async def handle_inline_query(self, update, context):
        query = update.inline_query.query
        
        if not query:
            return
        
        # Check cache
        cache_key = self._cache_key(query)
        cached = self.cache.get(cache_key)
        
        if cached and time.time() - cached['time'] &lt; self.cache_ttl:
            results = cached['results']
        else:
            # Perform search
            results = await self.search_content(query)
            self.cache[cache_key] = {
                'results': results,
                'time': time.time()
            }
        
        await update.inline_query.answer(results, cache_time=self.cache_ttl)
    
    async def search_content(self, query: str) -&gt; list:
        """Override this with your search logic"""
        return [
            InlineQueryResultArticle(
                id=str(i),
                title=f"Result {i}",
                input_message_content=InputTextMessageContent(f"Content: {query}")
            )
            for i in range(5)
        ]</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-20-2">
          <div class="snippet-header">
            <h3 class="snippet-title">20.2 Inline Result Pagination</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> ×œ××¤×©×¨ ×’×œ×™×œ×” ×“×¨×š ×ª×•×¦××•×ª ×¨×‘×•×ª ×‘-inline mode</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from telegram import InlineQueryResultsButton, InlineQueryResultArticle
from uuid import uuid4

class InlineQueryPaginator:
    def __init__(self, page_size: int = 10):
        self.page_size = page_size
        self.results_cache = {}  # Store full results temporarily
    
    async def handle_paginated_query(self, update, context):
        query = update.inline_query.query
        offset = update.inline_query.offset or "0"
        
        # Get or generate all results
        session_id = str(uuid4())
        if offset == "0":
            all_results = await self.fetch_all_results(query)
            self.results_cache[session_id] = all_results
        else:
            session_id = offset.split(":")[0]
            all_results = self.results_cache.get(session_id, [])
        
        # Parse offset
        start = int(offset.split(":")[-1]) if ":" in offset else 0
        end = start + self.page_size
        
        # Slice results
        page_results = all_results[start:end]
        
        # Calculate next offset
        next_offset = f"{session_id}:{end}" if end &lt; len(all_results) else ""
        
        await update.inline_query.answer(
            page_results,
            next_offset=next_offset,
            cache_time=10
        )
    
    async def fetch_all_results(self, query: str) -&gt; list:
        """Fetch all matching results"""
        # Your search logic here
        return []</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-20-3">
          <div class="snippet-header">
            <h3 class="snippet-title">20.3 Inline Query Rate Limiting</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> ×œ×× ×•×¢ ×©×™××•×© ×œ×¨×¢×” ×‘-inline queries</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from telegram.ext import InlineQueryHandler
from collections import defaultdict
import time

class RateLimitedInlineHandler:
    def __init__(self, max_queries: int = 30, window: int = 60):
        self.max_queries = max_queries
        self.window = window
        self.user_queries = defaultdict(list)
    
    async def handle_inline_query(self, update, context):
        user_id = update.inline_query.from_user.id
        now = time.time()
        
        # Clean old entries
        self.user_queries[user_id] = [
            t for t in self.user_queries[user_id]
            if now - t &lt; self.window
        ]
        
        # Check limit
        if len(self.user_queries[user_id]) &gt;= self.max_queries:
            await update.inline_query.answer(
                [],
                switch_pm_text="âš ï¸ Rate limit exceeded",
                switch_pm_parameter="rate_limit"
            )
            return
        
        # Record query
        self.user_queries[user_id].append(now)
        
        # Process normally
        results = await self.process_query(update.inline_query.query)
        await update.inline_query.answer(results)</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 21: Message Scheduling & Delayed Tasks -->
      <div class="category" id="category-21">
        <div class="category-header">
          <i class="fas fa-clock"></i>
          <h2>Message Scheduling & Delayed Tasks</h2>
        </div>

        <div class="snippet" id="snippet-21-1">
          <div class="snippet-header">
            <h3 class="snippet-title">21.1 Schedule Messages for Future</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> ×œ×©×œ×•×— ×”×•×“×¢×•×ª ×‘×–××Ÿ ××•×’×“×¨ ××¨××©</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from apscheduler.schedulers.asyncio import AsyncIOScheduler
from apscheduler.triggers.date import DateTrigger
from datetime import datetime

class MessageScheduler:
    def __init__(self, bot):
        self.bot = bot
        self.scheduler = AsyncIOScheduler()
        self.scheduler.start()
    
    def schedule_message(
        self, 
        chat_id: int, 
        text: str, 
        send_at: datetime,
        job_id: str = None
    ) -&gt; str:
        """Schedule a message to be sent at specific time"""
        job_id = job_id or f"msg_{chat_id}_{int(send_at.timestamp())}"
        
        self.scheduler.add_job(
            self._send_message,
            trigger=DateTrigger(run_date=send_at),
            args=[chat_id, text],
            id=job_id,
            replace_existing=True
        )
        
        return job_id
    
    async def _send_message(self, chat_id: int, text: str):
        try:
            await self.bot.send_message(chat_id, text)
        except Exception as e:
            logger.error(f"Failed to send scheduled message: {e}")
    
    def cancel_scheduled_message(self, job_id: str) -&gt; bool:
        try:
            self.scheduler.remove_job(job_id)
            return True
        except:
            return False

# Usage
scheduler = MessageScheduler(bot)
scheduler.schedule_message(
    chat_id=123456,
    text="Reminder: Meeting in 10 minutes!",
    send_at=datetime.now() + timedelta(hours=1)
)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-21-2">
          <div class="snippet-header">
            <h3 class="snippet-title">21.2 Delayed Job Execution</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> ×œ×”×¨×™×¥ ××©×™××•×ª ×œ××—×¨ ×”×©×”×™×™×” ××•×’×“×¨×ª</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import asyncio
from typing import Callable, Any

class DelayedJobQueue:
    def __init__(self):
        self.tasks = {}
    
    async def schedule_delayed(
        self,
        job_id: str,
        func: Callable,
        delay_seconds: float,
        *args,
        **kwargs
    ):
        """Execute function after delay"""
        # Cancel existing job with same ID
        if job_id in self.tasks:
            self.tasks[job_id].cancel()
        
        async def delayed_execution():
            await asyncio.sleep(delay_seconds)
            try:
                await func(*args, **kwargs)
            finally:
                self.tasks.pop(job_id, None)
        
        task = asyncio.create_task(delayed_execution())
        self.tasks[job_id] = task
        return task
    
    def cancel_job(self, job_id: str) -&gt; bool:
        if job_id in self.tasks:
            self.tasks[job_id].cancel()
            self.tasks.pop(job_id)
            return True
        return False

# Usage
queue = DelayedJobQueue()
await queue.schedule_delayed(
    job_id=f"delete_msg_{chat_id}_{msg_id}",
    func=bot.delete_message,
    delay_seconds=300,  # 5 minutes
    chat_id=chat_id,
    message_id=msg_id
)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-21-3">
          <div class="snippet-header">
            <h3 class="snippet-title">21.3 Recurring Tasks</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> ×œ×”×¨×™×¥ ××©×™××•×ª ×—×•×–×¨×•×ª ×‘××¨×•×•×—×™ ×–××Ÿ ×§×‘×•×¢×™×</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from apscheduler.schedulers.asyncio import AsyncIOScheduler
from apscheduler.triggers.cron import CronTrigger
from apscheduler.triggers.interval import IntervalTrigger

class RecurringTaskManager:
    def __init__(self):
        self.scheduler = AsyncIOScheduler()
        self.scheduler.start()
    
    def add_daily_task(
        self, 
        func: Callable, 
        hour: int, 
        minute: int = 0,
        job_id: str = None
    ):
        """Run task daily at specific time"""
        self.scheduler.add_job(
            func,
            trigger=CronTrigger(hour=hour, minute=minute),
            id=job_id,
            replace_existing=True
        )
    
    def add_interval_task(
        self,
        func: Callable,
        minutes: int = None,
        hours: int = None,
        job_id: str = None
    ):
        """Run task at regular intervals"""
        self.scheduler.add_job(
            func,
            trigger=IntervalTrigger(minutes=minutes, hours=hours),
            id=job_id,
            replace_existing=True
        )
    
    def remove_task(self, job_id: str):
        self.scheduler.remove_job(job_id)

# Usage
tasks = RecurringTaskManager()

# Send daily summary at 9 AM
tasks.add_daily_task(
    send_daily_summary,
    hour=9,
    minute=0,
    job_id="daily_summary"
)

# Check for updates every 30 minutes
tasks.add_interval_task(
    check_updates,
    minutes=30,
    job_id="update_checker"
)</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 22: Database Migrations -->
      <div class="category" id="category-22">
        <div class="category-header">
          <i class="fas fa-database"></i>
          <h2>Database Migrations</h2>
        </div>

        <div class="snippet" id="snippet-22-1">
          <div class="snippet-header">
            <h3 class="snippet-title">22.1 Alembic Migration Patterns</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> × ×™×”×•×œ ×©×™× ×•×™×™ ××‘× ×” DB ×‘××•×¤×Ÿ ×‘×˜×•×— ×•××‘×•×§×¨</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python"># alembic/env.py helper
from alembic import context
from sqlalchemy import engine_from_config, pool
from logging.config import fileConfig

def run_migrations_online():
    """Run migrations in 'online' mode with connection pooling"""
    connectable = engine_from_config(
        context.config.get_section(context.config.config_ini_section),
        prefix="sqlalchemy.",
        poolclass=pool.NullPool,
    )

    with connectable.connect() as connection:
        context.configure(
            connection=connection,
            target_metadata=target_metadata,
            compare_type=True,  # Detect column type changes
            compare_server_default=True,  # Detect default changes
            include_schemas=True,  # Support multiple schemas
        )

        with context.begin_transaction():
            context.run_migrations()

# Migration file pattern for adding column with data
def upgrade():
    # Add column as nullable first
    op.add_column('users', sa.Column('status', sa.String(20), nullable=True))
    
    # Populate existing rows
    op.execute("UPDATE users SET status = 'active' WHERE status IS NULL")
    
    # Make it non-nullable
    op.alter_column('users', 'status', nullable=False)

def downgrade():
    op.drop_column('users', 'status')</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-22-2">
          <div class="snippet-header">
            <h3 class="snippet-title">22.2 Data Migration Helpers</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> ×œ×”×¢×‘×™×¨ ×•×œ×”××™×¨ ×“××˜×” ×‘×¦×•×¨×” ×‘×˜×•×—×” ×‘××”×œ×š migration</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from alembic import op
import sqlalchemy as sa
from sqlalchemy.sql import table, column

def batch_update_data(
    table_name: str,
    update_column: str,
    condition_column: str,
    update_func: Callable,
    batch_size: int = 1000
):
    """Update data in batches to avoid locking table"""
    conn = op.get_bind()
    
    # Create table reference
    t = table(
        table_name,
        column('id', sa.Integer),
        column(condition_column),
        column(update_column)
    )
    
    offset = 0
    while True:
        # Fetch batch
        rows = conn.execute(
            sa.select(t.c.id, t.c[condition_column])
            .limit(batch_size)
            .offset(offset)
        ).fetchall()
        
        if not rows:
            break
        
        # Update batch
        for row in rows:
            new_value = update_func(row[1])
            conn.execute(
                t.update()
                .where(t.c.id == row[0])
                .values({update_column: new_value})
            )
        
        offset += batch_size

# Usage in migration
def upgrade():
    op.add_column('messages', sa.Column('processed_text', sa.Text))
    
    batch_update_data(
        'messages',
        update_column='processed_text',
        condition_column='raw_text',
        update_func=lambda text: text.strip().lower()
    )</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-22-3">
          <div class="snippet-header">
            <h3 class="snippet-title">22.3 Rollback Strategies</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> ×œ×•×•×“× ×©××¤×©×¨ ×œ×—×–×•×¨ ××—×•×¨×” ×‘×¦×•×¨×” ×‘×˜×•×—×”</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">def safe_migration_with_backup():
    """Pattern for safe migration with backup table"""
    # Create backup table
    op.execute("""
        CREATE TABLE users_backup AS 
        SELECT * FROM users
    """)
    
    try:
        # Perform migration
        op.add_column('users', sa.Column('new_field', sa.String(100)))
        op.execute("UPDATE users SET new_field = old_field || '_processed'")
        op.drop_column('users', 'old_field')
        
        # Drop backup if successful
        op.execute("DROP TABLE users_backup")
    except Exception as e:
        # Restore from backup
        op.execute("DROP TABLE users")
        op.execute("ALTER TABLE users_backup RENAME TO users")
        raise

def downgrade():
    """Always include meaningful downgrade"""
    # Re-add old column
    op.add_column('users', sa.Column('old_field', sa.String(100)))
    
    # Reverse data transformation
    op.execute("""
        UPDATE users 
        SET old_field = REPLACE(new_field, '_processed', '')
    """)
    
    # Remove new column
    op.drop_column('users', 'new_field')</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 23: API Client Patterns -->
      <div class="category" id="category-23">
        <div class="category-header">
          <i class="fas fa-plug"></i>
          <h2>API Client Patterns</h2>
        </div>

        <div class="snippet" id="snippet-23-1">
          <div class="snippet-header">
            <h3 class="snippet-title">23.1 Async HTTP Client with Retry</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> client ×××™×Ÿ ×œ×§×¨×™××•×ª API ×¢× ×˜×™×¤×•×œ ××•×˜×•××˜×™ ×‘×©×’×™××•×ª</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import aiohttp
from typing import Optional, Dict, Any
import asyncio

class ResilientAPIClient:
    def __init__(
        self, 
        base_url: str, 
        timeout: int = 30,
        max_retries: int = 3
    ):
        self.base_url = base_url
        self.timeout = aiohttp.ClientTimeout(total=timeout)
        self.max_retries = max_retries
        self.session: Optional[aiohttp.ClientSession] = None
    
    async def __aenter__(self):
        self.session = aiohttp.ClientSession(timeout=self.timeout)
        return self
    
    async def __aexit__(self, *args):
        await self.session.close()
    
    async def request(
        self, 
        method: str, 
        endpoint: str,
        **kwargs
    ) -&gt; Dict[Any, Any]:
        """Make HTTP request with retry logic"""
        url = f"{self.base_url}/{endpoint.lstrip('/')}"
        
        for attempt in range(self.max_retries):
            try:
                async with self.session.request(method, url, **kwargs) as resp:
                    resp.raise_for_status()
                    return await resp.json()
            
            except aiohttp.ClientError as e:
                if attempt == self.max_retries - 1:
                    raise
                
                wait = 2 ** attempt
                logger.warning(f"Request failed, retry {attempt + 1} in {wait}s")
                await asyncio.sleep(wait)
        
    async def get(self, endpoint: str, **kwargs):
        return await self.request("GET", endpoint, **kwargs)
    
    async def post(self, endpoint: str, **kwargs):
        return await self.request("POST", endpoint, **kwargs)

# Usage
async with ResilientAPIClient("https://api.example.com") as client:
    data = await client.get("/users/123")</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-23-2">
          <div class="snippet-header">
            <h3 class="snippet-title">23.2 Request/Response Logging</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> ×œ×¢×§×•×‘ ××—×¨×™ ×›×œ ×”×§×¨×™××•×ª ×œ-API ×œ×¦×•×¨×š debug ×•×× ×œ×™×–×”</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import json
import logging
from functools import wraps
from time import time

class APILogger:
    def __init__(self, logger_name: str = "api_client"):
        self.logger = logging.getLogger(logger_name)
    
    def log_request_response(self, func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            start_time = time()
            
            # Log request
            self.logger.info(
                f"API Request: {func.__name__}",
                extra={
                    "args": str(args)[:200],
                    "kwargs": {k: str(v)[:100] for k, v in kwargs.items()}
                }
            )
            
            try:
                response = await func(*args, **kwargs)
                duration = time() - start_time
                
                # Log successful response
                self.logger.info(
                    f"API Response: {func.__name__} completed",
                    extra={
                        "duration_ms": int(duration * 1000),
                        "response_size": len(str(response))
                    }
                )
                
                return response
                
            except Exception as e:
                duration = time() - start_time
                
                # Log error
                self.logger.error(
                    f"API Error: {func.__name__} failed",
                    extra={
                        "duration_ms": int(duration * 1000),
                        "error": str(e),
                        "error_type": type(e).__name__
                    },
                    exc_info=True
                )
                raise
        
        return wrapper

# Usage
api_logger = APILogger()

class MyAPIClient:
    @api_logger.log_request_response
    async def get_user(self, user_id: int):
        # API call logic
        pass</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-23-3">
          <div class="snippet-header">
            <h3 class="snippet-title">23.3 API Rate Limiting Compliance</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> ×œ×›×‘×“ ××ª ××’×‘×œ×•×ª ×”-API ×•×œ×× ×•×¢ blocking</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import asyncio
from datetime import datetime, timedelta
from collections import deque

class APIRateLimiter:
    def __init__(self, requests_per_second: int):
        self.rate = requests_per_second
        self.requests = deque()
        self.lock = asyncio.Lock()
    
    async def acquire(self):
        """Wait until we can make another request"""
        async with self.lock:
            now = datetime.now()
            
            # Remove requests older than 1 second
            while self.requests and now - self.requests[0] &gt; timedelta(seconds=1):
                self.requests.popleft()
            
            # If at limit, wait
            if len(self.requests) &gt;= self.rate:
                sleep_time = 1 - (now - self.requests[0]).total_seconds()
                if sleep_time &gt; 0:
                    await asyncio.sleep(sleep_time)
                self.requests.popleft()
            
            self.requests.append(datetime.now())

class RateLimitedClient:
    def __init__(self, requests_per_second: int = 10):
        self.limiter = APIRateLimiter(requests_per_second)
    
    async def call_api(self, endpoint: str):
        await self.limiter.acquire()
        # Make actual API call
        return await self._make_request(endpoint)

# Usage with multiple requests
client = RateLimitedClient(requests_per_second=20)
tasks = [client.call_api(f"/endpoint/{i}") for i in range(100)]
results = await asyncio.gather(*tasks)  # Will respect rate limit</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 24: Decorators ×©×™××•×©×™×™× -->
      <div class="category" id="category-24">
        <div class="category-header">
          <i class="fas fa-magic"></i>
          <h2>Decorators ×©×™××•×©×™×™×</h2>
        </div>

        <div class="snippet" id="snippet-24-1">
          <div class="snippet-header">
            <h3 class="snippet-title">24.1 @retry, @timeout, @cache</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> ×“×§×•×¨×˜×•×¨×™× ××•×›× ×™× ×œ×©×™××•×© ×œ× ×™×”×•×œ ×©×’×™××•×ª ×•×‘×™×¦×•×¢×™×</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import asyncio
from functools import wraps
from typing import Optional
import time

def retry(attempts: int = 3, delay: float = 1.0):
    """Retry decorator for async functions"""
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            for attempt in range(attempts):
                try:
                    return await func(*args, **kwargs)
                except Exception as e:
                    if attempt == attempts - 1:
                        raise
                    await asyncio.sleep(delay * (attempt + 1))
        return wrapper
    return decorator

def timeout(seconds: float):
    """Timeout decorator for async functions"""
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            try:
                return await asyncio.wait_for(
                    func(*args, **kwargs),
                    timeout=seconds
                )
            except asyncio.TimeoutError:
                raise TimeoutError(
                    f"{func.__name__} exceeded {seconds}s timeout"
                )
        return wrapper
    return decorator

def cache(ttl: Optional[int] = None):
    """Simple cache decorator with optional TTL"""
    cache_data = {}
    
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            key = str(args) + str(kwargs)
            
            if key in cache_data:
                cached_time, cached_value = cache_data[key]
                if ttl is None or time.time() - cached_time &lt; ttl:
                    return cached_value
            
            result = await func(*args, **kwargs)
            cache_data[key] = (time.time(), result)
            return result
        
        return wrapper
    return decorator

# Usage
@retry(attempts=3)
@timeout(10)
@cache(ttl=300)
async def fetch_user_data(user_id: int):
    # Will retry up to 3 times, timeout after 10s, cache for 5 minutes
    return await api.get(f"/users/{user_id}")</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-24-2">
          <div class="snippet-header">
            <h3 class="snippet-title">24.2 @require_auth, @admin_only</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> ×‘×§×¨×ª ×’×™×©×” ×¤×©×•×˜×” ×•×™×¢×™×œ×”</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from functools import wraps
from telegram import Update
from telegram.ext import ContextTypes

def require_auth(func):
    """Require user to be registered"""
    @wraps(func)
    async def wrapper(update: Update, context: ContextTypes.DEFAULT_TYPE):
        user_id = update.effective_user.id
        
        user = await db.get_user(user_id)
        if not user:
            await update.message.reply_text(
                "âš ï¸ Please register first with /start"
            )
            return
        
        return await func(update, context)
    return wrapper

def admin_only(func):
    """Restrict command to admin users"""
    @wraps(func)
    async def wrapper(update: Update, context: ContextTypes.DEFAULT_TYPE):
        user_id = update.effective_user.id
        
        if user_id not in ADMIN_USER_IDS:
            await update.message.reply_text("â›” Admin access required")
            return
        
        return await func(update, context)
    return wrapper

def chat_type(*allowed_types):
    """Restrict to specific chat types (private, group, channel)"""
    def decorator(func):
        @wraps(func)
        async def wrapper(update: Update, context: ContextTypes.DEFAULT_TYPE):
            chat_type = update.effective_chat.type
            
            if chat_type not in allowed_types:
                await update.message.reply_text(
                    f"This command works only in: {', '.join(allowed_types)}"
                )
                return
            
            return await func(update, context)
        return wrapper
    return decorator

# Usage
@admin_only
async def ban_user(update, context):
    # Only admins can use this
    pass

@require_auth
@chat_type("private")
async def settings(update, context):
    # Only registered users in private chat
    pass</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-24-3">
          <div class="snippet-header">
            <h3 class="snippet-title">24.3 @log_execution_time</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> ×œ×¢×§×•×‘ ××—×¨×™ ×‘×™×¦×•×¢×™× ×•×œ×–×”×•×ª bottlenecks</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from functools import wraps
import time
import logging

logger = logging.getLogger(__name__)

def log_execution_time(threshold_ms: Optional[int] = None):
    """Log execution time, warn if exceeds threshold"""
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            start = time.time()
            
            try:
                result = await func(*args, **kwargs)
                return result
            finally:
                duration_ms = (time.time() - start) * 1000
                
                log_data = {
                    "function": func.__name__,
                    "duration_ms": round(duration_ms, 2)
                }
                
                if threshold_ms and duration_ms &gt; threshold_ms:
                    logger.warning(
                        f"Slow execution: {func.__name__} took {duration_ms:.2f}ms "
                        f"(threshold: {threshold_ms}ms)",
                        extra=log_data
                    )
                else:
                    logger.debug(
                        f"{func.__name__} completed in {duration_ms:.2f}ms",
                        extra=log_data
                    )
        
        return wrapper
    return decorator

# Usage
@log_execution_time(threshold_ms=1000)
async def process_large_file(file_path: str):
    # Will warn if takes &gt; 1 second
    pass</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 25: Telegram Payments & Invoices -->
      <div class="category" id="category-25">
        <div class="category-header">
          <i class="fas fa-credit-card"></i>
          <h2>Telegram Payments & Invoices</h2>
        </div>

        <div class="snippet" id="snippet-25-1">
          <div class="snippet-header">
            <h3 class="snippet-title">25.1 Payment Processing</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> ×œ×§×‘×œ ×ª×©×œ×•××™× ×“×¨×š Telegram ×‘×¦×•×¨×” ×‘×˜×•×—×”</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from telegram import LabeledPrice, Update
from telegram.ext import ContextTypes, PreCheckoutQueryHandler

class PaymentProcessor:
    def __init__(self, provider_token: str):
        self.provider_token = provider_token
    
    async def send_invoice(
        self,
        update: Update,
        title: str,
        description: str,
        payload: str,
        amount: int,  # In smallest currency unit (cents)
        currency: str = "USD"
    ):
        """Send payment invoice to user"""
        await update.message.reply_invoice(
            title=title,
            description=description,
            payload=payload,
            provider_token=self.provider_token,
            currency=currency,
            prices=[LabeledPrice("Price", amount)],
            start_parameter="payment",
            photo_url="https://example.com/product.jpg",  # Optional
            need_name=True,
            need_email=True,
            need_shipping_address=False,
        )
    
    async def handle_pre_checkout(
        self, 
        update: Update, 
        context: ContextTypes.DEFAULT_TYPE
    ):
        """Validate payment before processing"""
        query = update.pre_checkout_query
        
        # Verify payload and amount
        if not await self._validate_payment(query.invoice_payload, query.total_amount):
            await query.answer(
                ok=False,
                error_message="Payment validation failed"
            )
            return
        
        await query.answer(ok=True)
    
    async def handle_successful_payment(
        self,
        update: Update,
        context: ContextTypes.DEFAULT_TYPE
    ):
        """Process successful payment"""
        payment = update.message.successful_payment
        
        # Log payment
        await db.save_payment({
            "user_id": update.effective_user.id,
            "amount": payment.total_amount,
            "currency": payment.currency,
            "payload": payment.invoice_payload,
            "telegram_payment_id": payment.telegram_payment_charge_id
        })
        
        # Grant access or deliver product
        await self._fulfill_order(payment.invoice_payload, update.effective_user.id)
        
        await update.message.reply_text(
            "âœ… Payment successful! Thank you for your purchase."
        )

# Usage
payment_processor = PaymentProcessor(PAYMENT_PROVIDER_TOKEN)
app.add_handler(PreCheckoutQueryHandler(payment_processor.handle_pre_checkout))</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-25-2">
          <div class="snippet-header">
            <h3 class="snippet-title">25.2 Invoice Generation</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> ×œ×™×¦×•×¨ ×—×©×‘×•× ×™×•×ª ××•×‘× ×•×ª ×¢× ××¡×¤×¨ ×¤×¨×™×˜×™×</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from telegram import LabeledPrice
from dataclasses import dataclass
from typing import List

@dataclass
class InvoiceItem:
    label: str
    amount: int  # In cents

class InvoiceBuilder:
    def __init__(self):
        self.items: List[InvoiceItem] = []
    
    def add_item(self, label: str, amount: int):
        """Add item to invoice"""
        self.items.append(InvoiceItem(label, amount))
        return self
    
    def add_tax(self, percentage: float):
        """Add tax based on current total"""
        subtotal = self.get_total()
        tax_amount = int(subtotal * percentage / 100)
        self.items.append(InvoiceItem(f"Tax ({percentage}%)", tax_amount))
        return self
    
    def add_discount(self, label: str, amount: int):
        """Add discount (negative amount)"""
        self.items.append(InvoiceItem(label, -amount))
        return self
    
    def get_total(self) -&gt; int:
        return sum(item.amount for item in self.items)
    
    def build_prices(self) -&gt; List[LabeledPrice]:
        """Convert to Telegram LabeledPrice format"""
        return [
            LabeledPrice(item.label, item.amount)
            for item in self.items
        ]

# Usage
invoice = InvoiceBuilder()
invoice.add_item("Premium Plan (1 month)", 999)  # $9.99
invoice.add_item("Extra Storage (10GB)", 299)     # $2.99
invoice.add_discount("First-time user discount", 200)  # -$2.00
invoice.add_tax(10)  # 10% tax

await bot.send_invoice(
    chat_id=user_id,
    title="Subscription Invoice",
    description="Your monthly subscription",
    payload="subscription_monthly",
    provider_token=PROVIDER_TOKEN,
    currency="USD",
    prices=invoice.build_prices()
)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-25-3">
          <div class="snippet-header">
            <h3 class="snippet-title">25.3 Payment Verification</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> ×œ×•×•×“× ×ª×§×™× ×•×ª ×ª×©×œ×•××™× ×•×œ×× ×•×¢ ×”×•× ××•×ª</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import hmac
import hashlib
from typing import Optional

class PaymentVerifier:
    def __init__(self, bot_token: str):
        self.bot_token = bot_token
    
    def verify_payment_signature(
        self,
        invoice_payload: str,
        total_amount: int,
        currency: str,
        provider_payment_id: str,
        signature: str
    ) -&gt; bool:
        """Verify payment signature from provider"""
        data = f"{invoice_payload}:{total_amount}:{currency}:{provider_payment_id}"
        expected_signature = hmac.new(
            self.bot_token.encode(),
            data.encode(),
            hashlib.sha256
        ).hexdigest()
        
        return hmac.compare_digest(signature, expected_signature)
    
    async def validate_payment(
        self,
        user_id: int,
        invoice_payload: str,
        amount: int
    ) -&gt; tuple[bool, Optional[str]]:
        """Validate payment details before processing"""
        # Check if user exists
        user = await db.get_user(user_id)
        if not user:
            return False, "User not found"
        
        # Check if payment already processed
        existing = await db.get_payment_by_payload(invoice_payload)
        if existing:
            return False, "Payment already processed"
        
        # Validate amount
        expected_amount = await self._get_expected_amount(invoice_payload)
        if amount != expected_amount:
            return False, f"Amount mismatch: expected {expected_amount}, got {amount}"
        
        return True, None

# Usage in pre-checkout handler
verifier = PaymentVerifier(BOT_TOKEN)

async def pre_checkout_callback(update, context):
    query = update.pre_checkout_query
    
    valid, error = await verifier.validate_payment(
        user_id=query.from_user.id,
        invoice_payload=query.invoice_payload,
        amount=query.total_amount
    )
    
    await query.answer(ok=valid, error_message=error)</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 26: Monitoring & Metrics -->
      <div class="category" id="category-26">
        <div class="category-header">
          <i class="fas fa-chart-line"></i>
          <h2>Monitoring & Metrics</h2>
        </div>

        <div class="snippet" id="snippet-26-1">
          <div class="snippet-header">
            <h3 class="snippet-title">26.1 Prometheus Metrics Collection</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> ×œ××¡×•×£ ×•×œ×—×©×•×£ ××˜×¨×™×§×•×ª ×œ× ×™×˜×•×¨ ×‘-Prometheus</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from prometheus_client import Counter, Histogram, Gauge, generate_latest
from functools import wraps
import time

# Define metrics
message_counter = Counter(
    'bot_messages_total',
    'Total messages processed',
    ['command', 'status']
)

response_time = Histogram(
    'bot_response_seconds',
    'Response time distribution',
    ['handler']
)

active_users = Gauge(
    'bot_active_users',
    'Number of active users'
)

error_counter = Counter(
    'bot_errors_total',
    'Total errors',
    ['error_type']
)

class MetricsCollector:
    @staticmethod
    def track_message(command: str, status: str = "success"):
        """Track message processing"""
        message_counter.labels(command=command, status=status).inc()
    
    @staticmethod
    def track_response_time(handler_name: str):
        """Decorator to track handler response time"""
        def decorator(func):
            @wraps(func)
            async def wrapper(*args, **kwargs):
                start = time.time()
                try:
                    result = await func(*args, **kwargs)
                    MetricsCollector.track_message(handler_name, "success")
                    return result
                except Exception as e:
                    MetricsCollector.track_message(handler_name, "error")
                    error_counter.labels(error_type=type(e).__name__).inc()
                    raise
                finally:
                    duration = time.time() - start
                    response_time.labels(handler=handler_name).observe(duration)
            return wrapper
        return decorator
    
    @staticmethod
    async def update_active_users():
        """Update active users gauge"""
        count = await db.count_active_users(minutes=5)
        active_users.set(count)

# Expose metrics endpoint (FastAPI)
from fastapi import FastAPI, Response
app = FastAPI()

@app.get("/metrics")
async def metrics():
    return Response(
        content=generate_latest(),
        media_type="text/plain"
    )

# Usage
@MetricsCollector.track_response_time("start_command")
async def start_command(update, context):
    await update.message.reply_text("Hello!")</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-26-2">
          <div class="snippet-header">
            <h3 class="snippet-title">26.2 Custom Metrics Helpers</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> ×™×¦×™×¨×ª ××˜×¨×™×§×•×ª ××•×ª×××•×ª ××™×©×™×ª ×œ×¦×¨×›×™× ×¡×¤×¦×™×¤×™×™×</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from collections import defaultdict
from datetime import datetime, timedelta
from typing import Dict, List
import json

class CustomMetrics:
    def __init__(self):
        self.metrics: Dict[str, List] = defaultdict(list)
        self.aggregations: Dict[str, float] = {}
    
    def record(self, metric_name: str, value: float, tags: dict = None):
        """Record a metric value with optional tags"""
        self.metrics[metric_name].append({
            "value": value,
            "timestamp": datetime.now().isoformat(),
            "tags": tags or {}
        })
        
        # Keep only last hour of data
        cutoff = datetime.now() - timedelta(hours=1)
        self.metrics[metric_name] = [
            m for m in self.metrics[metric_name]
            if datetime.fromisoformat(m["timestamp"]) &gt; cutoff
        ]
    
    def get_average(self, metric_name: str, minutes: int = 5) -&gt; float:
        """Get average value over last N minutes"""
        cutoff = datetime.now() - timedelta(minutes=minutes)
        values = [
            m["value"] for m in self.metrics.get(metric_name, [])
            if datetime.fromisoformat(m["timestamp"]) &gt; cutoff
        ]
        return sum(values) / len(values) if values else 0
    
    def get_percentile(self, metric_name: str, percentile: int) -&gt; float:
        """Get percentile value (e.g., 95th percentile)"""
        values = sorted([m["value"] for m in self.metrics.get(metric_name, [])])
        if not values:
            return 0
        index = int(len(values) * percentile / 100)
        return values[min(index, len(values) - 1)]
    
    def export_summary(self) -&gt; dict:
        """Export metrics summary"""
        return {
            name: {
                "count": len(values),
                "avg": self.get_average(name, minutes=60),
                "p95": self.get_percentile(name, 95),
                "p99": self.get_percentile(name, 99)
            }
            for name, values in self.metrics.items()
        }

# Usage
metrics = CustomMetrics()

# Track custom metric
metrics.record("api_latency_ms", 45.2, tags={"endpoint": "/users"})
metrics.record("cache_hit_rate", 0.85)

# Get insights
avg_latency = metrics.get_average("api_latency_ms", minutes=5)
p95_latency = metrics.get_percentile("api_latency_ms", 95)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-26-3">
          <div class="snippet-header">
            <h3 class="snippet-title">26.3 Performance Tracking Decorators</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> ×œ×¢×§×•×‘ ××•×˜×•××˜×™×ª ××—×¨×™ ×‘×™×¦×•×¢×™× ×©×œ ×¤×•× ×§×¦×™×•×ª</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from functools import wraps
import time
from typing import Optional, Callable
import asyncio

class PerformanceTracker:
    def __init__(self, metrics_collector):
        self.metrics = metrics_collector
        self.thresholds = {}
    
    def track(
        self, 
        metric_name: Optional[str] = None,
        slow_threshold_ms: Optional[int] = None,
        alert_callback: Optional[Callable] = None
    ):
        """Decorator to track function performance"""
        def decorator(func):
            name = metric_name or f"{func.__module__}.{func.__name__}"
            
            @wraps(func)
            async def wrapper(*args, **kwargs):
                start = time.time()
                exception = None
                
                try:
                    result = await func(*args, **kwargs)
                    return result
                except Exception as e:
                    exception = e
                    raise
                finally:
                    duration_ms = (time.time() - start) * 1000
                    
                    # Record metric
                    self.metrics.record(
                        f"{name}.duration_ms",
                        duration_ms,
                        tags={
                            "success": exception is None,
                            "error_type": type(exception).__name__ if exception else None
                        }
                    )
                    
                    # Alert if slow
                    if slow_threshold_ms and duration_ms &gt; slow_threshold_ms:
                        logger.warning(
                            f"Slow execution: {name} took {duration_ms:.2f}ms "
                            f"(threshold: {slow_threshold_ms}ms)"
                        )
                        
                        if alert_callback:
                            asyncio.create_task(
                                alert_callback(name, duration_ms, slow_threshold_ms)
                            )
            
            return wrapper
        return decorator

# Usage
tracker = PerformanceTracker(metrics)

async def send_alert(func_name, duration, threshold):
    await bot.send_message(
        ADMIN_CHAT_ID,
        f"âš ï¸ Slow function: {func_name}\n"
        f"Duration: {duration:.2f}ms (threshold: {threshold}ms)"
    )

@tracker.track(slow_threshold_ms=1000, alert_callback=send_alert)
async def process_user_request(user_id: int):
    # Your code here
    pass</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 27: Environment & Secrets Management -->
      <div class="category" id="category-27">
        <div class="category-header">
          <i class="fas fa-key"></i>
          <h2>Environment & Secrets Management</h2>
        </div>

        <div class="snippet" id="snippet-27-1">
          <div class="snippet-header">
            <h3 class="snippet-title">27.1 .env Loading with Validation</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> ×œ×˜×¢×•×Ÿ ×”×’×“×¨×•×ª ×‘×¦×•×¨×” ×‘×˜×•×—×” ×¢× ×•×œ×™×“×¦×™×”</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from pydantic import BaseSettings, validator, SecretStr
from typing import Optional, List
import os

class Settings(BaseSettings):
    # Bot settings
    bot_token: SecretStr
    webhook_url: Optional[str] = None
    webhook_secret: SecretStr
    
    # Database
    database_url: SecretStr
    db_pool_size: int = 10
    
    # Redis
    redis_url: Optional[str] = None
    
    # Features
    enable_payments: bool = False
    payment_provider_token: Optional[SecretStr] = None
    
    # Admin
    admin_user_ids: List[int] = []
    
    # API Keys
    openai_api_key: Optional[SecretStr] = None
    
    @validator('bot_token')
    def validate_bot_token(cls, v):
        token = v.get_secret_value()
        if not token or ':' not in token:
            raise ValueError('Invalid bot token format')
        return v
    
    @validator('webhook_url')
    def validate_webhook_url(cls, v):
        if v and not v.startswith('https://'):
            raise ValueError('Webhook URL must use HTTPS')
        return v
    
    @validator('admin_user_ids', pre=True)
    def parse_admin_ids(cls, v):
        if isinstance(v, str):
            return [int(x.strip()) for x in v.split(',') if x.strip()]
        return v
    
    @validator('enable_payments')
    def validate_payment_config(cls, v, values):
        if v and not values.get('payment_provider_token'):
            raise ValueError('payment_provider_token required when payments enabled')
        return v
    
    class Config:
        env_file = '.env'
        env_file_encoding = 'utf-8'
        case_sensitive = False

# Usage
try:
    settings = Settings()
    print("âœ… Configuration loaded successfully")
except Exception as e:
    print(f"âŒ Configuration error: {e}")
    exit(1)

# Access values
BOT_TOKEN = settings.bot_token.get_secret_value()
ADMIN_IDS = settings.admin_user_ids</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-27-2">
          <div class="snippet-header">
            <h3 class="snippet-title">27.2 Secrets Rotation</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> ×œ××¤×©×¨ ×”×—×œ×¤×ª secrets ×‘×œ×™ ×œ×”×¤×¡×™×§ ××ª ×”×©×™×¨×•×ª</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import asyncio
from datetime import datetime, timedelta
from typing import Dict, Optional

class SecretManager:
    def __init__(self):
        self.secrets: Dict[str, dict] = {}
        self.rotation_callbacks = {}
    
    def register_secret(
        self,
        name: str,
        value: str,
        rotation_interval: Optional[timedelta] = None,
        rotation_callback: Optional[callable] = None
    ):
        """Register a secret with optional rotation"""
        self.secrets[name] = {
            "value": value,
            "created_at": datetime.now(),
            "rotation_interval": rotation_interval,
            "last_rotated": datetime.now()
        }
        
        if rotation_callback:
            self.rotation_callbacks[name] = rotation_callback
    
    def get_secret(self, name: str) -&gt; str:
        """Get current secret value"""
        if name not in self.secrets:
            raise KeyError(f"Secret '{name}' not found")
        return self.secrets[name]["value"]
    
    async def rotate_secret(self, name: str, new_value: str):
        """Rotate a secret"""
        if name not in self.secrets:
            raise KeyError(f"Secret '{name}' not found")
        
        old_value = self.secrets[name]["value"]
        
        # Update secret
        self.secrets[name].update({
            "value": new_value,
            "last_rotated": datetime.now()
        })
        
        # Call rotation callback if registered
        if name in self.rotation_callbacks:
            await self.rotation_callbacks[name](old_value, new_value)
        
        logger.info(f"Secret '{name}' rotated successfully")
    
    async def check_rotation_needed(self):
        """Background task to check if secrets need rotation"""
        while True:
            for name, secret in self.secrets.items():
                interval = secret.get("rotation_interval")
                if not interval:
                    continue
                
                time_since_rotation = datetime.now() - secret["last_rotated"]
                if time_since_rotation &gt; interval:
                    logger.warning(
                        f"Secret '{name}' needs rotation "
                        f"(last rotated {time_since_rotation.days} days ago)"
                    )
            
            await asyncio.sleep(3600)  # Check every hour

# Usage
secret_manager = SecretManager()

async def on_webhook_secret_rotation(old_secret, new_secret):
    # Update webhook with new secret
    await bot.set_webhook(
        url=WEBHOOK_URL,
        secret_token=new_secret
    )

secret_manager.register_secret(
    "webhook_secret",
    os.getenv("WEBHOOK_SECRET"),
    rotation_interval=timedelta(days=30),
    rotation_callback=on_webhook_secret_rotation
)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-27-3">
          <div class="snippet-header">
            <h3 class="snippet-title">27.3 Multi-Environment Config</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> ×œ× ×”×œ ×”×’×“×¨×•×ª ×©×•× ×•×ª ×œ-dev/staging/production</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from enum import Enum
from pydantic import BaseSettings
from typing import Dict, Any

class Environment(str, Enum):
    DEVELOPMENT = "development"
    STAGING = "staging"
    PRODUCTION = "production"

class BaseConfig(BaseSettings):
    environment: Environment = Environment.DEVELOPMENT
    debug: bool = False
    
    class Config:
        env_file = '.env'

class DevelopmentConfig(BaseConfig):
    debug: bool = True
    database_url: str = "sqlite:///dev.db"
    log_level: str = "DEBUG"
    enable_sentry: bool = False

class StagingConfig(BaseConfig):
    database_url: str
    log_level: str = "INFO"
    enable_sentry: bool = True
    sentry_environment: str = "staging"

class ProductionConfig(BaseConfig):
    database_url: str
    log_level: str = "WARNING"
    enable_sentry: bool = True
    sentry_environment: str = "production"
    require_https: bool = True

def get_config() -&gt; BaseConfig:
    """Get configuration based on environment"""
    env = os.getenv("ENVIRONMENT", "development").lower()
    
    configs = {
        Environment.DEVELOPMENT: DevelopmentConfig,
        Environment.STAGING: StagingConfig,
        Environment.PRODUCTION: ProductionConfig
    }
    
    config_class = configs.get(Environment(env), DevelopmentConfig)
    return config_class()

# Usage
config = get_config()

if config.environment == Environment.PRODUCTION:
    # Production-specific setup
    pass

logger.setLevel(config.log_level)</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 28: Data Serialization & Validation -->
      <div class="category" id="category-28">
        <div class="category-header">
          <i class="fas fa-check-circle"></i>
          <h2>Data Serialization & Validation</h2>
        </div>

        <div class="snippet" id="snippet-28-1">
          <div class="snippet-header">
            <h3 class="snippet-title">28.1 Pydantic Models for Data</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> ×•×œ×™×“×¦×™×” ×•-typing ×—×–×§ ×œ×›×œ ×”×“××˜×”</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from pydantic import BaseModel, Field, validator
from typing import Optional, List
from datetime import datetime
from enum import Enum

class UserRole(str, Enum):
    USER = "user"
    ADMIN = "admin"
    MODERATOR = "moderator"

class User(BaseModel):
    id: int
    username: Optional[str] = None
    first_name: str
    role: UserRole = UserRole.USER
    created_at: datetime = Field(default_factory=datetime.now)
    is_active: bool = True
    
    @validator('username')
    def validate_username(cls, v):
        if v and (len(v) &lt; 3 or len(v) &gt; 32):
            raise ValueError('Username must be 3-32 characters')
        return v

class Message(BaseModel):
    message_id: int
    user_id: int
    text: str = Field(..., max_length=4096)
    timestamp: datetime = Field(default_factory=datetime.now)
    edited: bool = False
    reply_to: Optional[int] = None
    
    class Config:
        json_encoders = {
            datetime: lambda v: v.isoformat()
        }

class ChatStatistics(BaseModel):
    total_messages: int = 0
    total_users: int = 0
    active_users_24h: int = 0
    messages_by_hour: List[int] = Field(default_factory=lambda: [0] * 24)
    
    def add_message(self, hour: int):
        self.total_messages += 1
        self.messages_by_hour[hour] += 1

# Usage - automatic validation
try:
    user = User(
        id=123,
        username="ab",  # Too short - will raise ValidationError
        first_name="John"
    )
except ValidationError as e:
    print(e.json())

# Serialize to dict/JSON
user_dict = user.dict()
user_json = user.json()

# Parse from dict
user = User.parse_obj({"id": 123, "first_name": "John"})</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-28-2">
          <div class="snippet-header">
            <h3 class="snippet-title">28.2 Custom Validators</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> ×•×œ×™×“×¦×™×•×ª ××•×ª×××•×ª ××™×©×™×ª ×œ×¦×¨×›×™× ×¡×¤×¦×™×¤×™×™×</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from pydantic import BaseModel, validator, root_validator
from typing import Optional
import re

class BotSettings(BaseModel):
    bot_token: str
    webhook_url: Optional[str] = None
    max_message_length: int = 4096
    rate_limit: int = 30
    
    @validator('bot_token')
    def validate_token_format(cls, v):
        """Validate Telegram bot token format"""
        pattern = r'^\d+:[A-Za-z0-9_-]{35}$'
        if not re.match(pattern, v):
            raise ValueError('Invalid bot token format')
        return v
    
    @validator('webhook_url')
    def validate_webhook(cls, v):
        """Ensure webhook uses HTTPS"""
        if v and not v.startswith('https://'):
            raise ValueError('Webhook must use HTTPS')
        return v
    
    @validator('rate_limit')
    def validate_rate_limit(cls, v):
        """Ensure reasonable rate limit"""
        if v &lt; 1 or v &gt; 100:
            raise ValueError('Rate limit must be between 1-100')
        return v
    
    @root_validator
    def validate_settings(cls, values):
        """Cross-field validation"""
        webhook = values.get('webhook_url')
        token = values.get('bot_token')
        
        if webhook:
            # Ensure webhook domain doesn't contain bot token
            if token and token.split(':')[0] in webhook:
                raise ValueError('Webhook URL should not contain bot token')
        
        return values

class UserRegistration(BaseModel):
    email: str
    phone: Optional[str] = None
    age: int
    
    @validator('email')
    def validate_email(cls, v):
        email_pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
        if not re.match(email_pattern, v):
            raise ValueError('Invalid email format')
        return v.lower()
    
    @validator('phone')
    def validate_phone(cls, v):
        if v:
            # Remove common separators
            cleaned = re.sub(r'[-()\s]', '', v)
            if not cleaned.isdigit() or len(cleaned) &lt; 10:
                raise ValueError('Invalid phone number')
            return cleaned
        return v
    
    @validator('age')
    def validate_age(cls, v):
        if v &lt; 13:
            raise ValueError('Must be at least 13 years old')
        if v &gt; 120:
            raise ValueError('Invalid age')
        return v</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-28-3">
          <div class="snippet-header">
            <h3 class="snippet-title">28.3 Serialization Helpers</h3>
            <p class="snippet-description"><strong>××˜×¨×”:</strong> ×”××¨×” × ×•×—×” ×‘×™×Ÿ ×¤×•×¨××˜×™× ×©×•× ×™×</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from pydantic import BaseModel
from typing import Any, Type, List
import json
from datetime import datetime, date
from decimal import Decimal

class EnhancedJSONEncoder(json.JSONEncoder):
    """JSON encoder with support for datetime, Decimal, etc."""
    def default(self, obj):
        if isinstance(obj, (datetime, date)):
            return obj.isoformat()
        if isinstance(obj, Decimal):
            return float(obj)
        if isinstance(obj, BaseModel):
            return obj.dict()
        return super().default(obj)

class SerializationHelper:
    @staticmethod
    def to_json(obj: Any, pretty: bool = False) -&gt; str:
        """Convert object to JSON string"""
        indent = 2 if pretty else None
        return json.dumps(obj, cls=EnhancedJSONEncoder, indent=indent)
    
    @staticmethod
    def from_json(data: str, model: Type[BaseModel]) -&gt; BaseModel:
        """Parse JSON to Pydantic model"""
        return model.parse_raw(data)
    
    @staticmethod
    def batch_serialize(
        items: List[BaseModel],
        exclude_none: bool = True
    ) -&gt; List[dict]:
        """Serialize list of models"""
        return [
            item.dict(exclude_none=exclude_none)
            for item in items
        ]
    
    @staticmethod
    def nested_dict_to_model(
        data: dict,
        model: Type[BaseModel],
        strict: bool = True
    ) -&gt; BaseModel:
        """Convert nested dict to model with error handling"""
        try:
            return model.parse_obj(data)
        except ValidationError as e:
            if strict:
                raise
            # Return partial model with valid fields only
            valid_data = {}
            for field in model.__fields__:
                if field in data:
                    try:
                        valid_data[field] = data[field]
                    except:
                        pass
            return model.parse_obj(valid_data)

# Usage
class UserProfile(BaseModel):
    id: int
    name: str
    email: str
    created_at: datetime

user = UserProfile(
    id=1,
    name="John",
    email="john@example.com",
    created_at=datetime.now()
)

# Serialize
json_str = SerializationHelper.to_json(user, pretty=True)

# Deserialize
user_restored = SerializationHelper.from_json(json_str, UserProfile)

# Batch operations
users = [user, user2, user3]
users_dict = SerializationHelper.batch_serialize(users)</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 29: Conversation Handlers & State Machines -->
      <div class="category" id="category-29">
        <div class="category-header">
          <i class="fas fa-comments"></i>
          <h2>Conversation Handlers & State Machines</h2>
        </div>

        <div class="snippet" id="snippet-29-1">
          <div class="snippet-header">
            <h3 class="snippet-title">29.1 Multi-Step Registration Flow</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> × ×™×”×•×œ ×©×™×—×•×ª ××•×¨×›×‘×•×ª ×¢× ××©×ª××©×™× ×“×¨×š ××¡×¤×¨ ×©×œ×‘×™× (×›××• ×¨×™×©×•×, ×˜×•×¤×¡, ×”×–×× ×”)</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from telegram.ext import ConversationHandler, CommandHandler, MessageHandler, filters

# Define states
NAME, EMAIL, CONFIRM = range(3)

async def start_registration(update, context):
    await update.message.reply_text("××” ×©××š?")
    return NAME

async def get_name(update, context):
    context.user_data['name'] = update.message.text
    await update.message.reply_text("××¢×•×œ×”! ××” ×”××™××™×™×œ ×©×œ×š?")
    return EMAIL

async def get_email(update, context):
    context.user_data['email'] = update.message.text
    await update.message.reply_text(
        f"×©×: {context.user_data['name']}\n"
        f"××™××™×™×œ: {context.user_data['email']}\n"
        "×œ××©×¨? (×›×Ÿ/×œ×)"
    )
    return CONFIRM

async def confirm(update, context):
    if update.message.text.lower() == '×›×Ÿ':
        # Save to database
        await update.message.reply_text("× ×¨×©××ª ×‘×”×¦×œ×—×”! âœ…")
    return ConversationHandler.END

conv_handler = ConversationHandler(
    entry_points=[CommandHandler('register', start_registration)],
    states={
        NAME: [MessageHandler(filters.TEXT &amp; ~filters.COMMAND, get_name)],
        EMAIL: [MessageHandler(filters.TEXT &amp; ~filters.COMMAND, get_email)],
        CONFIRM: [MessageHandler(filters.TEXT &amp; ~filters.COMMAND, confirm)],
    },
    fallbacks=[CommandHandler('cancel', lambda u, c: ConversationHandler.END)],
    conversation_timeout=300  # 5 minutes timeout
)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-29-2">
          <div class="snippet-header">
            <h3 class="snippet-title">29.2 State Persistence with Redis</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×©××™×¨×ª ××¦×‘ ×©×™×—×” ×’× ×× ×”×‘×•×˜ × ×•×¤×œ - ×”××©×ª××© ×××©×™×š ×××™×¤×” ×©×¢×¦×¨</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import redis
import json
from telegram.ext import PicklePersistence, BasePersistence

class RedisPersistence(BasePersistence):
    def __init__(self, redis_url):
        super().__init__()
        self.redis = redis.from_url(redis_url)
    
    async def get_user_data(self):
        data = self.redis.get('user_data')
        return json.loads(data) if data else {}
    
    async def update_user_data(self, user_id, data):
        all_data = await self.get_user_data()
        all_data[user_id] = data
        self.redis.set('user_data', json.dumps(all_data))
    
    async def get_conversation(self, name):
        data = self.redis.get(f'conv:{name}')
        return json.loads(data) if data else {}
    
    async def update_conversation(self, name, key, new_state):
        convs = await self.get_conversation(name)
        if new_state is None:
            convs.pop(key, None)
        else:
            convs[key] = new_state
        self.redis.set(f'conv:{name}', json.dumps(convs))

# Usage
persistence = RedisPersistence('redis://localhost:6379')
app = Application.builder().token(TOKEN).persistence(persistence).build()</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-29-3">
          <div class="snippet-header">
            <h3 class="snippet-title">29.3 Nested Conversation with Sub-States</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×©×™×—×•×ª ××•×¨×›×‘×•×ª ×¢× ×ª×¤×¨×™×˜×™× ×•×ª×ª-×ª×¤×¨×™×˜×™× (×›××• ×”×–×× ×ª ×¤×™×¦×” ×¢× ×ª×•×¡×¤×•×ª)</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">CHOOSE_PIZZA, CHOOSE_SIZE, CHOOSE_TOPPINGS, CONFIRM_ORDER = range(4)
TOPPING_ADD, TOPPING_DONE = range(4, 6)

async def pizza_menu(update, context):
    keyboard = [['××¨×’×¨×™×˜×”', '×¤×¤×¨×•× ×™'], ['×™×¨×§×•×ª', '×—×–×¨×”']]
    await update.message.reply_text(
        "×‘×—×¨ ×¤×™×¦×”:", 
        reply_markup=ReplyKeyboardMarkup(keyboard, one_time_keyboard=True)
    )
    return CHOOSE_PIZZA

async def choose_toppings(update, context):
    context.user_data['pizza'] = update.message.text
    context.user_data['toppings'] = []
    await update.message.reply_text(
        "×”×•×¡×£ ×ª×•×¡×¤×•×ª (××• ×©×œ×— '×¡×™×™××ª×™'):"
    )
    return TOPPING_ADD

async def add_topping(update, context):
    if update.message.text == '×¡×™×™××ª×™':
        return await show_order_summary(update, context)
    
    context.user_data['toppings'].append(update.message.text)
    await update.message.reply_text(f"âœ… × ×•×¡×£ {update.message.text}. ×¢×•×“ ×ª×•×¡×¤×•×ª?")
    return TOPPING_ADD

nested_handler = ConversationHandler(
    entry_points=[CommandHandler('order', pizza_menu)],
    states={
        CHOOSE_PIZZA: [MessageHandler(filters.TEXT, choose_toppings)],
        TOPPING_ADD: [MessageHandler(filters.TEXT, add_topping)],
    },
    fallbacks=[CommandHandler('cancel', cancel_order)]
)</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 30: Telegram Media Handling -->
      <div class="category" id="category-30">
        <div class="category-header">
          <i class="fas fa-photo-video"></i>
          <h2>Telegram Media Handling</h2>
        </div>

        <div class="snippet" id="snippet-30-1">
          <div class="snippet-header">
            <h3 class="snippet-title">30.1 Image Processing & Resize Before Send</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×”×§×˜× ×ª ×ª××•× ×•×ª ×›×“×™ ×œ× ×œ×—×¨×•×’ ××’×‘×•×œ×•×ª ×˜×œ×’×¨× ×•×œ×©×¤×¨ ××”×™×¨×•×ª ×”×¢×œ××”</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from PIL import Image
from io import BytesIO

async def resize_and_send_image(update, context, image_path, max_size=(1280, 1280)):
    """
    Resize image if needed and send to user
    """
    img = Image.open(image_path)
    
    # Resize if too large
    if img.size[0] &gt; max_size[0] or img.size[1] &gt; max_size[1]:
        img.thumbnail(max_size, Image.Resampling.LANCZOS)
    
    # Convert to bytes
    bio = BytesIO()
    img.save(bio, format='JPEG', quality=85, optimize=True)
    bio.seek(0)
    
    await update.message.reply_photo(
        photo=bio,
        caption="×ª××•× ×” ××¢×•×‘×“×ª ×•××•×§×˜× ×ª"
    )

# Handle received images
async def process_received_image(update, context):
    photo = update.message.photo[-1]  # Largest size
    file = await photo.get_file()
    
    bio = BytesIO()
    await file.download_to_memory(bio)
    bio.seek(0)
    
    img = Image.open(bio)
    # Process image...
    width, height = img.size
    await update.message.reply_text(f"×”×ª××•× ×” ×©×œ×š: {width}x{height}px")</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-30-2">
          <div class="snippet-header">
            <h3 class="snippet-title">30.2 Video Thumbnail Generation</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×™×¦×™×¨×ª ×ª××•× ×•×ª ×ª×¦×•×’×” ××§×“×™××” ×œ×¡×¨×˜×•× ×™× ×‘××•×¤×Ÿ ××•×˜×•××˜×™</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import cv2
from pathlib import Path

async def generate_video_thumbnail(video_path, timestamp=1.0):
    """
    Extract frame from video at given timestamp
    """
    cap = cv2.VideoCapture(str(video_path))
    
    # Set position to timestamp (in seconds)
    fps = cap.get(cv2.CAP_PROP_FPS)
    frame_number = int(fps * timestamp)
    cap.set(cv2.CAP_PROP_POS_FRAMES, frame_number)
    
    ret, frame = cap.read()
    cap.release()
    
    if ret:
        # Save as thumbnail
        thumb_path = Path(video_path).with_suffix('.jpg')
        cv2.imwrite(str(thumb_path), frame)
        return thumb_path
    return None

async def send_video_with_thumb(update, context, video_path):
    thumb = await generate_video_thumbnail(video_path)
    
    with open(video_path, 'rb') as video:
        await update.message.reply_video(
            video=video,
            thumbnail=open(thumb, 'rb') if thumb else None,
            caption="×•×™×“××• ×¢× ×ª××•× ×” ×××•×–×¢×¨×ª"
        )</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-30-3">
          <div class="snippet-header">
            <h3 class="snippet-title">30.3 Smart Document Type Detection</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×–×™×”×•×™ ××•×˜×•××˜×™ ×©×œ ×¡×•×’ ×§×•×‘×¥ ×•×˜×™×¤×•×œ ××ª××™× ×œ×›×œ ×¡×•×’</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import magic
from pathlib import Path

class DocumentHandler:
    HANDLERS = {
        'application/pdf': 'handle_pdf',
        'image/': 'handle_image',
        'video/': 'handle_video',
        'text/': 'handle_text',
    }
    
    async def handle_document(self, update, context):
        doc = update.message.document
        file = await doc.get_file()
        
        # Download file
        file_path = f"/tmp/{doc.file_name}"
        await file.download_to_drive(file_path)
        
        # Detect MIME type
        mime = magic.from_file(file_path, mime=True)
        
        # Route to appropriate handler
        for pattern, handler_name in self.HANDLERS.items():
            if mime.startswith(pattern):
                handler = getattr(self, handler_name)
                await handler(update, context, file_path)
                return
        
        await update.message.reply_text(f"×¡×•×’ ×§×•×‘×¥ ×œ× × ×ª××š: {mime}")
    
    async def handle_pdf(self, update, context, path):
        await update.message.reply_text("ğŸ“„ ××¢×‘×“ PDF...")
        # Process PDF
    
    async def handle_image(self, update, context, path):
        await update.message.reply_text("ğŸ–¼ ××¢×‘×“ ×ª××•× ×”...")
        # Process image</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-30-4">
          <div class="snippet-header">
            <h3 class="snippet-title">30.4 Media Compression Before Upload</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×”×§×˜× ×ª ×’×•×“×œ ×§×‘×¦×™× ×œ×¤× ×™ ×”×¢×œ××” - ×—×¡×›×•×Ÿ ×‘×–××Ÿ ×•×‘× ×ª×•× ×™×</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from moviepy.editor import VideoFileClip
import subprocess

async def compress_video(input_path, output_path, target_size_mb=10):
    """
    Compress video to target file size using ffmpeg
    """
    # Get original duration
    clip = VideoFileClip(input_path)
    duration = clip.duration
    clip.close()
    
    # Calculate target bitrate
    target_bitrate = int((target_size_mb * 8192) / duration)
    
    # Compress using ffmpeg
    cmd = [
        'ffmpeg', '-i', input_path,
        '-b:v', f'{target_bitrate}k',
        '-maxrate', f'{target_bitrate}k',
        '-bufsize', f'{target_bitrate * 2}k',
        '-vcodec', 'libx264',
        '-preset', 'medium',
        '-y', output_path
    ]
    
    subprocess.run(cmd, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
    return output_path

async def send_compressed_video(update, context, video_path):
    compressed = await compress_video(video_path, '/tmp/compressed.mp4')
    
    with open(compressed, 'rb') as video:
        await update.message.reply_video(
            video=video,
            caption="×•×™×“××• ×“×—×•×¡"
        )</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 31: Internationalization (i18n) -->
      <div class="category" id="category-31">
        <div class="category-header">
          <i class="fas fa-globe"></i>
          <h2>Internationalization (i18n)</h2>
        </div>

        <div class="snippet" id="snippet-31-1">
          <div class="snippet-header">
            <h3 class="snippet-title">31.1 Multi-Language Support System</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×ª××™×›×” ×‘×¨×™×‘×•×™ ×©×¤×•×ª - ×›×œ ××©×ª××© ×¨×•××” ××ª ×”×‘×•×˜ ×‘×©×¤×” ×©×œ×•</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import json
from pathlib import Path

class I18n:
    def __init__(self, locales_dir='locales'):
        self.locales_dir = Path(locales_dir)
        self.translations = {}
        self._load_translations()
    
    def _load_translations(self):
        for locale_file in self.locales_dir.glob('*.json'):
            lang = locale_file.stem
            with open(locale_file, 'r', encoding='utf-8') as f:
                self.translations[lang] = json.load(f)
    
    def t(self, key, lang='en', **kwargs):
        """Get translation for key"""
        text = self.translations.get(lang, {}).get(key, key)
        return text.format(**kwargs) if kwargs else text
    
    def get_user_lang(self, user):
        """Detect user language from Telegram"""
        return user.language_code or 'en'

# Initialize
i18n = I18n('locales')

async def start(update, context):
    lang = i18n.get_user_lang(update.effective_user)
    greeting = i18n.t('greeting', lang, name=update.effective_user.first_name)
    await update.message.reply_text(greeting)

# locales/he.json
# {
#   "greeting": "×©×œ×•× {name}! ×‘×¨×•×š ×”×‘× ×œ×‘×•×˜",
#   "help": "×× ×™ ×™×›×•×œ ×œ×¢×–×•×¨ ×œ×š ×‘...",
#   "error": "××•×¤×¡! ××©×”×• ×”×©×ª×‘×©"
# }

# locales/en.json
# {
#   "greeting": "Hello {name}! Welcome to the bot",
#   "help": "I can help you with...",
#   "error": "Oops! Something went wrong"
# }</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-31-2">
          <div class="snippet-header">
            <h3 class="snippet-title">31.2 Language Switcher with Inline Keyboard</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××¤×©×¨×•×ª ×œ××©×ª××© ×œ×‘×—×•×¨ ×©×¤×” ×‘×§×œ×•×ª</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from telegram import InlineKeyboardButton, InlineKeyboardMarkup

LANGUAGES = {
    'en': 'ğŸ‡¬ğŸ‡§ English',
    'he': 'ğŸ‡®ğŸ‡± ×¢×‘×¨×™×ª',
    'es': 'ğŸ‡ªğŸ‡¸ EspaÃ±ol',
    'ru': 'ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹'
}

async def change_language(update, context):
    keyboard = [
        [InlineKeyboardButton(name, callback_data=f'lang:{code}')]
        for code, name in LANGUAGES.items()
    ]
    await update.message.reply_text(
        "Choose language / ×‘×—×¨ ×©×¤×”:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def language_callback(update, context):
    query = update.callback_query
    lang = query.data.split(':')[1]
    
    # Save to database
    await save_user_language(query.from_user.id, lang)
    
    await query.answer()
    await query.edit_message_text(
        i18n.t('language_changed', lang)
    )</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-31-3">
          <div class="snippet-header">
            <h3 class="snippet-title">31.3 RTL/LTR Text Handling</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×ª×¦×•×’×” × ×›×•× ×” ×©×œ ×˜×§×¡×˜ ×‘×©×¤×•×ª RTL ×›××• ×¢×‘×¨×™×ª ×•×¢×¨×‘×™×ª</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from telegram.constants import ParseMode

def format_rtl_text(text, lang='he'):
    """
    Add RTL marks for proper text display
    """
    RTL_LANGS = ['he', 'ar', 'fa']
    
    if lang in RTL_LANGS:
        # Add Right-to-Left Mark
        return f"\u200F{text}\u200F"
    return text

async def send_mixed_text(update, context, lang):
    """
    Send message with proper direction marks
    """
    name = "John Doe"  # Latin text
    message = i18n.t('welcome_msg', lang, name=name)
    
    # Format with RTL if needed
    formatted = format_rtl_text(message, lang)
    
    await update.message.reply_text(
        formatted,
        parse_mode=ParseMode.HTML
    )

# Advanced: Mixed content handling
def wrap_ltr_in_rtl(text):
    """
    Wrap English words in RTL context
    """
    import re
    # Find Latin text and wrap with LTR marks
    pattern = r'[a-zA-Z0-9@._-]+'
    return re.sub(pattern, r'\u200E\g&lt;0&gt;\u200E', text)

# Example: "×©×œ×•× John, ×™×© ×œ×š 5 ×”×•×“×¢×•×ª ×—×“×©×•×ª"
# Becomes: "×©×œ×•× â€Johnâ€, ×™×© ×œ×š â€5â€ ×”×•×“×¢×•×ª ×—×“×©×•×ª"</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 32: Command Permissions & Access Control -->
      <div class="category" id="category-32">
        <div class="category-header">
          <i class="fas fa-lock"></i>
          <h2>Command Permissions & Access Control</h2>
        </div>

        <div class="snippet" id="snippet-32-1">
          <div class="snippet-header">
            <h3 class="snippet-title">32.1 Role-Based Access Control Decorator</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×”×’×‘×œ×ª ×’×™×©×” ×œ×¤×§×•×“×•×ª ×œ×¤×™ ×ª×¤×§×™×“ ××©×ª××© (××“××™×Ÿ, VIP, ××©×ª××© ×¨×’×™×œ)</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from functools import wraps
from enum import Enum

class Role(Enum):
    USER = 1
    VIP = 2
    ADMIN = 3

# Mock database
USER_ROLES = {
    12345: Role.ADMIN,
    67890: Role.VIP,
}

def require_role(min_role: Role):
    def decorator(func):
        @wraps(func)
        async def wrapper(update, context):
            user_id = update.effective_user.id
            user_role = USER_ROLES.get(user_id, Role.USER)
            
            if user_role.value &lt; min_role.value:
                await update.message.reply_text(
                    "â›”ï¸ ××™×Ÿ ×œ×š ×”×¨×©××” ×œ×¤×§×•×“×” ×–×•"
                )
                return
            
            return await func(update, context)
        return wrapper
    return decorator

# Usage
@require_role(Role.ADMIN)
async def admin_panel(update, context):
    await update.message.reply_text("ğŸ” ×¤×× ×œ ××“××™×Ÿ")

@require_role(Role.VIP)
async def vip_feature(update, context):
    await update.message.reply_text("â­ï¸ ×¤×™×¦'×¨ VIP")</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-32-2">
          <div class="snippet-header">
            <h3 class="snippet-title">32.2 User Whitelist/Blacklist System</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×—×¡×™××” ××• ××™×©×•×¨ ×©×œ ××©×ª××©×™× ×¡×¤×¦×™×¤×™×™×</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import redis

class AccessControl:
    def __init__(self, redis_client):
        self.redis = redis_client
    
    def add_to_whitelist(self, user_id):
        self.redis.sadd('whitelist', user_id)
    
    def add_to_blacklist(self, user_id):
        self.redis.sadd('blacklist', user_id)
    
    def is_allowed(self, user_id):
        # Check blacklist first
        if self.redis.sismember('blacklist', user_id):
            return False
        
        # If whitelist exists and not empty, check membership
        if self.redis.scard('whitelist') &gt; 0:
            return self.redis.sismember('whitelist', user_id)
        
        # Default: allow
        return True

# Initialize
acl = AccessControl(redis.Redis())

def require_access(func):
    @wraps(func)
    async def wrapper(update, context):
        user_id = update.effective_user.id
        
        if not acl.is_allowed(user_id):
            await update.message.reply_text("ğŸš« ××™×Ÿ ×œ×š ×’×™×©×” ×œ×‘×•×˜ ×–×”")
            return
        
        return await func(update, context)
    return wrapper

# Admin commands to manage access
@require_role(Role.ADMIN)
async def whitelist_user(update, context):
    user_id = int(context.args[0])
    acl.add_to_whitelist(user_id)
    await update.message.reply_text(f"âœ… ××©×ª××© {user_id} × ×•×¡×£ ×œ×¨×©×™××” ×”×œ×‘× ×”")

@require_role(Role.ADMIN)
async def blacklist_user(update, context):
    user_id = int(context.args[0])
    acl.add_to_blacklist(user_id)
    await update.message.reply_text(f"ğŸš« ××©×ª××© {user_id} × ×—×¡×")</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-32-3">
          <div class="snippet-header">
            <h3 class="snippet-title">32.3 Permission Caching for Performance</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×©××™×¨×ª ×”×¨×©××•×ª ×‘××˜××•×Ÿ ×›×“×™ ×œ× ×œ×‘×“×•×§ ×‘DB ×‘×›×œ ×‘×§×©×”</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from functools import lru_cache
from datetime import datetime, timedelta

class PermissionCache:
    def __init__(self, ttl_seconds=300):
        self.cache = {}
        self.ttl = timedelta(seconds=ttl_seconds)
    
    def get(self, user_id):
        if user_id in self.cache:
            cached_data, timestamp = self.cache[user_id]
            if datetime.now() - timestamp &lt; self.ttl:
                return cached_data
            del self.cache[user_id]
        return None
    
    def set(self, user_id, permissions):
        self.cache[user_id] = (permissions, datetime.now())
    
    def invalidate(self, user_id):
        self.cache.pop(user_id, None)

perm_cache = PermissionCache(ttl_seconds=600)  # 10 minutes

async def check_permission(user_id, permission):
    # Try cache first
    cached = perm_cache.get(user_id)
    if cached:
        return permission in cached
    
    # Fetch from database
    user_perms = await db.get_user_permissions(user_id)
    
    # Cache for next time
    perm_cache.set(user_id, user_perms)
    
    return permission in user_perms

def require_permission(permission):
    def decorator(func):
        @wraps(func)
        async def wrapper(update, context):
            user_id = update.effective_user.id
            
            if not await check_permission(user_id, permission):
                await update.message.reply_text("â›”ï¸ ××™×Ÿ ×œ×š ×”×¨×©××”")
                return
            
            return await func(update, context)
        return wrapper
    return decorator

# Usage
@require_permission('delete_posts')
async def delete_post(update, context):
    await update.message.reply_text("ğŸ—‘ ×¤×•×¡×˜ × ××—×§")</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 33: Graceful Shutdown & Cleanup -->
      <div class="category" id="category-33">
        <div class="category-header">
          <i class="fas fa-power-off"></i>
          <h2>Graceful Shutdown & Cleanup</h2>
        </div>

        <div class="snippet" id="snippet-33-1">
          <div class="snippet-header">
            <h3 class="snippet-title">33.1 Complete Shutdown Handler</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×¡×’×™×¨×” × ×§×™×™×” ×©×œ ×”×‘×•×˜ - ×¡×™×•× ×ª×”×œ×™×›×™×, ×¡×’×™×¨×ª ×—×™×‘×•×¨×™×, ×©××™×¨×ª ××¦×‘</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import signal
import asyncio
from telegram.ext import Application

class BotShutdown:
    def __init__(self, app: Application):
        self.app = app
        self.is_shutting_down = False
        
        # Register signal handlers
        signal.signal(signal.SIGTERM, self.handle_signal)
        signal.signal(signal.SIGINT, self.handle_signal)
    
    def handle_signal(self, signum, frame):
        """Handle shutdown signals"""
        if not self.is_shutting_down:
            print(f"\nğŸ›‘ Received signal {signum}, shutting down gracefully...")
            self.is_shutting_down = True
            asyncio.create_task(self.shutdown())
    
    async def shutdown(self):
        """Perform graceful shutdown"""
        # 1. Stop accepting new updates
        await self.app.updater.stop()
        
        # 2. Wait for active handlers to complete
        print("â³ Waiting for handlers to complete...")
        await asyncio.sleep(2)
        
        # 3. Close database connections
        print("ğŸ’¾ Closing database connections...")
        await db.close()
        
        # 4. Close Redis connections
        print("ğŸ”´ Closing Redis...")
        await redis_client.close()
        
        # 5. Save state
        print("ğŸ’¾ Saving state...")
        await save_bot_state()
        
        # 6. Stop the application
        await self.app.stop()
        await self.app.shutdown()
        
        print("âœ… Shutdown complete")

# Usage
app = Application.builder().token(TOKEN).build()
shutdown_handler = BotShutdown(app)

app.run_polling()</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-33-2">
          <div class="snippet-header">
            <h3 class="snippet-title">33.2 In-Flight Request Tracking</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××¢×§×‘ ××—×¨ ×‘×§×©×•×ª ×¤×¢×™×œ×•×ª ×›×“×™ ×œ× ×œ× ×ª×§ ××•×ª×Ÿ ×‘×××¦×¢</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import asyncio
from contextlib import asynccontextmanager

class RequestTracker:
    def __init__(self):
        self.active_requests = set()
        self.shutdown_event = asyncio.Event()
    
    @asynccontextmanager
    async def track_request(self, request_id):
        """Context manager to track active requests"""
        self.active_requests.add(request_id)
        try:
            yield
        finally:
            self.active_requests.remove(request_id)
            
            # If shutting down and no more requests, signal completion
            if self.shutdown_event.is_set() and not self.active_requests:
                print("âœ… All requests completed")
    
    async def wait_for_completion(self, timeout=30):
        """Wait for all requests to complete"""
        self.shutdown_event.set()
        
        if not self.active_requests:
            return True
        
        print(f"â³ Waiting for {len(self.active_requests)} active requests...")
        
        try:
            await asyncio.wait_for(
                self._wait_empty(), 
                timeout=timeout
            )
            return True
        except asyncio.TimeoutError:
            print(f"âš ï¸  Timeout: {len(self.active_requests)} requests still active")
            return False
    
    async def _wait_empty(self):
        while self.active_requests:
            await asyncio.sleep(0.1)

tracker = RequestTracker()

async def long_running_handler(update, context):
    request_id = f"{update.effective_user.id}_{update.update_id}"
    
    async with tracker.track_request(request_id):
        # Long operation
        await update.message.reply_text("××ª×—×™×œ ×¢×™×‘×•×“...")
        await asyncio.sleep(10)  # Simulate work
        await update.message.reply_text("×”×¡×ª×™×™×!")

# In shutdown
async def graceful_shutdown():
    print("ğŸ›‘ Starting shutdown...")
    completed = await tracker.wait_for_completion(timeout=30)
    
    if not completed:
        print("âš ï¸  Force closing remaining requests")</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-33-3">
          <div class="snippet-header">
            <h3 class="snippet-title">33.3 Shutdown Hooks System</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×¨×™×©×•× ×¤×•× ×§×¦×™×•×ª × ×™×§×•×™ ×©×™×¨×•×¦×• ×‘×¡×’×™×¨×”</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class ShutdownHooks:
    def __init__(self):
        self.hooks = []
    
    def register(self, func, *args, **kwargs):
        """Register a cleanup function"""
        self.hooks.append((func, args, kwargs))
    
    async def run_all(self):
        """Execute all hooks"""
        print(f"ğŸ§¹ Running {len(self.hooks)} cleanup hooks...")
        
        for func, args, kwargs in reversed(self.hooks):  # LIFO order
            try:
                if asyncio.iscoroutinefunction(func):
                    await func(*args, **kwargs)
                else:
                    func(*args, **kwargs)
                print(f"âœ… {func.__name__}")
            except Exception as e:
                print(f"âŒ {func.__name__}: {e}")

hooks = ShutdownHooks()

# Register cleanup functions
hooks.register(db.close)
hooks.register(redis_client.close)
hooks.register(close_file_handles)
hooks.register(save_metrics)

# On shutdown
async def shutdown():
    await hooks.run_all()</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 34: Batch Processing & Bulk Operations -->
      <div class="category" id="category-34">
        <div class="category-header">
          <i class="fas fa-layer-group"></i>
          <h2>Batch Processing & Bulk Operations</h2>
        </div>

        <div class="snippet" id="snippet-34-1">
          <div class="snippet-header">
            <h3 class="snippet-title">34.1 Batch Database Inserts</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×”×›× ×¡×ª ××œ×¤×™ ×¨×©×•××•×ª ×œ-DB ×‘×‘×ª ××—×ª ×‘××§×•× ××—×ª-××—×ª (×¤×™ 100 ××”×¨ ×™×•×ª×¨!)</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">async def batch_insert_users(users, batch_size=1000):
    """
    Insert users in batches for better performance
    """
    from motor.motor_asyncio import AsyncIOMotorClient
    
    db = AsyncIOMotorClient()['mybot']
    collection = db['users']
    
    total = len(users)
    inserted = 0
    
    for i in range(0, total, batch_size):
        batch = users[i:i + batch_size]
        
        try:
            result = await collection.insert_many(batch, ordered=False)
            inserted += len(result.inserted_ids)
            print(f"âœ… Inserted {inserted}/{total}")
        except Exception as e:
            print(f"âŒ Batch {i} failed: {e}")
    
    return inserted

# Usage
users = [
    {'user_id': i, 'name': f'User{i}', 'joined': datetime.now()}
    for i in range(10000)
]

await batch_insert_users(users)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-34-2">
          <div class="snippet-header">
            <h3 class="snippet-title">34.2 Bulk Message Sending with Rate Limiting</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×©×œ×™×—×ª ×”×•×“×¢×•×ª ×œ××œ×¤×™ ××©×ª××©×™× ×‘×œ×™ ×œ×—×¨×•×’ ×××’×‘×œ×•×ª ×˜×œ×’×¨×</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import asyncio
from telegram.error import RetryAfter, TelegramError

async def bulk_send_messages(bot, user_ids, text, delay=0.05):
    """
    Send message to multiple users with rate limiting
    30 messages/second for different users
    """
    results = {'success': 0, 'failed': 0, 'blocked': 0}
    
    for user_id in user_ids:
        try:
            await bot.send_message(chat_id=user_id, text=text)
            results['success'] += 1
            await asyncio.sleep(delay)  # Rate limit
            
        except RetryAfter as e:
            print(f"â¸ Rate limited, waiting {e.retry_after}s")
            await asyncio.sleep(e.retry_after)
            # Retry
            await bot.send_message(chat_id=user_id, text=text)
            
        except TelegramError as e:
            if 'blocked' in str(e).lower():
                results['blocked'] += 1
            else:
                results['failed'] += 1
                print(f"âŒ Failed {user_id}: {e}")
    
    return results

# Usage with progress bar
async def send_broadcast(bot, message):
    users = await db.get_all_user_ids()
    print(f"ğŸ“¢ Sending to {len(users)} users...")
    
    results = await bulk_send_messages(bot, users, message)
    
    print(f"âœ… Success: {results['success']}")
    print(f"âŒ Failed: {results['failed']}")
    print(f"ğŸš« Blocked: {results['blocked']}")</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-34-3">
          <div class="snippet-header">
            <h3 class="snippet-title">34.3 Chunked Processing with Progress</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×¢×™×‘×•×“ ×›××•×™×•×ª ×’×“×•×œ×•×ª ×©×œ × ×ª×•× ×™× ×‘×—×œ×§×™× ×¢× ××¢×§×‘ ×”×ª×§×“××•×ª</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">async def process_in_chunks(items, process_func, chunk_size=100, progress_callback=None):
    """
    Process large dataset in chunks with progress tracking
    """
    total = len(items)
    processed = 0
    results = []
    
    for i in range(0, total, chunk_size):
        chunk = items[i:i + chunk_size]
        
        # Process chunk
        chunk_results = await asyncio.gather(*[
            process_func(item) for item in chunk
        ])
        
        results.extend(chunk_results)
        processed += len(chunk)
        
        # Report progress
        progress = (processed / total) * 100
        if progress_callback:
            await progress_callback(processed, total, progress)
        
        print(f"â³ {processed}/{total} ({progress:.1f}%)")
    
    return results

# Usage example
async def process_image(image_data):
    # Simulate processing
    await asyncio.sleep(0.1)
    return f"processed_{image_data['id']}"

async def progress_update(current, total, percent):
    # Update bot message with progress
    await bot.edit_message_text(
        chat_id=admin_chat,
        message_id=progress_msg_id,
        text=f"â³ ××¢×‘×“: {current}/{total} ({percent:.1f}%)"
    )

images = [{'id': i, 'url': f'img{i}.jpg'} for i in range(1000)]
results = await process_in_chunks(
    images, 
    process_image, 
    chunk_size=50,
    progress_callback=progress_update
)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-34-4">
          <div class="snippet-header">
            <h3 class="snippet-title">34.4 Batch Export to CSV</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×™×™×¦×•× ×›××•×™×•×ª ×’×“×•×œ×•×ª ×©×œ × ×ª×•× ×™× ×œ-CSV ×‘×™×¢×™×œ×•×ª</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import csv
from io import StringIO

async def export_users_to_csv(batch_size=1000):
    """
    Export all users to CSV in batches (memory efficient)
    """
    output = StringIO()
    writer = csv.writer(output)
    
    # Write header
    writer.writerow(['User ID', 'Name', 'Joined', 'Active'])
    
    skip = 0
    while True:
        # Fetch batch
        users = await db.users.find().skip(skip).limit(batch_size).to_list()
        
        if not users:
            break
        
        # Write batch
        for user in users:
            writer.writerow([
                user['user_id'],
                user.get('name', 'N/A'),
                user.get('joined_at', ''),
                user.get('is_active', False)
            ])
        
        skip += batch_size
        print(f"ğŸ“Š Exported {skip} users...")
    
    # Get CSV content
    output.seek(0)
    return output.getvalue()

# Send to admin
async def send_user_export(update, context):
    await update.message.reply_text("â³ ××™×™×¦× × ×ª×•× ×™×...")
    
    csv_data = await export_users_to_csv()
    
    from io import BytesIO
    file = BytesIO(csv_data.encode('utf-8'))
    file.name = 'users_export.csv'
    
    await update.message.reply_document(
        document=file,
        filename='users_export.csv',
        caption=f"ğŸ“Š ×™×™×¦×•× ××©×ª××©×™×"
    )</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 35: Telegram Channel/Group Management -->
      <div class="category" id="category-35">
        <div class="category-header">
          <i class="fas fa-users"></i>
          <h2>Telegram Channel/Group Management</h2>
        </div>

        <div class="snippet" id="snippet-35-1">
          <div class="snippet-header">
            <h3 class="snippet-title">35.1 Auto-Moderation System</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> × ×™×”×•×œ ××•×˜×•××˜×™ ×©×œ ×§×‘×•×¦×•×ª - ×—×¡×™××ª ×¡×¤××, ×§×™×©×•×¨×™×, ×©×¤×” ×’×¡×”</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import re
from telegram import ChatPermissions

class AutoModerator:
    SPAM_PATTERNS = [
        r'http[s]?://(?:[a-zA-Z]|[0-9]|[$-_@.&amp;+]|[!*\\(\\),]|(?:%[0-9a-fA-F][0-9a-fA-F]))+',
        r'@\w+',  # Mentions
        r'(.)\1{4,}',  # Repeated characters
    ]
    
    BAD_WORDS = ['spam', '×§×–×™× ×•', '×”×™××•×¨×™×']  # Add your words
    
    async def check_message(self, update, context):
        message = update.message
        text = message.text or message.caption or ''
        
        # Check for spam patterns
        for pattern in self.SPAM_PATTERNS:
            if re.search(pattern, text, re.IGNORECASE):
                await self.handle_violation(message, 'spam_link')
                return True
        
        # Check for bad words
        text_lower = text.lower()
        if any(word in text_lower for word in self.BAD_WORDS):
            await self.handle_violation(message, 'bad_language')
            return True
        
        # Check flood (too many messages)
        if await self.is_flooding(message.from_user.id):
            await self.handle_violation(message, 'flooding')
            return True
        
        return False
    
    async def handle_violation(self, message, reason):
        # Delete message
        await message.delete()
        
        # Warn user
        user_id = message.from_user.id
        warnings = await db.increment_warnings(user_id)
        
        if warnings &gt;= 3:
            # Ban user
            await message.chat.ban_member(user_id)
            await message.chat.send_message(
                f"ğŸš« {message.from_user.mention_html()} × ×—×¡× ×œ×¦××™×ª×•×ª (3 ××–×”×¨×•×ª)"
            )
        else:
            # Restrict for 1 hour
            await message.chat.restrict_member(
                user_id,
                permissions=ChatPermissions(can_send_messages=False),
                until_date=datetime.now() + timedelta(hours=1)
            )
            await message.chat.send_message(
                f"âš ï¸ {message.from_user.mention_html()} ×”×•×©×ª×§ ×œ×©×¢×” ({reason})"
            )
    
    async def is_flooding(self, user_id):
        # Check Redis for message count in last minute
        key = f'flood:{user_id}'
        count = await redis.incr(key)
        
        if count == 1:
            await redis.expire(key, 60)
        
        return count &gt; 10  # More than 10 messages/minute

moderator = AutoModerator()

async def group_message_handler(update, context):
    if await moderator.check_message(update, context):
        return  # Message was moderated
    
    # Process normal message</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-35-2">
          <div class="snippet-header">
            <h3 class="snippet-title">35.2 Member Management Utilities</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×›×œ×™× × ×•×—×™× ×œ× ×™×”×•×œ ×—×‘×¨×™ ×§×‘×•×¦×”</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">async def get_group_stats(chat_id):
    """Get comprehensive group statistics"""
    stats = {
        'total_members': 0,
        'admins': [],
        'bots': 0,
        'restricted': 0
    }
    
    # Get member count
    stats['total_members'] = await bot.get_chat_member_count(chat_id)
    
    # Get administrators
    admins = await bot.get_chat_administrators(chat_id)
    stats['admins'] = [
        {
            'id': admin.user.id,
            'name': admin.user.full_name,
            'status': admin.status
        }
        for admin in admins
    ]
    
    stats['bots'] = sum(1 for admin in admins if admin.user.is_bot)
    
    return stats

async def bulk_ban_users(chat_id, user_ids, reason="×”×¤×¨×ª ×›×œ×œ×™×"):
    """Ban multiple users at once"""
    results = {'success': 0, 'failed': 0}
    
    for user_id in user_ids:
        try:
            await bot.ban_chat_member(chat_id, user_id)
            results['success'] += 1
            
            # Log to admin channel
            await bot.send_message(
                admin_channel_id,
                f"ğŸš« User {user_id} banned from {chat_id}\nReason: {reason}"
            )
        except Exception as e:
            results['failed'] += 1
            print(f"Failed to ban {user_id}: {e}")
    
    return results

async def cleanup_inactive_members(chat_id, days=30):
    """Remove members who haven't sent a message in X days"""
    cutoff = datetime.now() - timedelta(days=days)
    inactive = await db.find({
        'chat_id': chat_id,
        'last_message': {'$lt': cutoff}
    })
    
    removed = 0
    for member in inactive:
        try:
            await bot.ban_chat_member(chat_id, member['user_id'])
            await bot.unban_chat_member(chat_id, member['user_id'])  # Soft kick
            removed += 1
        except:
            pass
    
    return removed</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-35-3">
          <div class="snippet-header">
            <h3 class="snippet-title">35.3 Channel Posting Helpers</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×›×œ×™× ×œ×¤×¨×¡×•× ××•×˜×•××˜×™ ×‘×¢×¨×•×¦×™×</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from telegram.constants import ParseMode

class ChannelPoster:
    def __init__(self, channel_id):
        self.channel_id = channel_id
    
    async def post_with_preview(self, title, text, image_url=None, link=None):
        """Post with link preview"""
        message = f"&lt;b&gt;{title}&lt;/b&gt;\n\n{text}"
        
        if link:
            message += f"\n\nğŸ”— &lt;a href='{link}'&gt;×§×¨× ×¢×•×“&lt;/a&gt;"
        
        if image_url:
            await bot.send_photo(
                chat_id=self.channel_id,
                photo=image_url,
                caption=message,
                parse_mode=ParseMode.HTML
            )
        else:
            await bot.send_message(
                chat_id=self.channel_id,
                text=message,
                parse_mode=ParseMode.HTML,
                disable_web_page_preview=False
            )
    
    async def schedule_post(self, content, scheduled_time):
        """Schedule a post for later"""
        await db.scheduled_posts.insert_one({
            'channel_id': self.channel_id,
            'content': content,
            'scheduled_for': scheduled_time,
            'status': 'pending'
        })
    
    async def post_poll(self, question, options, is_anonymous=True):
        """Post a poll"""
        await bot.send_poll(
            chat_id=self.channel_id,
            question=question,
            options=options,
            is_anonymous=is_anonymous
        )

# Background job to send scheduled posts
async def send_scheduled_posts(context):
    now = datetime.now()
    posts = await db.scheduled_posts.find({
        'scheduled_for': {'$lte': now},
        'status': 'pending'
    })
    
    for post in posts:
        try:
            await bot.send_message(
                chat_id=post['channel_id'],
                text=post['content']
            )
            
            await db.scheduled_posts.update_one(
                {'_id': post['_id']},
                {'$set': {'status': 'sent', 'sent_at': now}}
            )
        except Exception as e:
            print(f"Failed to send scheduled post: {e}")</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 36: Data Export/Import -->
      <div class="category" id="category-36">
        <div class="category-header">
          <i class="fas fa-file-export"></i>
          <h2>Data Export/Import</h2>
        </div>

        <div class="snippet" id="snippet-36-1">
          <div class="snippet-header">
            <h3 class="snippet-title">36.1 CSV Export with Streaming</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×™×™×¦×•× × ×ª×•× ×™× ×’×“×•×œ×™× ×œ×œ× ×˜×¢×™× ×ª ×”×›×œ ×œ×–×™×›×¨×•×Ÿ</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import csv
from io import StringIO, BytesIO

async def stream_export_to_csv(query_filter=None):
    """
    Stream large dataset to CSV without loading all into memory
    """
    output = StringIO()
    writer = csv.writer(output)
    
    # Write header
    writer.writerow(['ID', 'Username', 'Email', 'Created', 'Active'])
    
    # Stream from database
    async for user in db.users.find(query_filter or {}):
        writer.writerow([
            user['_id'],
            user.get('username', ''),
            user.get('email', ''),
            user.get('created_at', ''),
            user.get('is_active', False)
        ])
    
    # Convert to bytes for sending
    output.seek(0)
    bytes_output = BytesIO(output.getvalue().encode('utf-8-sig'))  # BOM for Excel
    bytes_output.name = 'export.csv'
    
    return bytes_output

# Command to export
async def export_data(update, context):
    await update.message.reply_text("â³ ××™×™×¦× × ×ª×•× ×™×...")
    
    csv_file = await stream_export_to_csv()
    
    await update.message.reply_document(
        document=csv_file,
        filename=f'export_{datetime.now():%Y%m%d}.csv',
        caption="âœ… ×”× ×ª×•× ×™× ×©×œ×š ××•×›× ×™×!"
    )</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-36-2">
          <div class="snippet-header">
            <h3 class="snippet-title">36.2 JSON Import with Validation</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×™×™×‘×•× ×××•×‘×˜×— ×©×œ × ×ª×•× ×™× ×¢× ×‘×“×™×§×•×ª ×ª×§×™× ×•×ª</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import json
from pydantic import BaseModel, ValidationError
from typing import List

class UserImport(BaseModel):
    user_id: int
    username: str
    email: str | None = None
    role: str = 'user'

async def import_from_json(file_path, validate=True):
    """
    Import data from JSON with optional validation
    """
    with open(file_path, 'r', encoding='utf-8') as f:
        data = json.load(f)
    
    results = {
        'imported': 0,
        'failed': 0,
        'errors': []
    }
    
    for item in data:
        try:
            # Validate with Pydantic
            if validate:
                user = UserImport(**item)
                item = user.dict()
            
            # Insert to database
            await db.users.insert_one(item)
            results['imported'] += 1
            
        except ValidationError as e:
            results['failed'] += 1
            results['errors'].append({
                'item': item,
                'error': str(e)
            })
        except Exception as e:
            results['failed'] += 1
            results['errors'].append({
                'item': item,
                'error': str(e)
            })
    
    return results

# Handler for file upload
async def handle_import_file(update, context):
    doc = update.message.document
    
    if not doc.file_name.endswith('.json'):
        await update.message.reply_text("âŒ ×¨×§ ×§×‘×¦×™ JSON × ×ª××›×™×")
        return
    
    # Download file
    file = await doc.get_file()
    file_path = f"/tmp/{doc.file_name}"
    await file.download_to_drive(file_path)
    
    # Import
    results = await import_from_json(file_path, validate=True)
    
    await update.message.reply_text(
        f"âœ… ×™×•×‘××•: {results['imported']}\n"
        f"âŒ × ×›×©×œ×•: {results['failed']}"
    )</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-36-3">
          <div class="snippet-header">
            <h3 class="snippet-title">36.3 Backup/Restore Complete Database</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×’×™×‘×•×™ ×•×©×—×–×•×¨ ××œ× ×©×œ DB ×‘×¤×§×•×“×” ××—×ª</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import gzip
import pickle
from datetime import datetime

async def create_backup():
    """
    Create compressed backup of entire database
    """
    backup_data = {}
    
    # Export all collections
    for collection_name in await db.list_collection_names():
        collection = db[collection_name]
        docs = await collection.find().to_list(length=None)
        backup_data[collection_name] = docs
    
    # Add metadata
    backup_data['_metadata'] = {
        'created_at': datetime.now().isoformat(),
        'version': '1.0',
        'collections': list(backup_data.keys())
    }
    
    # Compress and save
    filename = f"backup_{datetime.now():%Y%m%d_%H%M%S}.gz"
    
    with gzip.open(filename, 'wb') as f:
        pickle.dump(backup_data, f)
    
    return filename

async def restore_backup(backup_file):
    """
    Restore database from backup file
    """
    # Load backup
    with gzip.open(backup_file, 'rb') as f:
        backup_data = pickle.load(f)
    
    # Verify metadata
    metadata = backup_data.pop('_metadata', {})
    print(f"Restoring backup from {metadata.get('created_at')}")
    
    # Restore each collection
    for collection_name, docs in backup_data.items():
        collection = db[collection_name]
        
        # Clear existing data (optional)
        await collection.delete_many({})
        
        # Insert backup data
        if docs:
            await collection.insert_many(docs)
        
        print(f"âœ… Restored {len(docs)} docs to {collection_name}")

# Admin commands
async def backup_command(update, context):
    await update.message.reply_text("â³ ×™×•×¦×¨ ×’×™×‘×•×™...")
    
    filename = await create_backup()
    
    with open(filename, 'rb') as f:
        await update.message.reply_document(
            document=f,
            filename=filename,
            caption="ğŸ’¾ ×’×™×‘×•×™ ××œ× ×©×œ ×”× ×ª×•× ×™×"
        )

async def restore_command(update, context):
    """Usage: /restore &lt;reply to backup file&gt;"""
    if not update.message.reply_to_message or not update.message.reply_to_message.document:
        await update.message.reply_text("âŒ ×”×©×‘ ×œ×§×•×‘×¥ ×’×™×‘×•×™")
        return
    
    doc = update.message.reply_to_message.document
    file = await doc.get_file()
    file_path = f"/tmp/{doc.file_name}"
    await file.download_to_drive(file_path)
    
    await update.message.reply_text("â³ ××©×—×–×¨ × ×ª×•× ×™×...")
    
    await restore_backup(file_path)
    
    await update.message.reply_text("âœ… ×©×•×—×–×¨ ×‘×”×¦×œ×—×”!")</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-36-4">
          <div class="snippet-header">
            <h3 class="snippet-title">36.4 Data Transformation Pipeline</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×”××¨×” ×•×”×¢×‘×¨×ª × ×ª×•× ×™× ×‘×™×Ÿ ××‘× ×™× ×©×•× ×™×</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from typing import Callable, List

class DataTransformer:
    def __init__(self):
        self.transforms: List[Callable] = []
    
    def add_transform(self, func: Callable):
        """Add transformation function to pipeline"""
        self.transforms.append(func)
        return self
    
    async def process(self, data):
        """Run all transformations on data"""
        result = data
        
        for transform in self.transforms:
            if asyncio.iscoroutinefunction(transform):
                result = await transform(result)
            else:
                result = transform(result)
        
        return result
    
    async def process_batch(self, data_list):
        """Process multiple items"""
        return [await self.process(item) for item in data_list]

# Example transformations
def normalize_phone(user):
    """Normalize phone number format"""
    if 'phone' in user:
        phone = user['phone'].replace('-', '').replace(' ', '')
        user['phone'] = phone
    return user

def add_full_name(user):
    """Combine first and last name"""
    user['full_name'] = f"{user.get('first_name', '')} {user.get('last_name', '')}".strip()
    return user

async def enrich_with_location(user):
    """Add location data from external API"""
    if 'city' in user:
        location = await get_city_coordinates(user['city'])
        user['coordinates'] = location
    return user

# Build pipeline
transformer = DataTransformer()
transformer.add_transform(normalize_phone)
transformer.add_transform(add_full_name)
transformer.add_transform(enrich_with_location)

# Use it
users = await db.old_users.find().to_list()
transformed = await transformer.process_batch(users)
await db.new_users.insert_many(transformed)</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 37: Performance Monitoring -->
      <div class="category" id="category-37">
        <div class="category-header">
          <i class="fas fa-chart-bar"></i>
          <h2>Performance Monitoring</h2>
        </div>

        <div class="snippet" id="snippet-37-1">
          <div class="snippet-header">
            <h3 class="snippet-title">37.1 Query Performance Tracker</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×–×™×”×•×™ ×©××™×œ×ª×•×ª ××™×˜×™×•×ª ×œ-DB - ××•×¤×˜×™××™×–×¦×™×” ×™×¢×™×œ×”</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import time
from functools import wraps

class QueryMonitor:
    def __init__(self, slow_threshold=1.0):
        self.slow_threshold = slow_threshold
        self.slow_queries = []
    
    def track_query(self, collection_name):
        """Decorator to track query performance"""
        def decorator(func):
            @wraps(func)
            async def wrapper(*args, **kwargs):
                start = time.time()
                result = await func(*args, **kwargs)
                duration = time.time() - start
                
                if duration &gt; self.slow_threshold:
                    self.slow_queries.append({
                        'collection': collection_name,
                        'function': func.__name__,
                        'duration': duration,
                        'timestamp': datetime.now()
                    })
                    print(f"âš ï¸  Slow query: {func.__name__} took {duration:.2f}s")
                
                return result
            return wrapper
        return decorator
    
    def get_slow_queries(self):
        """Get list of slow queries"""
        return sorted(self.slow_queries, key=lambda x: x['duration'], reverse=True)

monitor = QueryMonitor(slow_threshold=0.5)

# Usage
@monitor.track_query('users')
async def find_user_by_email(email):
    return await db.users.find_one({'email': email})

@monitor.track_query('posts')
async def get_user_posts(user_id):
    return await db.posts.find({'user_id': user_id}).to_list()

# Admin command to view slow queries
async def show_slow_queries(update, context):
    slow = monitor.get_slow_queries()[:10]
    
    if not slow:
        await update.message.reply_text("âœ… ××™×Ÿ ×©××™×œ×ª×•×ª ××™×˜×™×•×ª")
        return
    
    text = "ğŸŒ ×”×©××™×œ×ª×•×ª ×”××™×˜×™×•×ª:\n\n"
    for q in slow:
        text += f"â€¢ {q['collection']}.{q['function']}: {q['duration']:.2f}s\n"
    
    await update.message.reply_text(text)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-37-2">
          <div class="snippet-header">
            <h3 class="snippet-title">37.2 Memory Usage Monitor</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××¢×§×‘ ××—×¨ ×¦×¨×™×›×ª ×–×™×›×¨×•×Ÿ - ×× ×™×¢×ª ×§×¨×™×¡×•×ª</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import psutil
import os

class MemoryMonitor:
    def __init__(self, alert_threshold_mb=500):
        self.process = psutil.Process(os.getpid())
        self.alert_threshold = alert_threshold_mb * 1024 * 1024  # Convert to bytes
        self.baseline = self.get_memory_usage()
    
    def get_memory_usage(self):
        """Get current memory usage in MB"""
        return self.process.memory_info().rss / 1024 / 1024
    
    def get_memory_stats(self):
        """Get detailed memory statistics"""
        mem = self.process.memory_info()
        return {
            'rss_mb': mem.rss / 1024 / 1024,
            'vms_mb': mem.vms / 1024 / 1024,
            'percent': self.process.memory_percent(),
            'increase_mb': (mem.rss - self.baseline * 1024 * 1024) / 1024 / 1024
        }
    
    async def check_and_alert(self, bot, admin_chat_id):
        """Check memory and alert if threshold exceeded"""
        current = self.get_memory_usage()
        
        if current &gt; self.alert_threshold / 1024 / 1024:
            stats = self.get_memory_stats()
            await bot.send_message(
                chat_id=admin_chat_id,
                text=f"âš ï¸ ×–×™×›×¨×•×Ÿ ×’×‘×•×”!\n\n"
                     f"×©×™××•×©: {stats['rss_mb']:.1f} MB\n"
                     f"××—×•×–: {stats['percent']:.1f}%\n"
                     f"×¢×œ×™×™×”: +{stats['increase_mb']:.1f} MB"
            )

memory_monitor = MemoryMonitor(alert_threshold_mb=500)

# Background job to check memory
async def check_memory_job(context):
    await memory_monitor.check_and_alert(
        context.bot,
        admin_chat_id=ADMIN_CHAT_ID
    )

# Add job every 5 minutes
job_queue.run_repeating(check_memory_job, interval=300)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-37-3">
          <div class="snippet-header">
            <h3 class="snippet-title">37.3 Slow Request Detection</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××¢×§×‘ ××—×¨ ×‘×§×©×•×ª ×©×œ×•×§×—×•×ª ×”×¨×‘×” ×–××Ÿ - ×©×™×¤×•×¨ ×—×•×•×™×™×ª ××©×ª××©</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class RequestTimer:
    def __init__(self, slow_threshold=2.0):
        self.slow_threshold = slow_threshold
        self.slow_requests = []
    
    def time_request(self, func):
        """Decorator to time request handlers"""
        @wraps(func)
        async def wrapper(update, context):
            start = time.time()
            user_id = update.effective_user.id if update.effective_user else 'unknown'
            
            try:
                result = await func(update, context)
                duration = time.time() - start
                
                if duration &gt; self.slow_threshold:
                    self.slow_requests.append({
                        'handler': func.__name__,
                        'user_id': user_id,
                        'duration': duration,
                        'timestamp': datetime.now()
                    })
                    
                    print(f"ğŸŒ Slow request: {func.__name__} "
                          f"by user {user_id} took {duration:.2f}s")
                
                return result
            except Exception as e:
                duration = time.time() - start
                print(f"âŒ Request failed after {duration:.2f}s: {e}")
                raise
        
        return wrapper

timer = RequestTimer(slow_threshold=1.5)

# Apply to handlers
@timer.time_request
async def search_command(update, context):
    query = ' '.join(context.args)
    results = await db.search(query)  # Potentially slow
    await update.message.reply_text(f"× ××¦××• {len(results)} ×ª×•×¦××•×ª")

# Get statistics
async def request_stats(update, context):
    if not timer.slow_requests:
        await update.message.reply_text("âœ… ×›×œ ×”×‘×§×©×•×ª ××”×™×¨×•×ª")
        return
    
    # Group by handler
    from collections import Counter
    handlers = Counter(r['handler'] for r in timer.slow_requests)
    
    text = "ğŸŒ ×”×‘×§×©×•×ª ×”××™×˜×™×•×ª:\n\n"
    for handler, count in handlers.most_common(5):
        text += f"â€¢ {handler}: {count} ×¤×¢××™×\n"
    
    await update.message.reply_text(text)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-37-4">
          <div class="snippet-header">
            <h3 class="snippet-title">37.4 Performance Profiling Decorator</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×¤×¨×•×¤×™×™×œ×™× ×’ ××¤×•×¨×˜ ×©×œ ×¤×•× ×§×¦×™×•×ª - ××¦×™××ª ×¦×•×•××¨×™ ×‘×§×‘×•×§</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import cProfile
import pstats
from io import StringIO

def profile_performance(func):
    """Profile function performance and print results"""
    @wraps(func)
    async def wrapper(*args, **kwargs):
        profiler = cProfile.Profile()
        profiler.enable()
        
        result = await func(*args, **kwargs)
        
        profiler.disable()
        
        # Get stats
        s = StringIO()
        ps = pstats.Stats(profiler, stream=s).sort_stats('cumulative')
        ps.print_stats(10)  # Top 10
        
        print(f"\n{'='*50}")
        print(f"Profile for {func.__name__}")
        print('='*50)
        print(s.getvalue())
        
        return result
    return wrapper

# Usage on complex functions
@profile_performance
async def complex_report_generation(user_id):
    # Multiple slow operations
    user = await db.users.find_one({'_id': user_id})
    posts = await db.posts.find({'user_id': user_id}).to_list()
    stats = await calculate_statistics(posts)
    report = await generate_pdf(user, stats)
    return report</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 38: Webhook vs Polling Patterns -->
      <div class="category" id="category-38">
        <div class="category-header">
          <i class="fas fa-exchange-alt"></i>
          <h2>Webhook vs Polling Patterns</h2>
        </div>

        <div class="snippet" id="snippet-38-1">
          <div class="snippet-header">
            <h3 class="snippet-title">38.1 Webhook Setup with Security</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×”×’×“×¨×ª webhook ×××•×‘×˜×— ×¢× ××™××•×ª</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from fastapi import FastAPI, Request, HTTPException
from telegram import Update
import hmac
import hashlib

app = FastAPI()

def verify_telegram_webhook(token: str, secret_token: str, request_secret: str):
    """Verify webhook request is from Telegram"""
    if secret_token != request_secret:
        return False
    return True

@app.post(f"/webhook/{BOT_TOKEN}")
async def telegram_webhook(request: Request):
    # Verify secret token
    secret = request.headers.get('X-Telegram-Bot-Api-Secret-Token')
    
    if not verify_telegram_webhook(BOT_TOKEN, WEBHOOK_SECRET, secret):
        raise HTTPException(status_code=403, detail="Invalid secret token")
    
    # Process update
    json_data = await request.json()
    update = Update.de_json(json_data, bot)
    
    await application.process_update(update)
    
    return {"ok": True}

# Set webhook
async def setup_webhook():
    webhook_url = f"https://your-domain.com/webhook/{BOT_TOKEN}"
    
    await bot.set_webhook(
        url=webhook_url,
        secret_token=WEBHOOK_SECRET,
        allowed_updates=["message", "callback_query"],
        drop_pending_updates=True
    )
    
    print(f"âœ… Webhook set: {webhook_url}")

# Remove webhook
async def remove_webhook():
    await bot.delete_webhook(drop_pending_updates=True)
    print("âœ… Webhook removed")</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-38-2">
          <div class="snippet-header">
            <h3 class="snippet-title">38.2 Smart Polling with Offset Management</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> polling ×™×¢×™×œ ×©×œ× ××¤×¡×¤×¡ ×¢×“×›×•× ×™× ×•×œ× ××¢×‘×“ ××•×ª× ×¤×¢××™×™×</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class SmartPoller:
    def __init__(self, bot):
        self.bot = bot
        self.offset = 0
        self.running = False
    
    async def start(self):
        """Start polling with offset management"""
        self.running = True
        
        # Load last offset from storage
        self.offset = await redis.get('polling_offset') or 0
        
        print(f"ğŸ”„ Starting polling from offset {self.offset}")
        
        while self.running:
            try:
                # Get updates
                updates = await self.bot.get_updates(
                    offset=self.offset,
                    timeout=30,
                    allowed_updates=["message", "callback_query"]
                )
                
                for update in updates:
                    # Process update
                    await application.process_update(update)
                    
                    # Update offset
                    self.offset = update.update_id + 1
                    
                    # Save offset periodically
                    await redis.set('polling_offset', self.offset)
                
            except Exception as e:
                print(f"âŒ Polling error: {e}")
                await asyncio.sleep(5)  # Wait before retry
    
    async def stop(self):
        """Stop polling gracefully"""
        self.running = False
        await redis.set('polling_offset', self.offset)
        print(f"âœ… Polling stopped at offset {self.offset}")

poller = SmartPoller(bot)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-38-3">
          <div class="snippet-header">
            <h3 class="snippet-title">38.3 Hybrid Approach (Webhook with Polling Fallback)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××¢×‘×¨ ××•×˜×•××˜×™ ×œ-polling ×× webhook × ×•×¤×œ</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class HybridUpdater:
    def __init__(self, bot, webhook_url):
        self.bot = bot
        self.webhook_url = webhook_url
        self.mode = 'webhook'
        self.poller = SmartPoller(bot)
    
    async def start(self):
        """Start in webhook mode with fallback"""
        try:
            await self.setup_webhook()
            self.mode = 'webhook'
            print("âœ… Running in webhook mode")
            
            # Monitor webhook health
            asyncio.create_task(self.monitor_webhook_health())
            
        except Exception as e:
            print(f"âŒ Webhook failed: {e}")
            await self.fallback_to_polling()
    
    async def setup_webhook(self):
        """Setup webhook"""
        await self.bot.set_webhook(
            url=self.webhook_url,
            secret_token=WEBHOOK_SECRET
        )
        
        # Test webhook
        webhook_info = await self.bot.get_webhook_info()
        if webhook_info.url != self.webhook_url:
            raise Exception("Webhook URL mismatch")
    
    async def fallback_to_polling(self):
        """Switch to polling mode"""
        print("âš ï¸  Falling back to polling mode")
        
        await self.bot.delete_webhook()
        self.mode = 'polling'
        await self.poller.start()
    
    async def monitor_webhook_health(self):
        """Check webhook health periodically"""
        while self.mode == 'webhook':
            await asyncio.sleep(300)  # Check every 5 minutes
            
            try:
                info = await self.bot.get_webhook_info()
                
                # Check for errors
                if info.last_error_date:
                    error_age = time.time() - info.last_error_date
                    
                    if error_age &lt; 600:  # Errors in last 10 minutes
                        print(f"âš ï¸  Webhook errors detected: {info.last_error_message}")
                        await self.fallback_to_polling()
                        break
            
            except Exception as e:
                print(f"âŒ Health check failed: {e}")
                await self.fallback_to_polling()
                break

updater = HybridUpdater(bot, WEBHOOK_URL)</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 39: Telegram Bot Commands Menu -->
      <div class="category" id="category-39">
        <div class="category-header">
          <i class="fas fa-bars"></i>
          <h2>Telegram Bot Commands Menu</h2>
        </div>

        <div class="snippet" id="snippet-39-1">
          <div class="snippet-header">
            <h3 class="snippet-title">39.1 Dynamic Command Registration</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×¨×™×©×•× ×¤×§×•×“×•×ª ×“×™× ××™ ×¢× ×ª×™××•×¨×™× ×©××•×¤×™×¢×™× ×‘×ª×¤×¨×™×˜ ×”×‘×•×˜</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class CommandRegistry:
    def __init__(self, bot):
        self.bot = bot
        self.commands = {}
    
    def register(self, command, description, handler, scope='default'):
        """Register command with description"""
        self.commands[command] = {
            'description': description,
            'handler': handler,
            'scope': scope
        }
    
    async def update_bot_menu(self):
        """Update Telegram bot commands menu"""
        from telegram import BotCommand
        
        # Default commands (for all users)
        default_commands = [
            BotCommand(cmd, info['description'])
            for cmd, info in self.commands.items()
            if info['scope'] == 'default'
        ]
        
        await self.bot.set_my_commands(default_commands)
        
        # Admin commands
        admin_commands = default_commands + [
            BotCommand(cmd, info['description'])
            for cmd, info in self.commands.items()
            if info['scope'] == 'admin'
        ]
        
        from telegram import BotCommandScopeChat
        
        for admin_id in ADMIN_IDS:
            await self.bot.set_my_commands(
                admin_commands,
                scope=BotCommandScopeChat(admin_id)
            )
    
    def get_handler(self, command):
        """Get handler for command"""
        return self.commands.get(command, {}).get('handler')

# Usage
registry = CommandRegistry(bot)

# Register commands
registry.register('start', '×”×ª×—×œ ×©×™×—×”', start_handler, scope='default')
registry.register('help', '×¢×–×¨×”', help_handler, scope='default')
registry.register('stats', '×¡×˜×˜×™×¡×˜×™×§×•×ª', stats_handler, scope='admin')
registry.register('broadcast', '×©×œ×— ×œ×›×•×œ×', broadcast_handler, scope='admin')

# Update bot menu
await registry.update_bot_menu()</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-39-2">
          <div class="snippet-header">
            <h3 class="snippet-title">39.2 Command Aliases System</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××¡×¤×¨ ×©××•×ª ×œ××•×ª×” ×¤×§×•×“×” (×›××• /help ×•-/h)</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class CommandAliases:
    def __init__(self):
        self.aliases = {}
        self.handlers = {}
    
    def register(self, main_command, aliases, handler):
        """Register command with aliases"""
        # Store main handler
        self.handlers[main_command] = handler
        
        # Map aliases to main command
        for alias in aliases:
            self.aliases[alias] = main_command
    
    def get_handler(self, command):
        """Get handler for command or alias"""
        # Check if it's an alias
        main_command = self.aliases.get(command, command)
        return self.handlers.get(main_command)
    
    def setup_handlers(self, application):
        """Setup all handlers in application"""
        for command, handler in self.handlers.items():
            # Get all aliases for this command
            all_commands = [command] + [
                alias for alias, main in self.aliases.items()
                if main == command
            ]
            
            # Register with all aliases
            application.add_handler(
                CommandHandler(all_commands, handler)
            )

# Usage
aliases = CommandAliases()

aliases.register('help', ['h', '×¢×–×¨×”'], help_handler)
aliases.register('stats', ['s', 'statistics', '×¡×˜×˜×™×¡×˜×™×§×•×ª'], stats_handler)
aliases.register('settings', ['config', '×”×’×“×¨×•×ª'], settings_handler)

aliases.setup_handlers(application)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-39-3">
          <div class="snippet-header">
            <h3 class="snippet-title">39.3 Grouped Commands Menu</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××¨×’×•×Ÿ ×¤×§×•×“×•×ª ×œ×§×˜×’×•×¨×™×•×ª - ×§×œ ×œ××©×ª××© ×œ××¦×•×</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class GroupedCommands:
    def __init__(self):
        self.groups = {
            'general': {'title': 'ğŸ“± ×›×œ×œ×™', 'commands': []},
            'files': {'title': 'ğŸ“ ×§×‘×¦×™×', 'commands': []},
            'admin': {'title': 'ğŸ‘‘ ××“××™×Ÿ', 'commands': []},
        }
    
    def add_command(self, group, command, description):
        """Add command to group"""
        if group in self.groups:
            self.groups[group]['commands'].append({
                'command': command,
                'description': description
            })
    
    def get_help_text(self, user_role='user'):
        """Generate formatted help text"""
        text = "ğŸ“š ×¨×©×™××ª ×¤×§×•×“×•×ª\n\n"
        
        for group_key, group in self.groups.items():
            # Skip admin commands for regular users
            if group_key == 'admin' and user_role != 'admin':
                continue
            
            text += f"{group['title']}\n"
            
            for cmd in group['commands']:
                text += f"/{cmd['command']} - {cmd['description']}\n"
            
            text += "\n"
        
        return text

# Usage
commands = GroupedCommands()

# General commands
commands.add_command('general', 'start', '×”×ª×—×œ ×©×™×—×”')
commands.add_command('general', 'help', '×”×¦×’ ×¢×–×¨×”')
commands.add_command('general', 'settings', '×”×’×“×¨×•×ª')

# File commands
commands.add_command('files', 'upload', '×”×¢×œ×” ×§×•×‘×¥')
commands.add_command('files', 'list', '×¨×©×™××ª ×§×‘×¦×™×')
commands.add_command('files', 'search', '×—×¤×© ×§×•×‘×¥')

# Admin commands
commands.add_command('admin', 'stats', '×¡×˜×˜×™×¡×˜×™×§×•×ª')
commands.add_command('admin', 'broadcast', '×©×œ×— ×œ×›×•×œ×')

# Handler
async def help_command(update, context):
    user_role = get_user_role(update.effective_user.id)
    help_text = commands.get_help_text(user_role)
    await update.message.reply_text(help_text)</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 40: Advanced Error Recovery -->
      <div class="category" id="category-40">
        <div class="category-header">
          <i class="fas fa-life-ring"></i>
          <h2>Advanced Error Recovery</h2>
        </div>

        <div class="snippet" id="snippet-40-1">
          <div class="snippet-header">
            <h3 class="snippet-title">40.1 Dead Letter Queue for Failed Messages</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×©××™×¨×ª ×”×•×“×¢×•×ª ×©× ×›×©×œ×• ×œ×˜×™×¤×•×œ ×××•×—×¨ ×™×•×ª×¨</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class DeadLetterQueue:
    def __init__(self, redis_client):
        self.redis = redis_client
        self.queue_key = 'dlq:messages'
    
    async def add(self, update, error, retry_count=0):
        """Add failed message to DLQ"""
        dlq_item = {
            'update_id': update.update_id,
            'user_id': update.effective_user.id if update.effective_user else None,
            'message': update.message.to_dict() if update.message else {},
            'error': str(error),
            'retry_count': retry_count,
            'timestamp': datetime.now().isoformat()
        }
        
        await self.redis.lpush(
            self.queue_key,
            json.dumps(dlq_item)
        )
        
        print(f"ğŸ“® Added to DLQ: update {update.update_id}")
    
    async def get_all(self, limit=100):
        """Get all items from DLQ"""
        items = await self.redis.lrange(self.queue_key, 0, limit - 1)
        return [json.loads(item) for item in items]
    
    async def retry_failed(self, bot, max_retries=3):
        """Retry processing failed messages"""
        items = await self.get_all()
        
        for item in items:
            if item['retry_count'] &gt;= max_retries:
                continue  # Skip if max retries reached
            
            try:
                # Reconstruct update
                update = Update.de_json(item['message'], bot)
                
                # Try processing again
                await application.process_update(update)
                
                # Remove from DLQ if successful
                await self.redis.lrem(self.queue_key, 1, json.dumps(item))
                print(f"âœ… Recovered update {item['update_id']}")
                
            except Exception as e:
                # Increment retry count
                item['retry_count'] += 1
                print(f"âŒ Retry failed for {item['update_id']}: {e}")

dlq = DeadLetterQueue(redis_client)

# Error handler
async def error_handler(update, context):
    error = context.error
    
    # Log error
    logger.error(f"Update {update} caused error {error}")
    
    # Add to DLQ
    await dlq.add(update, error)
    
    # Notify user
    if update and update.effective_message:
        await update.effective_message.reply_text(
            "âš ï¸ ××™×¨×¢×” ×©×’×™××”. × × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨."
        )

application.add_error_handler(error_handler)

# Background job to retry
async def retry_dlq_job(context):
    await dlq.retry_failed(context.bot)

job_queue.run_repeating(retry_dlq_job, interval=300)  # Every 5 minutes</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-40-2">
          <div class="snippet-header">
            <h3 class="snippet-title">40.2 Error Notification System</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×”×ª×¨××•×ª ××™×™×“×™×•×ª ×œ××“××™×Ÿ ×¢×œ ×©×’×™××•×ª ×§×¨×™×˜×™×•×ª</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class ErrorNotifier:
    def __init__(self, bot, admin_chat_id):
        self.bot = bot
        self.admin_chat_id = admin_chat_id
        self.error_counts = {}
        self.last_notification = {}
    
    async def notify(self, error, update=None, severity='error'):
        """Send error notification to admin"""
        error_key = f"{type(error).__name__}:{str(error)[:50]}"
        
        # Count errors
        self.error_counts[error_key] = self.error_counts.get(error_key, 0) + 1
        
        # Rate limit notifications (max 1 per minute per error type)
        last_notif = self.last_notification.get(error_key, 0)
        if time.time() - last_notif &lt; 60:
            return
        
        self.last_notification[error_key] = time.time()
        
        # Build message
        emoji = {'critical': 'ğŸ”¥', 'error': 'âŒ', 'warning': 'âš ï¸'}[severity]
        
        text = f"{emoji} &lt;b&gt;Error Alert&lt;/b&gt;\n\n"
        text += f"&lt;b&gt;Type:&lt;/b&gt; {type(error).__name__}\n"
        text += f"&lt;b&gt;Message:&lt;/b&gt; {str(error)[:200]}\n"
        text += f"&lt;b&gt;Count:&lt;/b&gt; {self.error_counts[error_key]} times\n"
        
        if update:
            text += f"\n&lt;b&gt;User:&lt;/b&gt; {update.effective_user.id if update.effective_user else 'Unknown'}\n"
            text += f"&lt;b&gt;Update ID:&lt;/b&gt; {update.update_id}\n"
        
        # Add traceback for critical errors
        if severity == 'critical':
            import traceback
            tb = ''.join(traceback.format_tb(error.__traceback__)[-3:])
            text += f"\n&lt;code&gt;{tb[:500]}&lt;/code&gt;"
        
        await self.bot.send_message(
            chat_id=self.admin_chat_id,
            text=text,
            parse_mode='HTML'
        )

notifier = ErrorNotifier(bot, ADMIN_CHAT_ID)

async def error_handler_with_notification(update, context):
    error = context.error
    
    # Determine severity
    if isinstance(error, (NetworkError, TimedOut)):
        severity = 'warning'
    elif isinstance(error, Unauthorized):
        severity = 'error'
    else:
        severity = 'critical'
    
    # Notify admin
    await notifier.notify(error, update, severity)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-40-3">
          <div class="snippet-header">
            <h3 class="snippet-title">40.3 Automatic Recovery Strategies</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×”×ª××•×©×©×•×ª ××•×˜×•××˜×™×ª ××©×’×™××•×ª × ×¤×•×¦×•×ª</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class AutoRecovery:
    def __init__(self, bot):
        self.bot = bot
        self.recovery_strategies = {
            'NetworkError': self.recover_network_error,
            'TimedOut': self.recover_timeout,
            'RetryAfter': self.recover_rate_limit,
        }
    
    async def try_recover(self, error, func, *args, **kwargs):
        """Try to recover from error and retry"""
        error_type = type(error).__name__
        
        recovery_func = self.recovery_strategies.get(error_type)
        
        if recovery_func:
            print(f"ğŸ”„ Attempting recovery for {error_type}")
            
            success = await recovery_func(error)
            
            if success:
                # Retry original function
                return await func(*args, **kwargs)
        
        # No recovery possible
        raise error
    
    async def recover_network_error(self, error):
        """Recover from network errors"""
        print("ğŸŒ Network error, waiting 5s...")
        await asyncio.sleep(5)
        return True
    
    async def recover_timeout(self, error):
        """Recover from timeout"""
        print("â± Timeout, retrying...")
        await asyncio.sleep(2)
        return True
    
    async def recover_rate_limit(self, error):
        """Recover from rate limiting"""
        retry_after = getattr(error, 'retry_after', 60)
        print(f"â¸ Rate limited, waiting {retry_after}s...")
        await asyncio.sleep(retry_after)
        return True

recovery = AutoRecovery(bot)

# Decorator for auto-recovery
def with_auto_recovery(func):
    @wraps(func)
    async def wrapper(*args, **kwargs):
        try:
            return await func(*args, **kwargs)
        except Exception as e:
            return await recovery.try_recover(e, func, *args, **kwargs)
    return wrapper

# Usage
@with_auto_recovery
async def send_message_reliable(chat_id, text):
    await bot.send_message(chat_id=chat_id, text=text)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-40-4">
          <div class="snippet-header">
            <h3 class="snippet-title">40.4 Error Aggregation & Reporting</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×“×•×— ××¨×•×›×– ×©×œ ×›×œ ×”×©×’×™××•×ª - ×–×™×”×•×™ ×‘×¢×™×•×ª ××ª××©×›×•×ª</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class ErrorAggregator:
    def __init__(self):
        self.errors = []
        self.start_time = datetime.now()
    
    def record(self, error, context=None):
        """Record an error"""
        self.errors.append({
            'type': type(error).__name__,
            'message': str(error),
            'context': context,
            'timestamp': datetime.now()
        })
    
    def get_report(self):
        """Generate error report"""
        if not self.errors:
            return "âœ… No errors recorded"
        
        # Count by type
        from collections import Counter
        error_types = Counter(e['type'] for e in self.errors)
        
        # Calculate uptime
        uptime = datetime.now() - self.start_time
        
        report = f"ğŸ“Š &lt;b&gt;Error Report&lt;/b&gt;\n\n"
        report += f"â± Uptime: {uptime}\n"
        report += f"âŒ Total Errors: {len(self.errors)}\n\n"
        
        report += "&lt;b&gt;By Type:&lt;/b&gt;\n"
        for error_type, count in error_types.most_common(10):
            report += f"â€¢ {error_type}: {count}\n"
        
        # Recent errors
        report += f"\n&lt;b&gt;Recent Errors (last 5):&lt;/b&gt;\n"
        for error in self.errors[-5:]:
            report += f"â€¢ [{error['timestamp']:%H:%M:%S}] {error['type']}: {error['message'][:50]}\n"
        
        return report
    
    def clear(self):
        """Clear recorded errors"""
        self.errors.clear()

aggregator = ErrorAggregator()

# Record errors
async def error_handler_with_aggregation(update, context):
    error = context.error
    aggregator.record(error, context={'update_id': update.update_id if update else None})

# Daily report
async def daily_error_report(context):
    report = aggregator.get_report()
    
    await context.bot.send_message(
        chat_id=ADMIN_CHAT_ID,
        text=report,
        parse_mode='HTML'
    )
    
    # Clear after reporting
    aggregator.clear()

# Schedule daily at 9 AM
job_queue.run_daily(daily_error_report, time=time(hour=9, minute=0))</code></pre>
          </div>
        </div>
      </div>
      <!-- Category 41: Voice & Audio Processing -->
      <div class="category" id="category-41">
        <div class="category-header">
          <i class="fas fa-microphone"></i>
          <h2>Voice & Audio Processing</h2>
        </div>

        <div class="snippet" id="snippet-41-1">
          <div class="snippet-header">
            <h3 class="snippet-title">41.1 Transcribe Voice Messages with Whisper API</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×××¤×©×¨ ×œ×‘×•×˜ ×œ×”×‘×™×Ÿ ×”×•×“×¢×•×ª ×§×•×œ×™×•×ª ×•×œ×”×’×™×‘ ×¢×œ×™×”×Ÿ ×‘×˜×§×¡×˜. ×©×™××•×©×™ ×‘××™×•×—×“ ×œ× ×’×™×©×•×ª, ×ª×™×¢×•×“ ×¤×’×™×©×•×ª, ××• × ×™×ª×•×— ×ª×•×›×Ÿ ×§×•×œ×™.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import os
import tempfile
import whisper
from telegram import Update
from telegram.ext import ContextTypes
import asyncio

class VoiceTranscriber:
    def __init__(self):
        # Load Whisper model (tiny, base, small, medium, large)
        self.model = whisper.load_model("base")
    
    async def transcribe_voice(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Transcribe voice message to text."""
        try:
            # Get voice file
            voice = update.message.voice
            file = await context.bot.get_file(voice.file_id)
            
            # Create temp file
            with tempfile.NamedTemporaryFile(suffix='.ogg', delete=False) as temp_file:
                await file.download_to_drive(temp_file.name)
                temp_path = temp_file.name
            
            # Transcribe in thread pool to avoid blocking
            loop = asyncio.get_event_loop()
            result = await loop.run_in_executor(
                None, 
                self._transcribe_sync,
                temp_path
            )
            
            # Clean up
            os.unlink(temp_path)
            
            # Send transcription
            await update.message.reply_text(
                f"ğŸ™ï¸ **×ª××œ×•×œ:**\n{result['text']}\n\n"
                f"ğŸ“Š **×©×¤×”:** {result.get('language', 'unknown')}"
            )
            
        except Exception as e:
            await update.message.reply_text(f"âŒ ×©×’×™××” ×‘×ª××œ×•×œ: {str(e)}")
    
    def _transcribe_sync(self, audio_path: str) -&gt; dict:
        """Synchronous transcription method."""
        result = self.model.transcribe(
            audio_path,
            language=None,  # Auto-detect language
            task="transcribe"
        )
        return result</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 42: Real-time Analytics Dashboard -->
      <div class="category" id="category-42">
        <div class="category-header">
          <i class="fas fa-chart-area"></i>
          <h2>Real-time Analytics Dashboard</h2>
        </div>

        <div class="snippet" id="snippet-42-1">
          <div class="snippet-header">
            <h3 class="snippet-title">42.1 Stream Bot Metrics via WebSocket</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××¡×¤×§ ×ª×¦×•×’×” ×—×™×” ×©×œ ×‘×™×¦×•×¢×™ ×”×‘×•×˜, ××¡×¤×¨ ××©×ª××©×™× ×¤×¢×™×œ×™×, ×•×¤×§×•×“×•×ª ×¤×•×¤×•×œ×¨×™×•×ª. ×××¤×©×¨ ×–×™×”×•×™ ××”×™×¨ ×©×œ ×‘×¢×™×•×ª ×•××’××•×ª ×©×™××•×©.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import json
import asyncio
from typing import Dict, Set
from datetime import datetime, timedelta
from collections import defaultdict
from aiohttp import web
import aiohttp_cors

class BotAnalyticsDashboard:
    def __init__(self):
        self.websockets: Set[web.WebSocketResponse] = set()
        self.metrics = defaultdict(lambda: 0)
        self.active_users = set()
        
    async def track_event(self, event_type: str, user_id: int, metadata: Dict = None):
        """Track an analytics event."""
        self.metrics[event_type] += 1
        self.active_users.add(user_id)
        
        # Broadcast to all connected dashboards
        await self.broadcast_update({
            'type': 'event',
            'event': event_type,
            'timestamp': datetime.now().isoformat(),
            'total_users': len(self.active_users),
            'metrics': dict(self.metrics),
            'metadata': metadata
        })
    
    async def websocket_handler(self, request):
        """WebSocket handler for real-time dashboard updates."""
        ws = web.WebSocketResponse()
        await ws.prepare(request)
        self.websockets.add(ws)
        
        try:
            # Send initial data
            await ws.send_json({
                'type': 'initial',
                'metrics': dict(self.metrics),
                'active_users': len(self.active_users)
            })
            
            async for msg in ws:
                if msg.type == aiohttp.WSMsgType.TEXT:
                    data = json.loads(msg.data)
                    
                    # Handle dashboard requests
                    if data.get('action') == 'get_details':
                        await ws.send_json({
                            'type': 'details',
                            'data': await self.get_detailed_metrics()
                        })
                        
        finally:
            self.websockets.discard(ws)
            
        return ws
    
    async def broadcast_update(self, data: Dict):
        """Broadcast update to all connected dashboards."""
        if self.websockets:
            await asyncio.gather(
                *[ws.send_json(data) for ws in self.websockets],
                return_exceptions=True
            )
    
    async def get_detailed_metrics(self) -&gt; Dict:
        """Get detailed metrics for dashboard."""
        return {
            'commands': dict(self.metrics),
            'active_users_count': len(self.active_users),
            'timestamp': datetime.now().isoformat()
        }
    
    def setup_dashboard_app(self) -&gt; web.Application:
        """Setup web application for dashboard."""
        app = web.Application()
        
        # Setup CORS
        cors = aiohttp_cors.setup(app, defaults={
            "*": aiohttp_cors.ResourceOptions(
                allow_credentials=True,
                expose_headers="*",
                allow_headers="*"
            )
        })
        
        # Add routes
        resource = cors.add(app.router.add_resource("/ws"))
        resource.add_route("GET", self.websocket_handler)
        
        return app</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 43: ML-Based Anti-Spam -->
      <div class="category" id="category-43">
        <div class="category-header">
          <i class="fas fa-user-shield"></i>
          <h2>ML-Based Anti-Spam</h2>
        </div>

        <div class="snippet" id="snippet-43-1">
          <div class="snippet-header">
            <h3 class="snippet-title">43.1 Detect Spam with Machine Learning</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××–×”×” ×•××¡× ×Ÿ ××•×˜×•××˜×™×ª ×”×•×“×¢×•×ª ×¡×¤×× ×‘×¦'××˜×™×. ××©×¤×¨ ××ª ××™×›×•×ª ×”×©×™×—×” ×•××’×Ÿ ×¢×œ ××©×ª××©×™× ××ª×•×›×Ÿ ×œ× ×¨×¦×•×™.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import pickle
import re
import numpy as np
from typing import Tuple, List
from sklearn.feature_extraction.text import TfidfVectorizer
from telegram import Update
from telegram.ext import ContextTypes

class MLSpamDetector:
    def __init__(self, model_path: str = "spam_model.pkl"):
        # Load pre-trained model and vectorizer
        with open(model_path, 'rb') as f:
            self.model = pickle.load(f)
        with open(model_path.replace('.pkl', '_vectorizer.pkl'), 'rb') as f:
            self.vectorizer = pickle.load(f)
        
        # Spam patterns for quick detection
        self.spam_patterns = [
            r'(?i)(click here|buy now|limited offer)',
            r'(?i)(earn money|work from home|get rich)',
            r'(?i)(viagra|casino|adult)',
            r'http[s]?://bit\.ly/\w+',  # Shortened URLs
            r'@[\w]+{3,}',  # Multiple mentions
        ]
    
    async def check_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Check if message is spam."""
        text = update.message.text
        
        # Quick pattern check
        if self._has_spam_patterns(text):
            await self._handle_spam(update, context, confidence=0.95)
            return
        
        # ML prediction
        is_spam, confidence = self._predict_spam(text)
        
        if is_spam and confidence &gt; 0.8:
            await self._handle_spam(update, context, confidence)
    
    def _has_spam_patterns(self, text: str) -&gt; bool:
        """Check for known spam patterns."""
        for pattern in self.spam_patterns:
            if re.search(pattern, text):
                return True
        return False
    
    def _predict_spam(self, text: str) -&gt; Tuple[bool, float]:
        """Predict if text is spam using ML model."""
        try:
            # Feature extraction
            features = self._extract_features(text)
            
            # Vectorize text
            text_vector = self.vectorizer.transform([text])
            
            # Combine features
            combined = np.hstack([text_vector.toarray(), features.reshape(1, -1)])
            
            # Predict
            prediction = self.model.predict(combined)[0]
            confidence = self.model.predict_proba(combined)[0].max()
            
            return prediction == 1, confidence
            
        except Exception as e:
            print(f"Prediction error: {e}")
            return False, 0.0
    
    def _extract_features(self, text: str) -&gt; np.array:
        """Extract additional features from text."""
        features = [
            len(text),  # Text length
            text.count('!'),  # Exclamation marks
            text.count('$'),  # Dollar signs
            text.count('http'),  # Links
            text.count('@'),  # Mentions
            len(re.findall(r'[A-Z]', text)) / max(len(text), 1),  # Uppercase ratio
            len(re.findall(r'\d', text)) / max(len(text), 1),  # Digit ratio
        ]
        return np.array(features)
    
    async def _handle_spam(self, update: Update, context: ContextTypes.DEFAULT_TYPE, confidence: float):
        """Handle detected spam."""
        # Delete spam message
        await update.message.delete()
        
        # Log spam detection
        print(f"Spam detected (confidence: {confidence:.2f}): {update.message.text[:50]}...")
        
        # Optionally warn/ban user
        if confidence &gt; 0.95:
            # Ban repeat offenders
            user_id = update.message.from_user.id
            spam_count = context.user_data.get('spam_count', 0) + 1
            context.user_data['spam_count'] = spam_count
            
            if spam_count &gt;= 3:
                await context.bot.ban_chat_member(
                    chat_id=update.effective_chat.id,
                    user_id=user_id
                )</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 44: Advanced Survey Builder -->
      <div class="category" id="category-44">
        <div class="category-header">
          <i class="fas fa-clipboard-check"></i>
          <h2>Advanced Survey Builder</h2>
        </div>

        <div class="snippet" id="snippet-44-1">
          <div class="snippet-header">
            <h3 class="snippet-title">44.1 Create Dynamic Surveys with Branching Logic</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×××¤×©×¨ ×™×¦×™×¨×ª ×¡×§×¨×™× ××•×¨×›×‘×™× ×¢× ×œ×•×’×™×§×ª ×”×¡×ª×¢×¤×•×ª ××•×ª× ×™×ª. ××¦×•×™×Ÿ ×œ××™×¡×•×£ ××©×•×‘ ××¤×•×¨×˜, ×˜×¤×¡×™ ×¨×™×©×•×, ××• ×©××œ×•× ×™× ××‘×—×•× ×™×™×.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from typing import Dict, List, Optional, Callable
from dataclasses import dataclass
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes, ConversationHandler

@dataclass
class SurveyQuestion:
    id: str
    text: str
    type: str  # 'choice', 'text', 'number', 'date', 'location'
    options: Optional[List[str]] = None
    validation: Optional[Callable] = None
    next_question: Optional[str] = None  # Default next question
    conditional_next: Optional[Dict[str, str]] = None  # Answer -&gt; next question

class SurveyBuilder:
    def __init__(self, survey_id: str):
        self.survey_id = survey_id
        self.questions: Dict[str, SurveyQuestion] = {}
        self.responses: Dict[int, Dict] = {}  # user_id -&gt; responses
        
    def add_question(self, question: SurveyQuestion):
        """Add a question to the survey."""
        self.questions[question.id] = question
        
    async def start_survey(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Start the survey for a user."""
        user_id = update.effective_user.id
        self.responses[user_id] = {'current_question': 'q1', 'answers': {}}
        
        await self.ask_question(update, context, 'q1')
        return 'ANSWERING'
    
    async def ask_question(self, update: Update, context: ContextTypes.DEFAULT_TYPE, question_id: str):
        """Ask a specific question."""
        question = self.questions.get(question_id)
        if not question:
            await self.end_survey(update, context)
            return
        
        user_id = update.effective_user.id
        self.responses[user_id]['current_question'] = question_id
        
        if question.type == 'choice' and question.options:
            # Create inline keyboard for choices
            keyboard = []
            for i in range(0, len(question.options), 2):
                row = []
                for option in question.options[i:i+2]:
                    row.append(InlineKeyboardButton(
                        option, 
                        callback_data=f"survey_{self.survey_id}_{question_id}_{option}"
                    ))
                keyboard.append(row)
            
            reply_markup = InlineKeyboardMarkup(keyboard)
            await update.effective_message.reply_text(
                question.text,
                reply_markup=reply_markup
            )
        else:
            # Text/number/date question
            await update.effective_message.reply_text(
                f"{question.text}\n\n"
                f"_×¡×•×’ ×ª×©×•×‘×”: {self._get_type_hint(question.type)}_",
                parse_mode='Markdown'
            )
    
    async def process_answer(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Process user's answer."""
        user_id = update.effective_user.id
        if user_id not in self.responses:
            return
        
        current_q_id = self.responses[user_id]['current_question']
        question = self.questions[current_q_id]
        
        # Extract answer
        if update.callback_query:
            # Choice answer from callback
            answer = update.callback_query.data.split('_')[-1]
            await update.callback_query.answer()
        else:
            # Text answer
            answer = update.message.text
        
        # Validate answer
        if question.validation and not question.validation(answer):
            await update.effective_message.reply_text(
                "âŒ ×”×ª×©×•×‘×” ×œ× ×ª×§×™× ×”. ×× × × ×¡×” ×©×•×‘."
            )
            return 'ANSWERING'
        
        # Store answer
        self.responses[user_id]['answers'][current_q_id] = answer
        
        # Determine next question
        next_q_id = self._get_next_question(question, answer)
        
        if next_q_id:
            await self.ask_question(update, context, next_q_id)
            return 'ANSWERING'
        else:
            await self.end_survey(update, context)
            return ConversationHandler.END
    
    def _get_next_question(self, question: SurveyQuestion, answer: str) -&gt; Optional[str]:
        """Determine next question based on branching logic."""
        if question.conditional_next and answer in question.conditional_next:
            return question.conditional_next[answer]
        return question.next_question
    
    def _get_type_hint(self, question_type: str) -&gt; str:
        """Get user-friendly type hint."""
        hints = {
            'text': '×˜×§×¡×˜ ×—×•×¤×©×™',
            'number': '××¡×¤×¨',
            'date': '×ª××¨×™×š (DD/MM/YYYY)',
            'location': '×©×œ×— ××™×§×•×'
        }
        return hints.get(question_type, question_type)
    
    async def end_survey(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """End the survey and save results."""
        user_id = update.effective_user.id
        responses = self.responses.get(user_id, {}).get('answers', {})
        
        # Save to database
        await self.save_responses(user_id, responses)
        
        # Send summary
        summary = "ğŸ‰ **×”×¡×§×¨ ×”×•×©×œ× ×‘×”×¦×œ×—×”!**\n\n"
        summary += "**×”×ª×©×•×‘×•×ª ×©×œ×š:**\n"
        for q_id, answer in responses.items():
            question = self.questions[q_id]
            summary += f"â€¢ {question.text}: {answer}\n"
        
        await update.effective_message.reply_text(summary)
        
        # Clean up
        if user_id in self.responses:
            del self.responses[user_id]
    
    async def save_responses(self, user_id: int, responses: Dict):
        """Save survey responses to database."""
        # Implementation depends on your database
        pass

# Example usage
def create_satisfaction_survey():
    survey = SurveyBuilder("satisfaction_2024")
    
    # Question 1: Overall satisfaction
    survey.add_question(SurveyQuestion(
        id="q1",
        text="×›××” ××ª×” ××¨×•×¦×” ××”×©×™×¨×•×ª ×©×œ× ×•?",
        type="choice",
        options=["×××•×“ ××¨×•×¦×”", "××¨×•×¦×”", "×‘×™× ×•× ×™", "×œ× ××¨×•×¦×”"],
        next_question="q2",
        conditional_next={
            "×œ× ××¨×•×¦×”": "q_complaint",
            "×‘×™× ×•× ×™": "q_improvement"
        }
    ))
    
    # Question 2: Recommendation
    survey.add_question(SurveyQuestion(
        id="q2",
        text="×”×× ×ª××œ×™×¥ ×¢×œ ×”×©×™×¨×•×ª ×©×œ× ×• ×œ×—×‘×¨?",
        type="choice",
        options=["×‘×”×—×œ×˜ ×›×Ÿ", "×›×Ÿ", "××•×œ×™", "×œ×"],
        next_question="q3"
    ))
    
    # Complaint branch
    survey.add_question(SurveyQuestion(
        id="q_complaint",
        text="× ×©××— ×œ×©××•×¢ ××” ×œ× ×”×™×” ×˜×•×‘. ×¡×¤×¨ ×œ× ×• ×‘×¤×™×¨×•×˜:",
        type="text",
        validation=lambda x: len(x) &gt;= 10,  # At least 10 characters
        next_question="q3"
    ))
    
    return survey</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 45: Telegram Games Integration -->
      <div class="category" id="category-45">
        <div class="category-header">
          <i class="fas fa-gamepad"></i>
          <h2>Telegram Games Integration</h2>
        </div>

        <div class="snippet" id="snippet-45-1">
          <div class="snippet-header">
            <h3 class="snippet-title">45.1 Integrate HTML5 Games</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×××¤×©×¨ ×”×•×¡×¤×ª ××©×—×§×™× ××™× ×˜×¨××§×˜×™×‘×™×™× ×œ×‘×•×˜. ××¢×œ×” ××ª ×”××¢×•×¨×‘×•×ª ×©×œ ×”××©×ª××©×™× ×•××¡×¤×§ ×—×•×•×™×” ×‘×™×“×•×¨×™×ª.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes
import hashlib
import time

class TelegramGameManager:
    def __init__(self, game_url: str, bot_token: str):
        self.game_url = game_url
        self.bot_token = bot_token
        self.high_scores = {}  # game_id -&gt; [(user_id, score, timestamp)]
        
    async def send_game(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Send game to user."""
        keyboard = [[
            InlineKeyboardButton(
                "ğŸ® ×©×—×§ ×¢×›×©×™×•!",
                callback_game=True
            )
        ]]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await update.message.reply_game(
            game_short_name="my_awesome_game",
            reply_markup=reply_markup
        )
    
    async def handle_game_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Handle game button click."""
        query = update.callback_query
        
        # Generate secure URL with user authentication
        user_id = query.from_user.id
        timestamp = int(time.time())
        
        # Create auth hash
        auth_data = f"{user_id}:{timestamp}:{self.bot_token}"
        auth_hash = hashlib.sha256(auth_data.encode()).hexdigest()
        
        # Build game URL with auth params
        game_url = (
            f"{self.game_url}"
            f"?user_id={user_id}"
            f"&amp;timestamp={timestamp}"
            f"&amp;auth={auth_hash}"
            f"&amp;inline_message_id={query.inline_message_id}"
        )
        
        # Answer with game URL
        await query.answer(url=game_url)
    
    async def set_game_score(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Set user's game score."""
        user_id = update.effective_user.id
        
        # Parse score from message (you'd get this from your game server)
        try:
            score = int(context.args[0])
        except (IndexError, ValueError):
            await update.message.reply_text("âŒ ×¦×™×•×Ÿ ×œ× ×ª×§×™×Ÿ")
            return
        
        # Update high score
        game_id = "my_awesome_game"
        if game_id not in self.high_scores:
            self.high_scores[game_id] = []
        
        # Check if it's a new high score for this user
        user_scores = [s for uid, s, _ in self.high_scores[game_id] if uid == user_id]
        is_new_high = not user_scores or score &gt; max(user_scores)
        
        if is_new_high:
            # Remove old score
            self.high_scores[game_id] = [
                (uid, s, t) for uid, s, t in self.high_scores[game_id] 
                if uid != user_id
            ]
            # Add new score
            self.high_scores[game_id].append((user_id, score, time.time()))
            # Sort by score
            self.high_scores[game_id].sort(key=lambda x: x[1], reverse=True)
            
            await update.message.reply_text(
                f"ğŸ‰ ×©×™× ×—×“×©! ×”×¦×™×•×Ÿ ×©×œ×š: {score}"
            )
        else:
            await update.message.reply_text(
                f"âœ… ×”×¦×™×•×Ÿ ×©×œ×š: {score}"
            )
    
    async def show_leaderboard(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Show game leaderboard."""
        game_id = "my_awesome_game"
        scores = self.high_scores.get(game_id, [])
        
        if not scores:
            await update.message.reply_text("ğŸ“Š ××™×Ÿ ×¢×“×™×™×Ÿ ×¦×™×•× ×™×")
            return
        
        leaderboard = "ğŸ† **×˜×‘×œ×ª ×”×©×™××™×:**\n\n"
        medals = ["ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰"]
        
        for i, (user_id, score, _) in enumerate(scores[:10]):
            # Get user info
            try:
                user = await context.bot.get_chat_member(
                    update.effective_chat.id, 
                    user_id
                )
                name = user.user.first_name
            except:
                name = f"User {user_id}"
            
            medal = medals[i] if i &lt; 3 else f"{i+1}."
            leaderboard += f"{medal} {name}: {score:,} × ×§×•×“×•×ª\n"
        
        await update.message.reply_text(leaderboard)</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 46: Location Services -->
      <div class="category" id="category-46">
        <div class="category-header">
          <i class="fas fa-map-marker-alt"></i>
          <h2>Location Services</h2>
        </div>

        <div class="snippet" id="snippet-46-1">
          <div class="snippet-header">
            <h3 class="snippet-title">46.1 Find Nearby Users or Services</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×××¤×©×¨ ×—×™×¤×•×© ××©×ª××©×™× ××• ×©×™×¨×•×ª×™× ×‘×§×¨×‘×ª ××§×•×. ××¦×•×™×Ÿ ×œ×‘×•×˜×™× ×©×œ ××©×œ×•×—×™×, ××¦×™××ª ×—×‘×¨×™× ×§×¨×•×‘×™×, ××• ×©×™×¨×•×ª×™× ××‘×•×¡×¡×™ ××™×§×•×.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from typing import List, Tuple, Dict
import math
from dataclasses import dataclass
from motor.motor_asyncio import AsyncIOMotorClient
from telegram import Update, Location
from telegram.ext import ContextTypes

@dataclass
class LocationPoint:
    user_id: int
    lat: float
    lon: float
    name: str
    timestamp: float
    metadata: Dict = None

class LocationServices:
    def __init__(self, mongo_client: AsyncIOMotorClient):
        self.db = mongo_client.bot_db
        self.locations = self.db.user_locations
        
        # Create geospatial index
        self.locations.create_index([("location", "2dsphere")])
    
    async def save_location(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Save user's location."""
        location = update.message.location
        user = update.effective_user
        
        # Save to MongoDB with GeoJSON format
        await self.locations.update_one(
            {"user_id": user.id},
            {
                "$set": {
                    "user_id": user.id,
                    "name": user.first_name,
                    "location": {
                        "type": "Point",
                        "coordinates": [location.longitude, location.latitude]
                    },
                    "timestamp": update.message.date.timestamp(),
                    "live_period": location.live_period
                }
            },
            upsert=True
        )
        
        await update.message.reply_text("ğŸ“ ×”××™×§×•× ×©×œ×š × ×©××¨ ×‘×”×¦×œ×—×”!")
        
        # Find nearby users
        nearby = await self.find_nearby_users(
            location.latitude, 
            location.longitude, 
            max_distance=5000  # 5km
        )
        
        if nearby:
            text = "ğŸ‘¥ **××©×ª××©×™× ×§×¨×•×‘×™× (×¢×“ 5 ×§×´×):**\n\n"
            for point in nearby:
                if point.user_id != user.id:
                    distance = self._calculate_distance(
                        location.latitude, location.longitude,
                        point.lat, point.lon
                    )
                    text += f"â€¢ {point.name}: {distance:.1f} ×§×´×\n"
            
            await update.message.reply_text(text)
    
    async def find_nearby_users(
        self, 
        lat: float, 
        lon: float, 
        max_distance: int = 1000,
        limit: int = 10
    ) -&gt; List[LocationPoint]:
        """Find users within specified distance (meters)."""
        
        # MongoDB geospatial query
        cursor = self.locations.find({
            "location": {
                "$near": {
                    "$geometry": {
                        "type": "Point",
                        "coordinates": [lon, lat]
                    },
                    "$maxDistance": max_distance
                }
            }
        }).limit(limit)
        
        results = []
        async for doc in cursor:
            results.append(LocationPoint(
                user_id=doc['user_id'],
                lat=doc['location']['coordinates'][1],
                lon=doc['location']['coordinates'][0],
                name=doc['name'],
                timestamp=doc['timestamp'],
                metadata=doc.get('metadata')
            ))
        
        return results
    
    async def find_in_radius(
        self, 
        center_lat: float,
        center_lon: float,
        radius_km: float
    ) -&gt; List[LocationPoint]:
        """Find all users within a circular area."""
        
        # Convert km to meters for MongoDB
        radius_meters = radius_km * 1000
        
        cursor = self.locations.find({
            "location": {
                "$geoWithin": {
                    "$centerSphere": [
                        [center_lon, center_lat],
                        radius_meters / 6378100  # Earth radius in meters
                    ]
                }
            }
        })
        
        results = []
        async for doc in cursor:
            results.append(LocationPoint(
                user_id=doc['user_id'],
                lat=doc['location']['coordinates'][1],
                lon=doc['location']['coordinates'][0],
                name=doc['name'],
                timestamp=doc['timestamp']
            ))
        
        return results
    
    def _calculate_distance(self, lat1: float, lon1: float, lat2: float, lon2: float) -&gt; float:
        """Calculate distance between two points in kilometers."""
        R = 6371  # Earth radius in kilometers
        
        # Convert to radians
        lat1, lon1, lat2, lon2 = map(math.radians, [lat1, lon1, lat2, lon2])
        
        # Haversine formula
        dlat = lat2 - lat1
        dlon = lon2 - lon1
        a = math.sin(dlat/2)**2 + math.cos(lat1) * math.cos(lat2) * math.sin(dlon/2)**2
        c = 2 * math.asin(math.sqrt(a))
        
        return R * c
    
    async def share_live_location(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Handle live location sharing."""
        location = update.edited_message.location if update.edited_message else update.message.location
        
        # Update location in real-time
        await self.locations.update_one(
            {"user_id": update.effective_user.id},
            {
                "$set": {
                    "location": {
                        "type": "Point",
                        "coordinates": [location.longitude, location.latitude]
                    },
                    "timestamp": update.effective_message.date.timestamp(),
                    "is_live": True,
                    "heading": location.heading,
                    "horizontal_accuracy": location.horizontal_accuracy
                }
            }
        )
        
        # Notify nearby users (optional)
        await self._notify_nearby_users(location.latitude, location.longitude)
    
    async def _notify_nearby_users(self, lat: float, lon: float):
        """Notify users when someone is nearby."""
        # Implementation for real-time notifications
        pass</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 47: Bot-to-Bot Communication -->
      <div class="category" id="category-47">
        <div class="category-header">
          <i class="fas fa-project-diagram"></i>
          <h2>Bot-to-Bot Communication</h2>
        </div>

        <div class="snippet" id="snippet-47-1">
          <div class="snippet-header">
            <h3 class="snippet-title">47.1 Inter-Bot Messaging System</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×××¤×©×¨ ×ª×§×©×•×¨×ª ×‘×™×Ÿ ××¡×¤×¨ ×‘×•×˜×™× ×œ×¦×•×¨×š ×¡× ×›×¨×•×Ÿ ××™×“×¢, ×”×¢×‘×¨×ª ××©×™××•×ª, ××• ×™×¦×™×¨×ª ××¢×¨×›×ª ×‘×•×˜×™× ××‘×•×–×¨×ª.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import json
import asyncio
import aioredis
from typing import Dict, Any, Callable
from telegram import Bot
from dataclasses import dataclass, asdict

@dataclass
class BotMessage:
    from_bot: str
    to_bot: str
    action: str
    payload: Dict
    timestamp: float
    message_id: str

class BotNetwork:
    def __init__(self, bot_id: str, bot_token: str, redis_url: str):
        self.bot_id = bot_id
        self.bot = Bot(token=bot_token)
        self.redis = None
        self.handlers: Dict[str, Callable] = {}
        self.other_bots: Dict[str, str] = {}  # bot_id -&gt; bot_token
        
    async def connect(self):
        """Connect to Redis for message queue."""
        self.redis = await aioredis.from_url(self.redis_url)
        
        # Start listening for messages
        asyncio.create_task(self._listen_for_messages())
    
    def register_bot(self, bot_id: str, bot_token: str):
        """Register another bot in the network."""
        self.other_bots[bot_id] = bot_token
    
    def register_handler(self, action: str, handler: Callable):
        """Register handler for specific action."""
        self.handlers[action] = handler
    
    async def send_to_bot(self, to_bot: str, action: str, payload: Dict):
        """Send message to another bot."""
        message = BotMessage(
            from_bot=self.bot_id,
            to_bot=to_bot,
            action=action,
            payload=payload,
            timestamp=asyncio.get_event_loop().time(),
            message_id=f"{self.bot_id}_{asyncio.get_event_loop().time()}"
        )
        
        # Publish to Redis channel
        channel = f"bot_channel_{to_bot}"
        await self.redis.publish(
            channel,
            json.dumps(asdict(message))
        )
        
        # Log the message
        await self._log_message(message)
        
        return message.message_id
    
    async def broadcast(self, action: str, payload: Dict):
        """Broadcast message to all bots."""
        tasks = []
        for bot_id in self.other_bots:
            tasks.append(self.send_to_bot(bot_id, action, payload))
        
        await asyncio.gather(*tasks)
    
    async def _listen_for_messages(self):
        """Listen for incoming messages from other bots."""
        pubsub = self.redis.pubsub()
        channel = f"bot_channel_{self.bot_id}"
        await pubsub.subscribe(channel)
        
        async for message in pubsub.listen():
            if message['type'] == 'message':
                await self._process_message(message['data'])
    
    async def _process_message(self, data: bytes):
        """Process incoming message."""
        try:
            message_data = json.loads(data)
            message = BotMessage(**message_data)
            
            # Find and execute handler
            handler = self.handlers.get(message.action)
            if handler:
                await handler(message)
            else:
                print(f"No handler for action: {message.action}")
            
            # Acknowledge message
            await self._acknowledge_message(message)
            
        except Exception as e:
            print(f"Error processing message: {e}")
    
    async def _acknowledge_message(self, message: BotMessage):
        """Send acknowledgment back to sender."""
        ack_channel = f"bot_ack_{message.from_bot}"
        await self.redis.publish(
            ack_channel,
            json.dumps({
                "message_id": message.message_id,
                "status": "received",
                "bot_id": self.bot_id
            })
        )
    
    async def _log_message(self, message: BotMessage):
        """Log message for debugging."""
        await self.redis.zadd(
            f"bot_messages_{self.bot_id}",
            {json.dumps(asdict(message)): message.timestamp}
        )
    
    async def request_data(self, from_bot: str, data_type: str) -&gt; Dict:
        """Request data from another bot and wait for response."""
        request_id = f"req_{asyncio.get_event_loop().time()}"
        
        # Create response future
        response_future = asyncio.Future()
        self.handlers[f"response_{request_id}"] = lambda msg: response_future.set_result(msg.payload)
        
        # Send request
        await self.send_to_bot(from_bot, "data_request", {
            "request_id": request_id,
            "data_type": data_type
        })
        
        # Wait for response (with timeout)
        try:
            response = await asyncio.wait_for(response_future, timeout=10.0)
            return response
        except asyncio.TimeoutError:
            return {"error": "Request timeout"}
        finally:
            # Clean up handler
            self.handlers.pop(f"response_{request_id}", None)

# Example usage
async def setup_bot_network():
    # Main bot
    main_bot = BotNetwork("main_bot", "MAIN_BOT_TOKEN", "redis://localhost")
    await main_bot.connect()
    
    # Register other bots
    main_bot.register_bot("analytics_bot", "ANALYTICS_BOT_TOKEN")
    main_bot.register_bot("support_bot", "SUPPORT_BOT_TOKEN")
    
    # Register handlers
    async def handle_user_stats(message: BotMessage):
        print(f"Received user stats: {message.payload}")
    
    main_bot.register_handler("user_stats", handle_user_stats)
    
    # Send message to analytics bot
    await main_bot.send_to_bot("analytics_bot", "get_stats", {
        "user_id": 123456,
        "period": "last_week"
    })
    
    # Broadcast event to all bots
    await main_bot.broadcast("system_update", {
        "version": "2.0",
        "features": ["new_ui", "faster_responses"]
    })</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 48: Auto-Deployment Scripts -->
      <div class="category" id="category-48">
        <div class="category-header">
          <i class="fas fa-rocket"></i>
          <h2>Auto-Deployment Scripts</h2>
        </div>

        <div class="snippet" id="snippet-48-1">
          <div class="snippet-header">
            <h3 class="snippet-title">48.1 GitHub Actions Deployment</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×××¤×©×¨ ×¤×¨×™×¡×” ××•×˜×•××˜×™×ª ×©×œ ×”×‘×•×˜ ×‘×›×œ ×¤×¢× ×©×™×© ×©×™× ×•×™ ×‘×§×•×“. ×—×•×¡×š ×–××Ÿ ×•××¤×—×™×ª ×˜×¢×•×™×•×ª ×™×“× ×™×•×ª ×‘×ª×”×œ×™×š ×”×¤×¨×™×¡×”.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-yaml"><code class="language-yaml"># .github/workflows/deploy.yml
name: Deploy Telegram Bot

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: &#x27;3.10&#x27;
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio pytest-cov
    
    - name: Run tests
      env:
        BOT_TOKEN: ${{ secrets.TEST_BOT_TOKEN }}
      run: |
        pytest tests/ --cov=bot --cov-report=xml
    
    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == &#x27;refs/heads/main&#x27;
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Deploy to server
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          cd /home/bot/telegram-bot
          git pull origin main
          
          # Backup current version
          cp -r . ../backup/$(date +%Y%m%d_%H%M%S)
          
          # Install/update dependencies
          source venv/bin/activate
          pip install -r requirements.txt
          
          # Run migrations if needed
          alembic upgrade head
          
          # Restart bot with zero downtime
          sudo systemctl reload telegram-bot || sudo systemctl restart telegram-bot
          
          # Health check
          sleep 5
          curl -f http://localhost:8000/health || exit 1
    
    - name: Notify deployment
      if: success()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          âœ… Deployment successful!
          
          Repository: ${{ github.repository }}
          Branch: ${{ github.ref }}
          Commit: ${{ github.sha }}
          Author: ${{ github.actor }}
          
          View changes: ${{ github.event.compare }}
    
    - name: Rollback on failure
      if: failure()
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          cd /home/bot
          latest_backup=$(ls -t backup/ | head -1)
          cp -r backup/$latest_backup/* telegram-bot/
          sudo systemctl restart telegram-bot</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-48-2">
          <div class="snippet-header">
            <h3 class="snippet-title">48.2 Docker Deployment Script</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××‘×¦×¢ ×¤×¨×™×¡×ª Docker ×¢× ×‘×“×™×§×•×ª, ××¢×‘×¨ ×ª×¢×‘×•×¨×” ××‘×•×§×¨ ×•××¤×©×¨×•×ª ×œ-Rollback ××”×™×¨.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python"># deploy.py
import subprocess
import os
import sys
from datetime import datetime

class BotDeployer:
    def __init__(self, config):
        self.config = config
        self.timestamp = datetime.now().strftime(&#x27;%Y%m%d_%H%M%S&#x27;)
    
    def build_docker_image(self):
        &quot;&quot;&quot;Build Docker image for the bot.&quot;&quot;&quot;
        print(&quot;ğŸ”¨ Building Docker image...&quot;)
        
        cmd = [
            &quot;docker&quot;, &quot;build&quot;,
            &quot;-t&quot;, f&quot;{self.config[&#x27;image_name&#x27;]}:{self.timestamp}&quot;,
            &quot;-t&quot;, f&quot;{self.config[&#x27;image_name&#x27;]}:latest&quot;,
            &quot;.&quot;
        ]
        
        result = subprocess.run(cmd, capture_output=True, text=True)
        if result.returncode != 0:
            print(f&quot;âŒ Build failed: {result.stderr}&quot;)
            sys.exit(1)
        
        print(&quot;âœ… Docker image built successfully&quot;)
    
    def run_tests(self):
        &quot;&quot;&quot;Run tests in Docker container.&quot;&quot;&quot;
        print(&quot;ğŸ§ª Running tests...&quot;)
        
        cmd = [
            &quot;docker&quot;, &quot;run&quot;, &quot;--rm&quot;,
            f&quot;{self.config[&#x27;image_name&#x27;]}:latest&quot;,
            &quot;pytest&quot;, &quot;tests/&quot;
        ]
        
        result = subprocess.run(cmd, capture_output=True, text=True)
        if result.returncode != 0:
            print(f&quot;âŒ Tests failed: {result.stderr}&quot;)
            sys.exit(1)
        
        print(&quot;âœ… All tests passed&quot;)
    
    def deploy_container(self):
        &quot;&quot;&quot;Deploy new container with zero downtime.&quot;&quot;&quot;
        print(&quot;ğŸš€ Deploying new container...&quot;)
        
        # Start new container
        new_container = f&quot;bot_{self.timestamp}&quot;
        cmd = [
            &quot;docker&quot;, &quot;run&quot;, &quot;-d&quot;,
            &quot;--name&quot;, new_container,
            &quot;--env-file&quot;, &quot;.env&quot;,
            &quot;--network&quot;, &quot;bot_network&quot;,
            &quot;-p&quot;, &quot;8001:8000&quot;,  # Temporary port
            f&quot;{self.config[&#x27;image_name&#x27;]}:latest&quot;
        ]
        
        subprocess.run(cmd, check=True)
        
        # Health check
        print(&quot;ğŸ¥ Running health check...&quot;)
        import time
        time.sleep(5)
        
        health_cmd = [&quot;docker&quot;, &quot;exec&quot;, new_container, &quot;curl&quot;, &quot;http://localhost:8000/health&quot;]
        result = subprocess.run(health_cmd, capture_output=True)
        
        if result.returncode != 0:
            print(&quot;âŒ Health check failed&quot;)
            subprocess.run([&quot;docker&quot;, &quot;stop&quot;, new_container])
            subprocess.run([&quot;docker&quot;, &quot;rm&quot;, new_container])
            sys.exit(1)
        
        # Switch traffic (nginx or load balancer)
        print(&quot;ğŸ”„ Switching traffic...&quot;)
        self.switch_traffic(new_container)
        
        # Stop old container
        old_container = self.get_current_container()
        if old_container:
            print(f&quot;ğŸ›‘ Stopping old container: {old_container}&quot;)
            subprocess.run([&quot;docker&quot;, &quot;stop&quot;, old_container])
            subprocess.run([&quot;docker&quot;, &quot;rm&quot;, old_container])
        
        print(&quot;âœ… Deployment completed successfully&quot;)
    
    def switch_traffic(self, new_container):
        &quot;&quot;&quot;Update nginx configuration to point to new container.&quot;&quot;&quot;
        # Implementation depends on your setup
        pass
    
    def get_current_container(self):
        &quot;&quot;&quot;Get currently running bot container.&quot;&quot;&quot;
        cmd = [&quot;docker&quot;, &quot;ps&quot;, &quot;--filter&quot;, &quot;name=bot_&quot;, &quot;--format&quot;, &quot;{{.Names}}&quot;]
        result = subprocess.run(cmd, capture_output=True, text=True)
        containers = result.stdout.strip().split(&#x27;\n&#x27;)
        return containers[0] if containers else None
    
    def rollback(self):
        &quot;&quot;&quot;Rollback to previous version.&quot;&quot;&quot;
        print(&quot;â®ï¸ Rolling back to previous version...&quot;)
        # Implementation for rollback
        pass

# Usage
if __name__ == &quot;__main__&quot;:
    config = {
        &quot;image_name&quot;: &quot;telegram-bot&quot;,
        &quot;registry&quot;: &quot;docker.io/myuser&quot;
    }
    
    deployer = BotDeployer(config)
    deployer.build_docker_image()
    deployer.run_tests()
    deployer.deploy_container()</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 49: Smart Caching with Dynamic TTL -->
      <div class="category" id="category-49">
        <div class="category-header">
          <i class="fas fa-sync"></i>
          <h2>Smart Caching with Dynamic TTL</h2>
        </div>

        <div class="snippet" id="snippet-49-1">
          <div class="snippet-header">
            <h3 class="snippet-title">49.1 Adaptive Cache Management</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××™×™×¢×œ ××ª ×‘×™×¦×•×¢×™ ×”×‘×•×˜ ×¢×œ ×™×“×™ ×©××™×¨×ª ××™×“×¢ × ×¤×•×¥ ×‘××˜××•×Ÿ ×¢× ×–×× ×™ ×ª×¤×•×’×” ×—×›××™×. ×—×•×¡×š ×§×¨×™××•×ª ×œ××¡×“ × ×ª×•× ×™× ×•××©×¤×¨ ×–×× ×™ ×ª×’×•×‘×”.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import asyncio
import time
from typing import Any, Optional, Callable
from collections import defaultdict
import aioredis
import pickle
import hashlib

class SmartCache:
    def __init__(self, redis_url: str):
        self.redis = None
        self.redis_url = redis_url
        self.access_counts = defaultdict(int)
        self.last_access = defaultdict(float)
        self.ttl_stats = defaultdict(list)
        
    async def connect(self):
        """Connect to Redis."""
        self.redis = await aioredis.from_url(self.redis_url)
    
    def _calculate_adaptive_ttl(self, key: str, base_ttl: int = 300) -&gt; int:
        """Calculate TTL based on access patterns."""
        access_count = self.access_counts[key]
        time_since_last = time.time() - self.last_access.get(key, 0)
        
        # Factors affecting TTL
        factors = {
            'high_access': min(access_count / 10, 3),  # Up to 3x for high access
            'recent_access': 2 if time_since_last &lt; 60 else 1,  # 2x if accessed recently
            'time_of_day': self._get_time_factor(),  # Peak hours get longer TTL
        }
        
        # Calculate final TTL
        multiplier = sum(factors.values()) / len(factors)
        adaptive_ttl = int(base_ttl * multiplier)
        
        # Cap between min and max
        return max(60, min(adaptive_ttl, 3600))  # 1 min to 1 hour
    
    def _get_time_factor(self) -&gt; float:
        """Get time-based factor for TTL."""
        hour = time.localtime().tm_hour
        # Peak hours (9-17) get longer TTL
        if 9 &lt;= hour &lt;= 17:
            return 2.0
        # Off-peak hours
        elif hour &lt; 6 or hour &gt; 22:
            return 0.5
        else:
            return 1.0
    
    async def get(
        self, 
        key: str, 
        fetch_func: Optional[Callable] = None,
        ttl: Optional[int] = None
    ) -&gt; Any:
        """Get value from cache or fetch if missing."""
        # Track access
        self.access_counts[key] += 1
        self.last_access[key] = time.time()
        
        # Try to get from cache
        cached = await self.redis.get(key)
        if cached:
            return pickle.loads(cached)
        
        # Cache miss - fetch if function provided
        if fetch_func:
            value = await fetch_func() if asyncio.iscoroutinefunction(fetch_func) else fetch_func()
            
            # Calculate adaptive TTL if not provided
            if ttl is None:
                ttl = self._calculate_adaptive_ttl(key)
            
            # Store in cache
            await self.set(key, value, ttl)
            return value
        
        return None
    
    async def set(self, key: str, value: Any, ttl: Optional[int] = None):
        """Set value in cache with adaptive TTL."""
        if ttl is None:
            ttl = self._calculate_adaptive_ttl(key)
        
        # Store TTL stats for monitoring
        self.ttl_stats[key].append((time.time(), ttl))
        
        # Serialize and store
        serialized = pickle.dumps(value)
        await self.redis.set(key, serialized, ex=ttl)
    
    async def get_or_compute(
        self,
        key: str,
        compute_func: Callable,
        ttl: Optional[int] = None,
        lock_timeout: int = 10
    ) -&gt; Any:
        """Get from cache or compute with distributed lock."""
        # Try cache first
        cached = await self.get(key)
        if cached is not None:
            return cached
        
        # Use distributed lock to prevent cache stampede
        lock_key = f"lock:{key}"
        lock_acquired = await self.redis.set(
            lock_key, "1", 
            nx=True, 
            ex=lock_timeout
        )
        
        if lock_acquired:
            try:
                # Double-check cache (another process might have computed it)
                cached = await self.get(key)
                if cached is not None:
                    return cached
                
                # Compute value
                value = await compute_func() if asyncio.iscoroutinefunction(compute_func) else compute_func()
                
                # Store with adaptive TTL
                await self.set(key, value, ttl)
                return value
            finally:
                await self.redis.delete(lock_key)
        else:
            # Wait for lock owner to compute
            for _ in range(lock_timeout * 10):  # Check every 100ms
                await asyncio.sleep(0.1)
                cached = await self.get(key)
                if cached is not None:
                    return cached
            
            # Timeout - compute anyway
            return await compute_func() if asyncio.iscoroutinefunction(compute_func) else compute_func()
    
    async def invalidate_pattern(self, pattern: str):
        """Invalidate all keys matching pattern."""
        cursor = '0'
        while cursor != 0:
            cursor, keys = await self.redis.scan(
                cursor=cursor,
                match=pattern,
                count=100
            )
            if keys:
                await self.redis.delete(*keys)
    
    async def get_stats(self) -&gt; dict:
        """Get cache statistics."""
        total_keys = await self.redis.dbsize()
        
        # Get top accessed keys
        top_keys = sorted(
            self.access_counts.items(),
            key=lambda x: x[1],
            reverse=True
        )[:10]
        
        return {
            'total_keys': total_keys,
            'top_accessed': top_keys,
            'average_ttl': self._calculate_average_ttl(),
            'memory_usage': await self.redis.info('memory')
        }
    
    def _calculate_average_ttl(self) -&gt; float:
        """Calculate average TTL across all keys."""
        all_ttls = []
        for ttls in self.ttl_stats.values():
            all_ttls.extend([ttl for _, ttl in ttls[-10:]])  # Last 10 TTLs per key
        
        return sum(all_ttls) / len(all_ttls) if all_ttls else 0

# Decorator for automatic caching
def cached(ttl: Optional[int] = None, key_prefix: str = ""):
    """Decorator for caching function results."""
    def decorator(func):
        async def wrapper(self, *args, **kwargs):
            # Generate cache key from function name and arguments
            cache_key = f"{key_prefix}:{func.__name__}:{hashlib.md5(str((args, kwargs)).encode()).hexdigest()}"
            
            # Get or compute with cache
            return await self.cache.get_or_compute(
                cache_key,
                lambda: func(self, *args, **kwargs),
                ttl
            )
        return wrapper
    return decorator

# Usage example
class BotService:
    def __init__(self, cache: SmartCache):
        self.cache = cache
    
    @cached(key_prefix="user")
    async def get_user_profile(self, user_id: int):
        """Get user profile with automatic caching."""
        # Expensive database query
        return await db.fetch_user(user_id)
    
    @cached(ttl=60, key_prefix="stats")
    async def get_statistics(self):
        """Get bot statistics with 60 second cache."""
        # Complex aggregation
        return await calculate_stats()</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 50: Video Chat Integration -->
      <div class="category" id="category-50">
        <div class="category-header">
          <i class="fas fa-video"></i>
          <h2>Video Chat Integration</h2>
        </div>

        <div class="snippet" id="snippet-50-1">
          <div class="snippet-header">
            <h3 class="snippet-title">50.1 Create Video Rooms for Users</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×××¤×©×¨ ×™×¦×™×¨×ª ×—×“×¨×™ ×•×™×“××• ×œ×©×™×—×•×ª ×§×‘×•×¦×ª×™×•×ª ××• ×¤×¨×˜×™×•×ª. ××¢×•×œ×” ×œ×‘×•×˜×™× ×©×œ ×¤×’×™×©×•×ª, ×œ××™×“×” ××¨×—×•×§, ××• ×ª××™×›×” ×˜×›× ×™×ª.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from typing import Dict, List, Optional
import uuid
import jwt
from datetime import datetime, timedelta
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes

class VideoRoomManager:
    def __init__(self, video_service_url: str, api_key: str, jwt_secret: str):
        self.video_service_url = video_service_url
        self.api_key = api_key
        self.jwt_secret = jwt_secret
        self.active_rooms: Dict[str, dict] = {}
        
    async def create_video_room(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Create a new video room."""
        user = update.effective_user
        room_id = str(uuid.uuid4())
        
        # Create room metadata
        room_data = {
            'room_id': room_id,
            'host_id': user.id,
            'host_name': user.first_name,
            'created_at': datetime.now(),
            'participants': [user.id],
            'max_participants': 10,
            'duration_minutes': 60,
            'settings': {
                'recording': False,
                'waiting_room': True,
                'mute_on_entry': True,
                'screen_share': True
            }
        }
        
        self.active_rooms[room_id] = room_data
        
        # Generate join links
        host_link = self._generate_join_link(room_id, user.id, is_host=True)
        participant_link = self._generate_join_link(room_id, user.id, is_host=False)
        
        # Create inline keyboard
        keyboard = [
            [InlineKeyboardButton("ğŸ¥ ×”×¦×˜×¨×£ ×›×××¨×—", url=host_link)],
            [InlineKeyboardButton("ğŸ“¤ ×©×ª×£ ×”×–×× ×”", switch_inline_query=f"join_video {room_id}")],
            [InlineKeyboardButton("âš™ï¸ ×”×’×“×¨×•×ª ×—×“×¨", callback_data=f"room_settings:{room_id}")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await update.message.reply_text(
            f"ğŸ¥ **×—×“×¨ ×•×™×“××• × ×•×¦×¨ ×‘×”×¦×œ×—×”!**\n\n"
            f"ğŸ†” ××–×”×” ×—×“×¨: `{room_id}`\n"
            f"ğŸ‘¥ ××§×¡×™××•× ××©×ª×ª×¤×™×: {room_data['max_participants']}\n"
            f"â±ï¸ ××©×š: {room_data['duration_minutes']} ×“×§×•×ª\n\n"
            f"ğŸ”— ×§×™×©×•×¨ ×œ×”×¦×˜×¨×¤×•×ª:\n{participant_link}",
            reply_markup=reply_markup,
            parse_mode='Markdown'
        )
    
    def _generate_join_link(self, room_id: str, user_id: int, is_host: bool) -&gt; str:
        """Generate secure join link with JWT."""
        payload = {
            'room_id': room_id,
            'user_id': user_id,
            'is_host': is_host,
            'exp': datetime.utcnow() + timedelta(hours=1)
        }
        
        token = jwt.encode(payload, self.jwt_secret, algorithm='HS256')
        return f"{self.video_service_url}/room/{room_id}?token={token}"
    
    async def join_video_room(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Handle joining a video room."""
        room_id = context.args[0] if context.args else None
        
        if not room_id or room_id not in self.active_rooms:
            await update.message.reply_text("âŒ ×—×“×¨ ×œ× × ××¦× ××• ×¤×’ ×ª×•×§×£")
            return
        
        room = self.active_rooms[room_id]
        user = update.effective_user
        
        # Check if room is full
        if len(room['participants']) &gt;= room['max_participants']:
            await update.message.reply_text("âŒ ×”×—×“×¨ ××œ×")
            return
        
        # Add participant
        if user.id not in room['participants']:
            room['participants'].append(user.id)
        
        # Generate join link
        join_link = self._generate_join_link(room_id, user.id, is_host=False)
        
        keyboard = [[InlineKeyboardButton("ğŸ¥ ×”×¦×˜×¨×£ ×œ×©×™×—×”", url=join_link)]]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await update.message.reply_text(
            f"âœ… ×”×¦×˜×¨×¤×ª ×œ×—×“×¨!\n"
            f"ğŸ‘¥ ××©×ª×ª×¤×™×: {len(room['participants'])}/{room['max_participants']}",
            reply_markup=reply_markup
        )
        
        # Notify host
        if user.id != room['host_id']:
            await context.bot.send_message(
                room['host_id'],
                f"ğŸ‘¤ {user.first_name} ×”×¦×˜×¨×£ ×œ×—×“×¨ ×”×•×™×“××• ×©×œ×š"
            )
    
    async def manage_room_settings(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Manage video room settings."""
        query = update.callback_query
        room_id = query.data.split(':')[1]
        
        if room_id not in self.active_rooms:
            await query.answer("×”×—×“×¨ ×œ× × ××¦×", show_alert=True)
            return
        
        room = self.active_rooms[room_id]
        
        # Only host can manage settings
        if query.from_user.id != room['host_id']:
            await query.answer("×¨×§ ×”×××¨×— ×™×›×•×œ ×œ×©× ×•×ª ×”×’×“×¨×•×ª", show_alert=True)
            return
        
        # Toggle settings keyboard
        keyboard = []
        for setting, value in room['settings'].items():
            emoji = "âœ…" if value else "âŒ"
            keyboard.append([InlineKeyboardButton(
                f"{emoji} {setting.replace('_', ' ').title()}",
                callback_data=f"toggle_setting:{room_id}:{setting}"
            )])
        
        keyboard.append([InlineKeyboardButton("ğŸ”™ ×—×–×•×¨", callback_data=f"room_info:{room_id}")])
        
        await query.edit_message_text(
            f"âš™ï¸ **×”×’×“×¨×•×ª ×—×“×¨ ×•×™×“××•**\n\n"
            f"×œ×—×¥ ×¢×œ ×”×’×“×¨×” ×›×“×™ ×œ×©× ×•×ª ××•×ª×”:",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
    
    async def end_video_room(self, room_id: str, context: ContextTypes.DEFAULT_TYPE):
        """End a video room and notify participants."""
        if room_id not in self.active_rooms:
            return
        
        room = self.active_rooms[room_id]
        
        # Notify all participants
        for participant_id in room['participants']:
            try:
                await context.bot.send_message(
                    participant_id,
                    f"ğŸ”š ×—×“×¨ ×”×•×™×“××• ×”×¡×ª×™×™×\n"
                    f"××©×š ×”×©×™×—×”: {(datetime.now() - room['created_at']).seconds // 60} ×“×§×•×ª"
                )
            except:
                pass
        
        # Clean up
        del self.active_rooms[room_id]
    
    async def schedule_video_meeting(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Schedule a video meeting for later."""
        # Parse meeting details
        try:
            date_str = context.args[0]  # Format: DD/MM/YYYY
            time_str = context.args[1]  # Format: HH:MM
            title = ' '.join(context.args[2:]) if len(context.args) &gt; 2 else "×¤×’×™×©×ª ×•×™×“××•"
            
            # Schedule the meeting
            meeting_time = datetime.strptime(f"{date_str} {time_str}", "%d/%m/%Y %H:%M")
            
            # Create scheduled meeting
            meeting_id = str(uuid.uuid4())
            
            # Store in database or scheduler
            context.job_queue.run_once(
                self._create_scheduled_room,
                when=meeting_time,
                context={
                    'meeting_id': meeting_id,
                    'host_id': update.effective_user.id,
                    'title': title
                }
            )
            
            await update.message.reply_text(
                f"ğŸ“… **×¤×’×™×©×” × ×§×‘×¢×”!**\n\n"
                f"ğŸ“ × ×•×©×: {title}\n"
                f"ğŸ“† ×ª××¨×™×š: {date_str}\n"
                f"â° ×©×¢×”: {time_str}\n\n"
                f"×ª×§×‘×œ ×ª×–×›×•×¨×ª 10 ×“×§×•×ª ×œ×¤× ×™ ×”×¤×’×™×©×”."
            )
            
        except (IndexError, ValueError):
            await update.message.reply_text(
                "âŒ ×¤×•×¨××˜ ×œ× ×ª×§×™×Ÿ. ×”×©×ª××© ×‘:\n"
                "/schedule DD/MM/YYYY HH:MM [× ×•×©× ×”×¤×’×™×©×”]"
            )
    
    async def _create_scheduled_room(self, context: ContextTypes.DEFAULT_TYPE):
        """Create room for scheduled meeting."""
        data = context.job.context
        
        # Create room
        room_id = str(uuid.uuid4())
        # ... create room logic ...
        
        # Notify host
        await context.bot.send_message(
            data['host_id'],
            f"ğŸ”” ×”×¤×’×™×©×” ×©×œ×š '{data['title']}' ××ª×—×™×œ×” ×¢×›×©×™×•!\n"
            f"×œ×—×¥ ×›××Ÿ ×›×“×™ ×œ×”×ª×—×™×œ: /start_video {room_id}"
        )</code></pre>
          </div>
        </div>
      </div>
    </div>

    <!-- Back to top button -->
    <button class="back-to-top" id="backToTop" aria-label="×—×–×¨×” ×œ××¢×œ×”">
      <i class="fas fa-arrow-up"></i>
    </button>

    <script src="scripts.js"></script>
  

</body></html>
