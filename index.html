<!DOCTYPE html>
<html lang="he" dir="rtl" data-theme="light" style=""><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¡×¤×¨×™×™×ª Code Snippets ×”××§×™×¤×”</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&amp;family=Fira+Code:wght@300;400;500&amp;display=swap" rel="stylesheet">

    <!-- Prism.js for syntax highlighting -->
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">

    <style>
      :root {
        --primary-color: #2d3748;
        --secondary-color: #4a5568;
        --accent-color: #3182ce;
        --background-color: #ffffff;
        --card-background: #f7fafc;
        --text-color: #1a202c;
        --border-color: #e2e8f0;
        --code-background: #282a36;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          'Heebo',
          -apple-system,
          BlinkMacSystemFont,
          sans-serif;
        background-color: var(--background-color);
        color: var(--text-color);
        line-height: 1.6;
        direction: rtl;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
      }

      /* Header */
      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 3rem 0;
        text-align: center;
        margin-bottom: 2rem;
      }

      .header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 1rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .header p {
        font-size: 1.2rem;
        opacity: 0.9;
        max-width: 600px;
        margin: 0 auto;
      }

      /* Search */
      .search-container {
        position: sticky;
        top: 0;
        background: var(--background-color);
        padding: 1rem 0;
        border-bottom: 2px solid var(--border-color);
        margin-bottom: 2rem;
        z-index: 100;
      }

      .search-box {
        position: relative;
        max-width: 500px;
        margin: 0 auto;
      }

      .search-input {
        width: 100%;
        padding: 0.75rem 3rem 0.75rem 1rem;
        border: 2px solid var(--border-color);
        border-radius: 0.5rem;
        font-size: 1rem;
        font-family: 'Heebo', sans-serif;
        direction: rtl;
        outline: none;
        transition: border-color 0.3s ease;
      }

      .search-input:focus {
        border-color: var(--accent-color);
      }

      .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--secondary-color);
        pointer-events: none;
      }

      /* Table of Contents */
      .toc {
        background: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
      }

      .toc h2 {
        color: var(--primary-color);
        margin-bottom: 1rem;
        font-size: 1.5rem;
      }

      .toc-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1rem;
      }

      .toc-category {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        padding: 1rem;
      }

      .toc-category h3 {
        color: var(--accent-color);
        font-size: 1rem;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .toc-links {
        list-style: none;
        font-size: 0.9rem;
      }

      .toc-links li {
        margin-bottom: 0.25rem;
      }

      .toc-links a {
        color: var(--secondary-color);
        text-decoration: none;
        display: block;
        padding: 0.25rem 0;
        border-radius: 0.25rem;
        transition: all 0.2s ease;
      }

      .toc-links a:hover {
        color: var(--accent-color);
        background: var(--card-background);
        padding-right: 0.5rem;
      }

      /* Categories */
      .category {
        margin-bottom: 3rem;
      }

      .category-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid var(--accent-color);
      }

      .category-header i {
        font-size: 1.5rem;
        color: var(--accent-color);
      }

      .category-header h2 {
        color: var(--primary-color);
        font-size: 1.75rem;
        font-weight: 600;
      }

      /* Snippets */
      .snippet {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
        overflow: hidden;
        box-shadow: var(--shadow);
        transition:
          transform 0.2s ease,
          box-shadow 0.2s ease;
      }

      .snippet:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 15px -3px rgba(0, 0, 0, 0.1);
      }

      .snippet-header {
        background: var(--card-background);
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
      }

      .snippet-title {
        color: var(--primary-color);
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }

      .snippet-description {
        color: var(--secondary-color);
        font-size: 0.95rem;
        line-height: 1.5;
      }

      .snippet-content {
        position: relative;
      }

      .copy-button {
        position: absolute;
        top: 0.75rem;
        left: 0.75rem;
        background: var(--accent-color);
        color: white;
        border: none;
        border-radius: 0.25rem;
        padding: 0.5rem;
        cursor: pointer;
        font-size: 0.875rem;
        opacity: 0;
        transition: opacity 0.2s ease;
        z-index: 10;
        direction: ltr;
      }

      .snippet:hover .copy-button {
        opacity: 1;
      }

      .copy-button:hover {
        background: #2c5aa0;
      }

      .copy-success {
        background: #10b981 !important;
      }

      /* Code blocks */
      pre[class*='language-'] {
        direction: ltr;
        text-align: left;
        margin: 0;
        border-radius: 0;
        background: var(--code-background) !important;
        font-family: 'Fira Code', 'Courier New', monospace !important;
      }

      code[class*='language-'] {
        font-family: 'Fira Code', 'Courier New', monospace !important;
        font-size: 0.9rem;
        line-height: 1.5;
      }

      /* Filter animations */
      .snippet.filtered-out {
        display: none;
      }

      .category.no-matches {
        display: none;
      }

      /* Responsive design */
      @media (max-width: 768px) {
        .container {
          padding: 0 15px;
        }

        .header h1 {
          font-size: 2rem;
        }

        .header p {
          font-size: 1rem;
        }

        .toc-grid {
          grid-template-columns: 1fr;
        }

        .snippet-header {
          padding: 0.75rem 1rem;
        }

        .snippet-title {
          font-size: 1.1rem;
        }
      }

      /* Scroll behavior */
      html {
        scroll-behavior: smooth;
      }

      /* Anchor offset */
      .category {
        scroll-margin-top: 100px;
      }

      /* No results message */
      .no-results {
        text-align: center;
        padding: 3rem;
        color: var(--secondary-color);
        display: none;
      }

      .no-results.show {
        display: block;
      }
    </style>
  </head>
  <body style="">
    <!-- Header -->
    <div class="header">
      <div class="container">
        <h1><i class="fas fa-code"></i> ×¡×¤×¨×™×™×ª Code Snippets ×”××§×™×¤×”</h1>
        <p>
          ××•×¡×£ ××§×™×£ ×©×œ ×ª×‘× ×™×•×ª ×§×•×“ ×œ×¤×™×ª×•×— ×‘×•×˜×™× ×‘×˜×œ×’×¨×, WebApps, ×¢×‘×•×“×” ×¢× ××¡×“×™ × ×ª×•× ×™× ×•×¢×•×“. ×›×œ ×”×¡× ×™×¤×˜×™× × ×‘×“×§×• ×•××•×›× ×™×
          ×œ×©×™××•×© ××™×™×“×™.
        </p>
      </div>
    </div>

    <div class="container">
      <!-- Search -->
      <div class="search-container">
        <div class="search-box">
          <input type="text" id="searchInput" class="search-input" placeholder="×—×¤×© ×¡× ×™×¤×˜×™×...">
          <i class="fas fa-search search-icon"></i>
        </div>
      </div>

      <!-- Table of Contents -->
      <div class="toc">
        <h2><i class="fas fa-list"></i> ×ª×•×›×Ÿ ×¢× ×™×™× ×™×</h2>
        <div class="toc-grid">
          <div class="toc-category">
            <h3><i class="fas fa-robot"></i> ×ª×¤×¨×™×˜×™× ×‘×‘×•×˜</h3>
            <ul class="toc-links">
              <li><a href="#snippet-1-1">×ª×¤×¨×™×˜ ×¤×¢×•×œ×•×ª ×¢×œ ×§×•×‘×¥</a></li>
              <li><a href="#snippet-1-2">×ª×™×‘×ª ××™×©×•×¨ ×¢× ×›×¤×ª×•×¨×™×</a></li>
              <li><a href="#snippet-1-3">Callback Query Handler</a></li>
              <li><a href="#snippet-1-4">Pagination Helper</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-database"></i> ×¢×‘×•×“×” ×¢× ××¡×“ × ×ª×•× ×™×</h3>
            <ul class="toc-links">
              <li><a href="#snippet-2-1">×©××™×¨×ª ××¡××š ×¢× Versioning</a></li>
              <li><a href="#snippet-2-2">×©×œ×™×¤×ª ××¡××š ×¢× ××˜××•×Ÿ</a></li>
              <li><a href="#snippet-2-3">Update ×¢× Upsert</a></li>
              <li><a href="#snippet-2-4">Aggregation Pipeline</a></li>
              <li><a href="#snippet-2-5">Soft Delete ×¢× TTL</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-file-code"></i> × ×™×”×•×œ ×§×‘×¦×™× ×•×’×¨×¡××•×ª</h3>
            <ul class="toc-links">
              <li><a href="#snippet-3-1">×©××™×¨×ª ×§×•×‘×¥ ×¢× ×–×™×”×•×™ ×©×¤×”</a></li>
              <li><a href="#snippet-3-2">×©×œ×™×¤×ª ×’×¨×¡××•×ª</a></li>
              <li><a href="#snippet-3-3">×–×™×”×•×™ ×©×™× ×•×™×™× ×¢× Hash</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-globe"></i> ××™× ×˜×’×¨×¦×™×” ×¢× WebApp</h3>
            <ul class="toc-links">
              <li><a href="#snippet-4-1">×›×¤×ª×•×¨ WebApp</a></li>
              <li><a href="#snippet-4-2">×˜×•×§×Ÿ ×”×ª×—×‘×¨×•×ª</a></li>
              <li><a href="#snippet-4-3">××™××•×ª ×˜×•×§×Ÿ</a></li>
              <li><a href="#snippet-4-4">××ª×—×•×œ WebApp</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-paint-brush"></i> ×¨×›×™×‘×™ UI ×‘-WebApp</h3>
            <ul class="toc-links">
              <li><a href="#snippet-5-1">Modal Dialog</a></li>
              <li><a href="#snippet-5-2">Toast Notification</a></li>
              <li><a href="#snippet-5-3">Loading Overlay</a></li>
              <li><a href="#snippet-5-4">Expandable Card</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-clipboard-list"></i> Structured Logging</h3>
            <ul class="toc-links">
              <li><a href="#snippet-6-1">Emit Event ×¢× Request ID</a></li>
              <li><a href="#snippet-6-2">Binding Request ID</a></li>
              <li><a href="#snippet-6-3">Binding User Context</a></li>
              <li><a href="#snippet-6-4">×”×’×“×¨×ª Structlog</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-exclamation-triangle"></i> ×”×•×“×¢×•×ª ×©×’×™××”</h3>
            <ul class="toc-links">
              <li><a href="#snippet-7-1">Rate Limit Error Handler</a></li>
              <li><a href="#snippet-7-2">Database Error</a></li>
              <li><a href="#snippet-7-3">Validation Messages</a></li>
              <li><a href="#snippet-7-4">Batch Processing</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-vial"></i> ×‘×“×™×§×•×ª Pytest</h3>
            <ul class="toc-links">
              <li><a href="#snippet-8-1">Fixture ×¢× Setup/Teardown</a></li>
              <li><a href="#snippet-8-2">Test Parametrization</a></li>
              <li><a href="#snippet-8-3">Async Test</a></li>
              <li><a href="#snippet-8-4">Mocking ×¢× MagicMock</a></li>
              <li><a href="#snippet-8-5">Mocking ×¢× @patch</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-tools"></i> ×¤×•× ×§×¦×™×•×ª ×¢×–×¨</h3>
            <ul class="toc-links">
              <li><a href="#snippet-9-1">×–××Ÿ ×™×—×¡×™ ×‘×¢×‘×¨×™×ª</a></li>
              <li><a href="#snippet-9-2">××¡×§×™×™×¤ ×œ-Markdown</a></li>
              <li><a href="#snippet-9-3">× ×™×§×•×™ ×©××•×ª ×§×‘×¦×™×</a></li>
              <li><a href="#snippet-9-4">××¢× ×” ×‘×˜×•×— ×œ-CallbackQuery</a></li>
              <li><a href="#snippet-9-5">×¤×™×¦×•×œ ×”×•×“×¢×•×ª ××¨×•×›×•×ª</a></li>
              <li><a href="#snippet-9-6">×¢×¨×™×›×ª ×”×•×“×¢×” ×‘×˜×•×—×”</a></li>
              <li><a href="#snippet-9-7">×× ×™×¢×ª ×œ×—×™×¦×” ×›×¤×•×œ×”</a></li>
              <li><a href="#snippet-9-8">×¢×™×‘×•×“ ×¤×¨×™×˜×™× ×‘×§×‘×•×¦×•×ª</a></li>
              <li><a href="#snippet-9-9">××“×™×“×ª ×–××Ÿ</a></li>
              <li><a href="#snippet-9-10">×‘×“×™×§×ª ×§×•×“ ××¡×•×›×Ÿ</a></li>
              <li><a href="#snippet-9-11">×™×¦×™×¨×ª ×§×•×‘×¥ ×–×× ×™</a></li>
              <li><a href="#snippet-9-12">×˜×¢×™× ×ª ×§×•×‘×¥ JSON</a></li>
              <li><a href="#snippet-9-13">×§××© ×–×™×›×¨×•×Ÿ ×¢× TTL</a></li>
              <li><a href="#snippet-9-14">××¡× ×Ÿ ×œ×•×’×™× ×œ×¨×’×™×©×•×™×•×ª</a></li>
              <li><a href="#snippet-9-15">× ×™×¨××•×œ ××¨×’×•×× ×˜×™×</a></li>
              <li><a href="#snippet-9-16">×§×™×¦×•×¨ ×˜×§×¡×˜ ×‘×××¦×¢</a></li>
              <li><a href="#snippet-9-17">××¢×§×‘ ×‘×™×¦×•×¢×™× ×¢× Prometheus</a></li>
              <li><a href="#snippet-9-18">×”×¦×¢×ª ×”×©×œ××•×ª ×œ×—×™×¤×•×©</a></li>
              <li><a href="#snippet-9-19">×”×“×’×©×ª ×˜×•×•×—×™× ×‘×—×™×¤×•×©</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-tasks"></i> Background Jobs</h3>
            <ul class="toc-links">
              <li><a href="#snippet-10-1">RQ Job ×¢× Retry</a></li>
              <li><a href="#snippet-10-2">Enqueue or Run Inline</a></li>
              <li><a href="#snippet-10-3">RQ Scheduler â€“ Recurring Jobs</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-robot"></i> ×ª×‘× ×™×•×ª ×‘×•×˜ ×˜×œ×’×¨×</h3>
            <ul class="toc-links">
              <li><a href="#snippet-11-1">Maintenance Mode</a></li>
              <li><a href="#snippet-11-2">Callback Query Router</a></li>
              <li><a href="#snippet-11-3">Safe Send ×¢× Fallback</a></li>
              <li><a href="#snippet-11-4">Message Chunking</a></li>
            </ul>
          </div>
        </div>
      </div>

      <!-- No results message -->
      <div class="no-results" id="noResults">
        <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5"></i>
        <h3>×œ× × ××¦××• ×ª×•×¦××•×ª</h3>
        <p>× ×¡×” ×œ×—×¤×© ×‘××™×œ×•×ª ××¤×ª×— ××—×¨×•×ª ××• ×‘×“×•×§ ××ª ×”××™×•×ª</p>
      </div>

      <!-- Category 1: ×ª×¤×¨×™×˜×™× ×‘×‘×•×˜ -->
      <div class="category" id="category-1">
        <div class="category-header">
          <i class="fas fa-robot"></i>
          <h2>×ª×¤×¨×™×˜×™× ×‘×‘×•×˜</h2>
        </div>

        <div class="snippet" id="snippet-1-1">
          <div class="snippet-header">
            <h3 class="snippet-title">1.1 ×ª×¤×¨×™×˜ ×¤×¢×•×œ×•×ª ×¢×œ ×§×•×‘×¥ (Multi-Row Grid)</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×™×¦×™×¨×ª ×ª×¤×¨×™×˜ ×¢× ××¡×¤×¨ ×©×•×¨×•×ª ×©×œ ×›×¤×ª×•×¨×™×, ×××•×¨×’× ×™× ×œ×¤×™ ×¤×•× ×§×¦×™×•× ×œ×™×•×ª.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">from</span> telegram <span class="token keyword">import</span> InlineKeyboardButton<span class="token punctuation">,</span> InlineKeyboardMarkup

<span class="token comment"># ×™×¦×™×¨×ª ×ª×¤×¨×™×˜ ×¢× ×›×¤×ª×•×¨×™× ××¨×•×‘×™×</span>
buttons <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span>
        InlineKeyboardButton<span class="token punctuation">(</span><span class="token string">"ğŸ—‘ï¸ ××—×™×§×”"</span><span class="token punctuation">,</span> callback_data<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"delete_</span><span class="token interpolation"><span class="token punctuation">{</span>file_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        InlineKeyboardButton<span class="token punctuation">(</span><span class="token string">"âœï¸ ×¢×¨×™×›×”"</span><span class="token punctuation">,</span> callback_data<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"edit_</span><span class="token interpolation"><span class="token punctuation">{</span>file_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
        InlineKeyboardButton<span class="token punctuation">(</span><span class="token string">"ğŸ“ ×¢×¨×•×š ×”×¢×¨×”"</span><span class="token punctuation">,</span> callback_data<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"edit_note_</span><span class="token interpolation"><span class="token punctuation">{</span>file_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        InlineKeyboardButton<span class="token punctuation">(</span><span class="token string">"ğŸ’¾ ×”×•×¨×“×”"</span><span class="token punctuation">,</span> callback_data<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"download_</span><span class="token interpolation"><span class="token punctuation">{</span>file_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
        InlineKeyboardButton<span class="token punctuation">(</span><span class="token string">"ğŸŒ ×©×™×ª×•×£"</span><span class="token punctuation">,</span> callback_data<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"share_</span><span class="token interpolation"><span class="token punctuation">{</span>file_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
        InlineKeyboardButton<span class="token punctuation">(</span>fav_text<span class="token punctuation">,</span> callback_data<span class="token operator">=</span>fav_cb<span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">]</span>
reply_markup <span class="token operator">=</span> InlineKeyboardMarkup<span class="token punctuation">(</span>buttons<span class="token punctuation">)</span>
<span class="token keyword">await</span> update<span class="token punctuation">.</span>message<span class="token punctuation">.</span>reply_text<span class="token punctuation">(</span>
    response_text<span class="token punctuation">,</span>
    parse_mode<span class="token operator">=</span><span class="token string">'HTML'</span><span class="token punctuation">,</span>
    reply_markup<span class="token operator">=</span>reply_markup
<span class="token punctuation">)</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-1-2">
          <div class="snippet-header">
            <h3 class="snippet-title">1.2 ×ª×™×‘×ª ××™×©×•×¨ ×¢× ×›×¤×ª×•×¨×™× (Yes/No Dialog)</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×“×™××œ×•×’ ××™×©×•×¨ ×¤×©×•×˜ ×œ×¤× ×™ ×‘×™×¦×•×¢ ×¤×¢×•×œ×” ×§×¨×™×˜×™×ª.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">from</span> telegram <span class="token keyword">import</span> InlineKeyboardButton<span class="token punctuation">,</span> InlineKeyboardMarkup
<span class="token keyword">from</span> telegram<span class="token punctuation">.</span>constants <span class="token keyword">import</span> ParseMode

keyboard <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span>
        InlineKeyboardButton<span class="token punctuation">(</span><span class="token string">"âœ… ×›×Ÿ, ××—×§"</span><span class="token punctuation">,</span> callback_data<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"confirm_delete_</span><span class="token interpolation"><span class="token punctuation">{</span>file_name<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        InlineKeyboardButton<span class="token punctuation">(</span><span class="token string">"âŒ ×‘×™×˜×•×œ"</span><span class="token punctuation">,</span> callback_data<span class="token operator">=</span><span class="token string">"cancel_delete"</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">]</span>
reply_markup <span class="token operator">=</span> InlineKeyboardMarkup<span class="token punctuation">(</span>keyboard<span class="token punctuation">)</span>

<span class="token keyword">await</span> update<span class="token punctuation">.</span>message<span class="token punctuation">.</span>reply_text<span class="token punctuation">(</span>
    <span class="token string-interpolation"><span class="token string">f"ğŸ—‘ï¸ **××™×©×•×¨ ××—×™×§×”**\n\n"</span></span>
    <span class="token string-interpolation"><span class="token string">f"×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª `</span><span class="token interpolation"><span class="token punctuation">{</span>file_name<span class="token punctuation">}</span></span><span class="token string">`?"</span></span><span class="token punctuation">,</span>
    parse_mode<span class="token operator">=</span>ParseMode<span class="token punctuation">.</span>MARKDOWN<span class="token punctuation">,</span>
    reply_markup<span class="token operator">=</span>reply_markup
<span class="token punctuation">)</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-1-3">
          <div class="snippet-header">
            <h3 class="snippet-title">1.3 Callback Query Handler - × ×™×ª×•×‘ ×œ×¤×™ ×“×¤×•×¡</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×˜×™×¤×•×œ ××¨×•×›×– ×‘×›×œ ×œ×—×™×¦×•×ª ×”×›×¤×ª×•×¨×™×, ×¢× × ×™×ª×•×‘ ×œ×¤×™ prefix.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">handle_callback_query</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> update<span class="token punctuation">:</span> Update<span class="token punctuation">,</span> context<span class="token punctuation">:</span> ContextTypes<span class="token punctuation">.</span>DEFAULT_TYPE<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""×˜×™×¤×•×œ ×‘×œ×—×™×¦×•×ª ×¢×œ ×›×¤×ª×•×¨×™×"""</span>
    query <span class="token operator">=</span> update<span class="token punctuation">.</span>callback_query
    <span class="token keyword">await</span> query<span class="token punctuation">.</span>answer<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># ×—×©×•×‘! ×××©×¨ ×§×‘×œ×ª ×”×œ×—×™×¦×”</span>

    data <span class="token operator">=</span> query<span class="token punctuation">.</span>data
    user_id <span class="token operator">=</span> query<span class="token punctuation">.</span>from_user<span class="token punctuation">.</span><span class="token builtin">id</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> data<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"confirm_delete_"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            file_name <span class="token operator">=</span> data<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"confirm_delete_"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> db<span class="token punctuation">.</span>delete_file<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> file_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">await</span> query<span class="token punctuation">.</span>edit_message_text<span class="token punctuation">(</span>
                    <span class="token string-interpolation"><span class="token string">f"âœ… ×”×§×•×‘×¥ `</span><span class="token interpolation"><span class="token punctuation">{</span>file_name<span class="token punctuation">}</span></span><span class="token string">` × ××—×§ ×‘×”×¦×œ×—×”!"</span></span><span class="token punctuation">,</span>
                    parse_mode<span class="token operator">=</span>ParseMode<span class="token punctuation">.</span>MARKDOWN
                <span class="token punctuation">)</span>

        <span class="token keyword">elif</span> data <span class="token operator">==</span> <span class="token string">"cancel_delete"</span><span class="token punctuation">:</span>
            <span class="token keyword">await</span> query<span class="token punctuation">.</span>edit_message_text<span class="token punctuation">(</span><span class="token string">"âŒ ××—×™×§×” ×‘×•×˜×œ×”."</span><span class="token punctuation">)</span>

        <span class="token keyword">elif</span> data<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"share_gist_"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            file_name <span class="token operator">=</span> data<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"share_gist_"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
            <span class="token keyword">await</span> self<span class="token punctuation">.</span>_share_to_gist<span class="token punctuation">(</span>query<span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> file_name<span class="token punctuation">)</span>

        <span class="token comment"># ... more handlers</span>

    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error handling callback: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> query<span class="token punctuation">.</span>edit_message_text<span class="token punctuation">(</span><span class="token string">"âš ï¸ ××™×¨×¢×” ×©×’×™××”"</span><span class="token punctuation">)</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-1-4">
          <div class="snippet-header">
            <h3 class="snippet-title">1.4 Pagination Helper - ×›×¤×ª×•×¨×™ ×”×§×•×“×/×”×‘×</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×¤×•× ×§×¦×™×” ×©×™××•×©×™×ª ×œ×‘× ×™×™×ª ×›×¤×ª×•×¨×™ × ×™×•×•×˜ ×‘×¢××•×“×™×.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">from</span> telegram <span class="token keyword">import</span> InlineKeyboardButton
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Optional<span class="token punctuation">,</span> List

<span class="token keyword">def</span> <span class="token function">build_pagination_row</span><span class="token punctuation">(</span>
    page<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    total_items<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    page_size<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    callback_prefix<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">[</span>List<span class="token punctuation">[</span>InlineKeyboardButton<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""×‘×•× ×” ×©×•×¨×ª ×›×¤×ª×•×¨×™ pagination ××• None ×× ××™×Ÿ ×¦×•×¨×š."""</span>
    <span class="token keyword">if</span> page_size <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>

    total_pages <span class="token operator">=</span> <span class="token punctuation">(</span>total_items <span class="token operator">+</span> page_size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">//</span> page_size <span class="token keyword">if</span> total_items <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">1</span>
    <span class="token keyword">if</span> total_pages <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>

    row<span class="token punctuation">:</span> List<span class="token punctuation">[</span>InlineKeyboardButton<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">if</span> page <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span>
        row<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
            InlineKeyboardButton<span class="token punctuation">(</span><span class="token string">"â¬…ï¸ ×”×§×•×“×"</span><span class="token punctuation">,</span> callback_data<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>callback_prefix<span class="token punctuation">}</span></span><span class="token interpolation"><span class="token punctuation">{</span>page<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">if</span> page <span class="token operator">&lt;</span> total_pages<span class="token punctuation">:</span>
        row<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
            InlineKeyboardButton<span class="token punctuation">(</span><span class="token string">"â¡ï¸ ×”×‘×"</span><span class="token punctuation">,</span> callback_data<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>callback_prefix<span class="token punctuation">}</span></span><span class="token interpolation"><span class="token punctuation">{</span>page<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">return</span> row <span class="token keyword">or</span> <span class="token boolean">None</span></code></pre>
          </div>
        </div>
      </div>

      <!-- Category 2: ×¢×‘×•×“×” ×¢× ××¡×“ × ×ª×•× ×™× -->
      <div class="category" id="category-2">
        <div class="category-header">
          <i class="fas fa-database"></i>
          <h2>×¢×‘×•×“×” ×¢× ××¡×“ × ×ª×•× ×™×</h2>
        </div>

        <div class="snippet" id="snippet-2-1">
          <div class="snippet-header">
            <h3 class="snippet-title">2.1 ×©××™×¨×ª ××¡××š ×¢× Versioning</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×©××™×¨×” ×¢× × ×™×”×•×œ ×’×¨×¡××•×ª ××•×˜×•××˜×™ + ×‘×™×˜×•×œ cache.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timezone
<span class="token keyword">from</span> dataclasses <span class="token keyword">import</span> asdict

<span class="token keyword">def</span> <span class="token function">save_code_snippet</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> snippet<span class="token punctuation">:</span> CodeSnippet<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># × ×¨××•×œ ×§×•×“ ×œ×¤× ×™ ×©××™×¨×”</span>
        <span class="token keyword">if</span> config<span class="token punctuation">.</span>NORMALIZE_CODE_ON_SAVE<span class="token punctuation">:</span>
            snippet<span class="token punctuation">.</span>code <span class="token operator">=</span> normalize_code<span class="token punctuation">(</span>snippet<span class="token punctuation">.</span>code<span class="token punctuation">)</span>

        <span class="token comment"># ×‘×“×™×§×ª ×’×¨×¡×” ×§×™×™××ª</span>
        existing <span class="token operator">=</span> self<span class="token punctuation">.</span>get_latest_version<span class="token punctuation">(</span>snippet<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span> snippet<span class="token punctuation">.</span>file_name<span class="token punctuation">)</span>
        <span class="token keyword">if</span> existing<span class="token punctuation">:</span>
            snippet<span class="token punctuation">.</span>version <span class="token operator">=</span> existing<span class="token punctuation">[</span><span class="token string">'version'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span>

        snippet<span class="token punctuation">.</span>updated_at <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span>timezone<span class="token punctuation">.</span>utc<span class="token punctuation">)</span>

        <span class="token comment"># ×©××™×¨×” ×‘××¡×“ ×”× ×ª×•× ×™×</span>
        result <span class="token operator">=</span> self<span class="token punctuation">.</span>manager<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>insert_one<span class="token punctuation">(</span>asdict<span class="token punctuation">(</span>snippet<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> result<span class="token punctuation">.</span>inserted_id<span class="token punctuation">:</span>
            <span class="token comment"># ×‘×™×˜×•×œ cache ×œ××©×ª××©</span>
            cache<span class="token punctuation">.</span>invalidate_user_cache<span class="token punctuation">(</span>snippet<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>

        <span class="token keyword">return</span> <span class="token boolean">False</span>

    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error saving snippet: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-2-2">
          <div class="snippet-header">
            <h3 class="snippet-title">2.2 ×©×œ×™×¤×ª ××¡××š ××—×“ ×¢× ××˜××•×Ÿ (Cached Query)</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×©×œ×™×¤×” ××”×™×¨×” ×¢× caching ××•×˜×•××˜×™ ×œ××©×š 3 ×“×§×•×ª.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Optional<span class="token punctuation">,</span> Dict

<span class="token decorator annotation punctuation">@cached</span><span class="token punctuation">(</span>expire_seconds<span class="token operator">=</span><span class="token number">180</span><span class="token punctuation">,</span> key_prefix<span class="token operator">=</span><span class="token string">"latest_version"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">get_latest_version</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> file_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># Fast-path ×œ×¡×‘×™×‘×•×ª ×‘×“×™×§×”</span>
        docs_list <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>manager<span class="token punctuation">.</span>collection<span class="token punctuation">,</span> <span class="token string">'docs'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>docs_list<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            candidates <span class="token operator">=</span> <span class="token punctuation">[</span>
                d <span class="token keyword">for</span> d <span class="token keyword">in</span> docs_list
                <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span>
                <span class="token keyword">and</span> d<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'user_id'</span><span class="token punctuation">)</span> <span class="token operator">==</span> user_id
                <span class="token keyword">and</span> d<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'file_name'</span><span class="token punctuation">)</span> <span class="token operator">==</span> file_name
            <span class="token punctuation">]</span>
            <span class="token keyword">if</span> candidates<span class="token punctuation">:</span>
                latest <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>candidates<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> d<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'version'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>latest<span class="token punctuation">)</span>

        <span class="token comment"># ×©×œ×™×¤×” ××”-DB ×¢× ×¡×™× ×•×Ÿ ×•×¡×™×“×•×¨</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>manager<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>find_one<span class="token punctuation">(</span>
            <span class="token punctuation">{</span>
                <span class="token string">"user_id"</span><span class="token punctuation">:</span> user_id<span class="token punctuation">,</span>
                <span class="token string">"file_name"</span><span class="token punctuation">:</span> file_name<span class="token punctuation">,</span>
                <span class="token string">"$or"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                    <span class="token punctuation">{</span><span class="token string">"is_active"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token punctuation">{</span><span class="token string">"is_active"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"$exists"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
                <span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            sort<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">"version"</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error fetching latest version: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-2-3">
          <div class="snippet-header">
            <h3 class="snippet-title">2.3 Update ×¢× Upsert ×•×˜×™×¤×•×œ ×‘×©×“×•×ª ××•×ª× ×™×</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×¢×“×›×•×Ÿ ××• ×™×¦×™×¨×” (upsert) ×¢× ×”×’×“×¨×ª ×©×“×•×ª ×©×•× ×™× ×œ×™×¦×™×¨×” ××•×œ ×¢×“×›×•×Ÿ.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timezone

<span class="token keyword">def</span> <span class="token function">save_github_token</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> token<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># ×”×¦×¤× ×ª ×”×˜×•×§×Ÿ</span>
        <span class="token keyword">from</span> secret_manager <span class="token keyword">import</span> encrypt_secret
        enc <span class="token operator">=</span> encrypt_secret<span class="token punctuation">(</span>token<span class="token punctuation">)</span>
        stored <span class="token operator">=</span> enc <span class="token keyword">if</span> enc <span class="token keyword">else</span> token

        users_collection <span class="token operator">=</span> self<span class="token punctuation">.</span>manager<span class="token punctuation">.</span>db<span class="token punctuation">.</span>users

        result <span class="token operator">=</span> users_collection<span class="token punctuation">.</span>update_one<span class="token punctuation">(</span>
            <span class="token punctuation">{</span><span class="token string">"user_id"</span><span class="token punctuation">:</span> user_id<span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token string">"$set"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    <span class="token string">"github_token"</span><span class="token punctuation">:</span> stored<span class="token punctuation">,</span>
                    <span class="token string">"updated_at"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span>timezone<span class="token punctuation">.</span>utc<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string">"$setOnInsert"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    <span class="token string">"created_at"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span>timezone<span class="token punctuation">.</span>utc<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            upsert<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>  <span class="token comment"># ×™×¦×™×¨×” ×× ×œ× ×§×™×™×</span>
        <span class="token punctuation">)</span>

        <span class="token keyword">return</span> <span class="token builtin">bool</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>acknowledged<span class="token punctuation">)</span>

    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error saving token: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-2-4">
          <div class="snippet-header">
            <h3 class="snippet-title">2.4 Aggregation Pipeline - ×©××™×œ×ª× ××•×¨×›×‘×ª</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×©××™×œ×ª×•×ª ××ª×§×“××•×ª ×¢× grouping, sorting ×•-projection.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_latest_files_aggregated</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> limit<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""××—×–×™×¨ ××ª ×”×’×¨×¡×” ×”××—×¨×•× ×” ×©×œ ×›×œ ×§×•×‘×¥"""</span>

    <span class="token keyword">match</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"user_id"</span><span class="token punctuation">:</span> user_id<span class="token punctuation">,</span> <span class="token string">"is_active"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>
    sort_key <span class="token operator">=</span> <span class="token string">"updated_at"</span>
    sort_dir <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>  <span class="token comment"># DESC</span>

    pipeline <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token string">"$match"</span><span class="token punctuation">:</span> <span class="token keyword">match</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment"># ×¡×™× ×•×Ÿ</span>
        <span class="token punctuation">{</span><span class="token string">"$sort"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"file_name"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"version"</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment"># ××™×•×Ÿ</span>
        <span class="token punctuation">{</span><span class="token string">"$group"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>  <span class="token comment"># ×§×™×‘×•×¥ ×œ×¤×™ ×©× ×§×•×‘×¥</span>
            <span class="token string">"_id"</span><span class="token punctuation">:</span> <span class="token string">"$file_name"</span><span class="token punctuation">,</span>
            <span class="token string">"latest"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"$first"</span><span class="token punctuation">:</span> <span class="token string">"$$ROOT"</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"$replaceRoot"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"newRoot"</span><span class="token punctuation">:</span> <span class="token string">"$latest"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment"># ×”×—×œ×¤×ª root</span>
        <span class="token punctuation">{</span><span class="token string">"$sort"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>sort_key<span class="token punctuation">:</span> sort_dir<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment"># ××™×•×Ÿ ×¡×•×¤×™</span>
        <span class="token punctuation">{</span><span class="token string">"$limit"</span><span class="token punctuation">:</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>limit <span class="token keyword">or</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment"># ×”×’×‘×œ×ª ×ª×•×¦××•×ª</span>
        <span class="token punctuation">{</span><span class="token string">"$project"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>  <span class="token comment"># ×‘×—×™×¨×ª ×©×“×•×ª</span>
            <span class="token string">"_id"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token string">"file_name"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token string">"programming_language"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token string">"updated_at"</span><span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>

    rows <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>manager<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>aggregate<span class="token punctuation">(</span>pipeline<span class="token punctuation">,</span> allowDiskUse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> rows</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-2-5">
          <div class="snippet-header">
            <h3 class="snippet-title">2.5 Soft Delete ×¢× TTL (Recycle Bin)</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××—×™×§×” ×¨×›×” ×¢× ××¤×©×¨×•×ª ×©×—×–×•×¨, ×•××—×™×§×” ×¡×•×¤×™×ª ××•×˜×•××˜×™×ª ×œ××—×¨ 7 ×™××™×.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timezone<span class="token punctuation">,</span> timedelta

<span class="token keyword">def</span> <span class="token function">delete_file</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> file_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""××—×™×§×” ×¨×›×” - ××¡××Ÿ ×›×œ× ×¤×¢×™×œ ×‘××§×•× ×œ××—×•×§"""</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        now <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span>timezone<span class="token punctuation">.</span>utc<span class="token punctuation">)</span>
        ttl_days <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">getattr</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token string">'RECYCLE_TTL_DAYS'</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token number">7</span><span class="token punctuation">)</span>
        expires <span class="token operator">=</span> now <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> ttl_days<span class="token punctuation">)</span><span class="token punctuation">)</span>

        result <span class="token operator">=</span> self<span class="token punctuation">.</span>manager<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>update_many<span class="token punctuation">(</span>
            <span class="token punctuation">{</span>
                <span class="token string">"user_id"</span><span class="token punctuation">:</span> user_id<span class="token punctuation">,</span>
                <span class="token string">"file_name"</span><span class="token punctuation">:</span> file_name<span class="token punctuation">,</span>
                <span class="token string">"$or"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                    <span class="token punctuation">{</span><span class="token string">"is_active"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token punctuation">{</span><span class="token string">"is_active"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"$exists"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
                <span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token string">"$set"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    <span class="token string">"is_active"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
                    <span class="token string">"updated_at"</span><span class="token punctuation">:</span> now<span class="token punctuation">,</span>
                    <span class="token string">"deleted_at"</span><span class="token punctuation">:</span> now<span class="token punctuation">,</span>
                    <span class="token string">"deleted_expires_at"</span><span class="token punctuation">:</span> expires<span class="token punctuation">,</span>  <span class="token comment"># TTL field</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

        <span class="token keyword">if</span> result<span class="token punctuation">.</span>modified_count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            cache<span class="token punctuation">.</span>invalidate_user_cache<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>

        <span class="token keyword">return</span> <span class="token boolean">False</span>

    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error deleting file: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span></code></pre>
          </div>
        </div>
      </div>

      <!-- Category 3: × ×™×”×•×œ ×§×‘×¦×™× ×•×’×¨×¡××•×ª -->
      <div class="category" id="category-3">
        <div class="category-header">
          <i class="fas fa-file-code"></i>
          <h2>× ×™×”×•×œ ×§×‘×¦×™× ×•×’×¨×¡××•×ª</h2>
        </div>

        <div class="snippet" id="snippet-3-1">
          <div class="snippet-header">
            <h3 class="snippet-title">3.1 ×©××™×¨×ª ×§×•×‘×¥ ×¢× ×–×™×”×•×™ ×©×¤×” ××•×˜×•××˜×™</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×–×¨×™××” ××œ××” ×©×œ ×©××™×¨×ª ×§×•×‘×¥ - × ×¨××•×œ, ×–×™×”×•×™ ×©×¤×”, ×©××™×¨×” + ×”×—×–×¨×ª ID.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">from</span> database <span class="token keyword">import</span> db<span class="token punctuation">,</span> CodeSnippet
<span class="token keyword">from</span> services<span class="token punctuation">.</span>code_service <span class="token keyword">import</span> detect_language<span class="token punctuation">,</span> normalize_code

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">save_file_final</span><span class="token punctuation">(</span>update<span class="token punctuation">,</span> context<span class="token punctuation">,</span> filename<span class="token punctuation">,</span> user_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""×©×•××¨ ×§×•×‘×¥ ×¢× metadata ××œ×"""</span>

    code <span class="token operator">=</span> context<span class="token punctuation">.</span>user_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'code_to_save'</span><span class="token punctuation">)</span>

    <span class="token comment"># × ×¨××•×œ ×§×•×“</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        code <span class="token operator">=</span> normalize_code<span class="token punctuation">(</span>code<span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
        <span class="token keyword">pass</span>

    <span class="token comment"># ×–×™×”×•×™ ×©×¤×ª ×ª×›× ×•×ª</span>
    detected_language <span class="token operator">=</span> detect_language<span class="token punctuation">(</span>code<span class="token punctuation">,</span> filename<span class="token punctuation">)</span>

    <span class="token comment"># ×”×¢×¨×” ××•×¤×¦×™×•× ×œ×™×ª</span>
    note <span class="token operator">=</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>user_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'note_to_save'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># ×™×¦×™×¨×ª snippet</span>
    snippet <span class="token operator">=</span> CodeSnippet<span class="token punctuation">(</span>
        user_id<span class="token operator">=</span>user_id<span class="token punctuation">,</span>
        file_name<span class="token operator">=</span>filename<span class="token punctuation">,</span>
        code<span class="token operator">=</span>code<span class="token punctuation">,</span>
        programming_language<span class="token operator">=</span>detected_language<span class="token punctuation">,</span>
        description<span class="token operator">=</span>note<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token comment"># ×©××™×¨×”</span>
    success <span class="token operator">=</span> db<span class="token punctuation">.</span>save_code_snippet<span class="token punctuation">(</span>snippet<span class="token punctuation">)</span>

    <span class="token keyword">if</span> success<span class="token punctuation">:</span>
        <span class="token comment"># ×©×œ×™×¤×ª ×”××¡××š ×”×©××•×¨ ×œ×§×‘×œ×ª ID</span>
        saved_doc <span class="token operator">=</span> db<span class="token punctuation">.</span>get_latest_version<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> filename<span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        file_id <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>saved_doc<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'_id'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">''</span><span class="token punctuation">)</span>

        <span class="token comment"># ×©××™×¨×” ×‘×”×§×©×¨ ×œ×©×™××•×© ×¢×ª×™×“×™</span>
        context<span class="token punctuation">.</span>user_data<span class="token punctuation">[</span><span class="token string">"last_save_success"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">"file_name"</span><span class="token punctuation">:</span> filename<span class="token punctuation">,</span>
            <span class="token string">"language"</span><span class="token punctuation">:</span> detected_language<span class="token punctuation">,</span>
            <span class="token string">"file_id"</span><span class="token punctuation">:</span> file_id<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">await</span> update<span class="token punctuation">.</span>message<span class="token punctuation">.</span>reply_text<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"âœ… ×”×§×•×‘×¥ `</span><span class="token interpolation"><span class="token punctuation">{</span>filename<span class="token punctuation">}</span></span><span class="token string">` × ×©××¨ ×‘×”×¦×œ×—×”!"</span></span><span class="token punctuation">)</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-3-2">
          <div class="snippet-header">
            <h3 class="snippet-title">3.2 ×©×œ×™×¤×ª ×’×¨×¡××•×ª - Latest / All / Specific</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×××©×§ ×¤×©×•×˜ ×œ× ×™×”×•×œ ×’×¨×¡××•×ª ×©×œ ×§×‘×¦×™×.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_latest_version</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> file_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""××—×–×™×¨ ××ª ×”×’×¨×¡×” ×”××—×¨×•× ×” ×©×œ ×§×•×‘×¥"""</span>
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>_get_repo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_latest_version<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> file_name<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">get_all_versions</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> file_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""××—×–×™×¨ ××ª ×›×œ ×”×’×¨×¡××•×ª ×©×œ ×§×•×‘×¥"""</span>
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>_get_repo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_all_versions<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> file_name<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">get_version</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> file_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> version<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""××—×–×™×¨ ×’×¨×¡×” ×¡×¤×¦×™×¤×™×ª"""</span>
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>_get_repo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_version<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> file_name<span class="token punctuation">,</span> version<span class="token punctuation">)</span>

<span class="token comment"># ×©×™××•×©:</span>
<span class="token comment"># latest = db.get_latest_version(123, "main.py")</span>
<span class="token comment"># all_versions = db.get_all_versions(123, "main.py")</span>
<span class="token comment"># v2 = db.get_version(123, "main.py", 2)</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-3-3">
          <div class="snippet-header">
            <h3 class="snippet-title">3.3 ×–×™×”×•×™ ×©×™× ×•×™×™× ×‘×§×•×‘×¥ ×¢× Hash</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×–×™×”×•×™ ×× ×§×•×‘×¥ ×”×©×ª× ×” ×œ×œ× ×¦×•×¨×š ×‘×”×©×•×•××ª ×ª×•×›×Ÿ ××œ×.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">import</span> hashlib
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timezone

<span class="token keyword">def</span> <span class="token function">check_file_sync</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> file_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> new_content<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""×‘×•×“×§ ×× ×”×§×•×‘×¥ ×”×©×ª× ×” ×××– ×”×©××™×¨×” ×”××—×¨×•× ×”"""</span>

    <span class="token comment"># ×—×™×©×•×‘ hash ×—×“×©</span>
    new_hash <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha256<span class="token punctuation">(</span>new_content<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># ×©×œ×™×¤×ª hash ×™×©×Ÿ</span>
    file_doc <span class="token operator">=</span> self<span class="token punctuation">.</span>files_collection<span class="token punctuation">.</span>find_one<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"_id"</span><span class="token punctuation">:</span> ObjectId<span class="token punctuation">(</span>file_id<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    old_hash <span class="token operator">=</span> file_doc<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"content_hash"</span><span class="token punctuation">)</span> <span class="token keyword">if</span> file_doc <span class="token keyword">else</span> <span class="token boolean">None</span>

    <span class="token comment"># ×”×©×•×•××”</span>
    <span class="token keyword">if</span> old_hash <span class="token operator">==</span> new_hash<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"changed"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">"affected"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span>

    <span class="token comment"># × ×™×ª×•×— ×”×©×¤×¢×” ×¢×œ ×¨×©×•××•×ª ×ª×œ×•×™×•×ª (×œ××©×œ ×¡×™×× ×™×•×ª)</span>
    old_lines <span class="token operator">=</span> file_doc<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>splitlines<span class="token punctuation">(</span><span class="token punctuation">)</span>
    new_lines <span class="token operator">=</span> new_content<span class="token punctuation">.</span>splitlines<span class="token punctuation">(</span><span class="token punctuation">)</span>
    affected <span class="token operator">=</span> self<span class="token punctuation">.</span>_analyze_bookmark_changes<span class="token punctuation">(</span>file_id<span class="token punctuation">,</span> old_lines<span class="token punctuation">,</span> new_lines<span class="token punctuation">)</span>

    <span class="token comment"># ×¢×“×›×•×Ÿ hash</span>
    self<span class="token punctuation">.</span>files_collection<span class="token punctuation">.</span>update_one<span class="token punctuation">(</span>
        <span class="token punctuation">{</span><span class="token string">"_id"</span><span class="token punctuation">:</span> ObjectId<span class="token punctuation">(</span>file_id<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"$set"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"content_hash"</span><span class="token punctuation">:</span> new_hash<span class="token punctuation">,</span>
            <span class="token string">"code"</span><span class="token punctuation">:</span> new_content<span class="token punctuation">,</span>
            <span class="token string">"last_sync"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span>timezone<span class="token punctuation">.</span>utc<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token string">"changed"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
        <span class="token string">"old_hash"</span><span class="token punctuation">:</span> old_hash<span class="token punctuation">,</span>
        <span class="token string">"new_hash"</span><span class="token punctuation">:</span> new_hash<span class="token punctuation">,</span>
        <span class="token string">"affected"</span><span class="token punctuation">:</span> affected
    <span class="token punctuation">}</span></code></pre>
          </div>
        </div>
      </div>

      <!-- Category 4: ××™× ×˜×’×¨×¦×™×” ×¢× WebApp -->
      <div class="category" id="category-4">
        <div class="category-header">
          <i class="fas fa-globe"></i>
          <h2>××™× ×˜×’×¨×¦×™×” ×¢× WebApp</h2>
        </div>

        <div class="snippet" id="snippet-4-1">
          <div class="snippet-header">
            <h3 class="snippet-title">4.1 ×™×¦×™×¨×ª ×›×¤×ª×•×¨ WebApp ×¢× ×§×™×©×•×¨ ×œ×§×•×‘×¥</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×¤×ª×™×—×ª WebApp ×™×©×™×¨×•×ª ×œ×§×•×‘×¥ ×¡×¤×¦×™×¤×™ ××• ×ª×•×¦××•×ª ×—×™×¤×•×©.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">from</span> telegram <span class="token keyword">import</span> InlineKeyboardButton
<span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> quote_plus
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Optional<span class="token punctuation">,</span> List

<span class="token keyword">def</span> <span class="token function">_get_webapp_button_row</span><span class="token punctuation">(</span>
    file_id<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    file_name<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">[</span>List<span class="token punctuation">[</span>InlineKeyboardButton<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""×‘×•× ×” ×›×¤×ª×•×¨ WebApp ×¢× ×§×™×©×•×¨ ×œ×§×•×‘×¥"""</span>

    base_url <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">'WEBAPP_URL'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> config<span class="token punctuation">.</span>WEBAPP_URL
    <span class="token keyword">if</span> <span class="token keyword">not</span> base_url<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>

    <span class="token comment"># ×§×™×©×•×¨ ×™×©×™×¨ ×œ×§×•×‘×¥ ×œ×¤×™ ID</span>
    <span class="token keyword">if</span> file_id<span class="token punctuation">:</span>
        target_url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>base_url<span class="token punctuation">}</span></span><span class="token string">/file/</span><span class="token interpolation"><span class="token punctuation">{</span>file_id<span class="token punctuation">}</span></span><span class="token string">"</span></span>

    <span class="token comment"># ××• ×§×™×©×•×¨ ×œ×—×™×¤×•×© ×œ×¤×™ ×©×</span>
    <span class="token keyword">elif</span> file_name<span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            query <span class="token operator">=</span> quote_plus<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
            query <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>
        target_url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>base_url<span class="token punctuation">}</span></span><span class="token string">/files?q=</span><span class="token interpolation"><span class="token punctuation">{</span>query<span class="token punctuation">}</span></span><span class="token string">#results"</span></span>

    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>

    <span class="token keyword">return</span> <span class="token punctuation">[</span>InlineKeyboardButton<span class="token punctuation">(</span><span class="token string">"ğŸŒ ×¦×¤×™×™×” ×‘WebApp"</span><span class="token punctuation">,</span> url<span class="token operator">=</span>target_url<span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token comment"># ×©×™××•×©:</span>
<span class="token comment"># webapp_row = _get_webapp_button_row(file_id_str, file_name)</span>
<span class="token comment"># if webapp_row:</span>
<span class="token comment">#     buttons.append(webapp_row)</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-4-2">
          <div class="snippet-header">
            <h3 class="snippet-title">4.2 ×™×¦×™×¨×ª ×˜×•×§×Ÿ ×”×ª×—×‘×¨×•×ª ×œ-WebApp</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×™×¦×™×¨×ª ×˜×•×§×Ÿ ×××•×‘×˜×— ×œ×›× ×™×¡×” ×œ-WebApp ××”×‘×•×˜.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">import</span> hashlib
<span class="token keyword">import</span> time
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timezone<span class="token punctuation">,</span> timedelta
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Optional<span class="token punctuation">,</span> Dict

<span class="token keyword">def</span> <span class="token function">_build_webapp_login_payload</span><span class="token punctuation">(</span>
    db_manager<span class="token punctuation">,</span>
    user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    username<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""×™×•×¦×¨ ×˜×•×§×Ÿ ×”×ª×—×‘×¨×•×ª ×××•×‘×˜×— ×œ-WebApp"""</span>

    base_url <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"WEBAPP_URL"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> config<span class="token punctuation">.</span>WEBAPP_URL
    secret <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"WEBAPP_LOGIN_SECRET"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> config<span class="token punctuation">.</span>SECRET_KEY <span class="token keyword">or</span> <span class="token string">"dev-secret-key"</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># ×™×¦×™×¨×ª ×˜×•×§×Ÿ ×××•×‘×˜×—</span>
        token_data <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>user_id<span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">int</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{</span>secret<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        auth_token <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha256<span class="token punctuation">(</span>token_data<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">32</span><span class="token punctuation">]</span>
    <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>exception<span class="token punctuation">(</span><span class="token string">"×™×¦×™×¨×ª ×˜×•×§×Ÿ webapp × ×›×©×œ×”"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>

    <span class="token comment"># ×©××™×¨×ª ×”×˜×•×§×Ÿ ×‘-DB</span>
    now_utc <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span>timezone<span class="token punctuation">.</span>utc<span class="token punctuation">)</span>
    token_doc <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">"token"</span><span class="token punctuation">:</span> auth_token<span class="token punctuation">,</span>
        <span class="token string">"user_id"</span><span class="token punctuation">:</span> user_id<span class="token punctuation">,</span>
        <span class="token string">"username"</span><span class="token punctuation">:</span> username<span class="token punctuation">,</span>
        <span class="token string">"created_at"</span><span class="token punctuation">:</span> now_utc<span class="token punctuation">,</span>
        <span class="token string">"expires_at"</span><span class="token punctuation">:</span> now_utc <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>minutes<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># ×ª×•×§×£ 5 ×“×§×•×ª</span>
    <span class="token punctuation">}</span>
    db_manager<span class="token punctuation">.</span>db<span class="token punctuation">.</span>webapp_tokens<span class="token punctuation">.</span>insert_one<span class="token punctuation">(</span>token_doc<span class="token punctuation">)</span>

    <span class="token comment"># ×™×¦×™×¨×ª URL ×”×ª×—×‘×¨×•×ª</span>
    login_url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>base_url<span class="token punctuation">}</span></span><span class="token string">/auth/token?token=</span><span class="token interpolation"><span class="token punctuation">{</span>auth_token<span class="token punctuation">}</span></span><span class="token string">&amp;user_id=</span><span class="token interpolation"><span class="token punctuation">{</span>user_id<span class="token punctuation">}</span></span><span class="token string">"</span></span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token string">"auth_token"</span><span class="token punctuation">:</span> auth_token<span class="token punctuation">,</span>
        <span class="token string">"login_url"</span><span class="token punctuation">:</span> login_url<span class="token punctuation">,</span>
        <span class="token string">"webapp_url"</span><span class="token punctuation">:</span> base_url<span class="token punctuation">,</span>
    <span class="token punctuation">}</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-4-3">
          <div class="snippet-header">
            <h3 class="snippet-title">4.3 ××™××•×ª ×˜×•×§×Ÿ ×•×™×¦×™×¨×ª Session (Server-Side)</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××™××•×ª ×”×˜×•×§×Ÿ ××”×‘×•×˜ ×•×™×¦×™×¨×ª session ×‘××¢×¨×›×ª ×”-WebApp.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> request<span class="token punctuation">,</span> session<span class="token punctuation">,</span> render_template
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timezone

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/auth/token'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">token_auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""×˜×™×¤×•×œ ×‘××™××•×ª ×¢× ×˜×•×§×Ÿ ××”×‘×•×˜"""</span>

    token <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">)</span>
    user_id <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'user_id'</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> token <span class="token keyword">or</span> <span class="token keyword">not</span> user_id<span class="token punctuation">:</span>
        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'404.html'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">404</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        db <span class="token operator">=</span> get_db<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># ×—×™×¤×•×© ×”×˜×•×§×Ÿ ×‘××¡×“ × ×ª×•× ×™×</span>
        token_doc <span class="token operator">=</span> db<span class="token punctuation">.</span>webapp_tokens<span class="token punctuation">.</span>find_one<span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token string">'token'</span><span class="token punctuation">:</span> token<span class="token punctuation">,</span>
            <span class="token string">'user_id'</span><span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token keyword">not</span> token_doc<span class="token punctuation">:</span>
            <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'login.html'</span><span class="token punctuation">,</span>
                                 error<span class="token operator">=</span><span class="token string">"×§×™×©×•×¨ ×”×”×ª×—×‘×¨×•×ª ×œ× ×ª×§×£ ××• ×¤×’ ×ª×•×§×¤×•"</span><span class="token punctuation">)</span>

        <span class="token comment"># ×‘×“×™×§×ª ×ª×•×§×£</span>
        <span class="token keyword">if</span> token_doc<span class="token punctuation">[</span><span class="token string">'expires_at'</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span>timezone<span class="token punctuation">.</span>utc<span class="token punctuation">)</span><span class="token punctuation">:</span>
            db<span class="token punctuation">.</span>webapp_tokens<span class="token punctuation">.</span>delete_one<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'_id'</span><span class="token punctuation">:</span> token_doc<span class="token punctuation">[</span><span class="token string">'_id'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'login.html'</span><span class="token punctuation">,</span>
                                 error<span class="token operator">=</span><span class="token string">"×§×™×©×•×¨ ×”×”×ª×—×‘×¨×•×ª ×¤×’ ×ª×•×§×£. ×× × ×‘×§×© ×§×™×©×•×¨ ×—×“×© ××”×‘×•×˜."</span><span class="token punctuation">)</span>

        <span class="token comment"># ××—×™×§×ª ×”×˜×•×§×Ÿ ×œ××—×¨ ×©×™××•×© (×—×“ ×¤×¢××™)</span>
        db<span class="token punctuation">.</span>webapp_tokens<span class="token punctuation">.</span>delete_one<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'_id'</span><span class="token punctuation">:</span> token_doc<span class="token punctuation">[</span><span class="token string">'_id'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment"># ×©××™×¨×ª × ×ª×•× ×™ ×”××©×ª××© ×‘×¡×©×Ÿ</span>
        user_id_int <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>
        session<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> user_id_int
        session<span class="token punctuation">[</span><span class="token string">'user_data'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">'id'</span><span class="token punctuation">:</span> user_id_int<span class="token punctuation">,</span>
            <span class="token string">'first_name'</span><span class="token punctuation">:</span> token_doc<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'first_name'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'username'</span><span class="token punctuation">:</span> token_doc<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>

        <span class="token comment"># ×”×¤×•×š ××ª ×”×¡×©×Ÿ ×œ×§×‘×•×¢ (30 ×™×•×)</span>
        session<span class="token punctuation">.</span>permanent <span class="token operator">=</span> <span class="token boolean">True</span>

        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'/files'</span><span class="token punctuation">)</span>

    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error in token auth: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'login.html'</span><span class="token punctuation">,</span> error<span class="token operator">=</span><span class="token string">"×©×’×™××” ×‘××™××•×ª"</span><span class="token punctuation">)</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-4-4">
          <div class="snippet-header">
            <h3 class="snippet-title">4.4 ××ª×—×•×œ WebApp ×‘×¦×“ ×”×œ×§×•×— (Frontend)</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×–×™×”×•×™ ×©×”-WebApp × ×˜×¢×Ÿ ×‘×ª×•×š ×˜×œ×’×¨× ×•×”×ª×××ª ×”×ª×¦×•×’×”.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// ×–×™×”×•×™ Telegram WebApp SDK</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>Telegram <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span>Telegram<span class="token punctuation">.</span>WebApp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'telegram-mini-app'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// ×”×¨×—×‘×ª viewport ×œ×©×™××•×© ××œ× ×‘××¡×š</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                window<span class="token punctuation">.</span>Telegram<span class="token punctuation">.</span>WebApp<span class="token punctuation">.</span><span class="token function">expand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

            <span class="token comment">// ××™×ª×•×ª ×©×”-WebApp ××•×›×Ÿ</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                window<span class="token punctuation">.</span>Telegram<span class="token punctuation">.</span>WebApp<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

            <span class="token comment">// ×§×‘×œ×ª × ×ª×•× ×™ ××©×ª××© ××˜×œ×’×¨×</span>
            <span class="token keyword">const</span> initData <span class="token operator">=</span> window<span class="token punctuation">.</span>Telegram<span class="token punctuation">.</span>WebApp<span class="token punctuation">.</span>initData<span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Telegram WebApp initialized:'</span><span class="token punctuation">,</span> initData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Error initializing Telegram WebApp:'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
          </div>
        </div>
      </div>

      <!-- Category 5: ×¨×›×™×‘×™ UI ×‘-WebApp -->
      <div class="category" id="category-5">
        <div class="category-header">
          <i class="fas fa-paint-brush"></i>
          <h2>×¨×›×™×‘×™ UI ×‘-WebApp</h2>
        </div>

        <div class="snippet" id="snippet-5-1">
          <div class="snippet-header">
            <h3 class="snippet-title">5.1 Modal Dialog ×¢× Promise</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×“×™××œ×•×’ ××•×“×œ×™ ×©××—×–×™×¨ ×ª×•×¦××” ×“×¨×š Promise (async/await).
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">async</span> <span class="token function">showTagDialog</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> dialog <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dialog<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">'modal-overlay'</span><span class="token punctuation">;</span>

        dialog<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
            
                
                     ×”×•×¡×£ ×ª×’×™×•×ª
                    
                        
                    
                

                
                    ×”×–×Ÿ ×ª×’×™×•×ª ××•×¤×¨×“×•×ª ×‘×¤×¡×™×§×™×:
                    
                    
                        ×”×¦×¢×•×ª:
                        important
                        python
                    
                

                
                    
                         ××™×©×•×¨
                    
                    
                         ×‘×™×˜×•×œ
                    
                
            
        </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>dialog<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ×˜×™×¤×•×œ ×‘××™×¨×•×¢×™×</span>
        dialog<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> action <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">closest</span><span class="token punctuation">(</span><span class="token string">'[data-action]'</span><span class="token punctuation">)</span><span class="token operator">?.</span>dataset<span class="token punctuation">.</span>action<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">===</span> <span class="token string">'confirm'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> input <span class="token operator">=</span> dialog<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#tagInput'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> tags <span class="token operator">=</span> input<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">t</span> <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">)</span><span class="token punctuation">;</span>
                document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>dialog<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>tags<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">===</span> <span class="token string">'cancel'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>dialog<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ×¤×•×§×•×¡ ×¢×œ ×”-input</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> dialog<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#tagInput'</span><span class="token punctuation">)</span><span class="token operator">?.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// ×©×™××•×©:</span>
<span class="token comment">// const tags = await showTagDialog();</span>
<span class="token comment">// if (tags) {</span>
<span class="token comment">//     console.log('Selected tags:', tags);</span>
<span class="token comment">// }</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-5-2">
          <div class="snippet-header">
            <h3 class="snippet-title">5.2 Toast Notification ×¢× Auto-Dismiss</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×”×¦×’×ª ×”×•×“×¢×•×ª ×–×× ×™×•×ª ×©× ×¢×œ××•×ª ××•×˜×•××˜×™×ª.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">NotificationManager</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>notificationContainer <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>notificationContainer<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">'notification-container'</span><span class="token punctuation">;</span>
        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>notificationContainer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">showNotification</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">'info'</span><span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> notification <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        notification<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">notification </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> icon <span class="token operator">=</span> <span class="token string">'info-circle'</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'success'</span><span class="token punctuation">)</span> icon <span class="token operator">=</span> options<span class="token punctuation">.</span>icon <span class="token operator">||</span> <span class="token string">'check-circle'</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'error'</span><span class="token punctuation">)</span> icon <span class="token operator">=</span> <span class="token string">'exclamation-circle'</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'warning'</span><span class="token punctuation">)</span> icon <span class="token operator">=</span> <span class="token string">'exclamation-triangle'</span><span class="token punctuation">;</span>

        notification<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
            
                
                </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
            
            
                
            
        </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

        <span class="token comment">// ×˜×™×¤×•×œ ×‘×¡×’×™×¨×” ×™×“× ×™×ª</span>
        notification<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.notification-close'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            notification<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'fade-out'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> notification<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>notificationContainer<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>notification<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ×× ×™××¦×™×™×ª ×›× ×™×¡×”</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> notification<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'show'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ×¡×’×™×¨×” ××•×˜×•××˜×™×ª</span>
        <span class="token keyword">const</span> duration <span class="token operator">=</span> options<span class="token punctuation">.</span>duration <span class="token operator">||</span> <span class="token number">3000</span><span class="token punctuation">;</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>notification<span class="token punctuation">.</span>parentNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                notification<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'fade-out'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> notification<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// ×©×™××•×©:</span>
<span class="token comment">// const notifier = new NotificationManager();</span>
<span class="token comment">// notifier.showNotification('×”×§×•×‘×¥ × ×©××¨ ×‘×”×¦×œ×—×”!', 'success');</span>
<span class="token comment">// notifier.showNotification('×©×’×™××” ×‘×©××™×¨×”', 'error', { duration: 5000 });</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-5-3">
          <div class="snippet-header">
            <h3 class="snippet-title">5.3 Loading Overlay ×¢× Progress Bar</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××¡×š ×˜×¢×™× ×” ×¢× ××¤×©×¨×•×ª ×œ×¢×“×›×•×Ÿ ×”×ª×§×“××•×ª ×‘××—×•×–×™×.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">ProcessingOverlay</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> overlay <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        overlay<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">'processing-overlay hidden'</span><span class="token punctuation">;</span>
        overlay<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
            
                
                ××¢×‘×“...
                
                    
                        
                    
                    0%
                
            
        </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>overlay<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>overlay <span class="token operator">=</span> overlay<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">show</span><span class="token punctuation">(</span>text <span class="token operator">=</span> <span class="token string">'××¢×‘×“...'</span><span class="token punctuation">,</span> showProgress <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>overlay<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.processing-text'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textContent <span class="token operator">=</span> text<span class="token punctuation">;</span>
        <span class="token keyword">const</span> progressEl <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>overlay<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.processing-progress'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>showProgress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            progressEl<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">'hidden'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            progressEl<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'hidden'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>overlay<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">'hidden'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">updateProgress</span><span class="token punctuation">(</span><span class="token parameter">percent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> progressFill <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>overlay<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.progress-fill'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> progressText <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>overlay<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.progress-text'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>progressFill <span class="token operator">&amp;&amp;</span> progressText<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            progressFill<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>percent<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">%</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
            progressText<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>percent<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">%</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">hide</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>overlay<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'hidden'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// ×©×™××•×©:</span>
<span class="token comment">// const overlay = new ProcessingOverlay();</span>
<span class="token comment">// overlay.show('××¢×‘×“ ×§×‘×¦×™×...', true);</span>
<span class="token comment">// for (let i = 0; i &lt;= 100; i += 10) {</span>
<span class="token comment">//     overlay.updateProgress(i);</span>
<span class="token comment">//     await processChunk();</span>
<span class="token comment">// }</span>
<span class="token comment">// overlay.hide();</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-5-4">
          <div class="snippet-header">
            <h3 class="snippet-title">5.4 Card ×¢× ×”×¨×—×‘×” (Expandable Card)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×›×¨×˜×™×¡ ×©× ×™×ª×Ÿ ×œ×”×¨×—×™×‘ ×œ×ª×¦×•×’×” ××§×“×™××” ××œ××”.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">async</span> <span class="token function">expandCard</span><span class="token punctuation">(</span><span class="token parameter">fileId<span class="token punctuation">,</span> cardElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cardElement<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'card-preview-expanding'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> wrapper <span class="token operator">=</span> cardElement<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.preview-wrapper'</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createWrapper</span><span class="token punctuation">(</span>cardElement<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ×”×¦×’×ª spinner</span>
    wrapper<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
        
            
            ×˜×•×¢×Ÿ ×ª×¦×•×’×” ××§×“×™××”...
        
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// ×©×œ×™×¤×ª ×ª×•×›×Ÿ</span>
        <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/api/file/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>fileId<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/preview</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'Accept'</span><span class="token operator">:</span> <span class="token string">'application/json'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">credentials</span><span class="token operator">:</span> <span class="token string">'same-origin'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">.</span>ok <span class="token operator">||</span> <span class="token operator">!</span>data <span class="token operator">||</span> data<span class="token punctuation">.</span>ok <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token punctuation">(</span>data <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token operator">?</span> data<span class="token punctuation">.</span>error <span class="token operator">:</span> <span class="token string">'×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×¦×•×’×” ××§×“×™××”'</span><span class="token punctuation">;</span>
            wrapper<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
                
                     </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>msg<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
                
            </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// ×”×¦×’×ª ×ª×•×›×Ÿ</span>
        wrapper<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildPreviewHTML</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> fileId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cardElement<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'card-preview-expanded'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        wrapper<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
            
                 ×©×’×™××ª ×¨×©×ª
            
        </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        cardElement<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">'card-preview-expanding'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
          </div>
        </div>
      </div>

      <!-- Additional categories would continue here... -->
      <!-- Due to length constraints, I'll show the structure with a few more key categories -->

      <!-- Category 6: Structured Logging -->
      <div class="category" id="category-6">
        <div class="category-header">
          <i class="fas fa-clipboard-list"></i>
          <h2>Structured Logging</h2>
        </div>

        <div class="snippet" id="snippet-6-1">
          <div class="snippet-header">
            <h3 class="snippet-title">6.1 Emit Event ×¢× Request ID</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×œ×•×’×™× ××•×‘× ×™× ×¢× ××¢×§×‘ ××—×¨ request ×™×™×—×•×“×™ ×œ××•×¨×š ×›×œ ×”×ª×”×œ×™×š.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import structlog
from typing import Any

def emit_event(event: str, severity: str = "info", **fields: Any) -> None:
    """×©×•×œ×— ××™×¨×•×¢ ×œ×•×’ ××•×‘× ×”"""

    logger = structlog.get_logger()
    fields.setdefault("event", event)

    # ×”×•×¡×¤×ª request_id ××”×§×•× ×˜×§×¡×˜
    if severity in {"error", "critical"}:
        ctx = get_observability_context()
        request_id = str(fields.get("request_id") or ctx.get("request_id") or "").strip()
        if request_id and "request_id" not in fields:
            fields["request_id"] = request_id

        # ×”×¢×©×¨×ª context ×¢× command, user_id, chat_id
        command_tag = _sanitize_command_identifier(fields.get("command")) or str(ctx.get("command") or "")
        user_tag = _hash_identifier(fields.get("user_id")) or str(ctx.get("user_id") or "")
        chat_tag = _hash_identifier(fields.get("chat_id")) or str(ctx.get("chat_id") or "")

        if command_tag:
            fields["command"] = command_tag
        if user_tag:
            fields["user_id"] = user_tag
        if chat_tag:
            fields["chat_id"] = chat_tag

    # ×©×œ×™×—×ª ×œ×•×’
    log_method = getattr(logger, severity, logger.info)
    log_method(event, **fields)

# ×©×™××•×©:
# emit_event("file_saved", severity="info", user_id=123, file_name="main.py")
# emit_event("db_error", severity="error", error=str(e), request_id=req_id)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-6-2">
          <div class="snippet-header">
            <h3 class="snippet-title">6.2 Binding Request ID ×œ×§×•× ×˜×§×¡×˜</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×§×•×©×¨ request_id ×œ×›×œ ×”×œ×•×’×™× ×‘×–×¨×™××” ×”× ×•×›×—×™×ª (×’× async).</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import structlog

def bind_request_id(request_id: str) -> None:
    """×§×•×©×¨ request_id ×œ×›×œ ×”×œ×•×’×™× ×‘×”×§×©×¨ ×”× ×•×›×—×™"""
    try:
        structlog.contextvars.bind_contextvars(request_id=request_id)
    except Exception:
        pass

    # ×©×œ×™×—×” ×’× ×œ-Sentry
    _set_sentry_tag("request_id", request_id)

# ×©×™××•×© ×‘×ª×—×™×œ×ª request:
# request_id = generate_request_id()  # uuid4().hex
# bind_request_id(request_id)
#
# # ×›×œ ×”×œ×•×’×™× ××¢×›×©×™×• ×™×›×œ×œ×• ××ª ×”-request_id ××•×˜×•××˜×™×ª:
# emit_event("processing_started", severity="info")
# emit_event("processing_completed", severity="info")</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-6-3">
          <div class="snippet-header">
            <h3 class="snippet-title">6.3 Binding User Context</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×§×™×©×•×¨ user_id ×•-chat_id ×œ×›×œ ×”×œ×•×’×™× ×‘×¦×•×¨×” ××•×˜×•××˜×™×ª.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import structlog
from typing import Any, Optional, Dict

def bind_user_context(
    *,
    user_id: Any | None = None,
    chat_id: Any | None = None
) -> None:
    """×§×•×©×¨ ×”×§×©×¨ ××©×ª××© ×œ×›×œ ×”×œ×•×’×™×"""

    to_bind: Dict[str, str] = {}

    # Hash ×©×œ user_id (××‘×˜×—×ª ×¤×¨×˜×™×•×ª)
    user_hash = _hash_identifier(user_id)
    if user_hash:
        to_bind["user_id"] = user_hash
        _set_sentry_tag("user_id", user_hash)

    # Hash ×©×œ chat_id
    chat_hash = _hash_identifier(chat_id)
    if chat_hash:
        to_bind["chat_id"] = chat_hash
        _set_sentry_tag("chat_id", chat_hash)

    # ×§×™×©×•×¨ ×œ×§×•× ×˜×§×¡×˜
    if to_bind:
        try:
            structlog.contextvars.bind_contextvars(**to_bind)
        except Exception:
            pass

# ×©×™××•×©:
# bind_user_context(user_id=update.effective_user.id, chat_id=update.effective_chat.id)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-6-4">
          <div class="snippet-header">
            <h3 class="snippet-title">6.4 ×”×’×“×¨×ª Structlog ×¢× Merge Context</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×§×•× ×¤×™×’×•×¨×¦×™×” ××œ××” ×©×œ structlog ×¢× ××™×–×•×’ ×§×•× ×˜×§×¡×˜ ××•×˜×•××˜×™.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import structlog

def setup_structlog_logging(min_level: str | int = "INFO") -> None:
    """××’×“×™×¨ structlog ×¢× processors ××œ××™×"""

    level = _parse_log_level(min_level)

    structlog.configure(
        processors=[
            structlog.contextvars.merge_contextvars,  # ××™×–×•×’ context ××•×˜×•××˜×™
            _add_otel_ids,                             # ×”×•×¡×¤×ª trace_id/span_id
            _redact_sensitive,                         # ×”×¡×¨×ª × ×ª×•× ×™× ×¨×’×™×©×™×
            _add_schema_version,                       # ×’×¨×¡×ª schema
            structlog.processors.add_log_level,        # ×¨××ª ×œ×•×’
            _mirror_to_log_aggregator,                 # ×©×œ×™×—×” ×œ-aggregator
            _maybe_sample_info,                        # ×“×’×™××ª info logs
            structlog.processors.TimeStamper(fmt="iso"),
            _choose_renderer(),  # JSON ××• console
        ],
        wrapper_class=structlog.make_filtering_bound_logger(level),
        context_class=dict,
        logger_factory=structlog.PrintLoggerFactory(),
        cache_logger_on_first_use=False,
    )

# ×©×™××•×©:
# setup_structlog_logging("INFO")</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 7: ×”×•×“×¢×•×ª ×©×’×™××” ×™×“×™×“×•×ª×™×•×ª -->
      <div class="category" id="category-7">
        <div class="category-header">
          <i class="fas fa-exclamation-triangle"></i>
          <h2>×”×•×“×¢×•×ª ×©×’×™××” ×™×“×™×“×•×ª×™×•×ª</h2>
        </div>

        <div class="snippet" id="snippet-7-1">
          <div class="snippet-header">
            <h3 class="snippet-title">7.1 Rate Limit Error Handler</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×˜×™×¤×•×œ ×‘×’×‘×œ×ª ×§×¦×‘ ×¢× ×”×•×“×¢×” ×™×“×™×“×•×ª×™×ª ×œ××©×ª××© + metrics.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from flask import jsonify, request

@app.errorhandler(429)
def _ratelimit_handler(e):
    """×˜×™×¤×•×œ ×‘×”×’×‘×œ×ª ×§×¦×‘"""
    try:
        # ×œ×•×’×™× ×•××˜×¨×™×§×•×ª (best-effort)
        try:
            emit_event(
                "rate_limit_blocked",
                severity="warning",
                path=str(getattr(request, 'path', '')),
                remote=str(getattr(request, 'remote_addr', '')),
            )
        except Exception:
            pass

        try:
            from metrics import rate_limit_blocked
            if rate_limit_blocked is not None:
                scope = str(getattr(request, 'path', '') or 'route')
                rate_limit_blocked.labels(
                    source="webapp",
                    scope=scope,
                    limit="route"
                ).inc()
        except Exception:
            pass

        # ×ª×’×•×‘×” ×œ××©×ª××©
        payload = {
            "error": "rate_limit_exceeded",
            "message": "×™×•×ª×¨ ××“×™ ×‘×§×©×•×ª. ×× × × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.",
            "retry_after": getattr(e, 'description', None),
        }
        return jsonify(payload), 429

    except Exception:
        # fallback ×× ×”×›×œ × ×›×©×œ
        return jsonify({"error": "rate_limit_exceeded"}), 429</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-7-2">
          <div class="snippet-header">
            <h3 class="snippet-title">7.2 Database Error ×¢× ×”×•×“×¢×•×ª ×¡×¤×¦×™×¤×™×•×ª</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×˜×™×¤×•×œ ×‘×©×’×™××•×ª DB ×¡×¤×¦×™×¤×™×•×ª ×¢× ×”×•×“×¢×•×ª ××ª××™××•×ª.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from pymongo.errors import DuplicateKeyError

def toggle_bookmark(
    self,
    user_id: int,
    file_id: str,
    file_name: str,
    line_number: int,
    **kwargs
) -> Dict[str, Any]:
    """××•×¡×™×£ ××• ××¡×™×¨ ×¡×™×× ×™×™×”"""

    try:
        # Validation
        if line_number <= 0:
            return {
                "ok": False,
                "action": "error",
                "error": "××¡×¤×¨ ×©×•×¨×” ×œ× ×ª×§×™×Ÿ"
            }

        note = kwargs.get('note', '')
        if len(note) > MAX_NOTE_LENGTH:
            note = note[:MAX_NOTE_LENGTH]

        # ... bookmark logic ...

        return {
            "ok": True,
            "action": "added",
            "bookmark": self._bookmark_to_response(bookmark)
        }

    except DuplicateKeyError:
        # ×©×’×™××” ×¡×¤×¦×™×¤×™×ª - ××¤×ª×— ×›×¤×•×œ
        return {
            "ok": False,
            "action": "error",
            "error": "×”×¡×™×× ×™×™×” ×›×‘×¨ ×§×™×™××ª"
        }

    except Exception as e:
        # ×©×’×™××” ×›×œ×œ×™×ª
        logger.error(f"Error toggling bookmark: {e}", exc_info=True)
        return {
            "ok": False,
            "action": "error",
            "error": "×©×’×™××” ×‘×©××™×¨×ª ×”×¡×™×× ×™×™×”"
        }</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-7-3">
          <div class="snippet-header">
            <h3 class="snippet-title">7.3 Validation ×¢× Error Messages</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×•×œ×™×“×¦×™×” ×¢× ×”×—×–×¨×ª tuple ×©×œ (success, data, error_message).</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from typing import Tuple

def validate_code_input(
    code: str,
    file_name: str,
    user_id: int
) -> Tuple[bool, str, str]:
    """
    ×‘×•×“×§ ×•×× ×§×” ×§×œ×˜ ×§×•×“.

    Returns:
        Tuple[bool, str, str]: (is_valid, cleaned_code, error_message)
    """

    # ×‘×“×™×§×•×ª ×‘×¡×™×¡×™×•×ª
    if not code or not code.strip():
        return False, "", "×”×§×•×“ ×¨×™×§"

    if len(code) > MAX_CODE_LENGTH:
        return False, "", f"×”×§×•×“ ××¨×•×š ××“×™ (××§×¡×™××•× {MAX_CODE_LENGTH} ×ª×•×•×™×)"

    # × ×™×§×•×™ ×§×•×“
    try:
        cleaned = normalize_code(code)
    except Exception as e:
        return False, "", f"×©×’×™××” ×‘× ×™×§×•×™ ×”×§×•×“: {str(e)}"

    # ×•×œ×™×“×¦×™×” × ×•×¡×¤×ª ×× ×™×©
    if code_processor:
        ok, cleaned, msg = code_processor.validate_code_input(code, file_name, user_id)
        if not ok:
            return False, cleaned, msg

    return True, cleaned, ""

# ×©×™××•×©:
# is_valid, cleaned_code, error_msg = validate_code_input(code, filename, user_id)
# if not is_valid:
#     await update.message.reply_text(f"âŒ {error_msg}")
#     return
# # ×”××©×š ×¢× cleaned_code</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-7-4">
          <div class="snippet-header">
            <h3 class="snippet-title">7.4 Batch Processing ×¢× Per-Item Errors</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×¢×™×‘×•×“ batch ×©×œ× × ×¢×¦×¨ ×¢×œ ×©×’×™××” ×‘×•×“×“×ª, ××œ× ×¢×•×§×‘ ××—×¨ ×”×¦×œ×—×•×ª/×›×™×©×œ×•× ×•×ª.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from concurrent.futures import ThreadPoolExecutor, as_completed
import time

async def process_files_batch(
    self,
    job_id: str,
    operation_func: Callable,
    **kwargs
) -> BatchJob:
    """×¢×™×‘×•×“ batch ×©×œ ×§×‘×¦×™× ×¢× ××¢×§×‘ ××—×¨ ×©×’×™××•×ª"""

    if job_id not in self.active_jobs:
        raise ValueError(f"×¢×‘×•×“×ª batch {job_id} ×œ× × ××¦××”")

    job = self.active_jobs[job_id]
    job.status = "running"
    job.start_time = time.time()

    try:
        with ThreadPoolExecutor(max_workers=self.max_workers) as executor:
            # ×™×¦×™×¨×ª futures ×œ×›×œ ×”×§×‘×¦×™×
            future_to_file = {
                executor.submit(operation_func, job.user_id, file_name, **kwargs): file_name
                for file_name in job.files
            }

            # ×¢×™×‘×•×“ ×ª×•×¦××•×ª ×¢× ××¢×§×‘ ××—×¨ ×©×’×™××•×ª
            for future in as_completed(future_to_file):
                file_name = future_to_file[future]

                try:
                    result = future.result()
                    success_flag = True

                    # ×‘×“×™×§×ª ×”×¦×œ×—×”
                    if isinstance(result, dict):
                        if 'is_valid' in result:
                            success_flag = bool(result.get('is_valid'))
                        elif 'error' in result:
                            success_flag = False

                    job.results[file_name] = {
                        'success': success_flag,
                        'result': result
                    }

                except Exception as e:
                    # ×©×’×™××” ×‘×§×•×‘×¥ ×‘×•×“×“ - ×œ× ×¢×•×¦×¨×™×
                    job.results[file_name] = {
                        'success': False,
                        'error': str(e)
                    }
                    logger.error(f"×©×’×™××” ×‘×¢×™×‘×•×“ {file_name}: {e}")

                job.progress += 1

        # ×¡×™×›×•×
        job.status = "completed"
        successful = sum(1 for r in job.results.values() if r['success'])
        failed = job.total - successful

        logger.info(f"×¢×‘×•×“×ª batch {job_id} ×”×•×©×œ××”: {successful} ×”×¦×œ×™×—×•, {failed} × ×›×©×œ×•")

    except Exception as e:
        job.status = "failed"
        job.error_message = str(e)
        logger.error(f"×¢×‘×•×“×ª batch {job_id} × ×›×©×œ×”: {e}")

    return job</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 8: ×‘×“×™×§×•×ª Pytest -->
      <div class="category" id="category-8">
        <div class="category-header">
          <i class="fas fa-vial"></i>
          <h2>×‘×“×™×§×•×ª Pytest</h2>
        </div>

        <div class="snippet" id="snippet-8-1">
          <div class="snippet-header">
            <h3 class="snippet-title">8.1 Fixture ×¢× Setup/Teardown</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> × ×™×§×•×™ ×¡×‘×™×‘×” ×œ×¤× ×™ ×•××—×¨×™ ×›×œ ×‘×“×™×§×”.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import pytest

@pytest.fixture(autouse=True)
def _clear_env(monkeypatch):
    """× ×™×§×•×™ ××©×ª× ×™ ×¡×‘×™×‘×” ×œ×¤× ×™ ×•××—×¨×™ ×›×œ ×‘×“×™×§×”"""
    # Setup
    monkeypatch.delenv('WEBAPP_URL', raising=False)

    yield  # ×”×‘×“×™×§×” ×¨×¦×” ×›××Ÿ

    # Teardown
    monkeypatch.delenv('WEBAPP_URL', raising=False)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-8-2">
          <div class="snippet-header">
            <h3 class="snippet-title">8.2 Test Parametrization</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×”×¨×¦×ª ××•×ª×” ×‘×“×™×§×” ×¢× ×›××” ×¡×˜×™× ×©×œ × ×ª×•× ×™×.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import pytest
import types

@pytest.mark.parametrize(
    "config_values, env_value, expected",
    [
        (
            {"WEBAPP_URL": "https://cfg.example", "PUBLIC_BASE_URL": None},
            None,
            "https://cfg.example/file/abc"
        ),
        (
            {"WEBAPP_URL": None, "PUBLIC_BASE_URL": "https://public.example"},
            None,
            "https://public.example/file/abc"
        ),
        (
            {"WEBAPP_URL": None, "PUBLIC_BASE_URL": None},
            "https://env.example",
            "https://env.example/file/abc"
        ),
    ],
)
def test_file_view_webapp_button_prefers_available_source(
    monkeypatch,
    config_values,
    env_value,
    expected
):
    """×‘×•×“×§ ×©×”×›×¤×ª×•×¨ ×‘×•×—×¨ ××ª ×”××§×•×¨ ×”× ×›×•×Ÿ"""
    import handlers.file_view as fv

    # ×”×’×“×¨×ª config mock
    stub_cfg = types.SimpleNamespace(**config_values)
    monkeypatch.setattr(fv, 'config', stub_cfg, raising=False)

    # ×”×’×“×¨×ª env ×× × ×“×¨×©
    if env_value:
        monkeypatch.setenv('WEBAPP_URL', env_value)

    # ×”×¨×¦×ª ×”×¤×•× ×§×¦×™×”
    row = fv._get_webapp_button_row('abc', None)

    # ×‘×“×™×§×”
    assert row[0].url == expected</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-8-3">
          <div class="snippet-header">
            <h3 class="snippet-title">8.3 Async Test</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×‘×“×™×§×ª ×¤×•× ×§×¦×™×•×ª async ×¢× aiohttp ××• asyncio.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import pytest
from aiohttp import web
import aiohttp

@pytest.mark.asyncio
async def test_health_endpoint_ok(monkeypatch):
    """×‘×•×“×§ ×©×”-health endpoint ×¢×•×‘×“"""
    from services.webserver import create_app

    app = create_app()

    # ×”×¨×¦×ª server ×–×× ×™
    runner = web.AppRunner(app)
    await runner.setup()
    site = web.TCPSite(runner, host="127.0.0.1", port=0)
    await site.start()

    try:
        # ×§×‘×œ×ª ×¤×•×¨×˜ ×“×™× ××™
        port = list(site._server.sockets)[0].getsockname()[1]

        # ×©×œ×™×—×ª request
        async with aiohttp.ClientSession() as session:
            async with session.get(f"http://127.0.0.1:{port}/health") as resp:
                assert resp.status == 200
                data = await resp.json()
                assert data.get("status") == "ok"

    finally:
        # × ×™×§×•×™
        await runner.cleanup()</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-8-4">
          <div class="snippet-header">
            <h3 class="snippet-title">8.4 Mocking ×¢× MagicMock</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×”×—×œ×¤×ª dependencies ×¢× mocks ×œ×‘×“×™×§×” ××‘×•×“×“×ª.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from unittest.mock import MagicMock, Mock
import unittest

class TestBookmarks(unittest.TestCase):
    def test_toggle_bookmark_add(self):
        """×‘×•×“×§ ×”×•×¡×¤×ª ×¡×™×× ×™×™×” ×—×“×©×”"""

        # ×”×’×“×¨×ª mocks
        mock_collection = MagicMock()
        mock_collection.find_one.return_value = None  # ×¡×™×× ×™×™×” ×œ× ×§×™×™××ª
        mock_collection.count_documents.return_value = 0
        mock_collection.insert_one.return_value = Mock(inserted_id="new_id")

        mock_db = MagicMock()
        mock_db.file_bookmarks = mock_collection

        manager = BookmarksManager(mock_db)

        # ×”×¨×¦×ª ×”×¤×•× ×§×¦×™×”
        result = manager.toggle_bookmark(
            user_id=123,
            file_id="file123",
            file_name="test.py",
            file_path="/test.py",
            line_number=42,
            line_text="def test():",
            note="Test bookmark"
        )

        # ×‘×“×™×§×•×ª
        self.assertTrue(result["ok"])
        self.assertEqual(result["action"], "added")
        self.assertIsNotNone(result["bookmark"])

        # ×•×™×“×•× ×©×”×¤×•× ×§×¦×™×” × ×§×¨××”
        mock_collection.insert_one.assert_called_once()</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-8-5">
          <div class="snippet-header">
            <h3 class="snippet-title">8.5 Mocking ×¢× @patch Decorator</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×”×—×œ×¤×ª ××•×“×•×œ×™× ×©×œ××™× ××• ×¤×•× ×§×¦×™×•×ª ×‘×¦×•×¨×” × ×§×™×™×”.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from unittest.mock import patch, MagicMock
import unittest

class TestBookmarks(unittest.TestCase):

    @patch('database.bookmarks_manager.logger')
    def test_error_handling(self, mock_logger):
        """×‘×•×“×§ ×©×”×œ×•×’×™× ×¢×•×‘×“×™× ×‘×©×’×™××•×ª"""

        # ×”×’×“×¨×ª mocks
        mock_db = MagicMock()
        mock_collection = MagicMock()
        mock_db.file_bookmarks = mock_collection

        # ×’×•×¨× ×œ×©×’×™××”
        mock_collection.find_one.return_value = None
        mock_collection.count_documents.return_value = 0
        mock_collection.insert_one.side_effect = Exception("DB Error")

        manager = BookmarksManager(mock_db)

        # ×”×¨×¦×ª ×”×¤×•× ×§×¦×™×”
        result = manager.toggle_bookmark(
            user_id=123,
            file_id="file123",
            file_name="test.py",
            file_path="/test.py",
            line_number=42
        )

        # ×‘×“×™×§×•×ª
        self.assertFalse(result["ok"])
        self.assertEqual(result["action"], "error")

        # ×•×™×“×•× ×©×”×©×’×™××” × ×¨×©××”
        mock_logger.error.assert_called()</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 9: ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ (Utility Functions) -->
      <div class="category" id="category-9">
        <div class="category-header">
          <i class="fas fa-tools"></i>
          <h2>×¤×•× ×§×¦×™×•×ª ×¢×–×¨</h2>
        </div>

        <div class="snippet" id="snippet-9-1">
          <div class="snippet-header">
            <h3 class="snippet-title">9.1 ×–××Ÿ ×™×—×¡×™ ×‘×¢×‘×¨×™×ª (TimeUtils.format_relative_time)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×¢×•×–×¨ ×œ×”×¦×™×’ ×œ××©×ª××©×™× ×›××” ×–××Ÿ ×¢×‘×¨ ×‘×©×¤×” ×˜×‘×¢×™×ª ×‘×¢×‘×¨×™×ª, ×¢× ×˜×™×¤×•×œ ×—×›× ×‘×™×—×™×“×•×ª ×–××Ÿ ×©×•× ×•×ª.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class TimeUtils:
    """×›×œ×™× ×œ×¢×‘×•×“×” ×¢× ×–××Ÿ ×•×ª××¨×™×›×™×"""
    
    @staticmethod
    def format_relative_time(dt: datetime) -> str:
        """×¤×•×¨××˜ ×–××Ÿ ×™×—×¡×™ (×œ×¤× ×™ 5 ×“×§×•×ª, ××ª××•×œ ×•×›×•')"""
        
        now = datetime.now(timezone.utc) if dt.tzinfo else datetime.now()
        diff = now - dt
        
        if diff.days > 365:
            years = diff.days // 365
            return f"×œ×¤× ×™ {years} ×©× {'×”' if years == 1 else '×™×'}"
        
        elif diff.days > 30:
            months = diff.days // 30
            return f"×œ×¤× ×™ {months} ×—×•×“{'×©' if months == 1 else '×©×™×'}"
        
        elif diff.days > 7:
            weeks = diff.days // 7
            return f"×œ×¤× ×™ {weeks} ×©×‘×•×¢{'×•×ª' if weeks > 1 else ''}"
        
        elif diff.days > 0:
            if diff.days == 1:
                return "××ª××•×œ"
            return f"×œ×¤× ×™ {diff.days} ×™××™×"
        
        elif diff.seconds > 3600:
            hours = diff.seconds // 3600
            return f"×œ×¤× ×™ {hours} ×©×¢{'×”' if hours == 1 else '×•×ª'}"
        
        elif diff.seconds > 60:
            minutes = diff.seconds // 60
            return f"×œ×¤× ×™ {minutes} ×“×§{'×”' if minutes == 1 else '×•×ª'}"
        
        else:
            return "×¢×›×©×™×•"</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-2">
          <div class="snippet-header">
            <h3 class="snippet-title">9.2 ××¡×§×™×™×¤ ×œ-Markdown ×‘×˜×œ×’×¨× (TextUtils.escape_markdown)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××ª××™× ×›×©×¦×¨×™×š ×œ×”×¦×™×’ ×˜×§×¡×˜ ×’×•×œ××™ ×‘×˜×œ×’×¨× ×‘×œ×™ ×œ×©×‘×•×¨ ×¢×™×¦×•×‘ Markdown V1/V2.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class TextUtils:
    """×›×œ×™× ×œ×¢×‘×•×“×” ×¢× ×˜×§×¡×˜"""
    
    @staticmethod
    def escape_markdown(text: str, version: int = 2) -> str:
        """×”×’× ×” ×¢×œ ×ª×•×•×™× ××™×•×—×“×™× ×‘-Markdown"""
        
        if version == 2:
            # Markdown V2: ×›×œ ×”×ª×•×•×™× ×©×™×© ×œ××¡×§×™×™×¤ ×œ×¤×™ Telegram MarkdownV2
            special_chars = set("_*[]()~`>#+-=|{}.!\\")
            return "".join(("\\" + ch) if ch in special_chars else ch for ch in text)
        else:
            # Markdown V1: × ×©×ª××© ×‘×§×‘×•×¦×” ××¦×•××¦××ª ××š ×’× × ×¡××Ÿ ×¡×•×’×¨×™×™× ×›×“×™ ×œ×”×™×× ×¢ ××ª×§×œ×•×ª ×›×œ×œ×™×•×ª
            special_chars = set("_*`[()\\")
            return "".join(("\\" + ch) if ch in special_chars else ch for ch in text)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-3">
          <div class="snippet-header">
            <h3 class="snippet-title">9.3 × ×™×§×•×™ ×©××•×ª ×§×‘×¦×™× (TextUtils.clean_filename)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××¡×™×¨ ×ª×•×•×™× ××¡×•×¨×™× ×•××§×¦×¨ ×©××•×ª ×œ×¤× ×™ ×©××™×¨×” ×‘×“×™×¡×§ ××• ×”×¢×œ××” ×œ×¢× ×Ÿ.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class TextUtils:
    """×›×œ×™× ×œ×¢×‘×•×“×” ×¢× ×˜×§×¡×˜"""
    
    @staticmethod
    def clean_filename(filename: str) -> str:
        """× ×™×§×•×™ ×©× ×§×•×‘×¥ ××ª×•×•×™× ×œ× ×—×•×§×™×™×"""
        
        # ×”×¡×¨×ª ×ª×•×•×™× ×œ× ×—×•×§×™×™×
        cleaned = re.sub(r'[<>:"/\\|?*]', '_', filename)
        
        # ×”×¡×¨×ª ×¨×•×•×—×™× ××™×•×ª×¨×™×
        cleaned = re.sub(r'\s+', '_', cleaned)
        
        # ×”×¡×¨×ª × ×§×•×“×•×ª ××™×•×ª×¨×•×ª
        cleaned = re.sub(r'\.+', '.', cleaned)
        
        # ×”×’×‘×œ×ª ××•×¨×š
        if len(cleaned) > 100:
            name, ext = os.path.splitext(cleaned)
            cleaned = name[:100-len(ext)] + ext
        
        return cleaned.strip('._')</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-4">
          <div class="snippet-header">
            <h3 class="snippet-title">9.4 ××¢× ×” ×‘×˜×•×— ×œ-CallbackQuery (TelegramUtils.safe_answer)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××‘×¦×¢ `query.answer` ×¢× ×”×—×¨×’×” ×©×œ ×©×’×™××•×ª ×™×“×•×¢×•×ª ×›×“×™ ×œ× ×œ×”×¤×™×œ ××ª ×”×–×¨×™××”.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class TelegramUtils:
    """×›×œ×™× ×œ×¢×‘×•×“×” ×¢× Telegram"""
    
    @staticmethod
    async def safe_answer(query, text: Optional[str] = None, show_alert: bool = False, cache_time: Optional[int] = None) -> None:
        """××¢× ×” ×‘×˜×•×— ×œ-CallbackQuery: ××ª×¢×œ× ××©×’×™××•×ª 'Query is too old'/'query_id_invalid'."""
        try:
            kwargs: Dict[str, Any] = {}
            if text is not None:
                kwargs["text"] = text
            if show_alert:
                kwargs["show_alert"] = True
            if cache_time is not None:
                kwargs["cache_time"] = int(cache_time)
            await query.answer(**kwargs)
        except Exception as e:
            msg = str(e).lower()
            if "query is too old" in msg or "query_id_invalid" in msg or "message to edit not found" in msg:
                return
            raise</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-5">
          <div class="snippet-header">
            <h3 class="snippet-title">9.5 ×¤×™×¦×•×œ ×”×•×“×¢×•×ª ××¨×•×›×•×ª (TelegramUtils.split_long_message)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×¢×•×–×¨ ×œ×¤×¦×œ ×ª×©×•×‘×” ×’×“×•×œ×” ×œ××§×˜×¢×™× ×‘×’×‘×•×œ 4096 ×ª×•×•×™× ×©×œ ×˜×œ×’×¨×.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class TelegramUtils:
    """×›×œ×™× ×œ×¢×‘×•×“×” ×¢× Telegram"""
    
    @staticmethod
    def split_long_message(text: str, max_length: int = 4096) -> List[str]:
        """×—×œ×•×§×ª ×”×•×“×¢×” ××¨×•×›×” ×œ×—×œ×§×™×"""
        
        if len(text) <= max_length:
            return [text]
        
        parts = []
        current_part = ""
        
        for line in text.split('\n'):
            if len(current_part) + len(line) + 1 <= max_length:
                current_part += line + '\n'
            else:
                if current_part:
                    parts.append(current_part.rstrip())
                current_part = line + '\n'
        
        if current_part:
            parts.append(current_part.rstrip())
        
        return parts</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-6">
          <div class="snippet-header">
            <h3 class="snippet-title">9.6 ×¢×¨×™×›×ª ×”×•×“×¢×” ×‘×˜×•×—×” (TelegramUtils.safe_edit_message_text)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××˜×¤×œ ×’× ×‘××™××•×©×™× ×¡×™× ×›×¨×•× ×™×™× ×•×’× ××¡×™× ×›×¨×•× ×™×™× ×•××“×›× ××ª ×©×’×™××ª "message is not modified".</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class TelegramUtils:
    """×›×œ×™× ×œ×¢×‘×•×“×” ×¢× Telegram"""
    
    @staticmethod
    async def safe_edit_message_text(query, text: str, reply_markup=None, parse_mode: Optional[str] = None) -> None:
        """×¢×¨×™×›×ª ×˜×§×¡×˜ ×”×•×“×¢×” ×‘×‘×˜×™×—×•×ª: ××ª×¢×œ× ××©×’×™××ª 'Message is not modified'.

        ×ª×•××š ×’× ×‘××™××•×©×™ ×‘×“×™×§×•×ª ×©×‘×”× `edit_message_text` ×”×™× ×¤×•× ×§×¦×™×” ×¡×™× ×›×¨×•× ×™×ª
        ×©××—×–×™×¨×” `None` (×œ× awaitable), ×•×’× ×‘××™××•×©×™× ××¡×™× ×›×¨×•× ×™×™× ×¨×’×™×œ×™×.
        """
        try:
            edit_func = getattr(query, "edit_message_text", None)
            if not callable(edit_func):
                return

            kwargs = {"text": text, "reply_markup": reply_markup}
            if parse_mode is not None:
                kwargs["parse_mode"] = parse_mode

            result = edit_func(**kwargs)

            # ×× ×—×–×¨ coroutine â€“ ×¦×¨×™×š ×œ×”××ª×™×Ÿ; ××—×¨×ª ×–×• ×¤×•× ×§×¦×™×” ×¡×™× ×›×¨×•× ×™×ª ×•××™×Ÿ ××” ×œ×”××ª×™×Ÿ
            if asyncio.iscoroutine(result):
                await result
        except Exception as e:
            msg = str(e).lower()
            # ×”×ª×¢×œ××•×ª ×¨×§ ×‘××§×¨×” "not modified" (×¢××™×“ ×œ×©×™× ×•×™×™× ×§×œ×™× ×‘×˜×§×¡×˜)
            if "not modified" in msg or "message is not modified" in msg:
                return
            raise</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-7">
          <div class="snippet-header">
            <h3 class="snippet-title">9.7 ×× ×™×¢×ª ×œ×—×™×¦×” ×›×¤×•×œ×” (CallbackQueryGuard.should_block_async)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××•× ×¢ ×”×¤×¢×œ×” ×›×¤×•×œ×” ×©×œ ××•×ª×• ×›×¤×ª×•×¨ ×‘×××¦×¢×•×ª × ×¢×™×œ×•×ª ×¤×¨-××©×ª××© ×•×—×œ×•×Ÿ ×–××Ÿ ×§×¦×¨.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class CallbackQueryGuard:
    """Guard ×’×•×¨×£ ×œ×œ×—×™×¦×•×ª ×›×¤×•×œ×•×ª ×¢×œ ×›×¤×ª×•×¨×™ CallbackQuery.
    
    ××‘×•×¡×¡ ×¢×œ ×˜×‘×™×¢×ª ××¦×‘×¢ ×©×œ ×”××©×ª××©/×”×•×“×¢×”/×”× ×ª×•×Ÿ (callback_data) ×›×“×™ ×œ×—×¡×•×
    ××ª ××•×ª×” ×¤×¢×•×œ×” ×‘×—×œ×•×Ÿ ×–××Ÿ ×§×¦×¨, ×‘×œ×™ ×œ×—×¡×•× ×¤×¢×•×œ×•×ª ×©×•× ×•×ª.
    """

    DEFAULT_WINDOW_SECONDS: float = 1.2
    _user_locks: Dict[int, asyncio.Lock] = {}

    @staticmethod
    async def should_block_async(update: Update, context: ContextTypes.DEFAULT_TYPE, window_seconds: Optional[float] = None) -> bool:
        """×‘×•×“×§ ×‘×¦×•×¨×” ××˜×•××™×ª (×¢× × ×¢×™×œ×”) ×× ×œ×—×¡×•× ×œ×—×™×¦×” ×›×¤×•×œ×” ×©×œ ××•×ª×• ××©×ª××©.

        ×—×¡×™××” ××‘×•×¡×¡×ª ×—×œ×•×Ÿ ×–××Ÿ ×¤×¨-××©×ª××©, ×œ×œ× ×ª×œ×•×ª ×‘-message_id/data, ×›×“×™ ×œ×× ×•×¢ ××¨×•×¥.
        """
        try:
            try:
                win = float(window_seconds if window_seconds is not None else CallbackQueryGuard.DEFAULT_WINDOW_SECONDS)
            except Exception:
                win = CallbackQueryGuard.DEFAULT_WINDOW_SECONDS

            user_id = int(getattr(getattr(update, 'effective_user', None), 'id', 0) or 0)

            # ×× ××™×Ÿ ×–×™×”×•×™ ××©×ª××©, fallback ×œ×”×ª× ×”×’×•×ª ×”×™×©× ×” ×œ×œ× ×—×¡×™××”
            if user_id <= 0:
                return CallbackQueryGuard.should_block(update, context, window_seconds=win)

            # ×§×‘×œ/×¦×•×¨ × ×¢×™×œ×” ×œ××©×ª××©
            lock = CallbackQueryGuard._user_locks.get(user_id)
            if lock is None:
                lock = asyncio.Lock()
                CallbackQueryGuard._user_locks[user_id] = lock

            async with lock:
                now_ts = time.time()
                # ×”×©×ª××© ×‘××•×ª×• ×©×“×” ×–××Ÿ ×’×œ×•×‘×œ×™ ×©×”×™×” ×‘×©×™××•×©, ××š ×œ×œ× ×˜×‘×™×¢×ª ××¦×‘×¢
                busy_until = float(context.user_data.get("_cb_guard_until", 0.0) or 0.0) if hasattr(context, "user_data") else 0.0
                if now_ts < busy_until:
                    return True
                # ×¡×× ×• ×—×œ×•×Ÿ ×–××Ÿ ×—×¡×™××” ×—×“×©
                if hasattr(context, "user_data"):
                    context.user_data["_cb_guard_until"] = now_ts + win
                return False
        except Exception:
            # ××œ ×ª×—×¡×•× ×× guard × ×›×©×œ
            return False</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-8">
          <div class="snippet-header">
            <h3 class="snippet-title">9.8 ×¢×™×‘×•×“ ×¤×¨×™×˜×™× ×‘×§×‘×•×¦×•×ª (AsyncUtils.batch_process)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×××¤×©×¨ ×œ×”×¨×™×¥ ×¤×¢×•×œ×•×ª ××¡×™× ×›×¨×•× ×™×•×ª ×‘×§×‘×•×¦×•×ª ×§×˜× ×•×ª ×¢× ×”×©×”×™×” ×‘×™×Ÿ ×’×•×©×™×.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class AsyncUtils:
    """×›×œ×™× ×œ×¢×‘×•×“×” ××¡×™× ×›×¨×•× ×™×ª"""
    
    @staticmethod
    async def batch_process(items: List[Any], process_func: Callable, 
                           batch_size: int = 10, delay: float = 0.1) -> List[Any]:
        """×¢×™×‘×•×“ ×¤×¨×™×˜×™× ×‘×§×‘×•×¦×•×ª"""
        
        results = []
        
        for i in range(0, len(items), batch_size):
            batch = items[i:i + batch_size]
            
            # ×¢×™×‘×•×“ ×”×§×‘×•×¦×”
            batch_tasks = [process_func(item) for item in batch]
            batch_results = await asyncio.gather(*batch_tasks, return_exceptions=True)
            
            results.extend(batch_results)
            
            # ×”××ª× ×” ×‘×™×Ÿ ×§×‘×•×¦×•×ª
            if delay > 0 and i + batch_size < len(items):
                await asyncio.sleep(delay)
        
        return results</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-9">
          <div class="snippet-header">
            <h3 class="snippet-title">9.9 ××“×™×“×ª ×–××Ÿ ×¢× context manager (PerformanceUtils.measure_time)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> × ×•×ª×Ÿ ×“×¨×š ×§×œ×” ×œ××“×•×“ ××©×š ×¤×¢×•×œ×” ×•×œ×¨×©×•× ××•×ª×• ×œ×œ×•×’.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class PerformanceUtils:
    """×›×œ×™× ×œ××“×™×“×ª ×‘×™×¦×•×¢×™×"""
    
    @staticmethod
    @contextmanager
    def measure_time(operation_name: str):
        """××“×™×“×ª ×–××Ÿ ×¢× context manager"""
        
        start_time = time.time()
        try:
            yield
        finally:
            execution_time = time.time() - start_time
            logger.info(f"{operation_name}: {execution_time:.3f}s")</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-10">
          <div class="snippet-header">
            <h3 class="snippet-title">9.10 ×‘×“×™×§×ª ×§×•×“ ××¡×•×›×Ÿ (ValidationUtils.is_safe_code)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××¡×¤×§ ×‘×“×™×§×ª ×‘×˜×™×—×•×ª ×‘×¡×™×¡×™×ª ×œ×§×•×“ ×œ×¤×™ ×©×¤×” ×•××—×–×™×¨ ×”×ª×¨××•×ª ××¤×©×¨×™×•×ª.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class ValidationUtils:
    """×›×œ×™× ×œ×•×•×œ×™×“×¦×™×”"""
    
    @staticmethod
    def is_safe_code(code: str, programming_language: str) -> Tuple[bool, List[str]]:
        """×‘×“×™×§×” ×‘×¡×™×¡×™×ª ×©×œ ×‘×˜×™×—×•×ª ×§×•×“"""
        
        warnings = []
        
        # ×“×¤×•×¡×™× ××¡×•×›× ×™×
        dangerous_patterns = {
            'python': [
                r'exec\s*\(',
                r'eval\s*\(',
                r'__import__\s*\(',
                r'open\s*\([^)]*["\']w',  # ×›×ª×™×‘×” ×œ×§×•×‘×¥
                r'subprocess\.',
                r'os\.system\s*\(',
                r'os\.popen\s*\(',
            ],
            'javascript': [
                r'eval\s*\(',
                r'Function\s*\(',
                r'document\.write\s*\(',
                r'innerHTML\s*=',
                r'outerHTML\s*=',
            ],
            'bash': [
                r'rm\s+-rf',
                r'rm\s+/',
                r'dd\s+if=',
                r'mkfs\.',
                r'fdisk\s+',
            ]
        }
        
        if programming_language in dangerous_patterns:
            for pattern in dangerous_patterns[programming_language]:
                if re.search(pattern, code, re.IGNORECASE):
                    warnings.append(f"×“×¤×•×¡ ××¡×•×›×Ÿ ××¤×©×¨×™: {pattern}")
        
        # ×‘×“×™×§×•×ª ×›×œ×œ×™×•×ª
        if 'password' in code.lower() or 'secret' in code.lower():
            warnings.append("×”×§×•×“ ××›×™×œ ××™×œ×•×ª ×¡×™×¡××” ××• ×¡×•×“")
        
        if re.search(r'https?://\S+', code):
            warnings.append("×”×§×•×“ ××›×™×œ URL×™×")
        
        is_safe = len(warnings) == 0
        return is_safe, warnings</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-11">
          <div class="snippet-header">
            <h3 class="snippet-title">9.11 ×™×¦×™×¨×ª ×§×•×‘×¥ ×–×× ×™ (FileUtils.create_temp_file)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×™×•×¦×¨ ×§×•×‘×¥ ×–×× ×™ ×¢× ×ª×•×›×Ÿ ××—×¨×•×–×ª/×‘×™×™×˜×™× ×•××—×–×™×¨ ××ª ×”× ×ª×™×‘ ×œ×©×™××•×© ××™×™×“×™.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class FileUtils:
    """×›×œ×™× ×œ×¢×‘×•×“×” ×¢× ×§×‘×¦×™×"""
    
    @staticmethod
    async def create_temp_file(content: Union[str, bytes], 
                              suffix: str = "") -> str:
        """×™×¦×™×¨×ª ×§×•×‘×¥ ×–×× ×™"""
        
        with tempfile.NamedTemporaryFile(mode='wb', suffix=suffix, delete=False) as temp_file:
            if isinstance(content, str):
                content = content.encode('utf-8')
            
            temp_file.write(content)
            return temp_file.name</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-12">
          <div class="snippet-header">
            <h3 class="snippet-title">9.12 ×˜×¢×™× ×ª ×§×•×‘×¥ JSON ×¢× ×‘×¨×™×¨×ª ××—×“×œ (ConfigUtils.load_json_config)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> × ×•×— ×œ×§×¨×™××ª ×§×‘×¦×™ ×”×’×“×¨×•×ª ×¢× ×˜×™×¤×•×œ ×‘×©×’×™××•×ª ×•×œ×•×’ ××–×”×¨×” ×× ×”×§×•×‘×¥ ×—×¡×¨.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class ConfigUtils:
    """×›×œ×™× ×œ×§×•× ×¤×™×’×•×¨×¦×™×”"""
    
    @staticmethod
    def load_json_config(file_path: str, default: Optional[Dict[str, Any]] = None) -> Dict[str, Any]:
        """×˜×¢×™× ×ª ×§×•× ×¤×™×’×•×¨×¦×™×” ××§×•×‘×¥ JSON"""
        
        if default is None:
            default = {}
        
        try:
            if os.path.exists(file_path):
                with open(file_path, 'r', encoding='utf-8') as f:
                    return json.load(f)
            else:
                logger.warning(f"×§×•×‘×¥ ×§×•× ×¤×™×’×•×¨×¦×™×” ×œ× × ××¦×: {file_path}")
                return default
        
        except Exception as e:
            logger.error(f"×©×’×™××” ×‘×˜×¢×™× ×ª ×§×•× ×¤×™×’×•×¨×¦×™×”: {e}")
            return default</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-13">
          <div class="snippet-header">
            <h3 class="snippet-title">9.13 ×§××© ×–×™×›×¨×•×Ÿ ×¢× TTL (CacheUtils.set/get)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×××¤×©×¨ ×œ×©××•×¨ ×¢×¨×›×™× ×‘×–×™×›×¨×•×Ÿ ×œ×–××Ÿ ×§×¦×•×‘ ×•×œ×”×¡×™×¨× ××•×˜×•××˜×™×ª ×›×©×”×ª×•×§×£ ×¤×’.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class CacheUtils:
    """×›×œ×™× ×œ×§××© ×–×× ×™"""
    
    _cache: Dict[str, Any] = {}
    _cache_times: Dict[str, float] = {}
    
    @classmethod
    def set(cls, key: str, value: Any, ttl: int = 300):
        """×©××™×¨×” ×‘×§××© ×¢× TTL (×©× ×™×•×ª)"""
        cls._cache[key] = value
        cls._cache_times[key] = time.time() + ttl
    
    @classmethod
    def get(cls, key: str, default: Any = None) -> Any:
        """×§×‘×œ×” ××”×§××©"""
        
        if key not in cls._cache:
            return default
        
        # ×‘×“×™×§×ª ×ª×¤×•×’×”
        if time.time() > cls._cache_times.get(key, 0):
            cls.delete(key)
            return default
        
        return cls._cache[key]

    @classmethod
    def delete(cls, key: str):
        """××—×™×§×” ××”×§××©"""
        cls._cache.pop(key, None)
        cls._cache_times.pop(key, None)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-14">
          <div class="snippet-header">
            <h3 class="snippet-title">9.14 ××¡× ×Ÿ ×œ×•×’×™× ×œ×¨×’×™×©×•×™×•×ª (SensitiveDataFilter)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××˜×©×˜×© ×˜×•×§× ×™× ×—×©×•×¤×™× ×‘×œ×•×’×™× ×œ×¤× ×™ ×©×”× × ×›×ª×‘×™× ×”×—×•×¦×”.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class SensitiveDataFilter(logging.Filter):
    """××¡× ×Ÿ ×©××˜×©×˜×© ×˜×•×§× ×™× ×•× ×ª×•× ×™× ×¨×’×™×©×™× ×‘×œ×•×’×™×."""
    def filter(self, record: logging.LogRecord) -> bool:
        try:
            msg = str(record.getMessage())
            # ×–×™×”×•×™ ×‘×¡×™×¡×™ ×©×œ ×˜×•×§× ×™×: ghp_..., github_pat_..., Bearer ...
            patterns = [
                (r"ghp_[A-Za-z0-9]{20,}", "ghp_***REDACTED***"),
                (r"github_pat_[A-Za-z0-9_]{20,}", "github_pat_***REDACTED***"),
                (r"Bearer\s+[A-Za-z0-9\-_.=:/+]{10,}", "Bearer ***REDACTED***"),
            ]
            redacted = msg
            import re as _re
            for pat, repl in patterns:
                redacted = _re.sub(pat, repl, redacted)
            # ×¢×“×›×Ÿ ×¨×§ ××ª message ×”×¤×•×¨××˜×™
            record.msg = redacted
            # ×—×©×•×‘: × ×§×” ××¨×’×•×× ×˜×™× ×›×“×™ ×œ×× ×•×¢ × ×™×¡×™×•×Ÿ ×¤×•×¨××˜ ×—×•×–×¨ (%s) ×©×™×•×‘×™×œ ×œ-TypeError
            record.args = ()
        except Exception:
            pass
        return True</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-15">
          <div class="snippet-header">
            <h3 class="snippet-title">9.15 × ×™×¨××•×œ ××¨×’×•×× ×˜×™× ×œ×¤×§×•×“×•×ª (_coerce_command_args)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××ª××™× ×›×©×¦×¨×™×š ×œ×§×‘×œ ××¨×’×•×× ×˜×™× ××¤×§×•×“×ª ×˜×œ×’×¨× ×•×œ×ª××•×š ×‘××¡×¤×¨ ×˜×™×¤×•×¡×™× ×©×•× ×™×.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">def _coerce_command_args(raw_args) -> List[str]:
    """×”××¨×ª args ××¡×•×’×™× ×©×•× ×™× ×œ×¨×©×™××ª ××—×¨×•×–×•×ª × ×§×™×™×”."""
    normalized: List[str] = []
    if raw_args is None:
        return normalized
    try:
        if isinstance(raw_args, (list, tuple, set)):
            iterable = list(raw_args)
        elif isinstance(raw_args, str):
            iterable = [raw_args]
        else:
            try:
                iterable = list(raw_args)
            except TypeError:
                iterable = [raw_args]
    except Exception:
        iterable = []
    for arg in iterable:
        if arg is None:
            continue
        if isinstance(arg, bytes):
            try:
                normalized.append(arg.decode("utf-8"))
                continue
            except Exception:
                normalized.append(arg.decode("utf-8", "ignore"))
                continue
        normalized.append(str(arg))
    return normalized</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-16">
          <div class="snippet-header">
            <h3 class="snippet-title">9.16 ×§×™×¦×•×¨ ×˜×§×¡×˜ ×‘×××¦×¢ (_truncate_middle)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> × ×•×— ×œ×”×¦×’×ª ×©××•×ª ×§×‘×¦×™× ××• ××–×”×™× ××¨×•×›×™× ×ª×•×š ×©××™×¨×” ×¢×œ ×”×”×ª×—×œ×” ×•×”×¡×•×£.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">def _truncate_middle(text: str, max_len: int) -> str:
    """××§×¦×¨ ××—×¨×•×–×ª ×‘×××¦×¢ ×¢× ××œ×™×¤×¡×™×¡ ×× ×—×•×¨×’×ª ×××•×¨×š × ×ª×•×Ÿ."""
    if max_len <= 0:
        return ''
    if len(text) <= max_len:
        return text
    if max_len <= 1:
        return text[:max_len]
    keep = max_len - 1
    front = keep // 2
    back = keep - front
    return text[:front] + 'â€¦' + text[-back:]</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-17">
          <div class="snippet-header">
            <h3 class="snippet-title">9.17 ××¢×§×‘ ×‘×™×¦×•×¢×™× ×¢× Prometheus (track_performance)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> context manager ×©××–×™×Ÿ Histogram ×©×œ Prometheus ×‘×œ×™ ×œ×”×¤×™×œ ××ª ×”×©×™×¨×•×ª ×‘××§×¨×” ×©×œ ×©×’×™××ª ×œ×™×™×‘×œ×™×.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">@contextmanager
def track_performance(operation: str, labels: Optional[Dict[str, str]] = None):
    start = time.time()
    try:
        yield
    finally:
        if operation_latency_seconds is not None:
            try:
                # ×‘×—×¨ ×¨×§ ×œ×™×™×‘×œ×™× ×©××•×’×“×¨×™× ×‘××˜×¨×™×§×” ×•××œ ×ª××¤×©×¨ ×“×¨×™×¡×” ×©×œ 'operation'
                allowed = set(getattr(operation_latency_seconds, "_labelnames", []) or [])
                target = {"operation": operation}
                if labels:
                    for k, v in labels.items():
                        if k in allowed and k != "operation":
                            target[k] = v
                # ×¡×¤×§ ×¢×¨×›×™ ×‘×¨×™×¨×ª ××—×“×œ ×œ×›×œ ×œ×™×™×‘×œ ×—×¡×¨ (×œ××©×œ repo="") ×›×“×™ ×œ×©××•×¨ ×ª××™××•×ª ×œ××—×•×¨
                for name in allowed:
                    if name not in target:
                        if name == "operation":
                            # ×›×‘×¨ ×¡×•×¤×§ ×œ×¢×™×œ
                            continue
                        # ×‘×¨×™×¨×ª ××—×“×œ: ××™×ª×¨ ×¡×× ×˜×™×§×”, ××•× ×¢ ValueError ×¢×œ ×—×•×¡×¨ ×‘×œ×™×™×‘×œ
                        target[name] = ""
                operation_latency_seconds.labels(**target).observe(time.time() - start)
            except Exception:
                # avoid breaking app on label mistakes
                pass</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-18">
          <div class="snippet-header">
            <h3 class="snippet-title">9.18 ×”×¦×¢×ª ×”×©×œ××•×ª ×œ×—×™×¤×•×© ×’×œ×•×‘×œ×™ (fetchSuggestions)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×©×•×œ×— ×‘×§×©×” ××¡×™× ×›×¨×•× ×™×ª ×‘×¦×“ ×”×œ×§×•×— ×•×× ×ª×‘ ×”×ª×—×‘×¨×•×ª ×××•×œ×¦×ª ×‘××§×¨×” ×©×œ 401.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript"><code class="language-javascript">async function fetchSuggestions(q){
  try{
    const res = await fetch('/api/search/suggestions?q=' + encodeURIComponent(q), {
      headers: { 'Accept': 'application/json' },
      credentials: 'same-origin'
    });

    if (res.status === 401 || res.redirected) {
      window.location.href = '/login?next=' + encodeURIComponent(location.pathname + location.search + location.hash);
      return;
    }

    const contentType = res.headers.get('content-type') || '';
    if (!contentType.includes('application/json')) { hideSuggestions(); return; }

    const data = await res.json();
    if (data && data.suggestions && data.suggestions.length){
      showSuggestions(data.suggestions);
    } else hideSuggestions();
  } catch (e){ hideSuggestions(); }
}</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-19">
          <div class="snippet-header">
            <h3 class="snippet-title">9.19 ×”×“×’×©×ª ×˜×•×•×—×™× ×‘×ª×•×¦××•×ª ×—×™×¤×•×© (highlightSnippet)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××§×‘×œ ×˜×§×¡×˜ ×’×•×œ××™ ×•××“×’×™×© ×˜×•×•×—×™× ×¨×œ×•×•× ×˜×™×™× ×¢× `<mark>` ××‘×œ×™ ×œ×©×‘×•×¨ HTML.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript"><code class="language-javascript">function highlightSnippet(text, ranges){
  text = String(text || '');
  if (!ranges || !ranges.length) return escapeHtml(text);
  const items = ranges.slice().sort((a,b)=> (a[0]-b[0]));
  let out = '', last = 0;
  for (const [s,e] of items){
    if (s < last) continue;
    out += escapeHtml(text.slice(last, s));
    out += '<mark class="bg-warning">' + escapeHtml(text.slice(s, e)) + '</mark>';
    last = e;
  }
  out += escapeHtml(text.slice(last));
  return out;
}</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 10: Background Jobs ×•-RQ -->
      <div class="category" id="category-10">
        <div class="category-header">
          <i class="fas fa-tasks"></i>
          <h2>Background Jobs ×•-RQ</h2>
        </div>

        <div class="snippet" id="snippet-10-1">
          <div class="snippet-header">
            <h3 class="snippet-title">10.1 RQ Job Definition ×¢× Retry ×•-Timeout</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×™×¦×™×¨×ª background job ×¢× RQ ×›×•×œ×œ retry ××•×˜×•××˜×™ ×•×˜×™×™××××•×˜</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from rq import Retry
from rq.decorators import job
from app.core.cache import redis_queue_sync

@job("default", timeout="10m", retry=Retry(max=3, interval=60), connection=redis_queue_sync)
def process_new_report(report_id: str):
    """
    Process a newly submitted report.
    
    Args:
        report_id: UUID string of the report to process
    """
    logger.info("Processing report", report_id=report_id)
    
    try:
        # Run async code from sync job
        return asyncio.run(_process_new_report_async(report_id))
    except Exception as e:
        logger.error("Failed to process report", report_id=report_id, error=str(e))
        raise  # Re-raise for RQ retry mechanism</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-10-2">
          <div class="snippet-header">
            <h3 class="snippet-title">10.2 Enqueue or Run Inline Pattern</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×ª××™×›×” ×‘-workers ×•×’× ×‘××¦×‘ ×œ×œ× workers (development)</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">def enqueue_or_run(func, *args, **kwargs):
    """
    Enqueue an RQ job when workers enabled, otherwise run inline.
    
    Example:
        enqueue_or_run(process_new_report, report_id=str(report.id))
    """
    if settings.ENABLE_WORKERS:
        # Production: Queue to RQ worker
        return func.delay(*args, **kwargs)
    else:
        # Development: Run inline
        if asyncio.iscoroutinefunction(func):
            return asyncio.create_task(func(*args, **kwargs))
        else:
            return func(*args, **kwargs)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-10-3">
          <div class="snippet-header">
            <h3 class="snippet-title">10.3 RQ Scheduler â€“ Recurring Jobs</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×ª×–××•×Ÿ ××©×™××•×ª ×—×•×–×¨×•×ª (cleanup, stats, sync)</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from rq_scheduler import Scheduler
from app.core.cache import redis_queue_sync

def schedule_recurring_jobs():
    """Schedule recurring background jobs."""
    scheduler = Scheduler(connection=redis_queue_sync)
    
    # Daily cleanup at 2 AM
    scheduler.cron(
        cron_string="0 2 * * *",  # Every day at 2 AM
        func=cleanup_old_data,
        timeout="30m",
        use_local_timezone=False
    )
    
    # Update stats every 6 hours
    scheduler.cron(
        cron_string="0 */6 * * *",
        func=update_organization_stats,
        timeout="10m",
        use_local_timezone=False
    )
    
    logger.info("Recurring jobs scheduled")</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 11: Telegram Bot Patterns -->
      <div class="category" id="category-11">
        <div class="category-header">
          <i class="fas fa-robot"></i>
          <h2>×ª×‘× ×™×•×ª ×‘×•×˜ ×˜×œ×’×¨×</h2>
        </div>

        <div class="snippet" id="snippet-11-1">
          <div class="snippet-header">
            <h3 class="snippet-title">11.1 Maintenance Mode Middleware</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×××¤×©×¨ ×œ×”×›× ×™×¡ ××ª ×”×‘×•×˜ ×œ××¦×‘ ×ª×—×–×•×§×” ×ª×•×š ×©××™×¨×” ×¢×œ ×’×™×©×” ×œ××“××™× ×™×.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript"><code class="language-javascript">const isMaintenanceMode = () => {
  return process.env.MAINTENANCE_MODE === 'true';
};

const isAdmin = (userId) => {
  const admins = (process.env.ADMIN_USER_IDS || '')
    .split(',')
    .map(s => s.trim())
    .filter(Boolean);
  return admins.includes(String(userId));
};

const maintenanceMiddleware = async (msg, next) => {
  if (!isMaintenanceMode() || isAdmin(msg.from.id)) {
    return next();
  }

  await bot.sendMessage(msg.chat.id,
    'ğŸ”§ *×”×‘×•×˜ ×‘××¦×‘ ×ª×—×–×•×§×”*\n\n' +
    '×× ×—× ×• ×¢×•×©×™× ×©×“×¨×•×’ ××”×™×¨ ×œ×‘×•×˜ ğŸš€\n\n' +
    '×”×›×œ ×™×—×–×•×¨ ×œ×¢×‘×•×“ ×ª×•×š ×›××” ×“×§×•×ª.\n\n' +
    '×ª×•×“×” ×¢×œ ×”×¡×‘×œ× ×•×ª! ğŸ˜Š',
    { parse_mode: 'Markdown' }
  );
  return false; // Block further processing
};</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-11-2">
          <div class="snippet-header">
            <h3 class="snippet-title">11.2 Callback Query Router</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> × ×™×ª×•×‘ ××•×˜×•××˜×™ ×©×œ callback queries ×œ×¤×™ prefix, ×—×•×¡×š if-else ××¨×•×›×™× ×•×××¨×’×Ÿ ××ª ×”×§×•×“.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript"><code class="language-javascript">async handleCallbackQuery(query) {
  const chatId = query.message.chat.id;
  const userId = query.from.id;
  const data = query.data;
  const messageId = query.message.message_id;

  // Answer callback to remove loading state
  await this.bot.answerCallbackQuery(query.id);

  // Route based on callback data prefix
  if (data.startsWith('pace_')) {
    await this.handlePaceSelection(chatId, userId, data, messageId);
  } else if (data.startsWith('answer_')) {
    await this.handleQuizAnswer(chatId, userId, data, messageId);
  } else if (data.startsWith('theme_')) {
    await this.handleThemeSelection(chatId, userId, data, messageId);
  } else if (data.startsWith('cheat_')) {
    await this.handleCheatsheetTopic(chatId, userId, data, messageId);
  } else if (data.startsWith('template_')) {
    await this.handleTemplateSelection(chatId, userId, data);
  }
  // ... more routes
}</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-11-3">
          <div class="snippet-header">
            <h3 class="snippet-title">11.3 Safe Send with Fallback</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×©×œ×™×—×ª ×”×•×“×¢×•×ª Markdown ×¢× fallback ××•×˜×•××˜×™ ×œ×˜×§×¡×˜ ×¨×’×™×œ ×× ×™×© ×©×’×™××ª parsing.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript"><code class="language-javascript">async safeSendMarkdown(chatId, text, options = {}) {
  try {
    return await this.bot.sendMessage(chatId, text, { 
      parse_mode: 'Markdown', 
      ...options 
    });
  } catch (err) {
    const desc = String(err?.response?.body?.description || err?.message || '').toLowerCase();
    if (desc.includes("can't parse entities") || desc.includes('parse') || desc.includes('entity')) {
      // Retry without parse mode
      return await this.bot.sendMessage(chatId, text, { ...options });
    }
    throw err;
  }
}</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-11-4">
          <div class="snippet-header">
            <h3 class="snippet-title">11.4 Message Chunking (Split Long Messages)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×˜×œ×’×¨× ××’×‘×™×œ ×”×•×“×¢×•×ª ×œ-4096 ×ª×•×•×™×. ×ª×‘× ×™×ª ×–×• ××—×œ×§×ª ×”×•×“×¢×•×ª ××¨×•×›×•×ª ×œ×—×ª×™×›×•×ª ×ª×•×š ×©××™×¨×” ×¢×œ ×§×¨×™××•×ª.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript"><code class="language-javascript">async sendLongMessage(chatId, text, options = {}) {
  const maxLength = 4000; // Leave room for formatting
  const chunks = [];
  let currentChunk = '';
  const lines = text.split('\n');

  for (const line of lines) {
    if ((currentChunk + line + '\n').length > maxLength) {
      chunks.push(currentChunk);
      currentChunk = line + '\n';
    } else {
      currentChunk += line + '\n';
    }
  }
  if (currentChunk) chunks.push(currentChunk);

  // Send each chunk
  for (let i = 0; i < chunks.length; i++) {
    await this.bot.sendMessage(chatId,
      chunks.length > 1 ? `*×—×œ×§ ${i + 1}/${chunks.length}*\n\n${chunks[i]}` : chunks[i],
      { parse_mode: 'Markdown', ...options }
    );
    await this.sleep(500); // Small delay between messages
  }
}</code></pre>
          </div>
        </div>
      </div>
    </div>
  

</body></html>
