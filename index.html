<!DOCTYPE html>
<html lang="he" dir="rtl" data-theme="light" style=""><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¡×¤×¨×™×™×ª Code Snippets ×”××§×™×¤×”</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&amp;family=Fira+Code:wght@300;400;500&amp;display=swap" rel="stylesheet">

    <!-- Prism.js for syntax highlighting -->
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">

    <style>
      :root {
        --primary-color: #2d3748;
        --secondary-color: #4a5568;
        --accent-color: #3182ce;
        --background-color: #ffffff;
        --card-background: #f7fafc;
        --text-color: #1a202c;
        --border-color: #e2e8f0;
        --code-background: #282a36;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          'Heebo',
          -apple-system,
          BlinkMacSystemFont,
          sans-serif;
        background-color: var(--background-color);
        color: var(--text-color);
        line-height: 1.6;
        direction: rtl;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
      }

      /* Header */
      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 3rem 0;
        text-align: center;
        margin-bottom: 2rem;
      }

      .header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 1rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .header p {
        font-size: 1.2rem;
        opacity: 0.9;
        max-width: 600px;
        margin: 0 auto;
      }

      /* Search */
      .search-container {
        position: sticky;
        top: 0;
        background: var(--background-color);
        padding: 1rem 0;
        border-bottom: 2px solid var(--border-color);
        margin-bottom: 2rem;
        z-index: 100;
      }

      .search-box {
        position: relative;
        max-width: 500px;
        margin: 0 auto;
      }

      .search-input {
        width: 100%;
        padding: 0.75rem 3rem 0.75rem 1rem;
        border: 2px solid var(--border-color);
        border-radius: 0.5rem;
        font-size: 1rem;
        font-family: 'Heebo', sans-serif;
        direction: rtl;
        outline: none;
        transition: border-color 0.3s ease;
      }

      .search-input:focus {
        border-color: var(--accent-color);
      }

      .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--secondary-color);
        pointer-events: none;
      }

      /* Table of Contents */
      .toc {
        background: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
      }

      .toc h2 {
        color: var(--primary-color);
        margin-bottom: 1rem;
        font-size: 1.5rem;
      }

      .toc-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1rem;
      }

      .toc-category {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        padding: 1rem;
      }

      .toc-category h3 {
        color: var(--accent-color);
        font-size: 1rem;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .toc-links {
        list-style: none;
        font-size: 0.9rem;
      }

      .toc-links li {
        margin-bottom: 0.25rem;
      }

      .toc-links a {
        color: var(--secondary-color);
        text-decoration: none;
        display: block;
        padding: 0.25rem 0;
        border-radius: 0.25rem;
        transition: all 0.2s ease;
      }

      .toc-links a:hover {
        color: var(--accent-color);
        background: var(--card-background);
        padding-right: 0.5rem;
      }

      /* Categories */
      .category {
        margin-bottom: 3rem;
      }

      .category-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid var(--accent-color);
      }

      .category-header i {
        font-size: 1.5rem;
        color: var(--accent-color);
      }

      .category-header h2 {
        color: var(--primary-color);
        font-size: 1.75rem;
        font-weight: 600;
      }

      /* Snippets */
      .snippet {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
        overflow: hidden;
        box-shadow: var(--shadow);
        transition:
          transform 0.2s ease,
          box-shadow 0.2s ease;
      }

      .snippet:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 15px -3px rgba(0, 0, 0, 0.1);
      }

      .snippet-header {
        background: var(--card-background);
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
      }

      .snippet-title {
        color: var(--primary-color);
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }

      .snippet-description {
        color: var(--secondary-color);
        font-size: 0.95rem;
        line-height: 1.5;
      }

      .snippet-content {
        position: relative;
      }

      .copy-button {
        position: absolute;
        top: 0.75rem;
        left: 0.75rem;
        background: var(--accent-color);
        color: white;
        border: none;
        border-radius: 0.25rem;
        padding: 0.5rem;
        cursor: pointer;
        font-size: 0.875rem;
        opacity: 0;
        transition: opacity 0.2s ease;
        z-index: 10;
        direction: ltr;
      }

      .snippet:hover .copy-button {
        opacity: 1;
      }

      .copy-button:hover {
        background: #2c5aa0;
      }

      .copy-success {
        background: #10b981 !important;
      }

      /* Code blocks */
      pre[class*='language-'] {
        direction: ltr;
        text-align: left;
        margin: 0;
        border-radius: 0;
        background: var(--code-background) !important;
        font-family: 'Fira Code', 'Courier New', monospace !important;
      }

      code[class*='language-'] {
        font-family: 'Fira Code', 'Courier New', monospace !important;
        font-size: 0.9rem;
        line-height: 1.5;
      }

      /* Filter animations */
      .snippet.filtered-out {
        display: none;
      }

      .category.no-matches {
        display: none;
      }

      /* Responsive design */
      @media (max-width: 768px) {
        .container {
          padding: 0 15px;
        }

        .header h1 {
          font-size: 2rem;
        }

        .header p {
          font-size: 1rem;
        }

        .toc-grid {
          grid-template-columns: 1fr;
        }

        .snippet-header {
          padding: 0.75rem 1rem;
        }

        .snippet-title {
          font-size: 1.1rem;
        }
      }

      /* Scroll behavior */
      html {
        scroll-behavior: smooth;
      }

      /* Anchor offset */
      .category {
        scroll-margin-top: 100px;
      }

      /* No results message */
      .no-results {
        text-align: center;
        padding: 3rem;
        color: var(--secondary-color);
        display: none;
      }

      .no-results.show {
        display: block;
      }

      /* Back to top button */
      .back-to-top {
        position: fixed;
        bottom: 2rem;
        left: 2rem;
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transform: translateY(20px);
        display: flex;
        pointer-events: none;
      }

      .back-to-top.show {
        opacity: 1 !important;
        visibility: visible !important;
        transform: translateY(0) !important;
        pointer-events: auto;
      }

      .back-to-top:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
      }

      .back-to-top:active {
        transform: translateY(-2px);
      }

      @media (max-width: 768px) {
        .back-to-top {
          bottom: 1rem;
          left: 1rem;
          width: 45px;
          height: 45px;
          font-size: 1.2rem;
        }
      }

      /* Ensure last section isn't covered by the fixed back-to-top button */
      .header + .container {
        padding-bottom: 96px;
      }

      /* Fallback: if a code block escapes its snippet wrapper, render it card-like */
      .container > pre[class*='language-'],
      .category > pre[class*='language-'] {
        background: #fff !important;
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 1rem 1.5rem;
        box-shadow: var(--shadow);
        margin-bottom: 1.5rem;
      }
    </style>
  </head>
  <body style="">
    <!-- Header -->
    <div class="header">
      <div class="container">
        <h1><i class="fas fa-code"></i> ×¡×¤×¨×™×™×ª Code Snippets ×”××§×™×¤×”</h1>
        <p>
          ××•×¡×£ ××§×™×£ ×©×œ ×ª×‘× ×™×•×ª ×§×•×“ ×œ×¤×™×ª×•×— ×‘×•×˜×™× ×‘×˜×œ×’×¨×, WebApps, ×¢×‘×•×“×” ×¢× ××¡×“×™ × ×ª×•× ×™× ×•×¢×•×“. ×›×œ ×”×¡× ×™×¤×˜×™× × ×‘×“×§×• ×•××•×›× ×™×
          ×œ×©×™××•×© ××™×™×“×™.
        </p>
      </div>
    </div>

    <div class="container">
      <!-- Search -->
      <div class="search-container">
        <div class="search-box">
          <input type="text" id="searchInput" class="search-input" placeholder="×—×¤×© ×¡× ×™×¤×˜×™×...">
          <i class="fas fa-search search-icon"></i>
        </div>
      </div>

      <!-- Table of Contents -->
      <div class="toc">
        <h2><i class="fas fa-list"></i> ×ª×•×›×Ÿ ×¢× ×™×™× ×™×</h2>
        <div class="toc-grid">
          <div class="toc-category">
            <h3><i class="fas fa-robot"></i> ×ª×¤×¨×™×˜×™× ×‘×‘×•×˜</h3>
            <ul class="toc-links">
              <li><a href="#snippet-1-1">×ª×¤×¨×™×˜ ×¤×¢×•×œ×•×ª ×¢×œ ×§×•×‘×¥</a></li>
              <li><a href="#snippet-1-2">×ª×™×‘×ª ××™×©×•×¨ ×¢× ×›×¤×ª×•×¨×™×</a></li>
              <li><a href="#snippet-1-3">Callback Query Handler</a></li>
              <li><a href="#snippet-1-4">Pagination Helper</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-database"></i> ×¢×‘×•×“×” ×¢× ××¡×“ × ×ª×•× ×™×</h3>
            <ul class="toc-links">
              <li><a href="#snippet-2-1">×©××™×¨×ª ××¡××š ×¢× Versioning</a></li>
              <li><a href="#snippet-2-2">×©×œ×™×¤×ª ××¡××š ×¢× ××˜××•×Ÿ</a></li>
              <li><a href="#snippet-2-3">Update ×¢× Upsert</a></li>
              <li><a href="#snippet-2-4">Aggregation Pipeline</a></li>
              <li><a href="#snippet-2-5">Soft Delete ×¢× TTL</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-file-code"></i> × ×™×”×•×œ ×§×‘×¦×™× ×•×’×¨×¡××•×ª</h3>
            <ul class="toc-links">
              <li><a href="#snippet-3-1">×©××™×¨×ª ×§×•×‘×¥ ×¢× ×–×™×”×•×™ ×©×¤×”</a></li>
              <li><a href="#snippet-3-2">×©×œ×™×¤×ª ×’×¨×¡××•×ª</a></li>
              <li><a href="#snippet-3-3">×–×™×”×•×™ ×©×™× ×•×™×™× ×¢× Hash</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-globe"></i> ××™× ×˜×’×¨×¦×™×” ×¢× WebApp</h3>
            <ul class="toc-links">
              <li><a href="#snippet-4-1">×›×¤×ª×•×¨ WebApp</a></li>
              <li><a href="#snippet-4-2">×˜×•×§×Ÿ ×”×ª×—×‘×¨×•×ª</a></li>
              <li><a href="#snippet-4-3">××™××•×ª ×˜×•×§×Ÿ</a></li>
              <li><a href="#snippet-4-4">××ª×—×•×œ WebApp</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-paint-brush"></i> ×¨×›×™×‘×™ UI ×‘-WebApp</h3>
            <ul class="toc-links">
              <li><a href="#snippet-5-1">Modal Dialog</a></li>
              <li><a href="#snippet-5-2">Toast Notification</a></li>
              <li><a href="#snippet-5-3">Loading Overlay</a></li>
              <li><a href="#snippet-5-4">Expandable Card</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-clipboard-list"></i> Structured Logging</h3>
            <ul class="toc-links">
              <li><a href="#snippet-6-1">Emit Event ×¢× Request ID</a></li>
              <li><a href="#snippet-6-2">Binding Request ID</a></li>
              <li><a href="#snippet-6-3">Binding User Context</a></li>
              <li><a href="#snippet-6-4">×”×’×“×¨×ª Structlog</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-exclamation-triangle"></i> ×”×•×“×¢×•×ª ×©×’×™××”</h3>
            <ul class="toc-links">
              <li><a href="#snippet-7-1">Rate Limit Error Handler</a></li>
              <li><a href="#snippet-7-2">Database Error</a></li>
              <li><a href="#snippet-7-3">Validation Messages</a></li>
              <li><a href="#snippet-7-4">Batch Processing</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-vial"></i> ×‘×“×™×§×•×ª Pytest</h3>
            <ul class="toc-links">
              <li><a href="#snippet-8-1">Fixture ×¢× Setup/Teardown</a></li>
              <li><a href="#snippet-8-2">Test Parametrization</a></li>
              <li><a href="#snippet-8-3">Async Test</a></li>
              <li><a href="#snippet-8-4">Mocking ×¢× MagicMock</a></li>
              <li><a href="#snippet-8-5">Mocking ×¢× @patch</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-tools"></i> ×¤×•× ×§×¦×™×•×ª ×¢×–×¨</h3>
            <ul class="toc-links">
              <li><a href="#snippet-9-1">×–××Ÿ ×™×—×¡×™ ×‘×¢×‘×¨×™×ª</a></li>
              <li><a href="#snippet-9-2">××¡×§×™×™×¤ ×œ-Markdown</a></li>
              <li><a href="#snippet-9-3">× ×™×§×•×™ ×©××•×ª ×§×‘×¦×™×</a></li>
              <li><a href="#snippet-9-4">××¢× ×” ×‘×˜×•×— ×œ-CallbackQuery</a></li>
              <li><a href="#snippet-9-5">×¤×™×¦×•×œ ×”×•×“×¢×•×ª ××¨×•×›×•×ª</a></li>
              <li><a href="#snippet-9-6">×¢×¨×™×›×ª ×”×•×“×¢×” ×‘×˜×•×—×”</a></li>
              <li><a href="#snippet-9-7">×× ×™×¢×ª ×œ×—×™×¦×” ×›×¤×•×œ×”</a></li>
              <li><a href="#snippet-9-8">×¢×™×‘×•×“ ×¤×¨×™×˜×™× ×‘×§×‘×•×¦×•×ª</a></li>
              <li><a href="#snippet-9-9">××“×™×“×ª ×–××Ÿ</a></li>
              <li><a href="#snippet-9-10">×‘×“×™×§×ª ×§×•×“ ××¡×•×›×Ÿ</a></li>
              <li><a href="#snippet-9-11">×™×¦×™×¨×ª ×§×•×‘×¥ ×–×× ×™</a></li>
              <li><a href="#snippet-9-12">×˜×¢×™× ×ª ×§×•×‘×¥ JSON</a></li>
              <li><a href="#snippet-9-13">×§××© ×–×™×›×¨×•×Ÿ ×¢× TTL</a></li>
              <li><a href="#snippet-9-14">××¡× ×Ÿ ×œ×•×’×™× ×œ×¨×’×™×©×•×™×•×ª</a></li>
              <li><a href="#snippet-9-15">× ×™×¨××•×œ ××¨×’×•×× ×˜×™×</a></li>
              <li><a href="#snippet-9-16">×§×™×¦×•×¨ ×˜×§×¡×˜ ×‘×××¦×¢</a></li>
              <li><a href="#snippet-9-17">××¢×§×‘ ×‘×™×¦×•×¢×™× ×¢× Prometheus</a></li>
              <li><a href="#snippet-9-18">×”×¦×¢×ª ×”×©×œ××•×ª ×œ×—×™×¤×•×©</a></li>
              <li><a href="#snippet-9-19">×”×“×’×©×ª ×˜×•×•×—×™× ×‘×—×™×¤×•×©</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-tasks"></i> Background Jobs</h3>
            <ul class="toc-links">
              <li><a href="#snippet-10-1">RQ Job ×¢× Retry</a></li>
              <li><a href="#snippet-10-2">Enqueue or Run Inline</a></li>
              <li><a href="#snippet-10-3">RQ Scheduler â€“ Recurring Jobs</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-robot"></i> ×ª×‘× ×™×•×ª ×‘×•×˜ ×˜×œ×’×¨×</h3>
            <ul class="toc-links">
              <li><a href="#snippet-11-1">Maintenance Mode</a></li>
              <li><a href="#snippet-11-2">Callback Query Router</a></li>
              <li><a href="#snippet-11-3">Safe Send ×¢× Fallback</a></li>
              <li><a href="#snippet-11-4">Message Chunking</a></li>
              <li><a href="#snippet-11-5">User Mode Management</a></li>
              <li><a href="#snippet-11-6">Progress Bar Generation</a></li>
              <li><a href="#snippet-11-7">Multi-Step Form Flow</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-database"></i> Database Async</h3>
            <ul class="toc-links">
              <li><a href="#snippet-12-1">Async Session Manager</a></li>
              <li><a href="#snippet-12-2">Eager Loading</a></li>
              <li><a href="#snippet-12-3">Complex Filter</a></li>
              <li><a href="#snippet-12-4">Transaction Pattern</a></li>
              <li><a href="#snippet-12-5">Upsert Pattern</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-shield-alt"></i> Authentication</h3>
            <ul class="toc-links">
              <li><a href="#snippet-13-1">JWT Token Creation</a></li>
              <li><a href="#snippet-13-2">JWT Validation</a></li>
              <li><a href="#snippet-13-3">Role-Based Access</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-memory"></i> Redis & Caching</h3>
            <ul class="toc-links">
              <li><a href="#snippet-14-1">Distributed Lock</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-heartbeat"></i> Health Checks</h3>
            <ul class="toc-links">
              <li><a href="#snippet-15-1">Comprehensive Health Check</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-file-upload"></i> File Storage</h3>
            <ul class="toc-links">
              <li><a href="#snippet-16-1">File Validation</a></li>
            </ul>
          </div>
          <div class="toc-category">
            <h3><i class="fas fa-link"></i> Webhook Handling & Security</h3>
            <ul class="toc-links">
              <li><a href="#snippet-17-1">Webhook Signature Verification</a></li>
              <li><a href="#snippet-17-2">Webhook Retry Mechanism</a></li>
              <li><a href="#snippet-17-3">Webhook Health Monitoring</a></li>
            </ul>
          </div>

          <div class="toc-category">
            <h3><i class="fas fa-tachometer-alt"></i> Rate Limiting ××ª×§×“×</h3>
            <ul class="toc-links">
              <li><a href="#snippet-18-1">Token Bucket Algorithm</a></li>
              <li><a href="#snippet-18-2">Rate Limiting Per User/Chat</a></li>
              <li><a href="#snippet-18-3">Distributed Rate Limiting with Redis</a></li>
            </ul>
          </div>

          <div class="toc-category">
            <h3><i class="fas fa-redo"></i> Retry & Circuit Breaker Patterns</h3>
            <ul class="toc-links">
              <li><a href="#snippet-19-1">Exponential Backoff Retry</a></li>
              <li><a href="#snippet-19-2">Circuit Breaker Pattern</a></li>
              <li><a href="#snippet-19-3">Retry Decorator with Jitter</a></li>
            </ul>
          </div>

          <div class="toc-category">
            <h3><i class="fas fa-search"></i> Telegram Inline Queries</h3>
            <ul class="toc-links">
              <li><a href="#snippet-20-1">Inline Query Handler with Caching</a></li>
              <li><a href="#snippet-20-2">Inline Result Pagination</a></li>
              <li><a href="#snippet-20-3">Inline Query Rate Limiting</a></li>
            </ul>
          </div>

          <div class="toc-category">
            <h3><i class="fas fa-clock"></i> Message Scheduling & Delayed Tasks</h3>
            <ul class="toc-links">
              <li><a href="#snippet-21-1">Schedule Messages for Future</a></li>
              <li><a href="#snippet-21-2">Delayed Job Execution</a></li>
              <li><a href="#snippet-21-3">Recurring Tasks</a></li>
            </ul>
          </div>

          <div class="toc-category">
            <h3><i class="fas fa-database"></i> Database Migrations</h3>
            <ul class="toc-links">
              <li><a href="#snippet-22-1">Alembic Migration Patterns</a></li>
              <li><a href="#snippet-22-2">Data Migration Helpers</a></li>
              <li><a href="#snippet-22-3">Rollback Strategies</a></li>
            </ul>
          </div>

          <div class="toc-category">
            <h3><i class="fas fa-plug"></i> API Client Patterns</h3>
            <ul class="toc-links">
              <li><a href="#snippet-23-1">Async HTTP Client with Retry</a></li>
              <li><a href="#snippet-23-2">Request/Response Logging</a></li>
              <li><a href="#snippet-23-3">API Rate Limiting Compliance</a></li>
            </ul>
          </div>

          <div class="toc-category">
            <h3><i class="fas fa-magic"></i> Decorators ×©×™××•×©×™×™×</h3>
            <ul class="toc-links">
              <li><a href="#snippet-24-1">@retry, @timeout, @cache</a></li>
              <li><a href="#snippet-24-2">@require_auth, @admin_only</a></li>
              <li><a href="#snippet-24-3">@log_execution_time</a></li>
            </ul>
          </div>

          <div class="toc-category">
            <h3><i class="fas fa-credit-card"></i> Telegram Payments & Invoices</h3>
            <ul class="toc-links">
              <li><a href="#snippet-25-1">Payment Processing</a></li>
              <li><a href="#snippet-25-2">Invoice Generation</a></li>
              <li><a href="#snippet-25-3">Payment Verification</a></li>
            </ul>
          </div>

          <div class="toc-category">
            <h3><i class="fas fa-chart-line"></i> Monitoring & Metrics</h3>
            <ul class="toc-links">
              <li><a href="#snippet-26-1">Prometheus Metrics Collection</a></li>
              <li><a href="#snippet-26-2">Custom Metrics Helpers</a></li>
              <li><a href="#snippet-26-3">Performance Tracking Decorators</a></li>
            </ul>
          </div>

          <div class="toc-category">
            <h3><i class="fas fa-cog"></i> Environment & Secrets Management</h3>
            <ul class="toc-links">
              <li><a href="#snippet-27-1">.env Loading with Validation</a></li>
              <li><a href="#snippet-27-2">Secrets Rotation</a></li>
              <li><a href="#snippet-27-3">Multi-Environment Config</a></li>
            </ul>
          </div>

          <div class="toc-category">
            <h3><i class="fas fa-code"></i> Data Serialization & Validation</h3>
            <ul class="toc-links">
              <li><a href="#snippet-28-1">Pydantic Models for Data</a></li>
              <li><a href="#snippet-28-2">Custom Validators</a></li>
              <li><a href="#snippet-28-3">Serialization Helpers</a></li>
            </ul>
          </div>
        </div>
      </div>

      <!-- No results message -->
      <div class="no-results" id="noResults">
        <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5"></i>
        <h3>×œ× × ××¦××• ×ª×•×¦××•×ª</h3>
        <p>× ×¡×” ×œ×—×¤×© ×‘××™×œ×•×ª ××¤×ª×— ××—×¨×•×ª ××• ×‘×“×•×§ ××ª ×”××™×•×ª</p>
      </div>

      <!-- Category 1: ×ª×¤×¨×™×˜×™× ×‘×‘×•×˜ -->
      <div class="category" id="category-1">
        <div class="category-header">
          <i class="fas fa-robot"></i>
          <h2>×ª×¤×¨×™×˜×™× ×‘×‘×•×˜</h2>
        </div>

        <div class="snippet" id="snippet-1-1">
          <div class="snippet-header">
            <h3 class="snippet-title">1.1 ×ª×¤×¨×™×˜ ×¤×¢×•×œ×•×ª ×¢×œ ×§×•×‘×¥ (Multi-Row Grid)</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×™×¦×™×¨×ª ×ª×¤×¨×™×˜ ×¢× ××¡×¤×¨ ×©×•×¨×•×ª ×©×œ ×›×¤×ª×•×¨×™×, ×××•×¨×’× ×™× ×œ×¤×™ ×¤×•× ×§×¦×™×•× ×œ×™×•×ª.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">from</span> telegram <span class="token keyword">import</span> InlineKeyboardButton<span class="token punctuation">,</span> InlineKeyboardMarkup

<span class="token comment"># ×™×¦×™×¨×ª ×ª×¤×¨×™×˜ ×¢× ×›×¤×ª×•×¨×™× ××¨×•×‘×™×</span>
buttons <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span>
        InlineKeyboardButton<span class="token punctuation">(</span><span class="token string">"ğŸ—‘ï¸ ××—×™×§×”"</span><span class="token punctuation">,</span> callback_data<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"delete_</span><span class="token interpolation"><span class="token punctuation">{</span>file_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        InlineKeyboardButton<span class="token punctuation">(</span><span class="token string">"âœï¸ ×¢×¨×™×›×”"</span><span class="token punctuation">,</span> callback_data<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"edit_</span><span class="token interpolation"><span class="token punctuation">{</span>file_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
        InlineKeyboardButton<span class="token punctuation">(</span><span class="token string">"ğŸ“ ×¢×¨×•×š ×”×¢×¨×”"</span><span class="token punctuation">,</span> callback_data<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"edit_note_</span><span class="token interpolation"><span class="token punctuation">{</span>file_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        InlineKeyboardButton<span class="token punctuation">(</span><span class="token string">"ğŸ’¾ ×”×•×¨×“×”"</span><span class="token punctuation">,</span> callback_data<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"download_</span><span class="token interpolation"><span class="token punctuation">{</span>file_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
        InlineKeyboardButton<span class="token punctuation">(</span><span class="token string">"ğŸŒ ×©×™×ª×•×£"</span><span class="token punctuation">,</span> callback_data<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"share_</span><span class="token interpolation"><span class="token punctuation">{</span>file_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
        InlineKeyboardButton<span class="token punctuation">(</span>fav_text<span class="token punctuation">,</span> callback_data<span class="token operator">=</span>fav_cb<span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">]</span>
reply_markup <span class="token operator">=</span> InlineKeyboardMarkup<span class="token punctuation">(</span>buttons<span class="token punctuation">)</span>
<span class="token keyword">await</span> update<span class="token punctuation">.</span>message<span class="token punctuation">.</span>reply_text<span class="token punctuation">(</span>
    response_text<span class="token punctuation">,</span>
    parse_mode<span class="token operator">=</span><span class="token string">'HTML'</span><span class="token punctuation">,</span>
    reply_markup<span class="token operator">=</span>reply_markup
<span class="token punctuation">)</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-1-2">
          <div class="snippet-header">
            <h3 class="snippet-title">1.2 ×ª×™×‘×ª ××™×©×•×¨ ×¢× ×›×¤×ª×•×¨×™× (Yes/No Dialog)</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×“×™××œ×•×’ ××™×©×•×¨ ×¤×©×•×˜ ×œ×¤× ×™ ×‘×™×¦×•×¢ ×¤×¢×•×œ×” ×§×¨×™×˜×™×ª.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">from</span> telegram <span class="token keyword">import</span> InlineKeyboardButton<span class="token punctuation">,</span> InlineKeyboardMarkup
<span class="token keyword">from</span> telegram<span class="token punctuation">.</span>constants <span class="token keyword">import</span> ParseMode

keyboard <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span>
        InlineKeyboardButton<span class="token punctuation">(</span><span class="token string">"âœ… ×›×Ÿ, ××—×§"</span><span class="token punctuation">,</span> callback_data<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"confirm_delete_</span><span class="token interpolation"><span class="token punctuation">{</span>file_name<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        InlineKeyboardButton<span class="token punctuation">(</span><span class="token string">"âŒ ×‘×™×˜×•×œ"</span><span class="token punctuation">,</span> callback_data<span class="token operator">=</span><span class="token string">"cancel_delete"</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">]</span>
reply_markup <span class="token operator">=</span> InlineKeyboardMarkup<span class="token punctuation">(</span>keyboard<span class="token punctuation">)</span>

<span class="token keyword">await</span> update<span class="token punctuation">.</span>message<span class="token punctuation">.</span>reply_text<span class="token punctuation">(</span>
    <span class="token string-interpolation"><span class="token string">f"ğŸ—‘ï¸ **××™×©×•×¨ ××—×™×§×”**\n\n"</span></span>
    <span class="token string-interpolation"><span class="token string">f"×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª `</span><span class="token interpolation"><span class="token punctuation">{</span>file_name<span class="token punctuation">}</span></span><span class="token string">`?"</span></span><span class="token punctuation">,</span>
    parse_mode<span class="token operator">=</span>ParseMode<span class="token punctuation">.</span>MARKDOWN<span class="token punctuation">,</span>
    reply_markup<span class="token operator">=</span>reply_markup
<span class="token punctuation">)</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-1-3">
          <div class="snippet-header">
            <h3 class="snippet-title">1.3 Callback Query Handler - × ×™×ª×•×‘ ×œ×¤×™ ×“×¤×•×¡</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×˜×™×¤×•×œ ××¨×•×›×– ×‘×›×œ ×œ×—×™×¦×•×ª ×”×›×¤×ª×•×¨×™×, ×¢× × ×™×ª×•×‘ ×œ×¤×™ prefix.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">handle_callback_query</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> update<span class="token punctuation">:</span> Update<span class="token punctuation">,</span> context<span class="token punctuation">:</span> ContextTypes<span class="token punctuation">.</span>DEFAULT_TYPE<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""×˜×™×¤×•×œ ×‘×œ×—×™×¦×•×ª ×¢×œ ×›×¤×ª×•×¨×™×"""</span>
    query <span class="token operator">=</span> update<span class="token punctuation">.</span>callback_query
    <span class="token keyword">await</span> query<span class="token punctuation">.</span>answer<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># ×—×©×•×‘! ×××©×¨ ×§×‘×œ×ª ×”×œ×—×™×¦×”</span>

    data <span class="token operator">=</span> query<span class="token punctuation">.</span>data
    user_id <span class="token operator">=</span> query<span class="token punctuation">.</span>from_user<span class="token punctuation">.</span><span class="token builtin">id</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> data<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"confirm_delete_"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            file_name <span class="token operator">=</span> data<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"confirm_delete_"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> db<span class="token punctuation">.</span>delete_file<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> file_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">await</span> query<span class="token punctuation">.</span>edit_message_text<span class="token punctuation">(</span>
                    <span class="token string-interpolation"><span class="token string">f"âœ… ×”×§×•×‘×¥ `</span><span class="token interpolation"><span class="token punctuation">{</span>file_name<span class="token punctuation">}</span></span><span class="token string">` × ××—×§ ×‘×”×¦×œ×—×”!"</span></span><span class="token punctuation">,</span>
                    parse_mode<span class="token operator">=</span>ParseMode<span class="token punctuation">.</span>MARKDOWN
                <span class="token punctuation">)</span>

        <span class="token keyword">elif</span> data <span class="token operator">==</span> <span class="token string">"cancel_delete"</span><span class="token punctuation">:</span>
            <span class="token keyword">await</span> query<span class="token punctuation">.</span>edit_message_text<span class="token punctuation">(</span><span class="token string">"âŒ ××—×™×§×” ×‘×•×˜×œ×”."</span><span class="token punctuation">)</span>

        <span class="token keyword">elif</span> data<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"share_gist_"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            file_name <span class="token operator">=</span> data<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"share_gist_"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
            <span class="token keyword">await</span> self<span class="token punctuation">.</span>_share_to_gist<span class="token punctuation">(</span>query<span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> file_name<span class="token punctuation">)</span>

        <span class="token comment"># ... more handlers</span>

    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error handling callback: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> query<span class="token punctuation">.</span>edit_message_text<span class="token punctuation">(</span><span class="token string">"âš ï¸ ××™×¨×¢×” ×©×’×™××”"</span><span class="token punctuation">)</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-1-4">
          <div class="snippet-header">
            <h3 class="snippet-title">1.4 Pagination Helper - ×›×¤×ª×•×¨×™ ×”×§×•×“×/×”×‘×</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×¤×•× ×§×¦×™×” ×©×™××•×©×™×ª ×œ×‘× ×™×™×ª ×›×¤×ª×•×¨×™ × ×™×•×•×˜ ×‘×¢××•×“×™×.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">from</span> telegram <span class="token keyword">import</span> InlineKeyboardButton
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Optional<span class="token punctuation">,</span> List

<span class="token keyword">def</span> <span class="token function">build_pagination_row</span><span class="token punctuation">(</span>
    page<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    total_items<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    page_size<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    callback_prefix<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">[</span>List<span class="token punctuation">[</span>InlineKeyboardButton<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""×‘×•× ×” ×©×•×¨×ª ×›×¤×ª×•×¨×™ pagination ××• None ×× ××™×Ÿ ×¦×•×¨×š."""</span>
    <span class="token keyword">if</span> page_size <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>

    total_pages <span class="token operator">=</span> <span class="token punctuation">(</span>total_items <span class="token operator">+</span> page_size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">//</span> page_size <span class="token keyword">if</span> total_items <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">1</span>
    <span class="token keyword">if</span> total_pages <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>

    row<span class="token punctuation">:</span> List<span class="token punctuation">[</span>InlineKeyboardButton<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">if</span> page <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span>
        row<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
            InlineKeyboardButton<span class="token punctuation">(</span><span class="token string">"â¬…ï¸ ×”×§×•×“×"</span><span class="token punctuation">,</span> callback_data<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>callback_prefix<span class="token punctuation">}</span></span><span class="token interpolation"><span class="token punctuation">{</span>page<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">if</span> page <span class="token operator">&lt;</span> total_pages<span class="token punctuation">:</span>
        row<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
            InlineKeyboardButton<span class="token punctuation">(</span><span class="token string">"â¡ï¸ ×”×‘×"</span><span class="token punctuation">,</span> callback_data<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>callback_prefix<span class="token punctuation">}</span></span><span class="token interpolation"><span class="token punctuation">{</span>page<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">return</span> row <span class="token keyword">or</span> <span class="token boolean">None</span></code></pre>
          </div>
        </div>
      </div>

      <!-- Category 2: ×¢×‘×•×“×” ×¢× ××¡×“ × ×ª×•× ×™× -->
      <div class="category" id="category-2">
        <div class="category-header">
          <i class="fas fa-database"></i>
          <h2>×¢×‘×•×“×” ×¢× ××¡×“ × ×ª×•× ×™×</h2>
        </div>

        <div class="snippet" id="snippet-2-1">
          <div class="snippet-header">
            <h3 class="snippet-title">2.1 ×©××™×¨×ª ××¡××š ×¢× Versioning</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×©××™×¨×” ×¢× × ×™×”×•×œ ×’×¨×¡××•×ª ××•×˜×•××˜×™ + ×‘×™×˜×•×œ cache.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timezone
<span class="token keyword">from</span> dataclasses <span class="token keyword">import</span> asdict

<span class="token keyword">def</span> <span class="token function">save_code_snippet</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> snippet<span class="token punctuation">:</span> CodeSnippet<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># × ×¨××•×œ ×§×•×“ ×œ×¤× ×™ ×©××™×¨×”</span>
        <span class="token keyword">if</span> config<span class="token punctuation">.</span>NORMALIZE_CODE_ON_SAVE<span class="token punctuation">:</span>
            snippet<span class="token punctuation">.</span>code <span class="token operator">=</span> normalize_code<span class="token punctuation">(</span>snippet<span class="token punctuation">.</span>code<span class="token punctuation">)</span>

        <span class="token comment"># ×‘×“×™×§×ª ×’×¨×¡×” ×§×™×™××ª</span>
        existing <span class="token operator">=</span> self<span class="token punctuation">.</span>get_latest_version<span class="token punctuation">(</span>snippet<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span> snippet<span class="token punctuation">.</span>file_name<span class="token punctuation">)</span>
        <span class="token keyword">if</span> existing<span class="token punctuation">:</span>
            snippet<span class="token punctuation">.</span>version <span class="token operator">=</span> existing<span class="token punctuation">[</span><span class="token string">'version'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span>

        snippet<span class="token punctuation">.</span>updated_at <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span>timezone<span class="token punctuation">.</span>utc<span class="token punctuation">)</span>

        <span class="token comment"># ×©××™×¨×” ×‘××¡×“ ×”× ×ª×•× ×™×</span>
        result <span class="token operator">=</span> self<span class="token punctuation">.</span>manager<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>insert_one<span class="token punctuation">(</span>asdict<span class="token punctuation">(</span>snippet<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> result<span class="token punctuation">.</span>inserted_id<span class="token punctuation">:</span>
            <span class="token comment"># ×‘×™×˜×•×œ cache ×œ××©×ª××©</span>
            cache<span class="token punctuation">.</span>invalidate_user_cache<span class="token punctuation">(</span>snippet<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>

        <span class="token keyword">return</span> <span class="token boolean">False</span>

    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error saving snippet: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-2-2">
          <div class="snippet-header">
            <h3 class="snippet-title">2.2 ×©×œ×™×¤×ª ××¡××š ××—×“ ×¢× ××˜××•×Ÿ (Cached Query)</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×©×œ×™×¤×” ××”×™×¨×” ×¢× caching ××•×˜×•××˜×™ ×œ××©×š 3 ×“×§×•×ª.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Optional<span class="token punctuation">,</span> Dict

<span class="token decorator annotation punctuation">@cached</span><span class="token punctuation">(</span>expire_seconds<span class="token operator">=</span><span class="token number">180</span><span class="token punctuation">,</span> key_prefix<span class="token operator">=</span><span class="token string">"latest_version"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">get_latest_version</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> file_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># Fast-path ×œ×¡×‘×™×‘×•×ª ×‘×“×™×§×”</span>
        docs_list <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>manager<span class="token punctuation">.</span>collection<span class="token punctuation">,</span> <span class="token string">'docs'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>docs_list<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            candidates <span class="token operator">=</span> <span class="token punctuation">[</span>
                d <span class="token keyword">for</span> d <span class="token keyword">in</span> docs_list
                <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span>
                <span class="token keyword">and</span> d<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'user_id'</span><span class="token punctuation">)</span> <span class="token operator">==</span> user_id
                <span class="token keyword">and</span> d<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'file_name'</span><span class="token punctuation">)</span> <span class="token operator">==</span> file_name
            <span class="token punctuation">]</span>
            <span class="token keyword">if</span> candidates<span class="token punctuation">:</span>
                latest <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>candidates<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> d<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'version'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>latest<span class="token punctuation">)</span>

        <span class="token comment"># ×©×œ×™×¤×” ××”-DB ×¢× ×¡×™× ×•×Ÿ ×•×¡×™×“×•×¨</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>manager<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>find_one<span class="token punctuation">(</span>
            <span class="token punctuation">{</span>
                <span class="token string">"user_id"</span><span class="token punctuation">:</span> user_id<span class="token punctuation">,</span>
                <span class="token string">"file_name"</span><span class="token punctuation">:</span> file_name<span class="token punctuation">,</span>
                <span class="token string">"$or"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                    <span class="token punctuation">{</span><span class="token string">"is_active"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token punctuation">{</span><span class="token string">"is_active"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"$exists"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
                <span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            sort<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">"version"</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error fetching latest version: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-2-3">
          <div class="snippet-header">
            <h3 class="snippet-title">2.3 Update ×¢× Upsert ×•×˜×™×¤×•×œ ×‘×©×“×•×ª ××•×ª× ×™×</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×¢×“×›×•×Ÿ ××• ×™×¦×™×¨×” (upsert) ×¢× ×”×’×“×¨×ª ×©×“×•×ª ×©×•× ×™× ×œ×™×¦×™×¨×” ××•×œ ×¢×“×›×•×Ÿ.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timezone

<span class="token keyword">def</span> <span class="token function">save_github_token</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> token<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># ×”×¦×¤× ×ª ×”×˜×•×§×Ÿ</span>
        <span class="token keyword">from</span> secret_manager <span class="token keyword">import</span> encrypt_secret
        enc <span class="token operator">=</span> encrypt_secret<span class="token punctuation">(</span>token<span class="token punctuation">)</span>
        stored <span class="token operator">=</span> enc <span class="token keyword">if</span> enc <span class="token keyword">else</span> token

        users_collection <span class="token operator">=</span> self<span class="token punctuation">.</span>manager<span class="token punctuation">.</span>db<span class="token punctuation">.</span>users

        result <span class="token operator">=</span> users_collection<span class="token punctuation">.</span>update_one<span class="token punctuation">(</span>
            <span class="token punctuation">{</span><span class="token string">"user_id"</span><span class="token punctuation">:</span> user_id<span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token string">"$set"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    <span class="token string">"github_token"</span><span class="token punctuation">:</span> stored<span class="token punctuation">,</span>
                    <span class="token string">"updated_at"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span>timezone<span class="token punctuation">.</span>utc<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string">"$setOnInsert"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    <span class="token string">"created_at"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span>timezone<span class="token punctuation">.</span>utc<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            upsert<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>  <span class="token comment"># ×™×¦×™×¨×” ×× ×œ× ×§×™×™×</span>
        <span class="token punctuation">)</span>

        <span class="token keyword">return</span> <span class="token builtin">bool</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>acknowledged<span class="token punctuation">)</span>

    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error saving token: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-2-4">
          <div class="snippet-header">
            <h3 class="snippet-title">2.4 Aggregation Pipeline - ×©××™×œ×ª× ××•×¨×›×‘×ª</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×©××™×œ×ª×•×ª ××ª×§×“××•×ª ×¢× grouping, sorting ×•-projection.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_latest_files_aggregated</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> limit<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""××—×–×™×¨ ××ª ×”×’×¨×¡×” ×”××—×¨×•× ×” ×©×œ ×›×œ ×§×•×‘×¥"""</span>

    <span class="token keyword">match</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"user_id"</span><span class="token punctuation">:</span> user_id<span class="token punctuation">,</span> <span class="token string">"is_active"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>
    sort_key <span class="token operator">=</span> <span class="token string">"updated_at"</span>
    sort_dir <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>  <span class="token comment"># DESC</span>

    pipeline <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token string">"$match"</span><span class="token punctuation">:</span> <span class="token keyword">match</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment"># ×¡×™× ×•×Ÿ</span>
        <span class="token punctuation">{</span><span class="token string">"$sort"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"file_name"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"version"</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment"># ××™×•×Ÿ</span>
        <span class="token punctuation">{</span><span class="token string">"$group"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>  <span class="token comment"># ×§×™×‘×•×¥ ×œ×¤×™ ×©× ×§×•×‘×¥</span>
            <span class="token string">"_id"</span><span class="token punctuation">:</span> <span class="token string">"$file_name"</span><span class="token punctuation">,</span>
            <span class="token string">"latest"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"$first"</span><span class="token punctuation">:</span> <span class="token string">"$$ROOT"</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"$replaceRoot"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"newRoot"</span><span class="token punctuation">:</span> <span class="token string">"$latest"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment"># ×”×—×œ×¤×ª root</span>
        <span class="token punctuation">{</span><span class="token string">"$sort"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>sort_key<span class="token punctuation">:</span> sort_dir<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment"># ××™×•×Ÿ ×¡×•×¤×™</span>
        <span class="token punctuation">{</span><span class="token string">"$limit"</span><span class="token punctuation">:</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>limit <span class="token keyword">or</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment"># ×”×’×‘×œ×ª ×ª×•×¦××•×ª</span>
        <span class="token punctuation">{</span><span class="token string">"$project"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>  <span class="token comment"># ×‘×—×™×¨×ª ×©×“×•×ª</span>
            <span class="token string">"_id"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token string">"file_name"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token string">"programming_language"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token string">"updated_at"</span><span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>

    rows <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>manager<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>aggregate<span class="token punctuation">(</span>pipeline<span class="token punctuation">,</span> allowDiskUse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> rows</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-2-5">
          <div class="snippet-header">
            <h3 class="snippet-title">2.5 Soft Delete ×¢× TTL (Recycle Bin)</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××—×™×§×” ×¨×›×” ×¢× ××¤×©×¨×•×ª ×©×—×–×•×¨, ×•××—×™×§×” ×¡×•×¤×™×ª ××•×˜×•××˜×™×ª ×œ××—×¨ 7 ×™××™×.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timezone<span class="token punctuation">,</span> timedelta

<span class="token keyword">def</span> <span class="token function">delete_file</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> file_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""××—×™×§×” ×¨×›×” - ××¡××Ÿ ×›×œ× ×¤×¢×™×œ ×‘××§×•× ×œ××—×•×§"""</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        now <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span>timezone<span class="token punctuation">.</span>utc<span class="token punctuation">)</span>
        ttl_days <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">getattr</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token string">'RECYCLE_TTL_DAYS'</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token number">7</span><span class="token punctuation">)</span>
        expires <span class="token operator">=</span> now <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> ttl_days<span class="token punctuation">)</span><span class="token punctuation">)</span>

        result <span class="token operator">=</span> self<span class="token punctuation">.</span>manager<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>update_many<span class="token punctuation">(</span>
            <span class="token punctuation">{</span>
                <span class="token string">"user_id"</span><span class="token punctuation">:</span> user_id<span class="token punctuation">,</span>
                <span class="token string">"file_name"</span><span class="token punctuation">:</span> file_name<span class="token punctuation">,</span>
                <span class="token string">"$or"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                    <span class="token punctuation">{</span><span class="token string">"is_active"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token punctuation">{</span><span class="token string">"is_active"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"$exists"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
                <span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token string">"$set"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    <span class="token string">"is_active"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
                    <span class="token string">"updated_at"</span><span class="token punctuation">:</span> now<span class="token punctuation">,</span>
                    <span class="token string">"deleted_at"</span><span class="token punctuation">:</span> now<span class="token punctuation">,</span>
                    <span class="token string">"deleted_expires_at"</span><span class="token punctuation">:</span> expires<span class="token punctuation">,</span>  <span class="token comment"># TTL field</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

        <span class="token keyword">if</span> result<span class="token punctuation">.</span>modified_count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            cache<span class="token punctuation">.</span>invalidate_user_cache<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>

        <span class="token keyword">return</span> <span class="token boolean">False</span>

    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error deleting file: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span></code></pre>
          </div>
        </div>
      </div>

      <!-- Category 3: × ×™×”×•×œ ×§×‘×¦×™× ×•×’×¨×¡××•×ª -->
      <div class="category" id="category-3">
        <div class="category-header">
          <i class="fas fa-file-code"></i>
          <h2>× ×™×”×•×œ ×§×‘×¦×™× ×•×’×¨×¡××•×ª</h2>
        </div>

        <div class="snippet" id="snippet-3-1">
          <div class="snippet-header">
            <h3 class="snippet-title">3.1 ×©××™×¨×ª ×§×•×‘×¥ ×¢× ×–×™×”×•×™ ×©×¤×” ××•×˜×•××˜×™</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×–×¨×™××” ××œ××” ×©×œ ×©××™×¨×ª ×§×•×‘×¥ - × ×¨××•×œ, ×–×™×”×•×™ ×©×¤×”, ×©××™×¨×” + ×”×—×–×¨×ª ID.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">from</span> database <span class="token keyword">import</span> db<span class="token punctuation">,</span> CodeSnippet
<span class="token keyword">from</span> services<span class="token punctuation">.</span>code_service <span class="token keyword">import</span> detect_language<span class="token punctuation">,</span> normalize_code

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">save_file_final</span><span class="token punctuation">(</span>update<span class="token punctuation">,</span> context<span class="token punctuation">,</span> filename<span class="token punctuation">,</span> user_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""×©×•××¨ ×§×•×‘×¥ ×¢× metadata ××œ×"""</span>

    code <span class="token operator">=</span> context<span class="token punctuation">.</span>user_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'code_to_save'</span><span class="token punctuation">)</span>

    <span class="token comment"># × ×¨××•×œ ×§×•×“</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        code <span class="token operator">=</span> normalize_code<span class="token punctuation">(</span>code<span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
        <span class="token keyword">pass</span>

    <span class="token comment"># ×–×™×”×•×™ ×©×¤×ª ×ª×›× ×•×ª</span>
    detected_language <span class="token operator">=</span> detect_language<span class="token punctuation">(</span>code<span class="token punctuation">,</span> filename<span class="token punctuation">)</span>

    <span class="token comment"># ×”×¢×¨×” ××•×¤×¦×™×•× ×œ×™×ª</span>
    note <span class="token operator">=</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>user_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'note_to_save'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># ×™×¦×™×¨×ª snippet</span>
    snippet <span class="token operator">=</span> CodeSnippet<span class="token punctuation">(</span>
        user_id<span class="token operator">=</span>user_id<span class="token punctuation">,</span>
        file_name<span class="token operator">=</span>filename<span class="token punctuation">,</span>
        code<span class="token operator">=</span>code<span class="token punctuation">,</span>
        programming_language<span class="token operator">=</span>detected_language<span class="token punctuation">,</span>
        description<span class="token operator">=</span>note<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token comment"># ×©××™×¨×”</span>
    success <span class="token operator">=</span> db<span class="token punctuation">.</span>save_code_snippet<span class="token punctuation">(</span>snippet<span class="token punctuation">)</span>

    <span class="token keyword">if</span> success<span class="token punctuation">:</span>
        <span class="token comment"># ×©×œ×™×¤×ª ×”××¡××š ×”×©××•×¨ ×œ×§×‘×œ×ª ID</span>
        saved_doc <span class="token operator">=</span> db<span class="token punctuation">.</span>get_latest_version<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> filename<span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        file_id <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>saved_doc<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'_id'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">''</span><span class="token punctuation">)</span>

        <span class="token comment"># ×©××™×¨×” ×‘×”×§×©×¨ ×œ×©×™××•×© ×¢×ª×™×“×™</span>
        context<span class="token punctuation">.</span>user_data<span class="token punctuation">[</span><span class="token string">"last_save_success"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">"file_name"</span><span class="token punctuation">:</span> filename<span class="token punctuation">,</span>
            <span class="token string">"language"</span><span class="token punctuation">:</span> detected_language<span class="token punctuation">,</span>
            <span class="token string">"file_id"</span><span class="token punctuation">:</span> file_id<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">await</span> update<span class="token punctuation">.</span>message<span class="token punctuation">.</span>reply_text<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"âœ… ×”×§×•×‘×¥ `</span><span class="token interpolation"><span class="token punctuation">{</span>filename<span class="token punctuation">}</span></span><span class="token string">` × ×©××¨ ×‘×”×¦×œ×—×”!"</span></span><span class="token punctuation">)</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-3-2">
          <div class="snippet-header">
            <h3 class="snippet-title">3.2 ×©×œ×™×¤×ª ×’×¨×¡××•×ª - Latest / All / Specific</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×××©×§ ×¤×©×•×˜ ×œ× ×™×”×•×œ ×’×¨×¡××•×ª ×©×œ ×§×‘×¦×™×.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_latest_version</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> file_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""××—×–×™×¨ ××ª ×”×’×¨×¡×” ×”××—×¨×•× ×” ×©×œ ×§×•×‘×¥"""</span>
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>_get_repo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_latest_version<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> file_name<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">get_all_versions</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> file_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""××—×–×™×¨ ××ª ×›×œ ×”×’×¨×¡××•×ª ×©×œ ×§×•×‘×¥"""</span>
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>_get_repo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_all_versions<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> file_name<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">get_version</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> file_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> version<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""××—×–×™×¨ ×’×¨×¡×” ×¡×¤×¦×™×¤×™×ª"""</span>
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>_get_repo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_version<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> file_name<span class="token punctuation">,</span> version<span class="token punctuation">)</span>

<span class="token comment"># ×©×™××•×©:</span>
<span class="token comment"># latest = db.get_latest_version(123, "main.py")</span>
<span class="token comment"># all_versions = db.get_all_versions(123, "main.py")</span>
<span class="token comment"># v2 = db.get_version(123, "main.py", 2)</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-3-3">
          <div class="snippet-header">
            <h3 class="snippet-title">3.3 ×–×™×”×•×™ ×©×™× ×•×™×™× ×‘×§×•×‘×¥ ×¢× Hash</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×–×™×”×•×™ ×× ×§×•×‘×¥ ×”×©×ª× ×” ×œ×œ× ×¦×•×¨×š ×‘×”×©×•×•××ª ×ª×•×›×Ÿ ××œ×.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">import</span> hashlib
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timezone

<span class="token keyword">def</span> <span class="token function">check_file_sync</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> file_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> new_content<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""×‘×•×“×§ ×× ×”×§×•×‘×¥ ×”×©×ª× ×” ×××– ×”×©××™×¨×” ×”××—×¨×•× ×”"""</span>

    <span class="token comment"># ×—×™×©×•×‘ hash ×—×“×©</span>
    new_hash <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha256<span class="token punctuation">(</span>new_content<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># ×©×œ×™×¤×ª hash ×™×©×Ÿ</span>
    file_doc <span class="token operator">=</span> self<span class="token punctuation">.</span>files_collection<span class="token punctuation">.</span>find_one<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"_id"</span><span class="token punctuation">:</span> ObjectId<span class="token punctuation">(</span>file_id<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    old_hash <span class="token operator">=</span> file_doc<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"content_hash"</span><span class="token punctuation">)</span> <span class="token keyword">if</span> file_doc <span class="token keyword">else</span> <span class="token boolean">None</span>

    <span class="token comment"># ×”×©×•×•××”</span>
    <span class="token keyword">if</span> old_hash <span class="token operator">==</span> new_hash<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"changed"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">"affected"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span>

    <span class="token comment"># × ×™×ª×•×— ×”×©×¤×¢×” ×¢×œ ×¨×©×•××•×ª ×ª×œ×•×™×•×ª (×œ××©×œ ×¡×™×× ×™×•×ª)</span>
    old_lines <span class="token operator">=</span> file_doc<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>splitlines<span class="token punctuation">(</span><span class="token punctuation">)</span>
    new_lines <span class="token operator">=</span> new_content<span class="token punctuation">.</span>splitlines<span class="token punctuation">(</span><span class="token punctuation">)</span>
    affected <span class="token operator">=</span> self<span class="token punctuation">.</span>_analyze_bookmark_changes<span class="token punctuation">(</span>file_id<span class="token punctuation">,</span> old_lines<span class="token punctuation">,</span> new_lines<span class="token punctuation">)</span>

    <span class="token comment"># ×¢×“×›×•×Ÿ hash</span>
    self<span class="token punctuation">.</span>files_collection<span class="token punctuation">.</span>update_one<span class="token punctuation">(</span>
        <span class="token punctuation">{</span><span class="token string">"_id"</span><span class="token punctuation">:</span> ObjectId<span class="token punctuation">(</span>file_id<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"$set"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"content_hash"</span><span class="token punctuation">:</span> new_hash<span class="token punctuation">,</span>
            <span class="token string">"code"</span><span class="token punctuation">:</span> new_content<span class="token punctuation">,</span>
            <span class="token string">"last_sync"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span>timezone<span class="token punctuation">.</span>utc<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token string">"changed"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
        <span class="token string">"old_hash"</span><span class="token punctuation">:</span> old_hash<span class="token punctuation">,</span>
        <span class="token string">"new_hash"</span><span class="token punctuation">:</span> new_hash<span class="token punctuation">,</span>
        <span class="token string">"affected"</span><span class="token punctuation">:</span> affected
    <span class="token punctuation">}</span></code></pre>
          </div>
        </div>
      </div>

      <!-- Category 4: ××™× ×˜×’×¨×¦×™×” ×¢× WebApp -->
      <div class="category" id="category-4">
        <div class="category-header">
          <i class="fas fa-globe"></i>
          <h2>××™× ×˜×’×¨×¦×™×” ×¢× WebApp</h2>
        </div>

        <div class="snippet" id="snippet-4-1">
          <div class="snippet-header">
            <h3 class="snippet-title">4.1 ×™×¦×™×¨×ª ×›×¤×ª×•×¨ WebApp ×¢× ×§×™×©×•×¨ ×œ×§×•×‘×¥</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×¤×ª×™×—×ª WebApp ×™×©×™×¨×•×ª ×œ×§×•×‘×¥ ×¡×¤×¦×™×¤×™ ××• ×ª×•×¦××•×ª ×—×™×¤×•×©.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">from</span> telegram <span class="token keyword">import</span> InlineKeyboardButton
<span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> quote_plus
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Optional<span class="token punctuation">,</span> List

<span class="token keyword">def</span> <span class="token function">_get_webapp_button_row</span><span class="token punctuation">(</span>
    file_id<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    file_name<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">[</span>List<span class="token punctuation">[</span>InlineKeyboardButton<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""×‘×•× ×” ×›×¤×ª×•×¨ WebApp ×¢× ×§×™×©×•×¨ ×œ×§×•×‘×¥"""</span>

    base_url <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">'WEBAPP_URL'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> config<span class="token punctuation">.</span>WEBAPP_URL
    <span class="token keyword">if</span> <span class="token keyword">not</span> base_url<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>

    <span class="token comment"># ×§×™×©×•×¨ ×™×©×™×¨ ×œ×§×•×‘×¥ ×œ×¤×™ ID</span>
    <span class="token keyword">if</span> file_id<span class="token punctuation">:</span>
        target_url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>base_url<span class="token punctuation">}</span></span><span class="token string">/file/</span><span class="token interpolation"><span class="token punctuation">{</span>file_id<span class="token punctuation">}</span></span><span class="token string">"</span></span>

    <span class="token comment"># ××• ×§×™×©×•×¨ ×œ×—×™×¤×•×© ×œ×¤×™ ×©×</span>
    <span class="token keyword">elif</span> file_name<span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            query <span class="token operator">=</span> quote_plus<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
            query <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>
        target_url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>base_url<span class="token punctuation">}</span></span><span class="token string">/files?q=</span><span class="token interpolation"><span class="token punctuation">{</span>query<span class="token punctuation">}</span></span><span class="token string">#results"</span></span>

    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>

    <span class="token keyword">return</span> <span class="token punctuation">[</span>InlineKeyboardButton<span class="token punctuation">(</span><span class="token string">"ğŸŒ ×¦×¤×™×™×” ×‘WebApp"</span><span class="token punctuation">,</span> url<span class="token operator">=</span>target_url<span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token comment"># ×©×™××•×©:</span>
<span class="token comment"># webapp_row = _get_webapp_button_row(file_id_str, file_name)</span>
<span class="token comment"># if webapp_row:</span>
<span class="token comment">#     buttons.append(webapp_row)</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-4-2">
          <div class="snippet-header">
            <h3 class="snippet-title">4.2 ×™×¦×™×¨×ª ×˜×•×§×Ÿ ×”×ª×—×‘×¨×•×ª ×œ-WebApp</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×™×¦×™×¨×ª ×˜×•×§×Ÿ ×××•×‘×˜×— ×œ×›× ×™×¡×” ×œ-WebApp ××”×‘×•×˜.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">import</span> hashlib
<span class="token keyword">import</span> time
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timezone<span class="token punctuation">,</span> timedelta
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Optional<span class="token punctuation">,</span> Dict

<span class="token keyword">def</span> <span class="token function">_build_webapp_login_payload</span><span class="token punctuation">(</span>
    db_manager<span class="token punctuation">,</span>
    user_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    username<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""×™×•×¦×¨ ×˜×•×§×Ÿ ×”×ª×—×‘×¨×•×ª ×××•×‘×˜×— ×œ-WebApp"""</span>

    base_url <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"WEBAPP_URL"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> config<span class="token punctuation">.</span>WEBAPP_URL
    secret <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"WEBAPP_LOGIN_SECRET"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> config<span class="token punctuation">.</span>SECRET_KEY <span class="token keyword">or</span> <span class="token string">"dev-secret-key"</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># ×™×¦×™×¨×ª ×˜×•×§×Ÿ ×××•×‘×˜×—</span>
        token_data <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>user_id<span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">int</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{</span>secret<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        auth_token <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha256<span class="token punctuation">(</span>token_data<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">32</span><span class="token punctuation">]</span>
    <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>exception<span class="token punctuation">(</span><span class="token string">"×™×¦×™×¨×ª ×˜×•×§×Ÿ webapp × ×›×©×œ×”"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>

    <span class="token comment"># ×©××™×¨×ª ×”×˜×•×§×Ÿ ×‘-DB</span>
    now_utc <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span>timezone<span class="token punctuation">.</span>utc<span class="token punctuation">)</span>
    token_doc <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">"token"</span><span class="token punctuation">:</span> auth_token<span class="token punctuation">,</span>
        <span class="token string">"user_id"</span><span class="token punctuation">:</span> user_id<span class="token punctuation">,</span>
        <span class="token string">"username"</span><span class="token punctuation">:</span> username<span class="token punctuation">,</span>
        <span class="token string">"created_at"</span><span class="token punctuation">:</span> now_utc<span class="token punctuation">,</span>
        <span class="token string">"expires_at"</span><span class="token punctuation">:</span> now_utc <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>minutes<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># ×ª×•×§×£ 5 ×“×§×•×ª</span>
    <span class="token punctuation">}</span>
    db_manager<span class="token punctuation">.</span>db<span class="token punctuation">.</span>webapp_tokens<span class="token punctuation">.</span>insert_one<span class="token punctuation">(</span>token_doc<span class="token punctuation">)</span>

    <span class="token comment"># ×™×¦×™×¨×ª URL ×”×ª×—×‘×¨×•×ª</span>
    login_url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>base_url<span class="token punctuation">}</span></span><span class="token string">/auth/token?token=</span><span class="token interpolation"><span class="token punctuation">{</span>auth_token<span class="token punctuation">}</span></span><span class="token string">&amp;user_id=</span><span class="token interpolation"><span class="token punctuation">{</span>user_id<span class="token punctuation">}</span></span><span class="token string">"</span></span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token string">"auth_token"</span><span class="token punctuation">:</span> auth_token<span class="token punctuation">,</span>
        <span class="token string">"login_url"</span><span class="token punctuation">:</span> login_url<span class="token punctuation">,</span>
        <span class="token string">"webapp_url"</span><span class="token punctuation">:</span> base_url<span class="token punctuation">,</span>
    <span class="token punctuation">}</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-4-3">
          <div class="snippet-header">
            <h3 class="snippet-title">4.3 ××™××•×ª ×˜×•×§×Ÿ ×•×™×¦×™×¨×ª Session (Server-Side)</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××™××•×ª ×”×˜×•×§×Ÿ ××”×‘×•×˜ ×•×™×¦×™×¨×ª session ×‘××¢×¨×›×ª ×”-WebApp.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> request<span class="token punctuation">,</span> session<span class="token punctuation">,</span> render_template
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timezone

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/auth/token'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">token_auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""×˜×™×¤×•×œ ×‘××™××•×ª ×¢× ×˜×•×§×Ÿ ××”×‘×•×˜"""</span>

    token <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">)</span>
    user_id <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'user_id'</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> token <span class="token keyword">or</span> <span class="token keyword">not</span> user_id<span class="token punctuation">:</span>
        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'404.html'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">404</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        db <span class="token operator">=</span> get_db<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># ×—×™×¤×•×© ×”×˜×•×§×Ÿ ×‘××¡×“ × ×ª×•× ×™×</span>
        token_doc <span class="token operator">=</span> db<span class="token punctuation">.</span>webapp_tokens<span class="token punctuation">.</span>find_one<span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token string">'token'</span><span class="token punctuation">:</span> token<span class="token punctuation">,</span>
            <span class="token string">'user_id'</span><span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token keyword">not</span> token_doc<span class="token punctuation">:</span>
            <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'login.html'</span><span class="token punctuation">,</span>
                                 error<span class="token operator">=</span><span class="token string">"×§×™×©×•×¨ ×”×”×ª×—×‘×¨×•×ª ×œ× ×ª×§×£ ××• ×¤×’ ×ª×•×§×¤×•"</span><span class="token punctuation">)</span>

        <span class="token comment"># ×‘×“×™×§×ª ×ª×•×§×£</span>
        <span class="token keyword">if</span> token_doc<span class="token punctuation">[</span><span class="token string">'expires_at'</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span>timezone<span class="token punctuation">.</span>utc<span class="token punctuation">)</span><span class="token punctuation">:</span>
            db<span class="token punctuation">.</span>webapp_tokens<span class="token punctuation">.</span>delete_one<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'_id'</span><span class="token punctuation">:</span> token_doc<span class="token punctuation">[</span><span class="token string">'_id'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'login.html'</span><span class="token punctuation">,</span>
                                 error<span class="token operator">=</span><span class="token string">"×§×™×©×•×¨ ×”×”×ª×—×‘×¨×•×ª ×¤×’ ×ª×•×§×£. ×× × ×‘×§×© ×§×™×©×•×¨ ×—×“×© ××”×‘×•×˜."</span><span class="token punctuation">)</span>

        <span class="token comment"># ××—×™×§×ª ×”×˜×•×§×Ÿ ×œ××—×¨ ×©×™××•×© (×—×“ ×¤×¢××™)</span>
        db<span class="token punctuation">.</span>webapp_tokens<span class="token punctuation">.</span>delete_one<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'_id'</span><span class="token punctuation">:</span> token_doc<span class="token punctuation">[</span><span class="token string">'_id'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment"># ×©××™×¨×ª × ×ª×•× ×™ ×”××©×ª××© ×‘×¡×©×Ÿ</span>
        user_id_int <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>
        session<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> user_id_int
        session<span class="token punctuation">[</span><span class="token string">'user_data'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">'id'</span><span class="token punctuation">:</span> user_id_int<span class="token punctuation">,</span>
            <span class="token string">'first_name'</span><span class="token punctuation">:</span> token_doc<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'first_name'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'username'</span><span class="token punctuation">:</span> token_doc<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>

        <span class="token comment"># ×”×¤×•×š ××ª ×”×¡×©×Ÿ ×œ×§×‘×•×¢ (30 ×™×•×)</span>
        session<span class="token punctuation">.</span>permanent <span class="token operator">=</span> <span class="token boolean">True</span>

        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'/files'</span><span class="token punctuation">)</span>

    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error in token auth: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'login.html'</span><span class="token punctuation">,</span> error<span class="token operator">=</span><span class="token string">"×©×’×™××” ×‘××™××•×ª"</span><span class="token punctuation">)</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-4-4">
          <div class="snippet-header">
            <h3 class="snippet-title">4.4 ××ª×—×•×œ WebApp ×‘×¦×“ ×”×œ×§×•×— (Frontend)</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×–×™×”×•×™ ×©×”-WebApp × ×˜×¢×Ÿ ×‘×ª×•×š ×˜×œ×’×¨× ×•×”×ª×××ª ×”×ª×¦×•×’×”.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// ×–×™×”×•×™ Telegram WebApp SDK</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>Telegram <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span>Telegram<span class="token punctuation">.</span>WebApp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'telegram-mini-app'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// ×”×¨×—×‘×ª viewport ×œ×©×™××•×© ××œ× ×‘××¡×š</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                window<span class="token punctuation">.</span>Telegram<span class="token punctuation">.</span>WebApp<span class="token punctuation">.</span><span class="token function">expand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

            <span class="token comment">// ××™×ª×•×ª ×©×”-WebApp ××•×›×Ÿ</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                window<span class="token punctuation">.</span>Telegram<span class="token punctuation">.</span>WebApp<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

            <span class="token comment">// ×§×‘×œ×ª × ×ª×•× ×™ ××©×ª××© ××˜×œ×’×¨×</span>
            <span class="token keyword">const</span> initData <span class="token operator">=</span> window<span class="token punctuation">.</span>Telegram<span class="token punctuation">.</span>WebApp<span class="token punctuation">.</span>initData<span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Telegram WebApp initialized:'</span><span class="token punctuation">,</span> initData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Error initializing Telegram WebApp:'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
          </div>
        </div>
      </div>

      <!-- Category 5: ×¨×›×™×‘×™ UI ×‘-WebApp -->
      <div class="category" id="category-5">
        <div class="category-header">
          <i class="fas fa-paint-brush"></i>
          <h2>×¨×›×™×‘×™ UI ×‘-WebApp</h2>
        </div>

        <div class="snippet" id="snippet-5-1">
          <div class="snippet-header">
            <h3 class="snippet-title">5.1 Modal Dialog ×¢× Promise</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×“×™××œ×•×’ ××•×“×œ×™ ×©××—×–×™×¨ ×ª×•×¦××” ×“×¨×š Promise (async/await).
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">async</span> <span class="token function">showTagDialog</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> dialog <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dialog<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">'modal-overlay'</span><span class="token punctuation">;</span>

        dialog<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
            
                
                     ×”×•×¡×£ ×ª×’×™×•×ª
                    
                        
                    
                

                
                    ×”×–×Ÿ ×ª×’×™×•×ª ××•×¤×¨×“×•×ª ×‘×¤×¡×™×§×™×:
                    
                    
                        ×”×¦×¢×•×ª:
                        important
                        python
                    
                

                
                    
                         ××™×©×•×¨
                    
                    
                         ×‘×™×˜×•×œ
                    
                
            
        </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>dialog<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ×˜×™×¤×•×œ ×‘××™×¨×•×¢×™×</span>
        dialog<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> action <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">closest</span><span class="token punctuation">(</span><span class="token string">'[data-action]'</span><span class="token punctuation">)</span><span class="token operator">?.</span>dataset<span class="token punctuation">.</span>action<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">===</span> <span class="token string">'confirm'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> input <span class="token operator">=</span> dialog<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#tagInput'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> tags <span class="token operator">=</span> input<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">t</span> <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">)</span><span class="token punctuation">;</span>
                document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>dialog<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>tags<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">===</span> <span class="token string">'cancel'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>dialog<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ×¤×•×§×•×¡ ×¢×œ ×”-input</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> dialog<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#tagInput'</span><span class="token punctuation">)</span><span class="token operator">?.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// ×©×™××•×©:</span>
<span class="token comment">// const tags = await showTagDialog();</span>
<span class="token comment">// if (tags) {</span>
<span class="token comment">//     console.log('Selected tags:', tags);</span>
<span class="token comment">// }</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-5-2">
          <div class="snippet-header">
            <h3 class="snippet-title">5.2 Toast Notification ×¢× Auto-Dismiss</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×”×¦×’×ª ×”×•×“×¢×•×ª ×–×× ×™×•×ª ×©× ×¢×œ××•×ª ××•×˜×•××˜×™×ª.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">NotificationManager</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>notificationContainer <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>notificationContainer<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">'notification-container'</span><span class="token punctuation">;</span>
        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>notificationContainer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">showNotification</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">'info'</span><span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> notification <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        notification<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">notification </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> icon <span class="token operator">=</span> <span class="token string">'info-circle'</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'success'</span><span class="token punctuation">)</span> icon <span class="token operator">=</span> options<span class="token punctuation">.</span>icon <span class="token operator">||</span> <span class="token string">'check-circle'</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'error'</span><span class="token punctuation">)</span> icon <span class="token operator">=</span> <span class="token string">'exclamation-circle'</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'warning'</span><span class="token punctuation">)</span> icon <span class="token operator">=</span> <span class="token string">'exclamation-triangle'</span><span class="token punctuation">;</span>

        notification<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
            
                
                </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
            
            
                
            
        </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

        <span class="token comment">// ×˜×™×¤×•×œ ×‘×¡×’×™×¨×” ×™×“× ×™×ª</span>
        notification<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.notification-close'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            notification<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'fade-out'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> notification<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>notificationContainer<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>notification<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ×× ×™××¦×™×™×ª ×›× ×™×¡×”</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> notification<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'show'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ×¡×’×™×¨×” ××•×˜×•××˜×™×ª</span>
        <span class="token keyword">const</span> duration <span class="token operator">=</span> options<span class="token punctuation">.</span>duration <span class="token operator">||</span> <span class="token number">3000</span><span class="token punctuation">;</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>notification<span class="token punctuation">.</span>parentNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                notification<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'fade-out'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> notification<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// ×©×™××•×©:</span>
<span class="token comment">// const notifier = new NotificationManager();</span>
<span class="token comment">// notifier.showNotification('×”×§×•×‘×¥ × ×©××¨ ×‘×”×¦×œ×—×”!', 'success');</span>
<span class="token comment">// notifier.showNotification('×©×’×™××” ×‘×©××™×¨×”', 'error', { duration: 5000 });</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-5-3">
          <div class="snippet-header">
            <h3 class="snippet-title">5.3 Loading Overlay ×¢× Progress Bar</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××¡×š ×˜×¢×™× ×” ×¢× ××¤×©×¨×•×ª ×œ×¢×“×›×•×Ÿ ×”×ª×§×“××•×ª ×‘××—×•×–×™×.
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">ProcessingOverlay</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> overlay <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        overlay<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">'processing-overlay hidden'</span><span class="token punctuation">;</span>
        overlay<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
            
                
                ××¢×‘×“...
                
                    
                        
                    
                    0%
                
            
        </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>overlay<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>overlay <span class="token operator">=</span> overlay<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">show</span><span class="token punctuation">(</span>text <span class="token operator">=</span> <span class="token string">'××¢×‘×“...'</span><span class="token punctuation">,</span> showProgress <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>overlay<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.processing-text'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textContent <span class="token operator">=</span> text<span class="token punctuation">;</span>
        <span class="token keyword">const</span> progressEl <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>overlay<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.processing-progress'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>showProgress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            progressEl<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">'hidden'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            progressEl<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'hidden'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>overlay<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">'hidden'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">updateProgress</span><span class="token punctuation">(</span><span class="token parameter">percent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> progressFill <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>overlay<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.progress-fill'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> progressText <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>overlay<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.progress-text'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>progressFill <span class="token operator">&amp;&amp;</span> progressText<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            progressFill<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>percent<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">%</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
            progressText<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>percent<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">%</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">hide</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>overlay<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'hidden'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// ×©×™××•×©:</span>
<span class="token comment">// const overlay = new ProcessingOverlay();</span>
<span class="token comment">// overlay.show('××¢×‘×“ ×§×‘×¦×™×...', true);</span>
<span class="token comment">// for (let i = 0; i &lt;= 100; i += 10) {</span>
<span class="token comment">//     overlay.updateProgress(i);</span>
<span class="token comment">//     await processChunk();</span>
<span class="token comment">// }</span>
<span class="token comment">// overlay.hide();</span></code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-5-4">
          <div class="snippet-header">
            <h3 class="snippet-title">5.4 Card ×¢× ×”×¨×—×‘×” (Expandable Card)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×›×¨×˜×™×¡ ×©× ×™×ª×Ÿ ×œ×”×¨×—×™×‘ ×œ×ª×¦×•×’×” ××§×“×™××” ××œ××”.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript" tabindex="0"><code class="language-javascript"><span class="token keyword">async</span> <span class="token function">expandCard</span><span class="token punctuation">(</span><span class="token parameter">fileId<span class="token punctuation">,</span> cardElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cardElement<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'card-preview-expanding'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> wrapper <span class="token operator">=</span> cardElement<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.preview-wrapper'</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createWrapper</span><span class="token punctuation">(</span>cardElement<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ×”×¦×’×ª spinner</span>
    wrapper<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
        
            
            ×˜×•×¢×Ÿ ×ª×¦×•×’×” ××§×“×™××”...
        
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// ×©×œ×™×¤×ª ×ª×•×›×Ÿ</span>
        <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/api/file/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>fileId<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/preview</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'Accept'</span><span class="token operator">:</span> <span class="token string">'application/json'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">credentials</span><span class="token operator">:</span> <span class="token string">'same-origin'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">.</span>ok <span class="token operator">||</span> <span class="token operator">!</span>data <span class="token operator">||</span> data<span class="token punctuation">.</span>ok <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token punctuation">(</span>data <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token operator">?</span> data<span class="token punctuation">.</span>error <span class="token operator">:</span> <span class="token string">'×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×¦×•×’×” ××§×“×™××”'</span><span class="token punctuation">;</span>
            wrapper<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
                
                     </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>msg<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
                
            </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// ×”×¦×’×ª ×ª×•×›×Ÿ</span>
        wrapper<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildPreviewHTML</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> fileId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cardElement<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'card-preview-expanded'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        wrapper<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
            
                 ×©×’×™××ª ×¨×©×ª
            
        </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        cardElement<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">'card-preview-expanding'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
          </div>
        </div>
      </div>

      <!-- Additional categories would continue here... -->
      <!-- Due to length constraints, I'll show the structure with a few more key categories -->

      <!-- Category 6: Structured Logging -->
      <div class="category" id="category-6">
        <div class="category-header">
          <i class="fas fa-clipboard-list"></i>
          <h2>Structured Logging</h2>
        </div>

        <div class="snippet" id="snippet-6-1">
          <div class="snippet-header">
            <h3 class="snippet-title">6.1 Emit Event ×¢× Request ID</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×œ×•×’×™× ××•×‘× ×™× ×¢× ××¢×§×‘ ××—×¨ request ×™×™×—×•×“×™ ×œ××•×¨×š ×›×œ ×”×ª×”×œ×™×š.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import structlog
from typing import Any

def emit_event(event: str, severity: str = "info", **fields: Any) -> None:
    """×©×•×œ×— ××™×¨×•×¢ ×œ×•×’ ××•×‘× ×”"""

    logger = structlog.get_logger()
    fields.setdefault("event", event)

    # ×”×•×¡×¤×ª request_id ××”×§×•× ×˜×§×¡×˜
    if severity in {"error", "critical"}:
        ctx = get_observability_context()
        request_id = str(fields.get("request_id") or ctx.get("request_id") or "").strip()
        if request_id and "request_id" not in fields:
            fields["request_id"] = request_id

        # ×”×¢×©×¨×ª context ×¢× command, user_id, chat_id
        command_tag = _sanitize_command_identifier(fields.get("command")) or str(ctx.get("command") or "")
        user_tag = _hash_identifier(fields.get("user_id")) or str(ctx.get("user_id") or "")
        chat_tag = _hash_identifier(fields.get("chat_id")) or str(ctx.get("chat_id") or "")

        if command_tag:
            fields["command"] = command_tag
        if user_tag:
            fields["user_id"] = user_tag
        if chat_tag:
            fields["chat_id"] = chat_tag

    # ×©×œ×™×—×ª ×œ×•×’
    log_method = getattr(logger, severity, logger.info)
    log_method(event, **fields)

# ×©×™××•×©:
# emit_event("file_saved", severity="info", user_id=123, file_name="main.py")
# emit_event("db_error", severity="error", error=str(e), request_id=req_id)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-6-2">
          <div class="snippet-header">
            <h3 class="snippet-title">6.2 Binding Request ID ×œ×§×•× ×˜×§×¡×˜</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×§×•×©×¨ request_id ×œ×›×œ ×”×œ×•×’×™× ×‘×–×¨×™××” ×”× ×•×›×—×™×ª (×’× async).</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import structlog

def bind_request_id(request_id: str) -> None:
    """×§×•×©×¨ request_id ×œ×›×œ ×”×œ×•×’×™× ×‘×”×§×©×¨ ×”× ×•×›×—×™"""
    try:
        structlog.contextvars.bind_contextvars(request_id=request_id)
    except Exception:
        pass

    # ×©×œ×™×—×” ×’× ×œ-Sentry
    _set_sentry_tag("request_id", request_id)

# ×©×™××•×© ×‘×ª×—×™×œ×ª request:
# request_id = generate_request_id()  # uuid4().hex
# bind_request_id(request_id)
#
# # ×›×œ ×”×œ×•×’×™× ××¢×›×©×™×• ×™×›×œ×œ×• ××ª ×”-request_id ××•×˜×•××˜×™×ª:
# emit_event("processing_started", severity="info")
# emit_event("processing_completed", severity="info")</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-6-3">
          <div class="snippet-header">
            <h3 class="snippet-title">6.3 Binding User Context</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×§×™×©×•×¨ user_id ×•-chat_id ×œ×›×œ ×”×œ×•×’×™× ×‘×¦×•×¨×” ××•×˜×•××˜×™×ª.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import structlog
from typing import Any, Optional, Dict

def bind_user_context(
    *,
    user_id: Any | None = None,
    chat_id: Any | None = None
) -> None:
    """×§×•×©×¨ ×”×§×©×¨ ××©×ª××© ×œ×›×œ ×”×œ×•×’×™×"""

    to_bind: Dict[str, str] = {}

    # Hash ×©×œ user_id (××‘×˜×—×ª ×¤×¨×˜×™×•×ª)
    user_hash = _hash_identifier(user_id)
    if user_hash:
        to_bind["user_id"] = user_hash
        _set_sentry_tag("user_id", user_hash)

    # Hash ×©×œ chat_id
    chat_hash = _hash_identifier(chat_id)
    if chat_hash:
        to_bind["chat_id"] = chat_hash
        _set_sentry_tag("chat_id", chat_hash)

    # ×§×™×©×•×¨ ×œ×§×•× ×˜×§×¡×˜
    if to_bind:
        try:
            structlog.contextvars.bind_contextvars(**to_bind)
        except Exception:
            pass

# ×©×™××•×©:
# bind_user_context(user_id=update.effective_user.id, chat_id=update.effective_chat.id)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-6-4">
          <div class="snippet-header">
            <h3 class="snippet-title">6.4 ×”×’×“×¨×ª Structlog ×¢× Merge Context</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×§×•× ×¤×™×’×•×¨×¦×™×” ××œ××” ×©×œ structlog ×¢× ××™×–×•×’ ×§×•× ×˜×§×¡×˜ ××•×˜×•××˜×™.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import structlog

def setup_structlog_logging(min_level: str | int = "INFO") -> None:
    """××’×“×™×¨ structlog ×¢× processors ××œ××™×"""

    level = _parse_log_level(min_level)

    structlog.configure(
        processors=[
            structlog.contextvars.merge_contextvars,  # ××™×–×•×’ context ××•×˜×•××˜×™
            _add_otel_ids,                             # ×”×•×¡×¤×ª trace_id/span_id
            _redact_sensitive,                         # ×”×¡×¨×ª × ×ª×•× ×™× ×¨×’×™×©×™×
            _add_schema_version,                       # ×’×¨×¡×ª schema
            structlog.processors.add_log_level,        # ×¨××ª ×œ×•×’
            _mirror_to_log_aggregator,                 # ×©×œ×™×—×” ×œ-aggregator
            _maybe_sample_info,                        # ×“×’×™××ª info logs
            structlog.processors.TimeStamper(fmt="iso"),
            _choose_renderer(),  # JSON ××• console
        ],
        wrapper_class=structlog.make_filtering_bound_logger(level),
        context_class=dict,
        logger_factory=structlog.PrintLoggerFactory(),
        cache_logger_on_first_use=False,
    )

# ×©×™××•×©:
# setup_structlog_logging("INFO")</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 7: ×”×•×“×¢×•×ª ×©×’×™××” ×™×“×™×“×•×ª×™×•×ª -->
      <div class="category" id="category-7">
        <div class="category-header">
          <i class="fas fa-exclamation-triangle"></i>
          <h2>×”×•×“×¢×•×ª ×©×’×™××” ×™×“×™×“×•×ª×™×•×ª</h2>
        </div>

        <div class="snippet" id="snippet-7-1">
          <div class="snippet-header">
            <h3 class="snippet-title">7.1 Rate Limit Error Handler</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×˜×™×¤×•×œ ×‘×’×‘×œ×ª ×§×¦×‘ ×¢× ×”×•×“×¢×” ×™×“×™×“×•×ª×™×ª ×œ××©×ª××© + metrics.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from flask import jsonify, request

@app.errorhandler(429)
def _ratelimit_handler(e):
    """×˜×™×¤×•×œ ×‘×”×’×‘×œ×ª ×§×¦×‘"""
    try:
        # ×œ×•×’×™× ×•××˜×¨×™×§×•×ª (best-effort)
        try:
            emit_event(
                "rate_limit_blocked",
                severity="warning",
                path=str(getattr(request, 'path', '')),
                remote=str(getattr(request, 'remote_addr', '')),
            )
        except Exception:
            pass

        try:
            from metrics import rate_limit_blocked
            if rate_limit_blocked is not None:
                scope = str(getattr(request, 'path', '') or 'route')
                rate_limit_blocked.labels(
                    source="webapp",
                    scope=scope,
                    limit="route"
                ).inc()
        except Exception:
            pass

        # ×ª×’×•×‘×” ×œ××©×ª××©
        payload = {
            "error": "rate_limit_exceeded",
            "message": "×™×•×ª×¨ ××“×™ ×‘×§×©×•×ª. ×× × × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.",
            "retry_after": getattr(e, 'description', None),
        }
        return jsonify(payload), 429

    except Exception:
        # fallback ×× ×”×›×œ × ×›×©×œ
        return jsonify({"error": "rate_limit_exceeded"}), 429</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-7-2">
          <div class="snippet-header">
            <h3 class="snippet-title">7.2 Database Error ×¢× ×”×•×“×¢×•×ª ×¡×¤×¦×™×¤×™×•×ª</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×˜×™×¤×•×œ ×‘×©×’×™××•×ª DB ×¡×¤×¦×™×¤×™×•×ª ×¢× ×”×•×“×¢×•×ª ××ª××™××•×ª.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from pymongo.errors import DuplicateKeyError

def toggle_bookmark(
    self,
    user_id: int,
    file_id: str,
    file_name: str,
    line_number: int,
    **kwargs
) -> Dict[str, Any]:
    """××•×¡×™×£ ××• ××¡×™×¨ ×¡×™×× ×™×™×”"""

    try:
        # Validation
        if line_number <= 0:
            return {
                "ok": False,
                "action": "error",
                "error": "××¡×¤×¨ ×©×•×¨×” ×œ× ×ª×§×™×Ÿ"
            }

        note = kwargs.get('note', '')
        if len(note) > MAX_NOTE_LENGTH:
            note = note[:MAX_NOTE_LENGTH]

        # ... bookmark logic ...

        return {
            "ok": True,
            "action": "added",
            "bookmark": self._bookmark_to_response(bookmark)
        }

    except DuplicateKeyError:
        # ×©×’×™××” ×¡×¤×¦×™×¤×™×ª - ××¤×ª×— ×›×¤×•×œ
        return {
            "ok": False,
            "action": "error",
            "error": "×”×¡×™×× ×™×™×” ×›×‘×¨ ×§×™×™××ª"
        }

    except Exception as e:
        # ×©×’×™××” ×›×œ×œ×™×ª
        logger.error(f"Error toggling bookmark: {e}", exc_info=True)
        return {
            "ok": False,
            "action": "error",
            "error": "×©×’×™××” ×‘×©××™×¨×ª ×”×¡×™×× ×™×™×”"
        }</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-7-3">
          <div class="snippet-header">
            <h3 class="snippet-title">7.3 Validation ×¢× Error Messages</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×•×œ×™×“×¦×™×” ×¢× ×”×—×–×¨×ª tuple ×©×œ (success, data, error_message).</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from typing import Tuple

def validate_code_input(
    code: str,
    file_name: str,
    user_id: int
) -> Tuple[bool, str, str]:
    """
    ×‘×•×“×§ ×•×× ×§×” ×§×œ×˜ ×§×•×“.

    Returns:
        Tuple[bool, str, str]: (is_valid, cleaned_code, error_message)
    """

    # ×‘×“×™×§×•×ª ×‘×¡×™×¡×™×•×ª
    if not code or not code.strip():
        return False, "", "×”×§×•×“ ×¨×™×§"

    if len(code) > MAX_CODE_LENGTH:
        return False, "", f"×”×§×•×“ ××¨×•×š ××“×™ (××§×¡×™××•× {MAX_CODE_LENGTH} ×ª×•×•×™×)"

    # × ×™×§×•×™ ×§×•×“
    try:
        cleaned = normalize_code(code)
    except Exception as e:
        return False, "", f"×©×’×™××” ×‘× ×™×§×•×™ ×”×§×•×“: {str(e)}"

    # ×•×œ×™×“×¦×™×” × ×•×¡×¤×ª ×× ×™×©
    if code_processor:
        ok, cleaned, msg = code_processor.validate_code_input(code, file_name, user_id)
        if not ok:
            return False, cleaned, msg

    return True, cleaned, ""

# ×©×™××•×©:
# is_valid, cleaned_code, error_msg = validate_code_input(code, filename, user_id)
# if not is_valid:
#     await update.message.reply_text(f"âŒ {error_msg}")
#     return
# # ×”××©×š ×¢× cleaned_code</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-7-4">
          <div class="snippet-header">
            <h3 class="snippet-title">7.4 Batch Processing ×¢× Per-Item Errors</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×¢×™×‘×•×“ batch ×©×œ× × ×¢×¦×¨ ×¢×œ ×©×’×™××” ×‘×•×“×“×ª, ××œ× ×¢×•×§×‘ ××—×¨ ×”×¦×œ×—×•×ª/×›×™×©×œ×•× ×•×ª.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from concurrent.futures import ThreadPoolExecutor, as_completed
import time

async def process_files_batch(
    self,
    job_id: str,
    operation_func: Callable,
    **kwargs
) -> BatchJob:
    """×¢×™×‘×•×“ batch ×©×œ ×§×‘×¦×™× ×¢× ××¢×§×‘ ××—×¨ ×©×’×™××•×ª"""

    if job_id not in self.active_jobs:
        raise ValueError(f"×¢×‘×•×“×ª batch {job_id} ×œ× × ××¦××”")

    job = self.active_jobs[job_id]
    job.status = "running"
    job.start_time = time.time()

    try:
        with ThreadPoolExecutor(max_workers=self.max_workers) as executor:
            # ×™×¦×™×¨×ª futures ×œ×›×œ ×”×§×‘×¦×™×
            future_to_file = {
                executor.submit(operation_func, job.user_id, file_name, **kwargs): file_name
                for file_name in job.files
            }

            # ×¢×™×‘×•×“ ×ª×•×¦××•×ª ×¢× ××¢×§×‘ ××—×¨ ×©×’×™××•×ª
            for future in as_completed(future_to_file):
                file_name = future_to_file[future]

                try:
                    result = future.result()
                    success_flag = True

                    # ×‘×“×™×§×ª ×”×¦×œ×—×”
                    if isinstance(result, dict):
                        if 'is_valid' in result:
                            success_flag = bool(result.get('is_valid'))
                        elif 'error' in result:
                            success_flag = False

                    job.results[file_name] = {
                        'success': success_flag,
                        'result': result
                    }

                except Exception as e:
                    # ×©×’×™××” ×‘×§×•×‘×¥ ×‘×•×“×“ - ×œ× ×¢×•×¦×¨×™×
                    job.results[file_name] = {
                        'success': False,
                        'error': str(e)
                    }
                    logger.error(f"×©×’×™××” ×‘×¢×™×‘×•×“ {file_name}: {e}")

                job.progress += 1

        # ×¡×™×›×•×
        job.status = "completed"
        successful = sum(1 for r in job.results.values() if r['success'])
        failed = job.total - successful

        logger.info(f"×¢×‘×•×“×ª batch {job_id} ×”×•×©×œ××”: {successful} ×”×¦×œ×™×—×•, {failed} × ×›×©×œ×•")

    except Exception as e:
        job.status = "failed"
        job.error_message = str(e)
        logger.error(f"×¢×‘×•×“×ª batch {job_id} × ×›×©×œ×”: {e}")

    return job</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 8: ×‘×“×™×§×•×ª Pytest -->
      <div class="category" id="category-8">
        <div class="category-header">
          <i class="fas fa-vial"></i>
          <h2>×‘×“×™×§×•×ª Pytest</h2>
        </div>

        <div class="snippet" id="snippet-8-1">
          <div class="snippet-header">
            <h3 class="snippet-title">8.1 Fixture ×¢× Setup/Teardown</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> × ×™×§×•×™ ×¡×‘×™×‘×” ×œ×¤× ×™ ×•××—×¨×™ ×›×œ ×‘×“×™×§×”.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import pytest

@pytest.fixture(autouse=True)
def _clear_env(monkeypatch):
    """× ×™×§×•×™ ××©×ª× ×™ ×¡×‘×™×‘×” ×œ×¤× ×™ ×•××—×¨×™ ×›×œ ×‘×“×™×§×”"""
    # Setup
    monkeypatch.delenv('WEBAPP_URL', raising=False)

    yield  # ×”×‘×“×™×§×” ×¨×¦×” ×›××Ÿ

    # Teardown
    monkeypatch.delenv('WEBAPP_URL', raising=False)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-8-2">
          <div class="snippet-header">
            <h3 class="snippet-title">8.2 Test Parametrization</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×”×¨×¦×ª ××•×ª×” ×‘×“×™×§×” ×¢× ×›××” ×¡×˜×™× ×©×œ × ×ª×•× ×™×.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import pytest
import types

@pytest.mark.parametrize(
    "config_values, env_value, expected",
    [
        (
            {"WEBAPP_URL": "https://cfg.example", "PUBLIC_BASE_URL": None},
            None,
            "https://cfg.example/file/abc"
        ),
        (
            {"WEBAPP_URL": None, "PUBLIC_BASE_URL": "https://public.example"},
            None,
            "https://public.example/file/abc"
        ),
        (
            {"WEBAPP_URL": None, "PUBLIC_BASE_URL": None},
            "https://env.example",
            "https://env.example/file/abc"
        ),
    ],
)
def test_file_view_webapp_button_prefers_available_source(
    monkeypatch,
    config_values,
    env_value,
    expected
):
    """×‘×•×“×§ ×©×”×›×¤×ª×•×¨ ×‘×•×—×¨ ××ª ×”××§×•×¨ ×”× ×›×•×Ÿ"""
    import handlers.file_view as fv

    # ×”×’×“×¨×ª config mock
    stub_cfg = types.SimpleNamespace(**config_values)
    monkeypatch.setattr(fv, 'config', stub_cfg, raising=False)

    # ×”×’×“×¨×ª env ×× × ×“×¨×©
    if env_value:
        monkeypatch.setenv('WEBAPP_URL', env_value)

    # ×”×¨×¦×ª ×”×¤×•× ×§×¦×™×”
    row = fv._get_webapp_button_row('abc', None)

    # ×‘×“×™×§×”
    assert row[0].url == expected</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-8-3">
          <div class="snippet-header">
            <h3 class="snippet-title">8.3 Async Test</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×‘×“×™×§×ª ×¤×•× ×§×¦×™×•×ª async ×¢× aiohttp ××• asyncio.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import pytest
from aiohttp import web
import aiohttp

@pytest.mark.asyncio
async def test_health_endpoint_ok(monkeypatch):
    """×‘×•×“×§ ×©×”-health endpoint ×¢×•×‘×“"""
    from services.webserver import create_app

    app = create_app()

    # ×”×¨×¦×ª server ×–×× ×™
    runner = web.AppRunner(app)
    await runner.setup()
    site = web.TCPSite(runner, host="127.0.0.1", port=0)
    await site.start()

    try:
        # ×§×‘×œ×ª ×¤×•×¨×˜ ×“×™× ××™
        port = list(site._server.sockets)[0].getsockname()[1]

        # ×©×œ×™×—×ª request
        async with aiohttp.ClientSession() as session:
            async with session.get(f"http://127.0.0.1:{port}/health") as resp:
                assert resp.status == 200
                data = await resp.json()
                assert data.get("status") == "ok"

    finally:
        # × ×™×§×•×™
        await runner.cleanup()</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-8-4">
          <div class="snippet-header">
            <h3 class="snippet-title">8.4 Mocking ×¢× MagicMock</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×”×—×œ×¤×ª dependencies ×¢× mocks ×œ×‘×“×™×§×” ××‘×•×“×“×ª.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from unittest.mock import MagicMock, Mock
import unittest

class TestBookmarks(unittest.TestCase):
    def test_toggle_bookmark_add(self):
        """×‘×•×“×§ ×”×•×¡×¤×ª ×¡×™×× ×™×™×” ×—×“×©×”"""

        # ×”×’×“×¨×ª mocks
        mock_collection = MagicMock()
        mock_collection.find_one.return_value = None  # ×¡×™×× ×™×™×” ×œ× ×§×™×™××ª
        mock_collection.count_documents.return_value = 0
        mock_collection.insert_one.return_value = Mock(inserted_id="new_id")

        mock_db = MagicMock()
        mock_db.file_bookmarks = mock_collection

        manager = BookmarksManager(mock_db)

        # ×”×¨×¦×ª ×”×¤×•× ×§×¦×™×”
        result = manager.toggle_bookmark(
            user_id=123,
            file_id="file123",
            file_name="test.py",
            file_path="/test.py",
            line_number=42,
            line_text="def test():",
            note="Test bookmark"
        )

        # ×‘×“×™×§×•×ª
        self.assertTrue(result["ok"])
        self.assertEqual(result["action"], "added")
        self.assertIsNotNone(result["bookmark"])

        # ×•×™×“×•× ×©×”×¤×•× ×§×¦×™×” × ×§×¨××”
        mock_collection.insert_one.assert_called_once()</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-8-5">
          <div class="snippet-header">
            <h3 class="snippet-title">8.5 Mocking ×¢× @patch Decorator</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×”×—×œ×¤×ª ××•×“×•×œ×™× ×©×œ××™× ××• ×¤×•× ×§×¦×™×•×ª ×‘×¦×•×¨×” × ×§×™×™×”.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from unittest.mock import patch, MagicMock
import unittest

class TestBookmarks(unittest.TestCase):

    @patch('database.bookmarks_manager.logger')
    def test_error_handling(self, mock_logger):
        """×‘×•×“×§ ×©×”×œ×•×’×™× ×¢×•×‘×“×™× ×‘×©×’×™××•×ª"""

        # ×”×’×“×¨×ª mocks
        mock_db = MagicMock()
        mock_collection = MagicMock()
        mock_db.file_bookmarks = mock_collection

        # ×’×•×¨× ×œ×©×’×™××”
        mock_collection.find_one.return_value = None
        mock_collection.count_documents.return_value = 0
        mock_collection.insert_one.side_effect = Exception("DB Error")

        manager = BookmarksManager(mock_db)

        # ×”×¨×¦×ª ×”×¤×•× ×§×¦×™×”
        result = manager.toggle_bookmark(
            user_id=123,
            file_id="file123",
            file_name="test.py",
            file_path="/test.py",
            line_number=42
        )

        # ×‘×“×™×§×•×ª
        self.assertFalse(result["ok"])
        self.assertEqual(result["action"], "error")

        # ×•×™×“×•× ×©×”×©×’×™××” × ×¨×©××”
        mock_logger.error.assert_called()</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 9: ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ (Utility Functions) -->
      <div class="category" id="category-9">
        <div class="category-header">
          <i class="fas fa-tools"></i>
          <h2>×¤×•× ×§×¦×™×•×ª ×¢×–×¨</h2>
        </div>

        <div class="snippet" id="snippet-9-1">
          <div class="snippet-header">
            <h3 class="snippet-title">9.1 ×–××Ÿ ×™×—×¡×™ ×‘×¢×‘×¨×™×ª (TimeUtils.format_relative_time)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×¢×•×–×¨ ×œ×”×¦×™×’ ×œ××©×ª××©×™× ×›××” ×–××Ÿ ×¢×‘×¨ ×‘×©×¤×” ×˜×‘×¢×™×ª ×‘×¢×‘×¨×™×ª, ×¢× ×˜×™×¤×•×œ ×—×›× ×‘×™×—×™×“×•×ª ×–××Ÿ ×©×•× ×•×ª.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class TimeUtils:
    """×›×œ×™× ×œ×¢×‘×•×“×” ×¢× ×–××Ÿ ×•×ª××¨×™×›×™×"""
    
    @staticmethod
    def format_relative_time(dt: datetime) -> str:
        """×¤×•×¨××˜ ×–××Ÿ ×™×—×¡×™ (×œ×¤× ×™ 5 ×“×§×•×ª, ××ª××•×œ ×•×›×•')"""
        
        now = datetime.now(timezone.utc) if dt.tzinfo else datetime.now()
        diff = now - dt
        
        if diff.days > 365:
            years = diff.days // 365
            return f"×œ×¤× ×™ {years} ×©× {'×”' if years == 1 else '×™×'}"
        
        elif diff.days > 30:
            months = diff.days // 30
            return f"×œ×¤× ×™ {months} ×—×•×“{'×©' if months == 1 else '×©×™×'}"
        
        elif diff.days > 7:
            weeks = diff.days // 7
            return f"×œ×¤× ×™ {weeks} ×©×‘×•×¢{'×•×ª' if weeks > 1 else ''}"
        
        elif diff.days > 0:
            if diff.days == 1:
                return "××ª××•×œ"
            return f"×œ×¤× ×™ {diff.days} ×™××™×"
        
        elif diff.seconds > 3600:
            hours = diff.seconds // 3600
            return f"×œ×¤× ×™ {hours} ×©×¢{'×”' if hours == 1 else '×•×ª'}"
        
        elif diff.seconds > 60:
            minutes = diff.seconds // 60
            return f"×œ×¤× ×™ {minutes} ×“×§{'×”' if minutes == 1 else '×•×ª'}"
        
        else:
            return "×¢×›×©×™×•"</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-2">
          <div class="snippet-header">
            <h3 class="snippet-title">9.2 ××¡×§×™×™×¤ ×œ-Markdown ×‘×˜×œ×’×¨× (TextUtils.escape_markdown)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××ª××™× ×›×©×¦×¨×™×š ×œ×”×¦×™×’ ×˜×§×¡×˜ ×’×•×œ××™ ×‘×˜×œ×’×¨× ×‘×œ×™ ×œ×©×‘×•×¨ ×¢×™×¦×•×‘ Markdown V1/V2.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class TextUtils:
    """×›×œ×™× ×œ×¢×‘×•×“×” ×¢× ×˜×§×¡×˜"""
    
    @staticmethod
    def escape_markdown(text: str, version: int = 2) -> str:
        """×”×’× ×” ×¢×œ ×ª×•×•×™× ××™×•×—×“×™× ×‘-Markdown"""
        
        if version == 2:
            # Markdown V2: ×›×œ ×”×ª×•×•×™× ×©×™×© ×œ××¡×§×™×™×¤ ×œ×¤×™ Telegram MarkdownV2
            special_chars = set("_*[]()~`>#+-=|{}.!\\")
            return "".join(("\\" + ch) if ch in special_chars else ch for ch in text)
        else:
            # Markdown V1: × ×©×ª××© ×‘×§×‘×•×¦×” ××¦×•××¦××ª ××š ×’× × ×¡××Ÿ ×¡×•×’×¨×™×™× ×›×“×™ ×œ×”×™×× ×¢ ××ª×§×œ×•×ª ×›×œ×œ×™×•×ª
            special_chars = set("_*`[()\\")
            return "".join(("\\" + ch) if ch in special_chars else ch for ch in text)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-3">
          <div class="snippet-header">
            <h3 class="snippet-title">9.3 × ×™×§×•×™ ×©××•×ª ×§×‘×¦×™× (TextUtils.clean_filename)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××¡×™×¨ ×ª×•×•×™× ××¡×•×¨×™× ×•××§×¦×¨ ×©××•×ª ×œ×¤× ×™ ×©××™×¨×” ×‘×“×™×¡×§ ××• ×”×¢×œ××” ×œ×¢× ×Ÿ.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class TextUtils:
    """×›×œ×™× ×œ×¢×‘×•×“×” ×¢× ×˜×§×¡×˜"""
    
    @staticmethod
    def clean_filename(filename: str) -> str:
        """× ×™×§×•×™ ×©× ×§×•×‘×¥ ××ª×•×•×™× ×œ× ×—×•×§×™×™×"""
        
        # ×”×¡×¨×ª ×ª×•×•×™× ×œ× ×—×•×§×™×™×
        cleaned = re.sub(r'[<>:"/\\|?*]', '_', filename)
        
        # ×”×¡×¨×ª ×¨×•×•×—×™× ××™×•×ª×¨×™×
        cleaned = re.sub(r'\s+', '_', cleaned)
        
        # ×”×¡×¨×ª × ×§×•×“×•×ª ××™×•×ª×¨×•×ª
        cleaned = re.sub(r'\.+', '.', cleaned)
        
        # ×”×’×‘×œ×ª ××•×¨×š
        if len(cleaned) > 100:
            name, ext = os.path.splitext(cleaned)
            cleaned = name[:100-len(ext)] + ext
        
        return cleaned.strip('._')</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-4">
          <div class="snippet-header">
            <h3 class="snippet-title">9.4 ××¢× ×” ×‘×˜×•×— ×œ-CallbackQuery (TelegramUtils.safe_answer)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××‘×¦×¢ `query.answer` ×¢× ×”×—×¨×’×” ×©×œ ×©×’×™××•×ª ×™×“×•×¢×•×ª ×›×“×™ ×œ× ×œ×”×¤×™×œ ××ª ×”×–×¨×™××”.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class TelegramUtils:
    """×›×œ×™× ×œ×¢×‘×•×“×” ×¢× Telegram"""
    
    @staticmethod
    async def safe_answer(query, text: Optional[str] = None, show_alert: bool = False, cache_time: Optional[int] = None) -> None:
        """××¢× ×” ×‘×˜×•×— ×œ-CallbackQuery: ××ª×¢×œ× ××©×’×™××•×ª 'Query is too old'/'query_id_invalid'."""
        try:
            kwargs: Dict[str, Any] = {}
            if text is not None:
                kwargs["text"] = text
            if show_alert:
                kwargs["show_alert"] = True
            if cache_time is not None:
                kwargs["cache_time"] = int(cache_time)
            await query.answer(**kwargs)
        except Exception as e:
            msg = str(e).lower()
            if "query is too old" in msg or "query_id_invalid" in msg or "message to edit not found" in msg:
                return
            raise</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-5">
          <div class="snippet-header">
            <h3 class="snippet-title">9.5 ×¤×™×¦×•×œ ×”×•×“×¢×•×ª ××¨×•×›×•×ª (TelegramUtils.split_long_message)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×¢×•×–×¨ ×œ×¤×¦×œ ×ª×©×•×‘×” ×’×“×•×œ×” ×œ××§×˜×¢×™× ×‘×’×‘×•×œ 4096 ×ª×•×•×™× ×©×œ ×˜×œ×’×¨×.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class TelegramUtils:
    """×›×œ×™× ×œ×¢×‘×•×“×” ×¢× Telegram"""
    
    @staticmethod
    def split_long_message(text: str, max_length: int = 4096) -> List[str]:
        """×—×œ×•×§×ª ×”×•×“×¢×” ××¨×•×›×” ×œ×—×œ×§×™×"""
        
        if len(text) <= max_length:
            return [text]
        
        parts = []
        current_part = ""
        
        for line in text.split('\n'):
            if len(current_part) + len(line) + 1 <= max_length:
                current_part += line + '\n'
            else:
                if current_part:
                    parts.append(current_part.rstrip())
                current_part = line + '\n'
        
        if current_part:
            parts.append(current_part.rstrip())
        
        return parts</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-6">
          <div class="snippet-header">
            <h3 class="snippet-title">9.6 ×¢×¨×™×›×ª ×”×•×“×¢×” ×‘×˜×•×—×” (TelegramUtils.safe_edit_message_text)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××˜×¤×œ ×’× ×‘××™××•×©×™× ×¡×™× ×›×¨×•× ×™×™× ×•×’× ××¡×™× ×›×¨×•× ×™×™× ×•××“×›× ××ª ×©×’×™××ª "message is not modified".</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class TelegramUtils:
    """×›×œ×™× ×œ×¢×‘×•×“×” ×¢× Telegram"""
    
    @staticmethod
    async def safe_edit_message_text(query, text: str, reply_markup=None, parse_mode: Optional[str] = None) -> None:
        """×¢×¨×™×›×ª ×˜×§×¡×˜ ×”×•×“×¢×” ×‘×‘×˜×™×—×•×ª: ××ª×¢×œ× ××©×’×™××ª 'Message is not modified'.

        ×ª×•××š ×’× ×‘××™××•×©×™ ×‘×“×™×§×•×ª ×©×‘×”× `edit_message_text` ×”×™× ×¤×•× ×§×¦×™×” ×¡×™× ×›×¨×•× ×™×ª
        ×©××—×–×™×¨×” `None` (×œ× awaitable), ×•×’× ×‘××™××•×©×™× ××¡×™× ×›×¨×•× ×™×™× ×¨×’×™×œ×™×.
        """
        try:
            edit_func = getattr(query, "edit_message_text", None)
            if not callable(edit_func):
                return

            kwargs = {"text": text, "reply_markup": reply_markup}
            if parse_mode is not None:
                kwargs["parse_mode"] = parse_mode

            result = edit_func(**kwargs)

            # ×× ×—×–×¨ coroutine â€“ ×¦×¨×™×š ×œ×”××ª×™×Ÿ; ××—×¨×ª ×–×• ×¤×•× ×§×¦×™×” ×¡×™× ×›×¨×•× ×™×ª ×•××™×Ÿ ××” ×œ×”××ª×™×Ÿ
            if asyncio.iscoroutine(result):
                await result
        except Exception as e:
            msg = str(e).lower()
            # ×”×ª×¢×œ××•×ª ×¨×§ ×‘××§×¨×” "not modified" (×¢××™×“ ×œ×©×™× ×•×™×™× ×§×œ×™× ×‘×˜×§×¡×˜)
            if "not modified" in msg or "message is not modified" in msg:
                return
            raise</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-7">
          <div class="snippet-header">
            <h3 class="snippet-title">9.7 ×× ×™×¢×ª ×œ×—×™×¦×” ×›×¤×•×œ×” (CallbackQueryGuard.should_block_async)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××•× ×¢ ×”×¤×¢×œ×” ×›×¤×•×œ×” ×©×œ ××•×ª×• ×›×¤×ª×•×¨ ×‘×××¦×¢×•×ª × ×¢×™×œ×•×ª ×¤×¨-××©×ª××© ×•×—×œ×•×Ÿ ×–××Ÿ ×§×¦×¨.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class CallbackQueryGuard:
    """Guard ×’×•×¨×£ ×œ×œ×—×™×¦×•×ª ×›×¤×•×œ×•×ª ×¢×œ ×›×¤×ª×•×¨×™ CallbackQuery.
    
    ××‘×•×¡×¡ ×¢×œ ×˜×‘×™×¢×ª ××¦×‘×¢ ×©×œ ×”××©×ª××©/×”×•×“×¢×”/×”× ×ª×•×Ÿ (callback_data) ×›×“×™ ×œ×—×¡×•×
    ××ª ××•×ª×” ×¤×¢×•×œ×” ×‘×—×œ×•×Ÿ ×–××Ÿ ×§×¦×¨, ×‘×œ×™ ×œ×—×¡×•× ×¤×¢×•×œ×•×ª ×©×•× ×•×ª.
    """

    DEFAULT_WINDOW_SECONDS: float = 1.2
    _user_locks: Dict[int, asyncio.Lock] = {}

    @staticmethod
    async def should_block_async(update: Update, context: ContextTypes.DEFAULT_TYPE, window_seconds: Optional[float] = None) -> bool:
        """×‘×•×“×§ ×‘×¦×•×¨×” ××˜×•××™×ª (×¢× × ×¢×™×œ×”) ×× ×œ×—×¡×•× ×œ×—×™×¦×” ×›×¤×•×œ×” ×©×œ ××•×ª×• ××©×ª××©.

        ×—×¡×™××” ××‘×•×¡×¡×ª ×—×œ×•×Ÿ ×–××Ÿ ×¤×¨-××©×ª××©, ×œ×œ× ×ª×œ×•×ª ×‘-message_id/data, ×›×“×™ ×œ×× ×•×¢ ××¨×•×¥.
        """
        try:
            try:
                win = float(window_seconds if window_seconds is not None else CallbackQueryGuard.DEFAULT_WINDOW_SECONDS)
            except Exception:
                win = CallbackQueryGuard.DEFAULT_WINDOW_SECONDS

            user_id = int(getattr(getattr(update, 'effective_user', None), 'id', 0) or 0)

            # ×× ××™×Ÿ ×–×™×”×•×™ ××©×ª××©, fallback ×œ×”×ª× ×”×’×•×ª ×”×™×©× ×” ×œ×œ× ×—×¡×™××”
            if user_id <= 0:
                return CallbackQueryGuard.should_block(update, context, window_seconds=win)

            # ×§×‘×œ/×¦×•×¨ × ×¢×™×œ×” ×œ××©×ª××©
            lock = CallbackQueryGuard._user_locks.get(user_id)
            if lock is None:
                lock = asyncio.Lock()
                CallbackQueryGuard._user_locks[user_id] = lock

            async with lock:
                now_ts = time.time()
                # ×”×©×ª××© ×‘××•×ª×• ×©×“×” ×–××Ÿ ×’×œ×•×‘×œ×™ ×©×”×™×” ×‘×©×™××•×©, ××š ×œ×œ× ×˜×‘×™×¢×ª ××¦×‘×¢
                busy_until = float(context.user_data.get("_cb_guard_until", 0.0) or 0.0) if hasattr(context, "user_data") else 0.0
                if now_ts < busy_until:
                    return True
                # ×¡×× ×• ×—×œ×•×Ÿ ×–××Ÿ ×—×¡×™××” ×—×“×©
                if hasattr(context, "user_data"):
                    context.user_data["_cb_guard_until"] = now_ts + win
                return False
        except Exception:
            # ××œ ×ª×—×¡×•× ×× guard × ×›×©×œ
            return False</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-8">
          <div class="snippet-header">
            <h3 class="snippet-title">9.8 ×¢×™×‘×•×“ ×¤×¨×™×˜×™× ×‘×§×‘×•×¦×•×ª (AsyncUtils.batch_process)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×××¤×©×¨ ×œ×”×¨×™×¥ ×¤×¢×•×œ×•×ª ××¡×™× ×›×¨×•× ×™×•×ª ×‘×§×‘×•×¦×•×ª ×§×˜× ×•×ª ×¢× ×”×©×”×™×” ×‘×™×Ÿ ×’×•×©×™×.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class AsyncUtils:
    """×›×œ×™× ×œ×¢×‘×•×“×” ××¡×™× ×›×¨×•× ×™×ª"""
    
    @staticmethod
    async def batch_process(items: List[Any], process_func: Callable, 
                           batch_size: int = 10, delay: float = 0.1) -> List[Any]:
        """×¢×™×‘×•×“ ×¤×¨×™×˜×™× ×‘×§×‘×•×¦×•×ª"""
        
        results = []
        
        for i in range(0, len(items), batch_size):
            batch = items[i:i + batch_size]
            
            # ×¢×™×‘×•×“ ×”×§×‘×•×¦×”
            batch_tasks = [process_func(item) for item in batch]
            batch_results = await asyncio.gather(*batch_tasks, return_exceptions=True)
            
            results.extend(batch_results)
            
            # ×”××ª× ×” ×‘×™×Ÿ ×§×‘×•×¦×•×ª
            if delay > 0 and i + batch_size < len(items):
                await asyncio.sleep(delay)
        
        return results</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-9">
          <div class="snippet-header">
            <h3 class="snippet-title">9.9 ××“×™×“×ª ×–××Ÿ ×¢× context manager (PerformanceUtils.measure_time)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> × ×•×ª×Ÿ ×“×¨×š ×§×œ×” ×œ××“×•×“ ××©×š ×¤×¢×•×œ×” ×•×œ×¨×©×•× ××•×ª×• ×œ×œ×•×’.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class PerformanceUtils:
    """×›×œ×™× ×œ××“×™×“×ª ×‘×™×¦×•×¢×™×"""
    
    @staticmethod
    @contextmanager
    def measure_time(operation_name: str):
        """××“×™×“×ª ×–××Ÿ ×¢× context manager"""
        
        start_time = time.time()
        try:
            yield
        finally:
            execution_time = time.time() - start_time
            logger.info(f"{operation_name}: {execution_time:.3f}s")</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-10">
          <div class="snippet-header">
            <h3 class="snippet-title">9.10 ×‘×“×™×§×ª ×§×•×“ ××¡×•×›×Ÿ (ValidationUtils.is_safe_code)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××¡×¤×§ ×‘×“×™×§×ª ×‘×˜×™×—×•×ª ×‘×¡×™×¡×™×ª ×œ×§×•×“ ×œ×¤×™ ×©×¤×” ×•××—×–×™×¨ ×”×ª×¨××•×ª ××¤×©×¨×™×•×ª.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class ValidationUtils:
    """×›×œ×™× ×œ×•×•×œ×™×“×¦×™×”"""
    
    @staticmethod
    def is_safe_code(code: str, programming_language: str) -> Tuple[bool, List[str]]:
        """×‘×“×™×§×” ×‘×¡×™×¡×™×ª ×©×œ ×‘×˜×™×—×•×ª ×§×•×“"""
        
        warnings = []
        
        # ×“×¤×•×¡×™× ××¡×•×›× ×™×
        dangerous_patterns = {
            'python': [
                r'exec\s*\(',
                r'eval\s*\(',
                r'__import__\s*\(',
                r'open\s*\([^)]*["\']w',  # ×›×ª×™×‘×” ×œ×§×•×‘×¥
                r'subprocess\.',
                r'os\.system\s*\(',
                r'os\.popen\s*\(',
            ],
            'javascript': [
                r'eval\s*\(',
                r'Function\s*\(',
                r'document\.write\s*\(',
                r'innerHTML\s*=',
                r'outerHTML\s*=',
            ],
            'bash': [
                r'rm\s+-rf',
                r'rm\s+/',
                r'dd\s+if=',
                r'mkfs\.',
                r'fdisk\s+',
            ]
        }
        
        if programming_language in dangerous_patterns:
            for pattern in dangerous_patterns[programming_language]:
                if re.search(pattern, code, re.IGNORECASE):
                    warnings.append(f"×“×¤×•×¡ ××¡×•×›×Ÿ ××¤×©×¨×™: {pattern}")
        
        # ×‘×“×™×§×•×ª ×›×œ×œ×™×•×ª
        if 'password' in code.lower() or 'secret' in code.lower():
            warnings.append("×”×§×•×“ ××›×™×œ ××™×œ×•×ª ×¡×™×¡××” ××• ×¡×•×“")
        
        if re.search(r'https?://\S+', code):
            warnings.append("×”×§×•×“ ××›×™×œ URL×™×")
        
        is_safe = len(warnings) == 0
        return is_safe, warnings</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-11">
          <div class="snippet-header">
            <h3 class="snippet-title">9.11 ×™×¦×™×¨×ª ×§×•×‘×¥ ×–×× ×™ (FileUtils.create_temp_file)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×™×•×¦×¨ ×§×•×‘×¥ ×–×× ×™ ×¢× ×ª×•×›×Ÿ ××—×¨×•×–×ª/×‘×™×™×˜×™× ×•××—×–×™×¨ ××ª ×”× ×ª×™×‘ ×œ×©×™××•×© ××™×™×“×™.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class FileUtils:
    """×›×œ×™× ×œ×¢×‘×•×“×” ×¢× ×§×‘×¦×™×"""
    
    @staticmethod
    async def create_temp_file(content: Union[str, bytes], 
                              suffix: str = "") -> str:
        """×™×¦×™×¨×ª ×§×•×‘×¥ ×–×× ×™"""
        
        with tempfile.NamedTemporaryFile(mode='wb', suffix=suffix, delete=False) as temp_file:
            if isinstance(content, str):
                content = content.encode('utf-8')
            
            temp_file.write(content)
            return temp_file.name</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-12">
          <div class="snippet-header">
            <h3 class="snippet-title">9.12 ×˜×¢×™× ×ª ×§×•×‘×¥ JSON ×¢× ×‘×¨×™×¨×ª ××—×“×œ (ConfigUtils.load_json_config)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> × ×•×— ×œ×§×¨×™××ª ×§×‘×¦×™ ×”×’×“×¨×•×ª ×¢× ×˜×™×¤×•×œ ×‘×©×’×™××•×ª ×•×œ×•×’ ××–×”×¨×” ×× ×”×§×•×‘×¥ ×—×¡×¨.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class ConfigUtils:
    """×›×œ×™× ×œ×§×•× ×¤×™×’×•×¨×¦×™×”"""
    
    @staticmethod
    def load_json_config(file_path: str, default: Optional[Dict[str, Any]] = None) -> Dict[str, Any]:
        """×˜×¢×™× ×ª ×§×•× ×¤×™×’×•×¨×¦×™×” ××§×•×‘×¥ JSON"""
        
        if default is None:
            default = {}
        
        try:
            if os.path.exists(file_path):
                with open(file_path, 'r', encoding='utf-8') as f:
                    return json.load(f)
            else:
                logger.warning(f"×§×•×‘×¥ ×§×•× ×¤×™×’×•×¨×¦×™×” ×œ× × ××¦×: {file_path}")
                return default
        
        except Exception as e:
            logger.error(f"×©×’×™××” ×‘×˜×¢×™× ×ª ×§×•× ×¤×™×’×•×¨×¦×™×”: {e}")
            return default</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-13">
          <div class="snippet-header">
            <h3 class="snippet-title">9.13 ×§××© ×–×™×›×¨×•×Ÿ ×¢× TTL (CacheUtils.set/get)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×××¤×©×¨ ×œ×©××•×¨ ×¢×¨×›×™× ×‘×–×™×›×¨×•×Ÿ ×œ×–××Ÿ ×§×¦×•×‘ ×•×œ×”×¡×™×¨× ××•×˜×•××˜×™×ª ×›×©×”×ª×•×§×£ ×¤×’.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class CacheUtils:
    """×›×œ×™× ×œ×§××© ×–×× ×™"""
    
    _cache: Dict[str, Any] = {}
    _cache_times: Dict[str, float] = {}
    
    @classmethod
    def set(cls, key: str, value: Any, ttl: int = 300):
        """×©××™×¨×” ×‘×§××© ×¢× TTL (×©× ×™×•×ª)"""
        cls._cache[key] = value
        cls._cache_times[key] = time.time() + ttl
    
    @classmethod
    def get(cls, key: str, default: Any = None) -> Any:
        """×§×‘×œ×” ××”×§××©"""
        
        if key not in cls._cache:
            return default
        
        # ×‘×“×™×§×ª ×ª×¤×•×’×”
        if time.time() > cls._cache_times.get(key, 0):
            cls.delete(key)
            return default
        
        return cls._cache[key]

    @classmethod
    def delete(cls, key: str):
        """××—×™×§×” ××”×§××©"""
        cls._cache.pop(key, None)
        cls._cache_times.pop(key, None)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-14">
          <div class="snippet-header">
            <h3 class="snippet-title">9.14 ××¡× ×Ÿ ×œ×•×’×™× ×œ×¨×’×™×©×•×™×•×ª (SensitiveDataFilter)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××˜×©×˜×© ×˜×•×§× ×™× ×—×©×•×¤×™× ×‘×œ×•×’×™× ×œ×¤× ×™ ×©×”× × ×›×ª×‘×™× ×”×—×•×¦×”.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">class SensitiveDataFilter(logging.Filter):
    """××¡× ×Ÿ ×©××˜×©×˜×© ×˜×•×§× ×™× ×•× ×ª×•× ×™× ×¨×’×™×©×™× ×‘×œ×•×’×™×."""
    def filter(self, record: logging.LogRecord) -> bool:
        try:
            msg = str(record.getMessage())
            # ×–×™×”×•×™ ×‘×¡×™×¡×™ ×©×œ ×˜×•×§× ×™×: ghp_..., github_pat_..., Bearer ...
            patterns = [
                (r"ghp_[A-Za-z0-9]{20,}", "ghp_***REDACTED***"),
                (r"github_pat_[A-Za-z0-9_]{20,}", "github_pat_***REDACTED***"),
                (r"Bearer\s+[A-Za-z0-9\-_.=:/+]{10,}", "Bearer ***REDACTED***"),
            ]
            redacted = msg
            import re as _re
            for pat, repl in patterns:
                redacted = _re.sub(pat, repl, redacted)
            # ×¢×“×›×Ÿ ×¨×§ ××ª message ×”×¤×•×¨××˜×™
            record.msg = redacted
            # ×—×©×•×‘: × ×§×” ××¨×’×•×× ×˜×™× ×›×“×™ ×œ×× ×•×¢ × ×™×¡×™×•×Ÿ ×¤×•×¨××˜ ×—×•×–×¨ (%s) ×©×™×•×‘×™×œ ×œ-TypeError
            record.args = ()
        except Exception:
            pass
        return True</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-15">
          <div class="snippet-header">
            <h3 class="snippet-title">9.15 × ×™×¨××•×œ ××¨×’×•×× ×˜×™× ×œ×¤×§×•×“×•×ª (_coerce_command_args)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××ª××™× ×›×©×¦×¨×™×š ×œ×§×‘×œ ××¨×’×•×× ×˜×™× ××¤×§×•×“×ª ×˜×œ×’×¨× ×•×œ×ª××•×š ×‘××¡×¤×¨ ×˜×™×¤×•×¡×™× ×©×•× ×™×.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">def _coerce_command_args(raw_args) -> List[str]:
    """×”××¨×ª args ××¡×•×’×™× ×©×•× ×™× ×œ×¨×©×™××ª ××—×¨×•×–×•×ª × ×§×™×™×”."""
    normalized: List[str] = []
    if raw_args is None:
        return normalized
    try:
        if isinstance(raw_args, (list, tuple, set)):
            iterable = list(raw_args)
        elif isinstance(raw_args, str):
            iterable = [raw_args]
        else:
            try:
                iterable = list(raw_args)
            except TypeError:
                iterable = [raw_args]
    except Exception:
        iterable = []
    for arg in iterable:
        if arg is None:
            continue
        if isinstance(arg, bytes):
            try:
                normalized.append(arg.decode("utf-8"))
                continue
            except Exception:
                normalized.append(arg.decode("utf-8", "ignore"))
                continue
        normalized.append(str(arg))
    return normalized</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-16">
          <div class="snippet-header">
            <h3 class="snippet-title">9.16 ×§×™×¦×•×¨ ×˜×§×¡×˜ ×‘×××¦×¢ (_truncate_middle)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> × ×•×— ×œ×”×¦×’×ª ×©××•×ª ×§×‘×¦×™× ××• ××–×”×™× ××¨×•×›×™× ×ª×•×š ×©××™×¨×” ×¢×œ ×”×”×ª×—×œ×” ×•×”×¡×•×£.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">def _truncate_middle(text: str, max_len: int) -> str:
    """××§×¦×¨ ××—×¨×•×–×ª ×‘×××¦×¢ ×¢× ××œ×™×¤×¡×™×¡ ×× ×—×•×¨×’×ª ×××•×¨×š × ×ª×•×Ÿ."""
    if max_len <= 0:
        return ''
    if len(text) <= max_len:
        return text
    if max_len <= 1:
        return text[:max_len]
    keep = max_len - 1
    front = keep // 2
    back = keep - front
    return text[:front] + 'â€¦' + text[-back:]</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-17">
          <div class="snippet-header">
            <h3 class="snippet-title">9.17 ××¢×§×‘ ×‘×™×¦×•×¢×™× ×¢× Prometheus (track_performance)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> context manager ×©××–×™×Ÿ Histogram ×©×œ Prometheus ×‘×œ×™ ×œ×”×¤×™×œ ××ª ×”×©×™×¨×•×ª ×‘××§×¨×” ×©×œ ×©×’×™××ª ×œ×™×™×‘×œ×™×.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">@contextmanager
def track_performance(operation: str, labels: Optional[Dict[str, str]] = None):
    start = time.time()
    try:
        yield
    finally:
        if operation_latency_seconds is not None:
            try:
                # ×‘×—×¨ ×¨×§ ×œ×™×™×‘×œ×™× ×©××•×’×“×¨×™× ×‘××˜×¨×™×§×” ×•××œ ×ª××¤×©×¨ ×“×¨×™×¡×” ×©×œ 'operation'
                allowed = set(getattr(operation_latency_seconds, "_labelnames", []) or [])
                target = {"operation": operation}
                if labels:
                    for k, v in labels.items():
                        if k in allowed and k != "operation":
                            target[k] = v
                # ×¡×¤×§ ×¢×¨×›×™ ×‘×¨×™×¨×ª ××—×“×œ ×œ×›×œ ×œ×™×™×‘×œ ×—×¡×¨ (×œ××©×œ repo="") ×›×“×™ ×œ×©××•×¨ ×ª××™××•×ª ×œ××—×•×¨
                for name in allowed:
                    if name not in target:
                        if name == "operation":
                            # ×›×‘×¨ ×¡×•×¤×§ ×œ×¢×™×œ
                            continue
                        # ×‘×¨×™×¨×ª ××—×“×œ: ××™×ª×¨ ×¡×× ×˜×™×§×”, ××•× ×¢ ValueError ×¢×œ ×—×•×¡×¨ ×‘×œ×™×™×‘×œ
                        target[name] = ""
                operation_latency_seconds.labels(**target).observe(time.time() - start)
            except Exception:
                # avoid breaking app on label mistakes
                pass</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-18">
          <div class="snippet-header">
            <h3 class="snippet-title">9.18 ×”×¦×¢×ª ×”×©×œ××•×ª ×œ×—×™×¤×•×© ×’×œ×•×‘×œ×™ (fetchSuggestions)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×©×•×œ×— ×‘×§×©×” ××¡×™× ×›×¨×•× ×™×ª ×‘×¦×“ ×”×œ×§×•×— ×•×× ×ª×‘ ×”×ª×—×‘×¨×•×ª ×××•×œ×¦×ª ×‘××§×¨×” ×©×œ 401.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript"><code class="language-javascript">async function fetchSuggestions(q){
  try{
    const res = await fetch('/api/search/suggestions?q=' + encodeURIComponent(q), {
      headers: { 'Accept': 'application/json' },
      credentials: 'same-origin'
    });

    if (res.status === 401 || res.redirected) {
      window.location.href = '/login?next=' + encodeURIComponent(location.pathname + location.search + location.hash);
      return;
    }

    const contentType = res.headers.get('content-type') || '';
    if (!contentType.includes('application/json')) { hideSuggestions(); return; }

    const data = await res.json();
    if (data && data.suggestions && data.suggestions.length){
      showSuggestions(data.suggestions);
    } else hideSuggestions();
  } catch (e){ hideSuggestions(); }
}</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-9-19">
          <div class="snippet-header">
            <h3 class="snippet-title">9.19 ×”×“×’×©×ª ×˜×•×•×—×™× ×‘×ª×•×¦××•×ª ×—×™×¤×•×© (highlightSnippet)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××§×‘×œ ×˜×§×¡×˜ ×’×•×œ××™ ×•××“×’×™×© ×˜×•×•×—×™× ×¨×œ×•×•× ×˜×™×™× ×¢× `<mark>` ××‘×œ×™ ×œ×©×‘×•×¨ HTML.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript"><code class="language-javascript">function highlightSnippet(text, ranges){
  text = String(text || '');
  if (!ranges || !ranges.length) return escapeHtml(text);
  const items = ranges.slice().sort((a,b)=> (a[0]-b[0]));
  let out = '', last = 0;
  for (const [s,e] of items){
    if (s < last) continue;
    out += escapeHtml(text.slice(last, s));
    out += '<mark class="bg-warning">' + escapeHtml(text.slice(s, e)) + '</mark>';
    last = e;
  }
  out += escapeHtml(text.slice(last));
  return out;
}</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 10: Background Jobs ×•-RQ -->
      <div class="category" id="category-10">
        <div class="category-header">
          <i class="fas fa-tasks"></i>
          <h2>Background Jobs ×•-RQ</h2>
        </div>

        <div class="snippet" id="snippet-10-1">
          <div class="snippet-header">
            <h3 class="snippet-title">10.1 RQ Job Definition ×¢× Retry ×•-Timeout</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×™×¦×™×¨×ª background job ×¢× RQ ×›×•×œ×œ retry ××•×˜×•××˜×™ ×•×˜×™×™××××•×˜</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from rq import Retry
from rq.decorators import job
from app.core.cache import redis_queue_sync

@job("default", timeout="10m", retry=Retry(max=3, interval=60), connection=redis_queue_sync)
def process_new_report(report_id: str):
    """
    Process a newly submitted report.
    
    Args:
        report_id: UUID string of the report to process
    """
    logger.info("Processing report", report_id=report_id)
    
    try:
        # Run async code from sync job
        return asyncio.run(_process_new_report_async(report_id))
    except Exception as e:
        logger.error("Failed to process report", report_id=report_id, error=str(e))
        raise  # Re-raise for RQ retry mechanism</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-10-2">
          <div class="snippet-header">
            <h3 class="snippet-title">10.2 Enqueue or Run Inline Pattern</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×ª××™×›×” ×‘-workers ×•×’× ×‘××¦×‘ ×œ×œ× workers (development)</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">def enqueue_or_run(func, *args, **kwargs):
    """
    Enqueue an RQ job when workers enabled, otherwise run inline.
    
    Example:
        enqueue_or_run(process_new_report, report_id=str(report.id))
    """
    if settings.ENABLE_WORKERS:
        # Production: Queue to RQ worker
        return func.delay(*args, **kwargs)
    else:
        # Development: Run inline
        if asyncio.iscoroutinefunction(func):
            return asyncio.create_task(func(*args, **kwargs))
        else:
            return func(*args, **kwargs)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-10-3">
          <div class="snippet-header">
            <h3 class="snippet-title">10.3 RQ Scheduler â€“ Recurring Jobs</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×ª×–××•×Ÿ ××©×™××•×ª ×—×•×–×¨×•×ª (cleanup, stats, sync)</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from rq_scheduler import Scheduler
from app.core.cache import redis_queue_sync

def schedule_recurring_jobs():
    """Schedule recurring background jobs."""
    scheduler = Scheduler(connection=redis_queue_sync)
    
    # Daily cleanup at 2 AM
    scheduler.cron(
        cron_string="0 2 * * *",  # Every day at 2 AM
        func=cleanup_old_data,
        timeout="30m",
        use_local_timezone=False
    )
    
    # Update stats every 6 hours
    scheduler.cron(
        cron_string="0 */6 * * *",
        func=update_organization_stats,
        timeout="10m",
        use_local_timezone=False
    )
    
    logger.info("Recurring jobs scheduled")</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 11: Telegram Bot Patterns -->
      <div class="category" id="category-11">
        <div class="category-header">
          <i class="fas fa-robot"></i>
          <h2>×ª×‘× ×™×•×ª ×‘×•×˜ ×˜×œ×’×¨×</h2>
        </div>

        <div class="snippet" id="snippet-11-1">
          <div class="snippet-header">
            <h3 class="snippet-title">11.1 Maintenance Mode Middleware</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×××¤×©×¨ ×œ×”×›× ×™×¡ ××ª ×”×‘×•×˜ ×œ××¦×‘ ×ª×—×–×•×§×” ×ª×•×š ×©××™×¨×” ×¢×œ ×’×™×©×” ×œ××“××™× ×™×.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript"><code class="language-javascript">const isMaintenanceMode = () => {
  return process.env.MAINTENANCE_MODE === 'true';
};

const isAdmin = (userId) => {
  const admins = (process.env.ADMIN_USER_IDS || '')
    .split(',')
    .map(s => s.trim())
    .filter(Boolean);
  return admins.includes(String(userId));
};

const maintenanceMiddleware = async (msg, next) => {
  if (!isMaintenanceMode() || isAdmin(msg.from.id)) {
    return next();
  }

  await bot.sendMessage(msg.chat.id,
    'ğŸ”§ *×”×‘×•×˜ ×‘××¦×‘ ×ª×—×–×•×§×”*\n\n' +
    '×× ×—× ×• ×¢×•×©×™× ×©×“×¨×•×’ ××”×™×¨ ×œ×‘×•×˜ ğŸš€\n\n' +
    '×”×›×œ ×™×—×–×•×¨ ×œ×¢×‘×•×“ ×ª×•×š ×›××” ×“×§×•×ª.\n\n' +
    '×ª×•×“×” ×¢×œ ×”×¡×‘×œ× ×•×ª! ğŸ˜Š',
    { parse_mode: 'Markdown' }
  );
  return false; // Block further processing
};</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-11-2">
          <div class="snippet-header">
            <h3 class="snippet-title">11.2 Callback Query Router</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> × ×™×ª×•×‘ ××•×˜×•××˜×™ ×©×œ callback queries ×œ×¤×™ prefix, ×—×•×¡×š if-else ××¨×•×›×™× ×•×××¨×’×Ÿ ××ª ×”×§×•×“.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript"><code class="language-javascript">async handleCallbackQuery(query) {
  const chatId = query.message.chat.id;
  const userId = query.from.id;
  const data = query.data;
  const messageId = query.message.message_id;

  // Answer callback to remove loading state
  await this.bot.answerCallbackQuery(query.id);

  // Route based on callback data prefix
  if (data.startsWith('pace_')) {
    await this.handlePaceSelection(chatId, userId, data, messageId);
  } else if (data.startsWith('answer_')) {
    await this.handleQuizAnswer(chatId, userId, data, messageId);
  } else if (data.startsWith('theme_')) {
    await this.handleThemeSelection(chatId, userId, data, messageId);
  } else if (data.startsWith('cheat_')) {
    await this.handleCheatsheetTopic(chatId, userId, data, messageId);
  } else if (data.startsWith('template_')) {
    await this.handleTemplateSelection(chatId, userId, data);
  }
  // ... more routes
}</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-11-3">
          <div class="snippet-header">
            <h3 class="snippet-title">11.3 Safe Send with Fallback</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×©×œ×™×—×ª ×”×•×“×¢×•×ª Markdown ×¢× fallback ××•×˜×•××˜×™ ×œ×˜×§×¡×˜ ×¨×’×™×œ ×× ×™×© ×©×’×™××ª parsing.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript"><code class="language-javascript">async safeSendMarkdown(chatId, text, options = {}) {
  try {
    return await this.bot.sendMessage(chatId, text, { 
      parse_mode: 'Markdown', 
      ...options 
    });
  } catch (err) {
    const desc = String(err?.response?.body?.description || err?.message || '').toLowerCase();
    if (desc.includes("can't parse entities") || desc.includes('parse') || desc.includes('entity')) {
      // Retry without parse mode
      return await this.bot.sendMessage(chatId, text, { ...options });
    }
    throw err;
  }
}</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-11-4">
          <div class="snippet-header">
            <h3 class="snippet-title">11.4 Message Chunking (Split Long Messages)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×˜×œ×’×¨× ××’×‘×™×œ ×”×•×“×¢×•×ª ×œ-4096 ×ª×•×•×™×. ×ª×‘× ×™×ª ×–×• ××—×œ×§×ª ×”×•×“×¢×•×ª ××¨×•×›×•×ª ×œ×—×ª×™×›×•×ª ×ª×•×š ×©××™×¨×” ×¢×œ ×§×¨×™××•×ª.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript"><code class="language-javascript">async sendLongMessage(chatId, text, options = {}) {
  const maxLength = 4000; // Leave room for formatting
  const chunks = [];
  let currentChunk = '';
  const lines = text.split('\n');

  for (const line of lines) {
    if ((currentChunk + line + '\n').length > maxLength) {
      chunks.push(currentChunk);
      currentChunk = line + '\n';
    } else {
      currentChunk += line + '\n';
    }
  }
  if (currentChunk) chunks.push(currentChunk);

  // Send each chunk
  for (let i = 0; i < chunks.length; i++) {
    await this.bot.sendMessage(chatId,
      chunks.length > 1 ? `*×—×œ×§ ${i + 1}/${chunks.length}*\n\n${chunks[i]}` : chunks[i],
      { parse_mode: 'Markdown', ...options }
    );
    await this.sleep(500); // Small delay between messages
  }
}</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-11-5">
          <div class="snippet-header">
            <h3 class="snippet-title">11.5 User Mode Management (State Machine)</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> × ×™×”×•×œ ××¦×‘×™ ××©×ª××© (sandbox, training, submitting_template) ×¢× × ×ª×•× ×™× JSON. ×××¤×©×¨ ×–×¨×™××•×ª ××•×¨×›×‘×•×ª.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript"><code class="language-javascript">// Database schema:
// CREATE TABLE user_modes (
//   user_id INTEGER PRIMARY KEY,
//   current_mode TEXT DEFAULT 'normal',
//   mode_data TEXT,  -- JSON string
//   updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
// )

getUserMode(userId) {
  const stmt = this.db.prepare('SELECT * FROM user_modes WHERE user_id = ?');
  let mode = stmt.get(userId);
  
  if (!mode) {
    const insertStmt = this.db.prepare(`
      INSERT INTO user_modes (user_id, current_mode)
      VALUES (?, 'normal')
    `);
    insertStmt.run(userId);
    mode = { user_id: userId, current_mode: 'normal', mode_data: null };
  }
  
  return mode;
}

setUserMode(userId, mode, modeData = null) {
  const stmt = this.db.prepare(`
    INSERT OR REPLACE INTO user_modes (user_id, current_mode, mode_data, updated_at)
    VALUES (?, ?, ?, CURRENT_TIMESTAMP)
  `);
  stmt.run(userId, mode, modeData ? JSON.stringify(modeData) : null);
}

clearUserMode(userId) {
  this.setUserMode(userId, 'normal', null);
}

// ×©×™××•×©:
const mode = this.db.getUserMode(userId);
if (mode.current_mode === 'sandbox') {
  await this.handleSandboxInput(chatId, userId, text);
} else if (mode.current_mode === 'training') {
  const modeData = JSON.parse(mode.mode_data);
  await this.handleTrainingAnswer(chatId, userId, text, modeData);
}</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-11-6">
          <div class="snippet-header">
            <h3 class="snippet-title">11.6 Progress Bar Generation</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×™×¦×™×¨×ª progress bar ×˜×§×¡×˜×•××œ×™ ×™×¤×” ×œ×”×•×“×¢×•×ª ×˜×œ×’×¨×, ×©×™××•×©×™ ×œ×”×¦×’×ª ×”×ª×§×“××•×ª.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript"><code class="language-javascript">createProgressBar(current, total, barLength = 10) {
  const filledBars = Math.floor((current / total) * barLength);
  const emptyBars = barLength - filledBars;
  return 'â–ˆ'.repeat(filledBars) + 'â–‘'.repeat(emptyBars);
}

// ×©×™××•×©:
const progress = this.db.getUserProgress(userId);
const totalLessons = 14;
const progressBar = this.createProgressBar(
  progress.lessons_completed,
  totalLessons,
  10
);
const message = `ğŸ“ˆ *×”×ª×§×“××•×ª ×‘×©×™×¢×•×¨×™×:*\n${progressBar} ${progressPercentage}%\n${progress.lessons_completed}/${totalLessons} ×©×™×¢×•×¨×™× ×”×•×©×œ××•`;</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-11-7">
          <div class="snippet-header">
            <h3 class="snippet-title">11.7 Multi-Step Form Flow</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×–×¨×™××ª ×”×’×©×ª ×ª×‘× ×™×•×ª/×˜×¤×¡×™× ×¨×‘-×©×œ×‘×™×ª. ×©×™××•×©×™ ×œ×©××œ×•× ×™×, ×”×¨×©××•×ª, ×•×”×’×©×•×ª.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript"><code class="language-javascript">// ×©×œ×‘ 1: ×”×ª×—×œ×”
async handleSubmitTemplate(msg) {
  const userId = msg.from.id;
  this.db.setUserMode(userId, 'submitting_template', JSON.stringify({ step: 'title' }));
  
  await this.bot.sendMessage(chatId,
    'ğŸ“ *×©×œ×‘ 1 ××ª×•×š 4: ×›×•×ª×¨×ª*\n' +
    '××” ×©× ×”×ª×‘× ×™×ª?',
    { parse_mode: 'Markdown' }
  );
}

// ×©×œ×‘ 2: ×˜×™×¤×•×œ ×‘×§×œ×˜
async handleTemplateSubmissionInput(chatId, userId, text, mode) {
  const modeData = JSON.parse(mode.mode_data || '{}');
  const step = modeData.step;

  if (step === 'title') {
    // Validate
    if (text.length < 3 || text.length > 100) {
      await this.bot.sendMessage(chatId, 'âŒ ×”×›×•×ª×¨×ª ×¦×¨×™×›×” ×œ×”×™×•×ª ×‘×™×Ÿ 3 ×œ-100 ×ª×•×•×™×.');
      return;
    }

    // Save and advance
    modeData.title = text;
    modeData.step = 'category';
    this.db.setUserMode(userId, 'submitting_template', JSON.stringify(modeData));

    await this.bot.sendMessage(chatId,
      `âœ… ×›×•×ª×¨×ª × ×©××¨×”: "${text}"\n\n` +
      `ğŸ“ *×©×œ×‘ 2 ××ª×•×š 4: ×§×˜×’×•×¨×™×”*`,
      { parse_mode: 'Markdown' }
    );
  } else if (step === 'category') {
    // ... continue flow
  } else if (step === 'content') {
    // Final step - save and complete
    this.db.createTemplateSubmission(userId, templateId, modeData.title, ...);
    this.db.clearUserMode(userId);
    await this.bot.sendMessage(chatId, 'ğŸ‰ ×ª×‘× ×™×ª × ×©×œ×—×” ×‘×”×¦×œ×—×”!');
  }
}</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 12: Database Async Patterns -->
      <div class="category" id="category-12">
        <div class="category-header">
          <i class="fas fa-database"></i>
          <h2>Database Async Patterns (SQLAlchemy)</h2>
        </div>

        <div class="snippet" id="snippet-12-1">
          <div class="snippet-header">
            <h3 class="snippet-title">12.1 Async Database Session Context Manager</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> × ×™×”×•×œ session ××•×˜×•××˜×™ ×¢× ×¡×’×™×¨×” ×‘×˜×•×—×”</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from sqlalchemy.ext.asyncio import AsyncSession, async_sessionmaker, create_async_engine

# Create async engine
engine = create_async_engine(
    settings.DATABASE_URL,
    pool_size=settings.DATABASE_POOL_SIZE,
    max_overflow=settings.DATABASE_MAX_OVERFLOW,
    pool_timeout=settings.DATABASE_POOL_TIMEOUT,
    echo=settings.DATABASE_ECHO,
    pool_pre_ping=True,  # Validate connections before use
    pool_recycle=3600,   # Recycle connections every hour
)

# Create session factory
async_session_maker = async_sessionmaker(
    engine,
    class_=AsyncSession,
    expire_on_commit=False,
    autoflush=False,
)

# Usage in code
async def some_database_operation():
    async with async_session_maker() as session:
        result = await session.execute(select(User).where(User.id == user_id))
        user = result.scalar_one_or_none()
        
        # Modify user
        user.last_login_at = datetime.now(timezone.utc)
        
        await session.commit()
        await session.refresh(user)
        
        return user</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-12-2">
          <div class="snippet-header">
            <h3 class="snippet-title">12.2 Eager Loading ×¢× selectinload</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×˜×¢×™× ×ª relationships ×‘×©××™×œ×ª×” ××—×ª ×œ×× ×™×¢×ª N+1</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from sqlalchemy.orm import selectinload

async def get_report_with_relations(report_id: uuid.UUID, session: AsyncSession):
    """Get report with all related data loaded."""
    
    query = select(Report).where(Report.id == report_id).options(
        selectinload(Report.reporter),              # Load reporter user
        selectinload(Report.files),                 # Load files
        selectinload(Report.alerts).selectinload(Alert.organization),  # Nested load
        selectinload(Report.assigned_organization)
    )
    
    result = await session.execute(query)
    report = result.scalar_one_or_none()
    
    return report</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-12-3">
          <div class="snippet-header">
            <h3 class="snippet-title">12.3 Complex Filter ×¢× and_ / or_</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×‘× ×™×™×ª ×©××™×œ×ª×•×ª ××•×¨×›×‘×•×ª ×¢× ×ª× ××™× ××¨×•×‘×™×</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from sqlalchemy import select, and_, or_, desc

async def search_reports(
    session: AsyncSession,
    animal_type: Optional[AnimalType] = None,
    urgency_level: Optional[UrgencyLevel] = None,
    city: Optional[str] = None,
    date_from: Optional[datetime] = None,
    status_list: Optional[List[ReportStatus]] = None
):
    """Search reports with multiple filters."""
    
    # Build conditions list
    conditions = []
    
    if animal_type:
        conditions.append(Report.animal_type == animal_type)
    
    if urgency_level:
        conditions.append(Report.urgency_level == urgency_level)
    
    if city:
        conditions.append(Report.city.ilike(f"%{city}%"))
    
    if date_from:
        conditions.append(Report.created_at >= date_from)
    
    if status_list:
        conditions.append(Report.status.in_(status_list))
    
    # Combine all conditions with AND
    query = select(Report)
    if conditions:
        query = query.where(and_(*conditions))
    
    # Order by created_at descending
    query = query.order_by(desc(Report.created_at))
    
    result = await session.execute(query)
    reports = result.scalars().all()
    
    return reports</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-12-4">
          <div class="snippet-header">
            <h3 class="snippet-title">12.4 Database Transaction Pattern</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×‘×™×¦×•×¢ ××¡×¤×¨ ×¤×¢×•×œ×•×ª DB ×›×˜×¨× ×–×§×¦×™×” ××˜×•××™×ª. ××‘×˜×™×— ×¢×§×‘×™×•×ª × ×ª×•× ×™×.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript"><code class="language-javascript">resetUserProgress(userId) {
  const trx = this.db.transaction((uid) => {
    // Reset core progress fields
    const resetStmt = this.db.prepare(`
      UPDATE user_progress
      SET current_lesson = 0,
          total_score = 0,
          level = 'Beginner',
          lessons_completed = 0,
          correct_answers = 0,
          wrong_answers = 0,
          last_lesson_date = NULL
      WHERE user_id = ?
    `);
    resetStmt.run(uid);

    // Clear lesson history and topic performance
    const delHistory = this.db.prepare('DELETE FROM lesson_history WHERE user_id = ?');
    delHistory.run(uid);
    const delTopics = this.db.prepare('DELETE FROM topic_performance WHERE user_id = ?');
    delTopics.run(uid);

    // Reset user mode to normal
    const resetMode = this.db.prepare(`
      INSERT OR REPLACE INTO user_modes (user_id, current_mode, mode_data, updated_at)
      VALUES (?, 'normal', NULL, CURRENT_TIMESTAMP)
    `);
    resetMode.run(uid);
  });

  trx(userId);
}</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-12-5">
          <div class="snippet-header">
            <h3 class="snippet-title">12.5 Upsert with ON CONFLICT</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×¢×“×›×•×Ÿ ××• ×”×•×¡×¤×ª ×¨×©×•××” ×‘×§×¨×™××” ××—×ª. ×©×™××•×©×™ ×œ××¢×§×‘ ×‘×™×¦×•×¢×™×, ×”×¢×“×¤×•×ª ××©×ª××©.</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-javascript"><code class="language-javascript">updateTopicPerformance(userId, topic, isCorrect) {
  const field = isCorrect ? 'correct_count' : 'wrong_count';
  
  const stmt = this.db.prepare(`
    INSERT INTO topic_performance (user_id, topic, ${field}, last_practiced)
    VALUES (?, ?, 1, CURRENT_TIMESTAMP)
    ON CONFLICT(user_id, topic) DO UPDATE SET
      ${field} = ${field} + 1,
      last_practiced = CURRENT_TIMESTAMP
  `);
  
  stmt.run(userId, topic);
}</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 13: Authentication & Security -->
      <div class="category" id="category-13">
        <div class="category-header">
          <i class="fas fa-shield-alt"></i>
          <h2>Authentication & Security</h2>
        </div>

        <div class="snippet" id="snippet-13-1">
          <div class="snippet-header">
            <h3 class="snippet-title">13.1 JWT Token Creation</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×™×¦×™×¨×ª JWT tokens ×××•×‘×˜×—×™×</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import jwt
from datetime import datetime, timezone, timedelta

def create_access_token(
    subject: Union[str, int],
    expires_delta: Optional[timedelta] = None,
    additional_claims: Optional[Dict[str, Any]] = None
) -> str:
    """
    Create JWT access token.
    
    Example:
        token = create_access_token(
            subject=str(user.id),
            expires_delta=timedelta(days=7),
            additional_claims={"role": user.role.value}
        )
    """
    if expires_delta:
        expire = datetime.now(timezone.utc) + expires_delta
    else:
        expire = datetime.now(timezone.utc) + timedelta(days=7)
    
    to_encode = {
        "exp": expire,
        "sub": str(subject),
        "iat": datetime.now(timezone.utc),
        "type": "access",
    }
    
    if additional_claims:
        to_encode.update(additional_claims)
    
    encoded_jwt = jwt.encode(
        to_encode,
        settings.SECRET_KEY,
        algorithm="HS256"
    )
    
    return encoded_jwt</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-13-2">
          <div class="snippet-header">
            <h3 class="snippet-title">13.2 JWT Token Validation Dependency</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ××™××•×ª ××•×˜×•××˜×™ ×©×œ ××©×ª××© ×-JWT</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from fastapi import Depends, HTTPException, status
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials

security = HTTPBearer()

async def get_current_user(
    session: AsyncSession = Depends(get_db_session),
    credentials: Optional[HTTPAuthorizationCredentials] = Depends(security)
) -> Optional[User]:
    """
    Get current authenticated user from JWT token.
    
    Usage:
        @app.get("/protected")
        async def protected_route(user: User = Depends(get_current_user)):
            return {"user_id": str(user.id)}
    """
    if not credentials:
        return None
    
    try:
        # Decode token
        payload = jwt.decode(
            credentials.credentials,
            settings.SECRET_KEY,
            algorithms=["HS256"]
        )
        
        user_id = payload.get("sub")
        if not user_id:
            return None
        
        # Get user from database
        result = await session.execute(
            select(User).where(User.id == uuid.UUID(user_id))
        )
        user = result.scalar_one_or_none()
        
        if not user or not user.is_active:
            return None
        
        # Update last activity
        user.last_login_at = datetime.now(timezone.utc)
        await session.commit()
        
        return user
    
    except Exception as e:
        logger.debug("Authentication failed", error=str(e))
        return None</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-13-3">
          <div class="snippet-header">
            <h3 class="snippet-title">13.3 Role-Based Access Control</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×”×’×‘×œ×ª ×’×™×©×” ×œ×¤×™ ×ª×¤×§×™×“×™×</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">def require_roles(allowed_roles: List[UserRole]):
    """
    Create dependency that requires specific roles.
    
    Usage:
        @app.post("/admin/action")
        async def admin_action(
            user: User = Depends(require_roles([UserRole.SYSTEM_ADMIN]))
        ):
            return {"status": "ok"}
    """
    async def role_checker(current_user: User = Depends(get_current_user)) -> User:
        if not current_user:
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail="Authentication required"
            )
        
        if current_user.role not in allowed_roles:
            logger.warning(
                "Access denied",
                user_id=str(current_user.id),
                user_role=current_user.role.value,
                required_roles=[r.value for r in allowed_roles]
            )
            raise HTTPException(
                status_code=status.HTTP_403_FORBIDDEN,
                detail="Insufficient permissions"
            )
        
        return current_user
    
    return role_checker</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 14: Redis & Caching -->
      <div class="category" id="category-14">
        <div class="category-header">
          <i class="fas fa-memory"></i>
          <h2>Redis & Caching</h2>
        </div>

        <div class="snippet" id="snippet-14-1">
          <div class="snippet-header">
            <h3 class="snippet-title">14.1 Distributed Lock ×¢× Redis</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> × ×¢×™×œ×” ××‘×•×–×¨×ª ×œ×× ×™×¢×ª race conditions</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from contextlib import asynccontextmanager

class DistributedLock:
    """Redis-based distributed lock."""
    
    def __init__(self, key: str, timeout: int = 30):
        self.key = f"lock:{key}"
        self.timeout = timeout
        self.identifier = f"{id(self)}:{time.time()}"
        self._acquired = False
    
    async def acquire(self) -> bool:
        """Acquire the lock."""
        result = await redis_client.set(
            self.key,
            self.identifier,
            nx=True,  # Only set if doesn't exist
            ex=self.timeout  # Expiration
        )
        self._acquired = bool(result)
        return self._acquired
    
    async def release(self) -> bool:
        """Release the lock (only if we own it)."""
        lua_script = """
        if redis.call('GET', KEYS[1]) == ARGV[1] then
            return redis.call('DEL', KEYS[1])
        else
            return 0
        end
        """
        result = await redis_client.eval(lua_script, 1, self.key, self.identifier)
        return bool(result)
    
    async def __aenter__(self):
        if await self.acquire():
            return self
        raise Exception(f"Could not acquire lock: {self.key}")
    
    async def __aexit__(self, exc_type, exc_val, exc_tb):
        await self.release()

# Usage
async with DistributedLock("process_report", timeout=60):
    # Critical section - only one process can execute this at a time
    await process_report_logic()</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 15: Health Checks & Monitoring -->
      <div class="category" id="category-15">
        <div class="category-header">
          <i class="fas fa-heartbeat"></i>
          <h2>Health Checks & Monitoring</h2>
        </div>

        <div class="snippet" id="snippet-15-1">
          <div class="snippet-header">
            <h3 class="snippet-title">15.1 Comprehensive Health Check</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×‘×“×™×§×ª ×‘×¨×™××•×ª ×›×œ ×”×©×™×¨×•×ª×™×</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">@app.get("/health")
async def health_check():
    """Application health check with all services."""
    
    health_data = {
        "status": "healthy",
        "timestamp": datetime.now(timezone.utc).isoformat(),
        "version": settings.APP_VERSION,
        "environment": settings.ENVIRONMENT,
        "services": {}
    }
    
    # Check database
    try:
        db_health = await check_database_health()
        health_data["services"]["database"] = db_health
    except Exception as e:
        health_data["services"]["database"] = {"status": "unhealthy", "error": str(e)}
        health_data["status"] = "degraded"
    
    # Check Redis
    try:
        await redis_client.ping()
        health_data["services"]["redis"] = {"status": "healthy"}
    except Exception as e:
        health_data["services"]["redis"] = {"status": "unhealthy", "error": str(e)}
        health_data["status"] = "degraded"
    
    # Check external APIs
    try:
        google_service = GoogleService()
        if await google_service.test_connection():
            health_data["services"]["google_apis"] = {"status": "healthy"}
        else:
            health_data["services"]["google_apis"] = {"status": "unavailable"}
    except Exception as e:
        health_data["services"]["google_apis"] = {"status": "unhealthy", "error": str(e)}
    
    # Determine overall health
    unhealthy = [name for name, svc in health_data["services"].items() 
                 if svc.get("status") == "unhealthy"]
    
    if unhealthy:
        health_data["status"] = "unhealthy"
        health_data["unhealthy_services"] = unhealthy
    
    status_code = 200 if health_data["status"] in {"healthy", "degraded"} else 503
    
    return JSONResponse(content=health_data, status_code=status_code)</code></pre>
          </div>
        </div>
      </div>

      <!-- Category 16: File Storage & Validation -->
      <div class="category" id="category-16">
        <div class="category-header">
          <i class="fas fa-file-upload"></i>
          <h2>File Storage & Validation</h2>
        </div>

        <div class="snippet" id="snippet-16-1">
          <div class="snippet-header">
            <h3 class="snippet-title">16.1 File Validation with Security Checks</h3>
            <p class="snippet-description"><strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×‘×“×™×§×•×ª ××‘×˜×—×” ×œ×§×‘×¦×™× ×©×¢×•×œ×™× ×œ××¢×¨×›×ª</p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from PIL import Image
from io import BytesIO
import mimetypes

def validate_file(file_data: bytes, filename: str, content_type: str) -> None:
    """
    Validate uploaded file for security and constraints.
    
    Raises:
        ValidationError: If file is invalid
    """
    # Check file size
    max_size = settings.MAX_FILE_SIZE_MB * 1024 * 1024
    if len(file_data) > max_size:
        raise ValidationError(f"File size exceeds {settings.MAX_FILE_SIZE_MB}MB limit")
    
    # Check file type
    if content_type not in settings.ALLOWED_FILE_TYPES:
        raise ValidationError(f"File type {content_type} is not allowed")
    
    # Verify MIME type matches content
    detected_type, _ = mimetypes.guess_type(filename)
    if detected_type and detected_type != content_type:
        logger.warning(
            "MIME type mismatch",
            declared=content_type,
            detected=detected_type
        )
    
    # Security checks for images
    if content_type.startswith('image/'):
        try:
            # Verify it's a valid image
            image = Image.open(BytesIO(file_data))
            image.verify()
            
            # Check dimensions
            if hasattr(image, 'size'):
                width, height = image.size
                if width > 10000 or height > 10000:
                    raise ValidationError("Image dimensions too large")
        
        except Exception as e:
            raise ValidationError(f"Invalid image file: {str(e)}")
    
    # Check for malicious content
    if b'<script' in file_data.lower() or b'javascript:' in file_data.lower():
        raise ValidationError("File contains potentially malicious content")
</code></pre>
          </div>
      </div>

      <!-- Category 17: Webhook Handling & Security -->
      <div class="category" id="category-17">
        <div class="category-header">
          <i class="fas fa-link"></i>
          <h2>Webhook Handling & Security</h2>
        </div>
        <div class="snippet" id="snippet-17-1">
          <div class="snippet-header">
            <h3 class="snippet-title">17.1 Webhook Signature Verification</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×œ×•×•×“× ×©×”×‘×§×©×•×ª ×‘×××ª ××’×™×¢×•×ª ××˜×œ×’×¨× ×•×œ× ××ª×•×§×£
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import hmac
import hashlib
from fastapi import Header, HTTPException

async def verify_telegram_webhook(
    request_body: bytes,
    x_telegram_bot_api_secret_token: str = Header(None)
) -> bool:
    """Verify that webhook request comes from Telegram"""
    expected_token = os.getenv("WEBHOOK_SECRET_TOKEN")
    
    if not x_telegram_bot_api_secret_token:
        raise HTTPException(401, "Missing secret token")
    
    if not hmac.compare_digest(
        x_telegram_bot_api_secret_token, 
        expected_token
    ):
        raise HTTPException(403, "Invalid secret token")
    
    return True</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-17-2">
          <div class="snippet-header">
            <h3 class="snippet-title">17.2 Webhook Retry Mechanism</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×œ×˜×¤×œ ×‘×›×©×œ×™× ×–×× ×™×™× ×•×œ×•×•×“× ×©××£ ×¢×“×›×•×Ÿ ×œ× ××•×‘×“
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from tenacity import retry, stop_after_attempt, wait_exponential

@retry(
    stop=stop_after_attempt(3),
    wait=wait_exponential(multiplier=1, min=2, max=10),
    reraise=True
)
async def process_webhook_update(update: dict):
    """Process update with automatic retry on failure"""
    try:
        await handle_update(update)
    except Exception as e:
        logger.error(f"Failed processing update {update.get('update_id')}: {e}")
        raise  # Will trigger retry</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-17-3">
          <div class="snippet-header">
            <h3 class="snippet-title">17.3 Webhook Health Monitoring</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×œ×¢×§×•×‘ ××—×¨×™ ×‘×¨×™××•×ª ×”-webhook ×•×œ×–×”×•×ª ×‘×¢×™×•×ª ××•×§×“×
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from datetime import datetime, timedelta
from collections import deque

class WebhookHealthMonitor:
    def __init__(self, window_minutes=5):
        self.requests = deque(maxlen=1000)
        self.errors = deque(maxlen=1000)
        self.window = timedelta(minutes=window_minutes)
    
    def record_request(self, success: bool = True):
        now = datetime.now()
        self.requests.append(now)
        if not success:
            self.errors.append(now)
    
    def get_health_status(self) -> dict:
        now = datetime.now()
        cutoff = now - self.window
        
        recent_requests = sum(1 for t in self.requests if t > cutoff)
        recent_errors = sum(1 for t in self.errors if t > cutoff)
        
        error_rate = recent_errors / recent_requests if recent_requests else 0
        
        return {
            "status": "healthy" if error_rate < 0.05 else "degraded",
            "requests_per_minute": recent_requests / self.window.seconds * 60,
            "error_rate": error_rate,
            "last_request": max(self.requests) if self.requests else None
        }</code></pre>
          </div>
        </div>

      </div>


      <!-- Category 18: Rate Limiting ××ª×§×“× -->
      <div class="category" id="category-18">
        <div class="category-header">
          <i class="fas fa-tachometer-alt"></i>
          <h2>Rate Limiting ××ª×§×“×</h2>
        </div>
        <div class="snippet" id="snippet-18-1">
          <div class="snippet-header">
            <h3 class="snippet-title">18.1 Token Bucket Algorithm</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×œ×× ×•×¢ spam ×•×”×¦×¤×” ×ª×•×š ×©××™×¨×” ×¢×œ ×—×•×•×™×ª ××©×ª××© ×˜×•×‘×”
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import time
from collections import defaultdict

class TokenBucket:
    def __init__(self, capacity: int, refill_rate: float):
        self.capacity = capacity
        self.refill_rate = refill_rate  # tokens per second
        self.buckets = defaultdict(lambda: {
            'tokens': capacity,
            'last_refill': time.time()
        })
    
    def consume(self, key: str, tokens: int = 1) -> bool:
        bucket = self.buckets[key]
        now = time.time()
        
        # Refill tokens
        time_passed = now - bucket['last_refill']
        bucket['tokens'] = min(
            self.capacity,
            bucket['tokens'] + time_passed * self.refill_rate
        )
        bucket['last_refill'] = now
        
        # Try to consume
        if bucket['tokens'] >= tokens:
            bucket['tokens'] -= tokens
            return True
        return False</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-18-2">
          <div class="snippet-header">
            <h3 class="snippet-title">18.2 Rate Limiting Per User/Chat</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×œ×”×’×‘×™×œ ×›×œ ××©×ª××©/×¦'××˜ ×‘× ×¤×¨×“ ×•×œ× ××ª ×›×œ ×”×‘×•×˜
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from functools import wraps
from telegram import Update

class UserRateLimiter:
    def __init__(self, max_requests: int, window_seconds: int):
        self.bucket = TokenBucket(
            capacity=max_requests,
            refill_rate=max_requests / window_seconds
        )
    
    def __call__(self, func):
        @wraps(func)
        async def wrapper(update: Update, context):
            user_id = update.effective_user.id
            
            if not self.bucket.consume(f"user:{user_id}"):
                await update.message.reply_text(
                    "â³ Too many requests. Please wait a moment."
                )
                return
            
            return await func(update, context)
        return wrapper

# Usage
@UserRateLimiter(max_requests=10, window_seconds=60)
async def handle_command(update: Update, context):
    await update.message.reply_text("Processing...")</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-18-3">
          <div class="snippet-header">
            <h3 class="snippet-title">18.3 Distributed Rate Limiting with Redis</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×œ×©×ª×£ ××’×‘×œ×•×ª ×‘×™×Ÿ ××¡×¤×¨ ×©×¨×ª×™×/workers
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import redis.asyncio as redis
from datetime import timedelta

class RedisRateLimiter:
    def __init__(self, redis_client: redis.Redis):
        self.redis = redis_client
    
    async def is_allowed(
        self, 
        key: str, 
        max_requests: int, 
        window: timedelta
    ) -> bool:
        pipe = self.redis.pipeline()
        now = int(time.time())
        window_start = now - int(window.total_seconds())
        
        # Remove old entries
        pipe.zremrangebyscore(key, 0, window_start)
        # Count current requests
        pipe.zcard(key)
        # Add current request
        pipe.zadd(key, {str(now): now})
        # Set expiry
        pipe.expire(key, window)
        
        results = await pipe.execute()
        request_count = results[1]
        
        return request_count < max_requests

# Usage
limiter = RedisRateLimiter(redis_client)
if await limiter.is_allowed(f"user:{user_id}", 20, timedelta(minutes=1)):
    # Process request
    pass</code></pre>
          </div>
        </div>

      </div>


      <!-- Category 19: Retry & Circuit Breaker Patterns -->
      <div class="category" id="category-19">
        <div class="category-header">
          <i class="fas fa-redo"></i>
          <h2>Retry & Circuit Breaker Patterns</h2>
        </div>
        <div class="snippet" id="snippet-19-1">
          <div class="snippet-header">
            <h3 class="snippet-title">19.1 Exponential Backoff Retry</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×œ× ×¡×•×ª ×©×•×‘ ×‘×¦×•×¨×” ×—×›××” ×›×©×™×© ×›×©×œ×•×Ÿ ×–×× ×™
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import asyncio
import random
from typing import TypeVar, Callable

T = TypeVar('T')

async def retry_with_backoff(
    func: Callable[..., T],
    max_retries: int = 3,
    base_delay: float = 1.0,
    max_delay: float = 60.0,
    *args, **kwargs
) -> T:
    """Retry with exponential backoff and jitter"""
    for attempt in range(max_retries):
        try:
            return await func(*args, **kwargs)
        except Exception as e:
            if attempt == max_retries - 1:
                raise
            
            # Calculate delay with jitter
            delay = min(base_delay * (2 ** attempt), max_delay)
            jitter = random.uniform(0, delay * 0.1)
            wait_time = delay + jitter
            
            logger.warning(
                f"Attempt {attempt + 1} failed: {e}. "
                f"Retrying in {wait_time:.2f}s..."
            )
            await asyncio.sleep(wait_time)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-19-2">
          <div class="snippet-header">
            <h3 class="snippet-title">19.2 Circuit Breaker Pattern</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×œ×”×¤×¡×™×§ ×œ× ×¡×•×ª ×›×©×”×©×™×¨×•×ª × ×•×¤×œ, ×œ×—×¡×•×š ××©××‘×™×
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from enum import Enum
from datetime import datetime, timedelta

class CircuitState(Enum):
    CLOSED = "closed"  # Normal operation
    OPEN = "open"      # Blocking requests
    HALF_OPEN = "half_open"  # Testing recovery

class CircuitBreaker:
    def __init__(
        self, 
        failure_threshold: int = 5,
        timeout: timedelta = timedelta(seconds=60),
        success_threshold: int = 2
    ):
        self.failure_threshold = failure_threshold
        self.timeout = timeout
        self.success_threshold = success_threshold
        
        self.failure_count = 0
        self.success_count = 0
        self.state = CircuitState.CLOSED
        self.opened_at = None
    
    async def call(self, func, *args, **kwargs):
        if self.state == CircuitState.OPEN:
            if datetime.now() - self.opened_at > self.timeout:
                self.state = CircuitState.HALF_OPEN
                self.success_count = 0
            else:
                raise Exception("Circuit breaker is OPEN")
        
        try:
            result = await func(*args, **kwargs)
            self._on_success()
            return result
        except Exception as e:
            self._on_failure()
            raise
    
    def _on_success(self):
        self.failure_count = 0
        if self.state == CircuitState.HALF_OPEN:
            self.success_count += 1
            if self.success_count >= self.success_threshold:
                self.state = CircuitState.CLOSED
    
    def _on_failure(self):
        self.failure_count += 1
        if self.failure_count >= self.failure_threshold:
            self.state = CircuitState.OPEN
            self.opened_at = datetime.now()</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-19-3">
          <div class="snippet-header">
            <h3 class="snippet-title">19.3 Retry Decorator with Jitter</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×“×§×•×¨×˜×•×¨ × ×•×— ×œ×©×™××•×© ×—×•×–×¨ ×‘×›×œ ×”×¤×¨×•×™×§×˜
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from functools import wraps
import asyncio
import random

def async_retry(
    max_attempts: int = 3,
    base_delay: float = 1.0,
    exceptions: tuple = (Exception,)
):
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            for attempt in range(max_attempts):
                try:
                    return await func(*args, **kwargs)
                except exceptions as e:
                    if attempt == max_attempts - 1:
                        raise
                    
                    delay = base_delay * (2 ** attempt)
                    jitter = random.uniform(0, delay * 0.3)
                    await asyncio.sleep(delay + jitter)
                    
                    logger.info(f"Retry {attempt + 1}/{max_attempts} for {func.__name__}")
        return wrapper
    return decorator

# Usage
@async_retry(max_attempts=3, base_delay=2.0)
async def send_telegram_message(chat_id, text):
    await bot.send_message(chat_id, text)</code></pre>
          </div>
        </div>

      </div>


      <!-- Category 20: Telegram Inline Queries -->
      <div class="category" id="category-20">
        <div class="category-header">
          <i class="fas fa-search"></i>
          <h2>Telegram Inline Queries</h2>
        </div>
        <div class="snippet" id="snippet-20-1">
          <div class="snippet-header">
            <h3 class="snippet-title">20.1 Inline Query Handler with Caching</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×œ×©×¤×¨ ×‘×™×¦×•×¢×™× ×•×œ×”×¤×—×™×ª ×¢×•××¡ ×¢×œ ×”×©×¨×ª/API
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from telegram import InlineQueryResultArticle, InputTextMessageContent
from telegram.ext import InlineQueryHandler
from functools import lru_cache
from hashlib import md5

class CachedInlineQueryHandler:
    def __init__(self, cache_ttl: int = 300):
        self.cache = {}
        self.cache_ttl = cache_ttl
    
    @staticmethod
    def _cache_key(query: str) -> str:
        return md5(query.encode()).hexdigest()
    
    async def handle_inline_query(self, update, context):
        query = update.inline_query.query
        
        if not query:
            return
        
        # Check cache
        cache_key = self._cache_key(query)
        cached = self.cache.get(cache_key)
        
        if cached and time.time() - cached['time'] < self.cache_ttl:
            results = cached['results']
        else:
            # Perform search
            results = await self.search_content(query)
            self.cache[cache_key] = {
                'results': results,
                'time': time.time()
            }
        
        await update.inline_query.answer(results, cache_time=self.cache_ttl)
    
    async def search_content(self, query: str) -> list:
        """Override this with your search logic"""
        return [
            InlineQueryResultArticle(
                id=str(i),
                title=f"Result {i}",
                input_message_content=InputTextMessageContent(f"Content: {query}")
            )
            for i in range(5)
        ]</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-20-2">
          <div class="snippet-header">
            <h3 class="snippet-title">20.2 Inline Result Pagination</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×œ××¤×©×¨ ×’×œ×™×œ×” ×“×¨×š ×ª×•×¦××•×ª ×¨×‘×•×ª ×‘-inline mode
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from telegram import InlineQueryResultsButton, InlineQueryResultArticle
from uuid import uuid4

class InlineQueryPaginator:
    def __init__(self, page_size: int = 10):
        self.page_size = page_size
        self.results_cache = {}  # Store full results temporarily
    
    async def handle_paginated_query(self, update, context):
        query = update.inline_query.query
        offset = update.inline_query.offset or "0"
        
        # Get or generate all results
        session_id = str(uuid4())
        if offset == "0":
            all_results = await self.fetch_all_results(query)
            self.results_cache[session_id] = all_results
        else:
            session_id = offset.split(":")[0]
            all_results = self.results_cache.get(session_id, [])
        
        # Parse offset
        start = int(offset.split(":")[-1]) if ":" in offset else 0
        end = start + self.page_size
        
        # Slice results
        page_results = all_results[start:end]
        
        # Calculate next offset
        next_offset = f"{session_id}:{end}" if end < len(all_results) else ""
        
        await update.inline_query.answer(
            page_results,
            next_offset=next_offset,
            cache_time=10
        )
    
    async def fetch_all_results(self, query: str) -> list:
        """Fetch all matching results"""
        # Your search logic here
        return []</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-20-3">
          <div class="snippet-header">
            <h3 class="snippet-title">20.3 Inline Query Rate Limiting</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×œ×× ×•×¢ ×©×™××•×© ×œ×¨×¢×” ×‘-inline queries
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from telegram.ext import InlineQueryHandler
from collections import defaultdict
import time

class RateLimitedInlineHandler:
    def __init__(self, max_queries: int = 30, window: int = 60):
        self.max_queries = max_queries
        self.window = window
        self.user_queries = defaultdict(list)
    
    async def handle_inline_query(self, update, context):
        user_id = update.inline_query.from_user.id
        now = time.time()
        
        # Clean old entries
        self.user_queries[user_id] = [
            t for t in self.user_queries[user_id]
            if now - t < self.window
        ]
        
        # Check limit
        if len(self.user_queries[user_id]) >= self.max_queries:
            await update.inline_query.answer(
                [],
                switch_pm_text="âš ï¸ Rate limit exceeded",
                switch_pm_parameter="rate_limit"
            )
            return
        
        # Record query
        self.user_queries[user_id].append(now)
        
        # Process normally
        results = await self.process_query(update.inline_query.query)
        await update.inline_query.answer(results)</code></pre>
          </div>
        </div>

      </div>


      <!-- Category 21: Message Scheduling & Delayed Tasks -->
      <div class="category" id="category-21">
        <div class="category-header">
          <i class="fas fa-clock"></i>
          <h2>Message Scheduling & Delayed Tasks</h2>
        </div>
        <div class="snippet" id="snippet-21-1">
          <div class="snippet-header">
            <h3 class="snippet-title">21.1 Schedule Messages for Future</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×œ×©×œ×•×— ×”×•×“×¢×•×ª ×‘×–××Ÿ ××•×’×“×¨ ××¨××©
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from apscheduler.schedulers.asyncio import AsyncIOScheduler
from apscheduler.triggers.date import DateTrigger
from datetime import datetime

class MessageScheduler:
    def __init__(self, bot):
        self.bot = bot
        self.scheduler = AsyncIOScheduler()
        self.scheduler.start()
    
    def schedule_message(
        self, 
        chat_id: int, 
        text: str, 
        send_at: datetime,
        job_id: str = None
    ) -> str:
        """Schedule a message to be sent at specific time"""
        job_id = job_id or f"msg_{chat_id}_{int(send_at.timestamp())}"
        
        self.scheduler.add_job(
            self._send_message,
            trigger=DateTrigger(run_date=send_at),
            args=[chat_id, text],
            id=job_id,
            replace_existing=True
        )
        
        return job_id
    
    async def _send_message(self, chat_id: int, text: str):
        try:
            await self.bot.send_message(chat_id, text)
        except Exception as e:
            logger.error(f"Failed to send scheduled message: {e}")
    
    def cancel_scheduled_message(self, job_id: str) -> bool:
        try:
            self.scheduler.remove_job(job_id)
            return True
        except:
            return False

# Usage
scheduler = MessageScheduler(bot)
scheduler.schedule_message(
    chat_id=123456,
    text="Reminder: Meeting in 10 minutes!",
    send_at=datetime.now() + timedelta(hours=1)
)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-21-2">
          <div class="snippet-header">
            <h3 class="snippet-title">21.2 Delayed Job Execution</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×œ×”×¨×™×¥ ××©×™××•×ª ×œ××—×¨ ×”×©×”×™×™×” ××•×’×“×¨×ª
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import asyncio
from typing import Callable, Any

class DelayedJobQueue:
    def __init__(self):
        self.tasks = {}
    
    async def schedule_delayed(
        self,
        job_id: str,
        func: Callable,
        delay_seconds: float,
        *args,
        **kwargs
    ):
        """Execute function after delay"""
        # Cancel existing job with same ID
        if job_id in self.tasks:
            self.tasks[job_id].cancel()
        
        async def delayed_execution():
            await asyncio.sleep(delay_seconds)
            try:
                await func(*args, **kwargs)
            finally:
                self.tasks.pop(job_id, None)
        
        task = asyncio.create_task(delayed_execution())
        self.tasks[job_id] = task
        return task
    
    def cancel_job(self, job_id: str) -> bool:
        if job_id in self.tasks:
            self.tasks[job_id].cancel()
            self.tasks.pop(job_id)
            return True
        return False

# Usage
queue = DelayedJobQueue()
await queue.schedule_delayed(
    job_id=f"delete_msg_{chat_id}_{msg_id}",
    func=bot.delete_message,
    delay_seconds=300,  # 5 minutes
    chat_id=chat_id,
    message_id=msg_id
)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-21-3">
          <div class="snippet-header">
            <h3 class="snippet-title">21.3 Recurring Tasks</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×œ×”×¨×™×¥ ××©×™××•×ª ×—×•×–×¨×•×ª ×‘××¨×•×•×—×™ ×–××Ÿ ×§×‘×•×¢×™×
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from apscheduler.schedulers.asyncio import AsyncIOScheduler
from apscheduler.triggers.cron import CronTrigger
from apscheduler.triggers.interval import IntervalTrigger

class RecurringTaskManager:
    def __init__(self):
        self.scheduler = AsyncIOScheduler()
        self.scheduler.start()
    
    def add_daily_task(
        self, 
        func: Callable, 
        hour: int, 
        minute: int = 0,
        job_id: str = None
    ):
        """Run task daily at specific time"""
        self.scheduler.add_job(
            func,
            trigger=CronTrigger(hour=hour, minute=minute),
            id=job_id,
            replace_existing=True
        )
    
    def add_interval_task(
        self,
        func: Callable,
        minutes: int = None,
        hours: int = None,
        job_id: str = None
    ):
        """Run task at regular intervals"""
        self.scheduler.add_job(
            func,
            trigger=IntervalTrigger(minutes=minutes, hours=hours),
            id=job_id,
            replace_existing=True
        )
    
    def remove_task(self, job_id: str):
        self.scheduler.remove_job(job_id)

# Usage
tasks = RecurringTaskManager()

# Send daily summary at 9 AM
tasks.add_daily_task(
    send_daily_summary,
    hour=9,
    minute=0,
    job_id="daily_summary"
)

# Check for updates every 30 minutes
tasks.add_interval_task(
    check_updates,
    minutes=30,
    job_id="update_checker"
)</code></pre>
          </div>
        </div>

      </div>


      <!-- Category 22: Database Migrations -->
      <div class="category" id="category-22">
        <div class="category-header">
          <i class="fas fa-database"></i>
          <h2>Database Migrations</h2>
        </div>
        <div class="snippet" id="snippet-22-1">
          <div class="snippet-header">
            <h3 class="snippet-title">22.1 Alembic Migration Patterns</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> × ×™×”×•×œ ×©×™× ×•×™×™ ××‘× ×” DB ×‘××•×¤×Ÿ ×‘×˜×•×— ×•××‘×•×§×¨
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python"># alembic/env.py helper
from alembic import context
from sqlalchemy import engine_from_config, pool
from logging.config import fileConfig

def run_migrations_online():
    """Run migrations in 'online' mode with connection pooling"""
    connectable = engine_from_config(
        context.config.get_section(context.config.config_ini_section),
        prefix="sqlalchemy.",
        poolclass=pool.NullPool,
    )

    with connectable.connect() as connection:
        context.configure(
            connection=connection,
            target_metadata=target_metadata,
            compare_type=True,  # Detect column type changes
            compare_server_default=True,  # Detect default changes
            include_schemas=True,  # Support multiple schemas
        )

        with context.begin_transaction():
            context.run_migrations()

# Migration file pattern for adding column with data
def upgrade():
    # Add column as nullable first
    op.add_column('users', sa.Column('status', sa.String(20), nullable=True))
    
    # Populate existing rows
    op.execute("UPDATE users SET status = 'active' WHERE status IS NULL")
    
    # Make it non-nullable
    op.alter_column('users', 'status', nullable=False)

def downgrade():
    op.drop_column('users', 'status')</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-22-2">
          <div class="snippet-header">
            <h3 class="snippet-title">22.2 Data Migration Helpers</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×œ×”×¢×‘×™×¨ ×•×œ×”××™×¨ ×“××˜×” ×‘×¦×•×¨×” ×‘×˜×•×—×” ×‘××”×œ×š migration
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from alembic import op
import sqlalchemy as sa
from sqlalchemy.sql import table, column

def batch_update_data(
    table_name: str,
    update_column: str,
    condition_column: str,
    update_func: Callable,
    batch_size: int = 1000
):
    """Update data in batches to avoid locking table"""
    conn = op.get_bind()
    
    # Create table reference
    t = table(
        table_name,
        column('id', sa.Integer),
        column(condition_column),
        column(update_column)
    )
    
    offset = 0
    while True:
        # Fetch batch
        rows = conn.execute(
            sa.select(t.c.id, t.c[condition_column])
            .limit(batch_size)
            .offset(offset)
        ).fetchall()
        
        if not rows:
            break
        
        # Update batch
        for row in rows:
            new_value = update_func(row[1])
            conn.execute(
                t.update()
                .where(t.c.id == row[0])
                .values({update_column: new_value})
            )
        
        offset += batch_size

# Usage in migration
def upgrade():
    op.add_column('messages', sa.Column('processed_text', sa.Text))
    
    batch_update_data(
        'messages',
        update_column='processed_text',
        condition_column='raw_text',
        update_func=lambda text: text.strip().lower()
    )</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-22-3">
          <div class="snippet-header">
            <h3 class="snippet-title">22.3 Rollback Strategies</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×œ×•×•×“× ×©××¤×©×¨ ×œ×—×–×•×¨ ××—×•×¨×” ×‘×¦×•×¨×” ×‘×˜×•×—×”
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">def safe_migration_with_backup():
    """Pattern for safe migration with backup table"""
    # Create backup table
    op.execute("""
        CREATE TABLE users_backup AS 
        SELECT * FROM users
    """)
    
    try:
        # Perform migration
        op.add_column('users', sa.Column('new_field', sa.String(100)))
        op.execute("UPDATE users SET new_field = old_field || '_processed'")
        op.drop_column('users', 'old_field')
        
        # Drop backup if successful
        op.execute("DROP TABLE users_backup")
    except Exception as e:
        # Restore from backup
        op.execute("DROP TABLE users")
        op.execute("ALTER TABLE users_backup RENAME TO users")
        raise

def downgrade():
    """Always include meaningful downgrade"""
    # Re-add old column
    op.add_column('users', sa.Column('old_field', sa.String(100)))
    
    # Reverse data transformation
    op.execute("""
        UPDATE users 
        SET old_field = REPLACE(new_field, '_processed', '')
    """)
    
    # Remove new column
    op.drop_column('users', 'new_field')</code></pre>
          </div>
        </div>

      </div>


      <!-- Category 23: API Client Patterns -->
      <div class="category" id="category-23">
        <div class="category-header">
          <i class="fas fa-plug"></i>
          <h2>API Client Patterns</h2>
        </div>
        <div class="snippet" id="snippet-23-1">
          <div class="snippet-header">
            <h3 class="snippet-title">23.1 Async HTTP Client with Retry</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> client ×××™×Ÿ ×œ×§×¨×™××•×ª API ×¢× ×˜×™×¤×•×œ ××•×˜×•××˜×™ ×‘×©×’×™××•×ª
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import aiohttp
from typing import Optional, Dict, Any
import asyncio

class ResilientAPIClient:
    def __init__(
        self, 
        base_url: str, 
        timeout: int = 30,
        max_retries: int = 3
    ):
        self.base_url = base_url
        self.timeout = aiohttp.ClientTimeout(total=timeout)
        self.max_retries = max_retries
        self.session: Optional[aiohttp.ClientSession] = None
    
    async def __aenter__(self):
        self.session = aiohttp.ClientSession(timeout=self.timeout)
        return self
    
    async def __aexit__(self, *args):
        await self.session.close()
    
    async def request(
        self, 
        method: str, 
        endpoint: str,
        **kwargs
    ) -> Dict[Any, Any]:
        """Make HTTP request with retry logic"""
        url = f"{self.base_url}/{endpoint.lstrip('/')}"
        
        for attempt in range(self.max_retries):
            try:
                async with self.session.request(method, url, **kwargs) as resp:
                    resp.raise_for_status()
                    return await resp.json()
            
            except aiohttp.ClientError as e:
                if attempt == self.max_retries - 1:
                    raise
                
                wait = 2 ** attempt
                logger.warning(f"Request failed, retry {attempt + 1} in {wait}s")
                await asyncio.sleep(wait)
        
    async def get(self, endpoint: str, **kwargs):
        return await self.request("GET", endpoint, **kwargs)
    
    async def post(self, endpoint: str, **kwargs):
        return await self.request("POST", endpoint, **kwargs)

# Usage
async with ResilientAPIClient("https://api.example.com") as client:
    data = await client.get("/users/123")</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-23-2">
          <div class="snippet-header">
            <h3 class="snippet-title">23.2 Request/Response Logging</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×œ×¢×§×•×‘ ××—×¨×™ ×›×œ ×”×§×¨×™××•×ª ×œ-API ×œ×¦×•×¨×š debug ×•×× ×œ×™×–×”
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import json
import logging
from functools import wraps
from time import time

class APILogger:
    def __init__(self, logger_name: str = "api_client"):
        self.logger = logging.getLogger(logger_name)
    
    def log_request_response(self, func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            start_time = time()
            
            # Log request
            self.logger.info(
                f"API Request: {func.__name__}",
                extra={
                    "args": str(args)[:200],
                    "kwargs": {k: str(v)[:100] for k, v in kwargs.items()}
                }
            )
            
            try:
                response = await func(*args, **kwargs)
                duration = time() - start_time
                
                # Log successful response
                self.logger.info(
                    f"API Response: {func.__name__} completed",
                    extra={
                        "duration_ms": int(duration * 1000),
                        "response_size": len(str(response))
                    }
                )
                
                return response
                
            except Exception as e:
                duration = time() - start_time
                
                # Log error
                self.logger.error(
                    f"API Error: {func.__name__} failed",
                    extra={
                        "duration_ms": int(duration * 1000),
                        "error": str(e),
                        "error_type": type(e).__name__
                    },
                    exc_info=True
                )
                raise
        
        return wrapper

# Usage
api_logger = APILogger()

class MyAPIClient:
    @api_logger.log_request_response
    async def get_user(self, user_id: int):
        # API call logic
        pass</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-23-3">
          <div class="snippet-header">
            <h3 class="snippet-title">23.3 API Rate Limiting Compliance</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×œ×›×‘×“ ××ª ××’×‘×œ×•×ª ×”-API ×•×œ×× ×•×¢ blocking
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import asyncio
from datetime import datetime, timedelta
from collections import deque

class APIRateLimiter:
    def __init__(self, requests_per_second: int):
        self.rate = requests_per_second
        self.requests = deque()
        self.lock = asyncio.Lock()
    
    async def acquire(self):
        """Wait until we can make another request"""
        async with self.lock:
            now = datetime.now()
            
            # Remove requests older than 1 second
            while self.requests and now - self.requests[0] > timedelta(seconds=1):
                self.requests.popleft()
            
            # If at limit, wait
            if len(self.requests) >= self.rate:
                sleep_time = 1 - (now - self.requests[0]).total_seconds()
                if sleep_time > 0:
                    await asyncio.sleep(sleep_time)
                self.requests.popleft()
            
            self.requests.append(datetime.now())

class RateLimitedClient:
    def __init__(self, requests_per_second: int = 10):
        self.limiter = APIRateLimiter(requests_per_second)
    
    async def call_api(self, endpoint: str):
        await self.limiter.acquire()
        # Make actual API call
        return await self._make_request(endpoint)

# Usage with multiple requests
client = RateLimitedClient(requests_per_second=20)
tasks = [client.call_api(f"/endpoint/{i}") for i in range(100)]
results = await asyncio.gather(*tasks)  # Will respect rate limit</code></pre>
          </div>
        </div>

      </div>


      <!-- Category 24: Decorators ×©×™××•×©×™×™× -->
      <div class="category" id="category-24">
        <div class="category-header">
          <i class="fas fa-magic"></i>
          <h2>Decorators ×©×™××•×©×™×™×</h2>
        </div>
        <div class="snippet" id="snippet-24-1">
          <div class="snippet-header">
            <h3 class="snippet-title">24.1 @retry, @timeout, @cache</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×“×§×•×¨×˜×•×¨×™× ××•×›× ×™× ×œ×©×™××•×© ×œ× ×™×”×•×œ ×©×’×™××•×ª ×•×‘×™×¦×•×¢×™×
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import asyncio
from functools import wraps
from typing import Optional
import time

def retry(attempts: int = 3, delay: float = 1.0):
    """Retry decorator for async functions"""
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            for attempt in range(attempts):
                try:
                    return await func(*args, **kwargs)
                except Exception as e:
                    if attempt == attempts - 1:
                        raise
                    await asyncio.sleep(delay * (attempt + 1))
        return wrapper
    return decorator

def timeout(seconds: float):
    """Timeout decorator for async functions"""
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            try:
                return await asyncio.wait_for(
                    func(*args, **kwargs),
                    timeout=seconds
                )
            except asyncio.TimeoutError:
                raise TimeoutError(
                    f"{func.__name__} exceeded {seconds}s timeout"
                )
        return wrapper
    return decorator

def cache(ttl: Optional[int] = None):
    """Simple cache decorator with optional TTL"""
    cache_data = {}
    
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            key = str(args) + str(kwargs)
            
            if key in cache_data:
                cached_time, cached_value = cache_data[key]
                if ttl is None or time.time() - cached_time < ttl:
                    return cached_value
            
            result = await func(*args, **kwargs)
            cache_data[key] = (time.time(), result)
            return result
        
        return wrapper
    return decorator

# Usage
@retry(attempts=3)
@timeout(10)
@cache(ttl=300)
async def fetch_user_data(user_id: int):
    # Will retry up to 3 times, timeout after 10s, cache for 5 minutes
    return await api.get(f"/users/{user_id}")</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-24-2">
          <div class="snippet-header">
            <h3 class="snippet-title">24.2 @require_auth, @admin_only</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×‘×§×¨×ª ×’×™×©×” ×¤×©×•×˜×” ×•×™×¢×™×œ×”
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from functools import wraps
from telegram import Update
from telegram.ext import ContextTypes

def require_auth(func):
    """Require user to be registered"""
    @wraps(func)
    async def wrapper(update: Update, context: ContextTypes.DEFAULT_TYPE):
        user_id = update.effective_user.id
        
        user = await db.get_user(user_id)
        if not user:
            await update.message.reply_text(
                "âš ï¸ Please register first with /start"
            )
            return
        
        return await func(update, context)
    return wrapper

def admin_only(func):
    """Restrict command to admin users"""
    @wraps(func)
    async def wrapper(update: Update, context: ContextTypes.DEFAULT_TYPE):
        user_id = update.effective_user.id
        
        if user_id not in ADMIN_USER_IDS:
            await update.message.reply_text("â›” Admin access required")
            return
        
        return await func(update, context)
    return wrapper

def chat_type(*allowed_types):
    """Restrict to specific chat types (private, group, channel)"""
    def decorator(func):
        @wraps(func)
        async def wrapper(update: Update, context: ContextTypes.DEFAULT_TYPE):
            chat_type = update.effective_chat.type
            
            if chat_type not in allowed_types:
                await update.message.reply_text(
                    f"This command works only in: {', '.join(allowed_types)}"
                )
                return
            
            return await func(update, context)
        return wrapper
    return decorator

# Usage
@admin_only
async def ban_user(update, context):
    # Only admins can use this
    pass

@require_auth
@chat_type("private")
async def settings(update, context):
    # Only registered users in private chat
    pass</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-24-3">
          <div class="snippet-header">
            <h3 class="snippet-title">24.3 @log_execution_time</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×œ×¢×§×•×‘ ××—×¨×™ ×‘×™×¦×•×¢×™× ×•×œ×–×”×•×ª bottlenecks
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from functools import wraps
import time
import logging

logger = logging.getLogger(__name__)

def log_execution_time(threshold_ms: Optional[int] = None):
    """Log execution time, warn if exceeds threshold"""
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            start = time.time()
            
            try:
                result = await func(*args, **kwargs)
                return result
            finally:
                duration_ms = (time.time() - start) * 1000
                
                log_data = {
                    "function": func.__name__,
                    "duration_ms": round(duration_ms, 2)
                }
                
                if threshold_ms and duration_ms > threshold_ms:
                    logger.warning(
                        f"Slow execution: {func.__name__} took {duration_ms:.2f}ms "
                        f"(threshold: {threshold_ms}ms)",
                        extra=log_data
                    )
                else:
                    logger.debug(
                        f"{func.__name__} completed in {duration_ms:.2f}ms",
                        extra=log_data
                    )
        
        return wrapper
    return decorator

# Usage
@log_execution_time(threshold_ms=1000)
async def process_large_file(file_path: str):
    # Will warn if takes > 1 second
    pass</code></pre>
          </div>
        </div>

      </div>


      <!-- Category 25: Telegram Payments & Invoices -->
      <div class="category" id="category-25">
        <div class="category-header">
          <i class="fas fa-credit-card"></i>
          <h2>Telegram Payments & Invoices</h2>
        </div>
        <div class="snippet" id="snippet-25-1">
          <div class="snippet-header">
            <h3 class="snippet-title">25.1 Payment Processing</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×œ×§×‘×œ ×ª×©×œ×•××™× ×“×¨×š Telegram ×‘×¦×•×¨×” ×‘×˜×•×—×”
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from telegram import LabeledPrice, Update
from telegram.ext import ContextTypes, PreCheckoutQueryHandler

class PaymentProcessor:
    def __init__(self, provider_token: str):
        self.provider_token = provider_token
    
    async def send_invoice(
        self,
        update: Update,
        title: str,
        description: str,
        payload: str,
        amount: int,  # In smallest currency unit (cents)
        currency: str = "USD"
    ):
        """Send payment invoice to user"""
        await update.message.reply_invoice(
            title=title,
            description=description,
            payload=payload,
            provider_token=self.provider_token,
            currency=currency,
            prices=[LabeledPrice("Price", amount)],
            start_parameter="payment",
            photo_url="https://example.com/product.jpg",  # Optional
            need_name=True,
            need_email=True,
            need_shipping_address=False,
        )
    
    async def handle_pre_checkout(
        self, 
        update: Update, 
        context: ContextTypes.DEFAULT_TYPE
    ):
        """Validate payment before processing"""
        query = update.pre_checkout_query
        
        # Verify payload and amount
        if not await self._validate_payment(query.invoice_payload, query.total_amount):
            await query.answer(
                ok=False,
                error_message="Payment validation failed"
            )
            return
        
        await query.answer(ok=True)
    
    async def handle_successful_payment(
        self,
        update: Update,
        context: ContextTypes.DEFAULT_TYPE
    ):
        """Process successful payment"""
        payment = update.message.successful_payment
        
        # Log payment
        await db.save_payment({
            "user_id": update.effective_user.id,
            "amount": payment.total_amount,
            "currency": payment.currency,
            "payload": payment.invoice_payload,
            "telegram_payment_id": payment.telegram_payment_charge_id
        })
        
        # Grant access or deliver product
        await self._fulfill_order(payment.invoice_payload, update.effective_user.id)
        
        await update.message.reply_text(
            "âœ… Payment successful! Thank you for your purchase."
        )

# Usage
payment_processor = PaymentProcessor(PAYMENT_PROVIDER_TOKEN)
app.add_handler(PreCheckoutQueryHandler(payment_processor.handle_pre_checkout))</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-25-2">
          <div class="snippet-header">
            <h3 class="snippet-title">25.2 Invoice Generation</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×œ×™×¦×•×¨ ×—×©×‘×•× ×™×•×ª ××•×‘× ×•×ª ×¢× ××¡×¤×¨ ×¤×¨×™×˜×™×
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from telegram import LabeledPrice
from dataclasses import dataclass
from typing import List

@dataclass
class InvoiceItem:
    label: str
    amount: int  # In cents

class InvoiceBuilder:
    def __init__(self):
        self.items: List[InvoiceItem] = []
    
    def add_item(self, label: str, amount: int):
        """Add item to invoice"""
        self.items.append(InvoiceItem(label, amount))
        return self
    
    def add_tax(self, percentage: float):
        """Add tax based on current total"""
        subtotal = self.get_total()
        tax_amount = int(subtotal * percentage / 100)
        self.items.append(InvoiceItem(f"Tax ({percentage}%)", tax_amount))
        return self
    
    def add_discount(self, label: str, amount: int):
        """Add discount (negative amount)"""
        self.items.append(InvoiceItem(label, -amount))
        return self
    
    def get_total(self) -> int:
        return sum(item.amount for item in self.items)
    
    def build_prices(self) -> List[LabeledPrice]:
        """Convert to Telegram LabeledPrice format"""
        return [
            LabeledPrice(item.label, item.amount)
            for item in self.items
        ]

# Usage
invoice = InvoiceBuilder()
invoice.add_item("Premium Plan (1 month)", 999)  # $9.99
invoice.add_item("Extra Storage (10GB)", 299)     # $2.99
invoice.add_discount("First-time user discount", 200)  # -$2.00
invoice.add_tax(10)  # 10% tax

await bot.send_invoice(
    chat_id=user_id,
    title="Subscription Invoice",
    description="Your monthly subscription",
    payload="subscription_monthly",
    provider_token=PROVIDER_TOKEN,
    currency="USD",
    prices=invoice.build_prices()
)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-25-3">
          <div class="snippet-header">
            <h3 class="snippet-title">25.3 Payment Verification</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×œ×•×•×“× ×ª×§×™× ×•×ª ×ª×©×œ×•××™× ×•×œ×× ×•×¢ ×”×•× ××•×ª
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import hmac
import hashlib
from typing import Optional

class PaymentVerifier:
    def __init__(self, bot_token: str):
        self.bot_token = bot_token
    
    def verify_payment_signature(
        self,
        invoice_payload: str,
        total_amount: int,
        currency: str,
        provider_payment_id: str,
        signature: str
    ) -> bool:
        """Verify payment signature from provider"""
        data = f"{invoice_payload}:{total_amount}:{currency}:{provider_payment_id}"
        expected_signature = hmac.new(
            self.bot_token.encode(),
            data.encode(),
            hashlib.sha256
        ).hexdigest()
        
        return hmac.compare_digest(signature, expected_signature)
    
    async def validate_payment(
        self,
        user_id: int,
        invoice_payload: str,
        amount: int
    ) -> tuple[bool, Optional[str]]:
        """Validate payment details before processing"""
        # Check if user exists
        user = await db.get_user(user_id)
        if not user:
            return False, "User not found"
        
        # Check if payment already processed
        existing = await db.get_payment_by_payload(invoice_payload)
        if existing:
            return False, "Payment already processed"
        
        # Validate amount
        expected_amount = await self._get_expected_amount(invoice_payload)
        if amount != expected_amount:
            return False, f"Amount mismatch: expected {expected_amount}, got {amount}"
        
        return True, None

# Usage in pre-checkout handler
verifier = PaymentVerifier(BOT_TOKEN)

async def pre_checkout_callback(update, context):
    query = update.pre_checkout_query
    
    valid, error = await verifier.validate_payment(
        user_id=query.from_user.id,
        invoice_payload=query.invoice_payload,
        amount=query.total_amount
    )
    
    await query.answer(ok=valid, error_message=error)</code></pre>
          </div>
        </div>

      </div>


      <!-- Category 26: Monitoring & Metrics -->
      <div class="category" id="category-26">
        <div class="category-header">
          <i class="fas fa-chart-line"></i>
          <h2>Monitoring & Metrics</h2>
        </div>
        <div class="snippet" id="snippet-26-1">
          <div class="snippet-header">
            <h3 class="snippet-title">26.1 Prometheus Metrics Collection</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×œ××¡×•×£ ×•×œ×—×©×•×£ ××˜×¨×™×§×•×ª ×œ× ×™×˜×•×¨ ×‘-Prometheus
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from prometheus_client import Counter, Histogram, Gauge, generate_latest
from functools import wraps
import time

# Define metrics
message_counter = Counter(
    'bot_messages_total',
    'Total messages processed',
    ['command', 'status']
)

response_time = Histogram(
    'bot_response_seconds',
    'Response time distribution',
    ['handler']
)

active_users = Gauge(
    'bot_active_users',
    'Number of active users'
)

error_counter = Counter(
    'bot_errors_total',
    'Total errors',
    ['error_type']
)

class MetricsCollector:
    @staticmethod
    def track_message(command: str, status: str = "success"):
        """Track message processing"""
        message_counter.labels(command=command, status=status).inc()
    
    @staticmethod
    def track_response_time(handler_name: str):
        """Decorator to track handler response time"""
        def decorator(func):
            @wraps(func)
            async def wrapper(*args, **kwargs):
                start = time.time()
                try:
                    result = await func(*args, **kwargs)
                    MetricsCollector.track_message(handler_name, "success")
                    return result
                except Exception as e:
                    MetricsCollector.track_message(handler_name, "error")
                    error_counter.labels(error_type=type(e).__name__).inc()
                    raise
                finally:
                    duration = time.time() - start
                    response_time.labels(handler=handler_name).observe(duration)
            return wrapper
        return decorator
    
    @staticmethod
    async def update_active_users():
        """Update active users gauge"""
        count = await db.count_active_users(minutes=5)
        active_users.set(count)

# Expose metrics endpoint (FastAPI)
from fastapi import FastAPI, Response
app = FastAPI()

@app.get("/metrics")
async def metrics():
    return Response(
        content=generate_latest(),
        media_type="text/plain"
    )

# Usage
@MetricsCollector.track_response_time("start_command")
async def start_command(update, context):
    await update.message.reply_text("Hello!")</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-26-2">
          <div class="snippet-header">
            <h3 class="snippet-title">26.2 Custom Metrics Helpers</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×™×¦×™×¨×ª ××˜×¨×™×§×•×ª ××•×ª×××•×ª ××™×©×™×ª ×œ×¦×¨×›×™× ×¡×¤×¦×™×¤×™×™×
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from collections import defaultdict
from datetime import datetime, timedelta
from typing import Dict, List
import json

class CustomMetrics:
    def __init__(self):
        self.metrics: Dict[str, List] = defaultdict(list)
        self.aggregations: Dict[str, float] = {}
    
    def record(self, metric_name: str, value: float, tags: dict = None):
        """Record a metric value with optional tags"""
        self.metrics[metric_name].append({
            "value": value,
            "timestamp": datetime.now().isoformat(),
            "tags": tags or {}
        })
        
        # Keep only last hour of data
        cutoff = datetime.now() - timedelta(hours=1)
        self.metrics[metric_name] = [
            m for m in self.metrics[metric_name]
            if datetime.fromisoformat(m["timestamp"]) > cutoff
        ]
    
    def get_average(self, metric_name: str, minutes: int = 5) -> float:
        """Get average value over last N minutes"""
        cutoff = datetime.now() - timedelta(minutes=minutes)
        values = [
            m["value"] for m in self.metrics.get(metric_name, [])
            if datetime.fromisoformat(m["timestamp"]) > cutoff
        ]
        return sum(values) / len(values) if values else 0
    
    def get_percentile(self, metric_name: str, percentile: int) -> float:
        """Get percentile value (e.g., 95th percentile)"""
        values = sorted([m["value"] for m in self.metrics.get(metric_name, [])])
        if not values:
            return 0
        index = int(len(values) * percentile / 100)
        return values[min(index, len(values) - 1)]
    
    def export_summary(self) -> dict:
        """Export metrics summary"""
        return {
            name: {
                "count": len(values),
                "avg": self.get_average(name, minutes=60),
                "p95": self.get_percentile(name, 95),
                "p99": self.get_percentile(name, 99)
            }
            for name, values in self.metrics.items()
        }

# Usage
metrics = CustomMetrics()

# Track custom metric
metrics.record("api_latency_ms", 45.2, tags={"endpoint": "/users"})
metrics.record("cache_hit_rate", 0.85)

# Get insights
avg_latency = metrics.get_average("api_latency_ms", minutes=5)
p95_latency = metrics.get_percentile("api_latency_ms", 95)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-26-3">
          <div class="snippet-header">
            <h3 class="snippet-title">26.3 Performance Tracking Decorators</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×œ×¢×§×•×‘ ××•×˜×•××˜×™×ª ××—×¨×™ ×‘×™×¦×•×¢×™× ×©×œ ×¤×•× ×§×¦×™×•×ª
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from functools import wraps
import time
from typing import Optional, Callable
import asyncio

class PerformanceTracker:
    def __init__(self, metrics_collector):
        self.metrics = metrics_collector
        self.thresholds = {}
    
    def track(
        self, 
        metric_name: Optional[str] = None,
        slow_threshold_ms: Optional[int] = None,
        alert_callback: Optional[Callable] = None
    ):
        """Decorator to track function performance"""
        def decorator(func):
            name = metric_name or f"{func.__module__}.{func.__name__}"
            
            @wraps(func)
            async def wrapper(*args, **kwargs):
                start = time.time()
                exception = None
                
                try:
                    result = await func(*args, **kwargs)
                    return result
                except Exception as e:
                    exception = e
                    raise
                finally:
                    duration_ms = (time.time() - start) * 1000
                    
                    # Record metric
                    self.metrics.record(
                        f"{name}.duration_ms",
                        duration_ms,
                        tags={
                            "success": exception is None,
                            "error_type": type(exception).__name__ if exception else None
                        }
                    )
                    
                    # Alert if slow
                    if slow_threshold_ms and duration_ms > slow_threshold_ms:
                        logger.warning(
                            f"Slow execution: {name} took {duration_ms:.2f}ms "
                            f"(threshold: {slow_threshold_ms}ms)"
                        )
                        
                        if alert_callback:
                            asyncio.create_task(
                                alert_callback(name, duration_ms, slow_threshold_ms)
                            )
            
            return wrapper
        return decorator

# Usage
tracker = PerformanceTracker(metrics)

async def send_alert(func_name, duration, threshold):
    await bot.send_message(
        ADMIN_CHAT_ID,
        f"âš ï¸ Slow function: {func_name}\n"
        f"Duration: {duration:.2f}ms (threshold: {threshold}ms)"
    )

@tracker.track(slow_threshold_ms=1000, alert_callback=send_alert)
async def process_user_request(user_id: int):
    # Your code here
    pass</code></pre>
          </div>
        </div>

      </div>


      <!-- Category 27: Environment & Secrets Management -->
      <div class="category" id="category-27">
        <div class="category-header">
          <i class="fas fa-cog"></i>
          <h2>Environment & Secrets Management</h2>
        </div>
        <div class="snippet" id="snippet-27-1">
          <div class="snippet-header">
            <h3 class="snippet-title">27.1 .env Loading with Validation</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×œ×˜×¢×•×Ÿ ×”×’×“×¨×•×ª ×‘×¦×•×¨×” ×‘×˜×•×—×” ×¢× ×•×œ×™×“×¦×™×”
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from pydantic import BaseSettings, validator, SecretStr
from typing import Optional, List
import os

class Settings(BaseSettings):
    # Bot settings
    bot_token: SecretStr
    webhook_url: Optional[str] = None
    webhook_secret: SecretStr
    
    # Database
    database_url: SecretStr
    db_pool_size: int = 10
    
    # Redis
    redis_url: Optional[str] = None
    
    # Features
    enable_payments: bool = False
    payment_provider_token: Optional[SecretStr] = None
    
    # Admin
    admin_user_ids: List[int] = []
    
    # API Keys
    openai_api_key: Optional[SecretStr] = None
    
    @validator('bot_token')
    def validate_bot_token(cls, v):
        token = v.get_secret_value()
        if not token or ':' not in token:
            raise ValueError('Invalid bot token format')
        return v
    
    @validator('webhook_url')
    def validate_webhook_url(cls, v):
        if v and not v.startswith('https://'):
            raise ValueError('Webhook URL must use HTTPS')
        return v
    
    @validator('admin_user_ids', pre=True)
    def parse_admin_ids(cls, v):
        if isinstance(v, str):
            return [int(x.strip()) for x in v.split(',') if x.strip()]
        return v
    
    @validator('enable_payments')
    def validate_payment_config(cls, v, values):
        if v and not values.get('payment_provider_token'):
            raise ValueError('payment_provider_token required when payments enabled')
        return v
    
    class Config:
        env_file = '.env'
        env_file_encoding = 'utf-8'
        case_sensitive = False

# Usage
try:
    settings = Settings()
    print("âœ… Configuration loaded successfully")
except Exception as e:
    print(f"âŒ Configuration error: {e}")
    exit(1)

# Access values
BOT_TOKEN = settings.bot_token.get_secret_value()
ADMIN_IDS = settings.admin_user_ids</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-27-2">
          <div class="snippet-header">
            <h3 class="snippet-title">27.2 Secrets Rotation</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×œ××¤×©×¨ ×”×—×œ×¤×ª secrets ×‘×œ×™ ×œ×”×¤×¡×™×§ ××ª ×”×©×™×¨×•×ª
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">import asyncio
from datetime import datetime, timedelta
from typing import Dict, Optional

class SecretManager:
    def __init__(self):
        self.secrets: Dict[str, dict] = {}
        self.rotation_callbacks = {}
    
    def register_secret(
        self,
        name: str,
        value: str,
        rotation_interval: Optional[timedelta] = None,
        rotation_callback: Optional[callable] = None
    ):
        """Register a secret with optional rotation"""
        self.secrets[name] = {
            "value": value,
            "created_at": datetime.now(),
            "rotation_interval": rotation_interval,
            "last_rotated": datetime.now()
        }
        
        if rotation_callback:
            self.rotation_callbacks[name] = rotation_callback
    
    def get_secret(self, name: str) -> str:
        """Get current secret value"""
        if name not in self.secrets:
            raise KeyError(f"Secret '{name}' not found")
        return self.secrets[name]["value"]
    
    async def rotate_secret(self, name: str, new_value: str):
        """Rotate a secret"""
        if name not in self.secrets:
            raise KeyError(f"Secret '{name}' not found")
        
        old_value = self.secrets[name]["value"]
        
        # Update secret
        self.secrets[name].update({
            "value": new_value,
            "last_rotated": datetime.now()
        })
        
        # Call rotation callback if registered
        if name in self.rotation_callbacks:
            await self.rotation_callbacks[name](old_value, new_value)
        
        logger.info(f"Secret '{name}' rotated successfully")
    
    async def check_rotation_needed(self):
        """Background task to check if secrets need rotation"""
        while True:
            for name, secret in self.secrets.items():
                interval = secret.get("rotation_interval")
                if not interval:
                    continue
                
                time_since_rotation = datetime.now() - secret["last_rotated"]
                if time_since_rotation > interval:
                    logger.warning(
                        f"Secret '{name}' needs rotation "
                        f"(last rotated {time_since_rotation.days} days ago)"
                    )
            
            await asyncio.sleep(3600)  # Check every hour

# Usage
secret_manager = SecretManager()

async def on_webhook_secret_rotation(old_secret, new_secret):
    # Update webhook with new secret
    await bot.set_webhook(
        url=WEBHOOK_URL,
        secret_token=new_secret
    )

secret_manager.register_secret(
    "webhook_secret",
    os.getenv("WEBHOOK_SECRET"),
    rotation_interval=timedelta(days=30),
    rotation_callback=on_webhook_secret_rotation
)</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-27-3">
          <div class="snippet-header">
            <h3 class="snippet-title">27.3 Multi-Environment Config</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×œ× ×”×œ ×”×’×“×¨×•×ª ×©×•× ×•×ª ×œ-dev/staging/production
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from enum import Enum
from pydantic import BaseSettings
from typing import Dict, Any

class Environment(str, Enum):
    DEVELOPMENT = "development"
    STAGING = "staging"
    PRODUCTION = "production"

class BaseConfig(BaseSettings):
    environment: Environment = Environment.DEVELOPMENT
    debug: bool = False
    
    class Config:
        env_file = '.env'

class DevelopmentConfig(BaseConfig):
    debug: bool = True
    database_url: str = "sqlite:///dev.db"
    log_level: str = "DEBUG"
    enable_sentry: bool = False

class StagingConfig(BaseConfig):
    database_url: str
    log_level: str = "INFO"
    enable_sentry: bool = True
    sentry_environment: str = "staging"

class ProductionConfig(BaseConfig):
    database_url: str
    log_level: str = "WARNING"
    enable_sentry: bool = True
    sentry_environment: str = "production"
    require_https: bool = True

def get_config() -> BaseConfig:
    """Get configuration based on environment"""
    env = os.getenv("ENVIRONMENT", "development").lower()
    
    configs = {
        Environment.DEVELOPMENT: DevelopmentConfig,
        Environment.STAGING: StagingConfig,
        Environment.PRODUCTION: ProductionConfig
    }
    
    config_class = configs.get(Environment(env), DevelopmentConfig)
    return config_class()

# Usage
config = get_config()

if config.environment == Environment.PRODUCTION:
    # Production-specific setup
    pass

logger.setLevel(config.log_level)</code></pre>
          </div>
        </div>

      </div>


      <!-- Category 28: Data Serialization & Validation -->
      <div class="category" id="category-28">
        <div class="category-header">
          <i class="fas fa-code"></i>
          <h2>Data Serialization & Validation</h2>
        </div>
        <div class="snippet" id="snippet-28-1">
          <div class="snippet-header">
            <h3 class="snippet-title">28.1 Pydantic Models for Data</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×•×œ×™×“×¦×™×” ×•-typing ×—×–×§ ×œ×›×œ ×”×“××˜×”
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from pydantic import BaseModel, Field, validator
from typing import Optional, List
from datetime import datetime
from enum import Enum

class UserRole(str, Enum):
    USER = "user"
    ADMIN = "admin"
    MODERATOR = "moderator"

class User(BaseModel):
    id: int
    username: Optional[str] = None
    first_name: str
    role: UserRole = UserRole.USER
    created_at: datetime = Field(default_factory=datetime.now)
    is_active: bool = True
    
    @validator('username')
    def validate_username(cls, v):
        if v and (len(v) < 3 or len(v) > 32):
            raise ValueError('Username must be 3-32 characters')
        return v

class Message(BaseModel):
    message_id: int
    user_id: int
    text: str = Field(..., max_length=4096)
    timestamp: datetime = Field(default_factory=datetime.now)
    edited: bool = False
    reply_to: Optional[int] = None
    
    class Config:
        json_encoders = {
            datetime: lambda v: v.isoformat()
        }

class ChatStatistics(BaseModel):
    total_messages: int = 0
    total_users: int = 0
    active_users_24h: int = 0
    messages_by_hour: List[int] = Field(default_factory=lambda: [0] * 24)
    
    def add_message(self, hour: int):
        self.total_messages += 1
        self.messages_by_hour[hour] += 1

# Usage - automatic validation
try:
    user = User(
        id=123,
        username="ab",  # Too short - will raise ValidationError
        first_name="John"
    )
except ValidationError as e:
    print(e.json())

# Serialize to dict/JSON
user_dict = user.dict()
user_json = user.json()

# Parse from dict
user = User.parse_obj({"id": 123, "first_name": "John"})</code></pre>
          </div>
        </div>

        <div class="snippet" id="snippet-28-2">
          <div class="snippet-header">
            <h3 class="snippet-title">28.2 Custom Validators</h3>
            <p class="snippet-description">
              <strong>×œ××” ×–×” ×©×™××•×©×™:</strong> ×•×œ×™×“×¦×™×•×ª ××•×ª×××•×ª ××™×©×™×ª ×œ×¦×¨×›×™× ×¡×¤×¦×™×¤×™×™×
            </p>
          </div>
          <div class="snippet-content">
            <button class="copy-button" onclick="copyCode(this)">×”×¢×ª×§</button>
            <pre class="language-python"><code class="language-python">from pydantic import BaseModel, validator, root_validator
from typing import Optional
import re

class BotSettings(BaseModel):
    bot_token: str
    webhook_url: Optional[str] = None
    max_message_length: int = 4096
    rate_limit: int = 30
    
    @validator('bot_token')
    def validate_token_format(cls, v):
        """Validate Telegram bot token format"""
        pattern = r'^\d+:[A-Za-z0-9_-]{35}$'
        if not re.match(pattern, v):
            raise ValueError('Invalid bot token format')
        return v
    
    @validator('webhook_url')
    def validate_webhook(cls, v):
        """Ensure webhook uses HTTPS"""
        if v and not v.startswith('https://'):
            raise ValueError('Webhook must use HTTPS')
        return v
    
    @validator('rate_limit')
    def validate_rate_limit(cls, v):
        """Ensure reasonable rate limit"""
        if v < 1 or v > 100:
            raise ValueError('Rate limit must be between 1-100')
        return v
    
    @root_validator
    def validate_settings(cls, values):
        """Cross-field validation"""
        webhook = values.get('webhook_url')
        token = values.get('bot_token')
        
        if webhook:
            # Ensure webhook domain doesn't contain bot token
            if token and token.split(':')[0] in webhook:
                raise ValueError('Webhook URL should not contain bot token')
        
        return values

class UserRegistration(BaseModel):
    email: str
    phone: Optional[str] = None
    age: int
    
    @validator('email')
    def validate_email(cls, v):
        email_pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
        if not re.match(email_pattern, v):
            raise ValueError('Invalid email format')
        return v.lower()
    
    @validator('phone')
    def validate_phone(cls, v):
        if v:
            # Remove common separators
            cleaned = re.sub(r'[-()\s]', '', v)
            if not cleaned.isdigit() or len(cleaned) < 10:
                raise ValueError('Invalid phone number')
            return cleaned
        return v
    
    @validator('age')
    def validate_age(cls, v):
        if v < 13:
            raise ValueError('Must be at least 13 years old')
        if v > 120:
            raise ValueError('Invalid age')
        return v</code></pre>
          </div>
        </div>
      </div>

      </div>
    </div>

    <!-- Back to top button -->
    <button class="back-to-top" id="backToTop" aria-label="×—×–×¨×” ×œ××¢×œ×”">
      <i class="fas fa-arrow-up"></i>
    </button>

    <script src="scripts.js"></script>
  

</body></html>
